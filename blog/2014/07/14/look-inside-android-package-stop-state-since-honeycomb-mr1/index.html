
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>你造么,Android中程序的停止状态 - 技术小黑屋</title>
  <meta name="author" content="androidyue">

  
  <meta name="keywords" content="Java,Ruby,Android,Linux,日语" />
  <meta name="ujianVerification" content="13e7551f5af04296bb891d33b010bf6b" />
  
  <meta name="description" content="你造么,Android中程序的停止状态 Jul 14th, 2014 很多人遇到过广播收不到的问题,比如Google Play推广安装广播没有收到等,诸如这些问题,又都是什么原因呢,这篇文章将进行回答. 从Android 3.1(HoneyComb) 也就是API 12开始, &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="apple-touch-icon" href="http://droidyueimg.qiniudn.com/touch_icon.png"/>

  
  <link rel="canonical" href="http://droidyue.com/blog/2014/07/14/look-inside-android-package-stop-state-since-honeycomb-mr1">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="技术小黑屋" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//droidyue-tools.qiniudn.com/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.useso.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.useso.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-43841039-1']);
    _gaq.push(['_trackPageview']);

    (function() {
     var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
     ga.src='http://stats.g.doubleclick.net/dc.js';
     var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">技术小黑屋</a></h1>
  
    <h2>Better Than Before</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:droidyue.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">博客</a></li>
  <li><a href="/blog/archives">存档</a></li>
  <li><a href="/values/">作品集</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">你造么,Android中程序的停止状态</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-14T19:46:00+08:00" pubdate data-updated="true">Jul 14<span>th</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>很多人遇到过广播收不到的问题,比如Google Play推广安装广播没有收到等,诸如这些问题,又都是什么原因呢,这篇文章将进行回答.</p>

<p>从Android 3.1(HoneyComb) 也就是API 12开始,Android引入了一套新的启动控制,这就是程序的停止状态.那让我们看一下Google对于程序的停止状态的描述.</p>

<!--more-->


<h2>什么是程序的停止状态</h2>

<blockquote><p>Starting from Android 3.1, the system&rsquo;s package manager keeps track of applications that are in a stopped state and provides a means of controlling their launch from background processes and other applications.</p>

<p>从Android 3.1开始,系统的包管理器开始跟踪处理停止状态的程序.并且提供了方法来控制从后台进程或者其他程序对它们的启动.</p>

<p>Note that an application&rsquo;s stopped state is not the same as an Activity&rsquo;s stopped state. The system manages those two stopped states separately.</p>

<p>注意 程序的停止状态和Activity的停止状态不同,系统会单独处理这两种状态.</p>

<p>The platform defines two new intent flags that let a sender specify whether the Intent should be allowed to activate components in stopped application.
Android平台提供了两个intent flags,用来让发送广播的一方决定广播是否需要同时发送给已经停止的程序.</p>

<p>FLAG_INCLUDE_STOPPED_PACKAGES — Include intent filters of stopped applications in the list of potential targets to resolve against.
将已经支持的程序加入到能处理intent的目标处理者.</p>

<p>FLAG_EXCLUDE_STOPPED_PACKAGES — Exclude intent filters of stopped applications from the list of potential targets.
在能处理intent的目标处理者中不包含已经停止的程序.</p></blockquote>

<p>当如果intnet中没有或者设置了上面两个flag,在目标处理者中是包含已经处于停止的程序.但是注意,系统会为所有的广播intent增加FLAG_EXCLUDE_STOPPED_PACKAGES这个flag.</p>

<h2>为什么Android要引入这一状态</h2>

<p>Note that the system adds FLAG_EXCLUDE_STOPPED_PACKAGES to all broadcast intents. It does this to prevent broadcasts from background services from inadvertently or unnecessarily launching components of stoppped applications. A background service or application can override this behavior by adding the FLAG_INCLUDE_STOPPED_PACKAGES flag to broadcast intents that should be allowed to activate stopped applications.</p>

<p>需要注意的是,系统会默认地对所有的广播intent增加一个FLAG_EXCLUDE_STOPPED_PACKAGES的flag,这样做的目的是为了阻止来自后台服务的广播不慎或者启动处于停止状态的程序的不必要的组件.</p>

<p>通常的intnet广播,处于停止状态的程序的receiver是无法接受到的.那么怎么才能让这些停止状态的程序接受到呢?可以这样做,在后台服务或者应用中发送广播时,增加一个FLAG_INCLUDE_STOPPED_PACKAGES 的flag,意思是包含处于停止状态的程序.这样就可以激活停止状态的程序.</p>

<p>正如上述引用指出,系统默认阻止广播intent发送给处于停止状态的程序包,实际上这是为了保证安全和省电需要.比如说网络变化的广播,如果某些程序注册监听,并且它在得到广播时,做一系列的网络操作,这样必然是很耗能源的.</p>

<h2>激活状态和停止状态的切换</h2>

<p>当程序第一次安装并且没有启动,或者用户手动从程序管理将其停止后,程序都会处于停止状态.</p>

<h3>如何变为停止状态</h3>

<ul>
<li>在设置应用管理中的应用详情页点击强制停止</li>
<li>使用adb shell    <code>adb shell am force-stop package-name</code></li>
<li>使用ActivityManager的隐藏方法forceStopPackages,并且向manifest加入申请权限&lt;uses-permission android:name=&ldquo;android.permission.FORCE_STOP_PACKAGES&rdquo;/></li>
</ul>


<h3>如何脱离停止状态</h3>

<ul>
<li>手动启动程序</li>
<li>使用adb激活应用组件,如activity或者receiver</li>
</ul>


<h2>发送广播intent给处于停止状态的应用</h2>

<ul>
<li>在Java代码发送Intent时,加入flag FLAG_INCLUDE_STOPPED_PACKAGES</li>
<li>如果使用adb,同样是加入FLAG_INCLUDE_STOPPED_PACKAGES(其具体值为32),如<strong>adb shell am broadcast -a com.android.vending.INSTALL_REFERRER -f 32</strong></li>
</ul>


<h2>检查是否处于停止状态</h2>

<ul>
<li>进入设置&mdash;应用管理&mdash;某个应用的详细页,如果强制停止按钮不可用,则说明程序已经处于停止状态.</li>
<li>进入设备终端,查看系统文件<strong>cat /data/system/packages-stopped.xml</strong></li>
</ul>


<h2>问答环节</h2>

<ul>
<li>提问:如果我的程序没有activity只有一个receiver,我改如何激活才能接收到正常的广播intent呢</li>
<li><p>回答:实际上,如果是上面所述的情况,该应用在安装之后不是处于停止状态,因为它没有任何用户可以直接点击的行为去将它移除停止状态.你可以正常接收广播intent,除非你人为地将它强制停止.</p></li>
<li><p>提问:系统的程序刚安装会处于停止状态么?</p></li>
<li><p>回答:系统的程序通常会存放在 /system/app目录下,在一开始安装之后不会处于停止状态.</p></li>
<li><p>提问:Google Play的推广广播据说是在程序安装完成之后发送,是不是3.1之后受影响么</p></li>
<li>回答:不受影响的.Google文档说INSTALL_REFERRER会在程序安装完成之后发送,据实际查看日志观察,从3.1之后,是在程序安装后第一次打开时发送.</li>
</ul>


<h2>引用参考</h2>

<p><a href="http://developer.android.com/about/versions/android-3.1.html" target="_blank">Android 3.1 Hignlight</a></p>

<h3>其他</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B00EOIDFX8/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00EOIDFX8&linkCode=as2&tag=droidyue-23">Android开发权威指南</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00EOIDFX8" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B007PMPHJA/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B007PMPHJA&linkCode=as2&tag=droidyue-23">Android框架揭秘</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B007PMPHJA" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

</div>


  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js">
  </script>
  <!-- droidyue -->
  <ins class="adsbygoogle"
      style="display:inline-block;width:728px;height:90px"
      data-ad-client="ca-pub-7565659593663612"
      data-ad-slot="3065659745">
  </ins>
  <script>
    
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">androidyue</span></span>

      








  


<time datetime="2014-07-14T19:46:00+08:00" pubdate data-updated="true">Jul 14<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/android/'>Android</a>
  
</span>


    </p>
    
      <div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a><a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a><a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a><a href="#" class="bds_mshare" data-cmd="mshare" title="分享到一键分享"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"1","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"32"},"share":{},"image":{"viewList":["fbook","twi","douban","tsina","qzone","weixin","mshare"],"viewText":"分享到：","viewSize":"32"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["fbook","twi","douban","tsina","qzone","weixin","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/07/13/mac-terminal-exit-troubleshoot/" title="Previous Post: 解决Mac终端退出时的不爽">&laquo; 解决Mac终端退出时的不爽</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/07/15/python-dictionary-traversal-examples/" title="Next Post: Python中的字典遍历">Python中的字典遍历 &raquo;</a>
        
        <!-- UJian Button BEGIN -->
<div class="ujian-hook"></div>
<script type="text/javascript">var ujian_config = {num:8,showType:3};</script>
<script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?uid=1728662"></script>
<a href="http://www.ujian.cc" style="border:0;"><img src="http://img.ujian.cc/pixel.png" alt="友荐云推荐" style="border:0;padding:0;margin:0;" /></a>
<!-- UJian Button END -->

    </p>
  </footer>
  </article>

  <section>
   <!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="/blog/2014/07/14/look-inside-android-package-stop-state-since-honeycomb-mr1" data-title="你造么,Android中程序的停止状态" data-url="http://droidyue.com/blog/2014/07/14/look-inside-android-package-stop-state-since-honeycomb-mr1/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    var duoshuoQuery = {short_name:"droidyue"};
    (function() {

        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
     })();
 </script>
 <!-- 多说公共JS代码 end -->

  </section>

</div>

<aside class="sidebar">
  
    <a href="http://stackoverflow.com/users/749727/androidyue">
<img src="http://stackoverflow.com/users/flair/749727.png" width="270" height="58" alt="profile for androidyue at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for androidyue at Stack Overflow, Q&amp;A for professional and enthusiast programmers">
</a>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/09/27/missingformatargumentexception-format-specifier-s/">MissingFormatArgumentException: Format Specifier 'S'</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/22/weekly-script-add-prefix-to-mutiple-files-in-ruby/">每周一脚本：批量对多个文件增加前缀</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/21/determine-shell-script-located-directory/">获取shell脚本所在目录</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/20/interaction-between-java-and-javascript-in-android/">Android中Java和JavaScript交互</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/15/weekly-scripts-grep-android-application-log-in-terminal/">每周一脚本：过滤单个Android程序日志</a>
      </li>
    
  </ul>
</section>
<!-- 将此标记放置在你希望显示+1 按钮的位置。 -->
<div class="g-plusone" data-size="tall" data-annotation="inline" data-width="300" data-href="http://droidyue.com/"></div>
<!-- 将此标记放置在最后一个 +1 按钮 标记之后。 -->
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/platform.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
<a href="https://plus.google.com/105362551238192049560?rel=author">Google+</a>
<section>
<h1>Blogrolls</h1>
<ul>
    <li><a href="http://www.pcyoyo.com" target="_blank">Pcyoyo</a></li>
    <li><a href="http://www.dnnode.cn" target="_blank">第恩Web</a></li>
    <li><a href="/donate/">捐赠 Donate!</a></li>
    <li><a href="http://droidyue.com/blog/2014/09/13/my-work-for-qiniu-demo/" target="blank">我的七牛参赛作品</a></li>
    <li><a href="https://portal.qiniu.com/signup?code=3l8cqx1u74rbm" target="_blank">国内最好的免费CDN图床</a></li>
</ul>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - androidyue -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











  <script type="text/javascript" src="http://droidyue-tools.qiniudn.com/arrow37.js"></script>
<noscript>Not seeing a <a href="http://www.scrolltotop.com/">Scroll to Top Button</a>? Go to our FAQ page for more info.</noscript>


</body>
</html>
