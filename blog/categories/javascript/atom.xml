<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Javascript | 技术小黑屋]]></title>
  <link href="http://droidyue.com/blog/categories/javascript/atom.xml" rel="self"/>
  <link href="http://droidyue.com/"/>
  <updated>2014-11-29T17:26:58+08:00</updated>
  <id>http://droidyue.com/</id>
  <author>
    <name><![CDATA[androidyue]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[利用WebView实现网页的i18n]]></title>
    <link href="http://droidyue.com/blog/2014/09/30/i18n-web-page-using-webview-in-android/"/>
    <updated>2014-09-30T21:44:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/09/30/i18n-web-page-using-webview-in-android</id>
    <content type="html"><![CDATA[<p>软件如果想在全球获得更多的用户，国际化与本地化（internationalization and localization 简称：i18n 和L10n）是非常必要的。本文将介绍一个很geeky的方法来利用webview实现html的i18n。</p>

<!--more-->


<h2>基本概念</h2>

<p>国际化是指在设计软件，将软件与特定语言及地区脱钩的过程。当软件被移植到不同的语言及地区时，软件本身不用做内部工程上的改变或修正。本地化则是指当移植软件时，加上与特定区域设置有关的信息和翻译文件的过程。</p>

<p>国际化和本地化之间的区别虽然微妙，但却很重要。国际化意味着产品有适用于任何地方的“潜力”；本地化则是为了更适合于“特定”地方的使用，而另外增添的特色。用一项产品来说，国际化只需做一次，但本地化则要针对不同的区域各做一次。 这两者之间是互补的，并且两者合起来才能让一个系统适用于各地。</p>

<p>上述摘自<a href="http://zh.wikipedia.org/wiki/%E5%9B%BD%E9%99%85%E5%8C%96%E4%B8%8E%E6%9C%AC%E5%9C%B0%E5%8C%96">维基百科 国际化与本地化</a></p>

<h2>问题</h2>

<p>如何实现网页的国际化和本地化，支持更多的语言呢？最简单的逻辑可能类似如下伪代码实现
```javascript lineos:false
if (isChinese) {</p>

<pre><code>lable.innerText = "中文"
</code></pre>

<p>} else if (isEnglish) {</p>

<pre><code>lable.innerText = "English"
</code></pre>

<p>}
```
但是这样是很有问题的，如果增加了语言必然要修改代码代码，违背了对修改关闭的原则。所以上述并不是一种很好的方法</p>

<h2>更Hacky的实现</h2>

<p>实现思路主要是借助强大的Android系统的资源适配机制（基于设备设备的信息Locale等匹配最合适的资源）。貌似这个是Chrome中网页实现i18n的逻辑。实现步骤主要如下</p>

<ul>
<li>Android程序提供必要多个Locale的资源</li>
<li>将网页需要的文字资源组成JSON交换格式</li>
<li>WebView注入一个变量，变量内容为上一步的JSON数据</li>
<li>网页实现读取资源，为元素设置内容</li>
<li>加载网页</li>
</ul>


<h3>提供多个Locale文字资源</h3>

<h4>values/strings.xml</h4>

<p>```xml lineos:false
&lt;?xml version=&ldquo;1.0&rdquo; encoding=&ldquo;utf-8&rdquo;?>
<resources></p>

<pre><code>&lt;string name="city_beijing"&gt;Beijing&lt;/string&gt;
&lt;string name="country_china"&gt;China&lt;/string&gt;
</code></pre>

<p></resources>
```</p>

<h4>values-zh-rCN/strings.xml</h4>

<p>```xml lineos:false
&lt;?xml version=&ldquo;1.0&rdquo; encoding=&ldquo;utf-8&rdquo;?>
<resources></p>

<pre><code>&lt;string name="city_beijing"&gt;北京&lt;/string&gt;
&lt;string name="country_china"&gt;中国&lt;/string&gt;
</code></pre>

<p></resources>
```</p>

<h3>接下来的代码</h3>

<p>```java lineos:false
WebView myWebView = new WebView(this);
addContentView(myWebView, new LayoutParams(LayoutParams.MATCH_PARENT, LayoutParams.MATCH_PARENT));
//将网页需要的文字资源组成JSON交换格式
JSONObject jsObj = new JSONObject();
try {</p>

<pre><code>jsObj.put("country", getString(R.string.country_china));
jsObj.put("city", getString(R.string.city_beijing));
</code></pre>

<p>} catch (JSONException e) {</p>

<pre><code>e.printStackTrace();
</code></pre>

<p>}
//WebView注入一个变量，变量内容为上一步的JSON数据
String injectString = &ldquo;var textRes = &rdquo; + jsObj;
Log.i(LOGTAG, &ldquo;injuectString = &rdquo; + injectString);
WebSettings settings = myWebView.getSettings();
settings.setJavaScriptEnabled(true);
myWebView.loadUrl(&ldquo;javascript:&rdquo; + injectString);
myWebView.loadUrl(&ldquo;file:///android_asset/location.html&rdquo;);
```</p>

<h3>网页实现</h3>

<p>```html lineos:false
<html></p>

<pre><code>&lt;head&gt;
    &lt;title&gt;i18n Test&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;label id="country"&gt;&lt;/label&gt;
    &lt;lable id="city"&gt;&lt;/lable&gt;
&lt;/body&gt;
&lt;script type="text/javascript"&gt;
    document.getElementById('country').innerText= textRes.country
    document.getElementById('city').innerText = textRes.city
&lt;/script&gt;
</code></pre>

<p></html>
```</p>

<h3>结果</h3>

<ul>
<li>当系统语言为中文简体环境下网页显示<strong>中国 北京</strong></li>
<li>当系统语言为非中文简体环境下网页显示<strong>China Beijing</strong></li>
</ul>


<h3>Demo源码下载</h3>

<p><a href="http://pan.baidu.com/s/1sjwNamL">@百度网盘</a></p>

<h3>其他</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B00ASIN7G8/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00ASIN7G8&linkCode=as2&tag=droidyue-23">这样才可以精通Android</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00ASIN7G8" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B002JCU2TG/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B002JCU2TG&linkCode=as2&tag=droidyue-23">瞬间之美:Web界面设计如何让用户心动</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B002JCU2TG" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[每周一脚本：js设置链接为新标签打开]]></title>
    <link href="http://droidyue.com/blog/2014/09/29/open-url-in-new-tab-using-javascript/"/>
    <updated>2014-09-29T21:59:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/09/29/open-url-in-new-tab-using-javascript</id>
    <content type="html"><![CDATA[<p>由于Markdown在编辑Octopress文章的链接时无法指定打开方式，所以很多时候需要使用html写。后来想了一下，为什么不通过javascript把超链接的打开方式默认成新标签实现呢。</p>

<!--more-->


<p>JQuery中提供了一个DOM元素插入事件 DOMNodeInserted ，我们可以通过监听这个事件，对没有target属性值的a标签设置其target为_blank。这样就实现了默认新标签打开了。</p>

<h3>脚本代码</h3>

<p>```javascript lineos:false
/<em>To use the  DOMNodeInserted event listening, jquery is required</em>/
$(document).bind(&lsquo;DOMNodeInserted&rsquo;, function(event) {</p>

<pre><code>$('a[href^="http"]').each(
    function(){
        if (!$(this).attr('target')) {
            $(this).attr('target', '_blank')
        }   
    }
);
</code></pre>

<p>});
```</p>

<h3>示例</h3>

<p>```html lineos:false
<html></p>

<pre><code>&lt;script type="text/javascript" src="http://droidyue.com//code.jquery.com/jquery-1.11.0.min.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript" src="https://rawgit.com/androidyue/weekly-scripts/master/javascript/target_blank_link.js"&gt;&lt;/script&gt;
&lt;body&gt;
    &lt;a href="http://droidyue.com"&gt;droidyue&lt;/a&gt;
&lt;/body&gt;
</code></pre>

<p></html>
```
上述示例在浏览器加载之后，就会对a标签添加target=&ldquo;_blank"属性。</p>

<p><a href="https://github.com/androidyue/weekly-scripts/blob/master/javascript/target_blank_link.js">每周一脚本@Github</a></p>

<h3>其他</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B0089TDFNS/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B0089TDFNS&linkCode=as2&tag=droidyue-23">锋利的jQuery</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B0089TDFNS" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00BQ7RMW0/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00BQ7RMW0&linkCode=as2&tag=droidyue-23">编写可维护的JavaScript</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00BQ7RMW0" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00B14IGUK/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00B14IGUK&linkCode=as2&tag=droidyue-23">安全技术大系:Web前端黑客技术揭秘</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00B14IGUK" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Refused to execute script from because its MIME type (text/plain) is not executable, and strict MIME type checking is enabled]]></title>
    <link href="http://droidyue.com/blog/2014/09/27/refused-to-execute-script-from-because-its-mime-type-text-slash-plain-is-not-executable-and-strict-mime-type-checking-is-enabled/"/>
    <updated>2014-09-27T17:08:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/09/27/refused-to-execute-script-from-because-its-mime-type-text-slash-plain-is-not-executable-and-strict-mime-type-checking-is-enabled</id>
    <content type="html"><![CDATA[<p>今天又与这个问题相遇了,Orz,还是研究一下解决方法和出现原因吧。<br/>
刚刚在github上传了一个js文件，想让这个文件被其他网页引用，于是贴出了这个文件的raw版本的地址。但是却就遇到了这样的问题。</p>

<!--more-->


<p>这就是出现错误的代码
```html
<html></p>

<pre><code>&lt;script src="http://droidyue-tools.qiniudn.com/jquery.min.js"&gt;&lt;/script&gt;
&lt;script src="https://raw.githubusercontent.com/androidyue/weekly-scripts/master/javascript/target_blank_link.js"&gt;&lt;/script&gt;
&lt;div&gt;
&lt;a href="http://droidyue.com"&gt;droidyue.com&lt;/a&gt;
&lt;/div&gt;
</code></pre>

<p></html>
```</p>

<h2>解决方法</h2>

<p>将上面的链接中的<font color="red">raw.githubusercontent.com</font>换成<font color="red">rawgit.com</font>即可，此例中的网址最终为 <b><a href="https://rawgit.com/androidyue/weekly-scripts/master/javascript/target_blank_link.js">https://rawgit.com/androidyue/weekly-scripts/master/javascript/target_blank_link.js</a></b></p>

<h2>原因</h2>

<p>因为raw.githubusercontent.com在Response中设置了<strong>X-Content-Type-Options:nosniff</strong>，告诉浏览器强制检查资源的MIME，进行加载。</p>

<p>下面就是未处理的HTTP Response
<code>bash lineos:false
HTTP/1.1 200 OK
Date: Sat, 27 Sep 2014 09:27:12 GMT
Server: Apache
Access-Control-Allow-Origin: https://render.githubusercontent.com
Content-Security-Policy: default-src 'none'
X-XSS-Protection: 1; mode=block
X-Frame-Options: deny
X-Content-Type-Options: nosniff
Strict-Transport-Security: max-age=31536000
ETag: "4f10b14e4a81a195976ea05787287a019c8bcf6f"
Content-Type: text/plain; charset=utf-8
Cache-Control: max-age=300
Content-Encoding: gzip
Content-Length: 204
Accept-Ranges: bytes
Via: 1.1 varnish
X-Served-By: cache-lax1426-LAX
X-Cache: HIT
X-Cache-Hits: 1
Vary: Authorization,Accept-Encoding
Expires: Sat, 27 Sep 2014 09:32:12 GMT
Source-Age: 44
Keep-Alive: timeout=10, max=50
Connection: Keep-Alive
</code></p>

<h3>X-Content-Type-Options:nosniff 是神马</h3>

<p>  1 如果服务器发送响应头 &ldquo;X-Content-Type-Options: nosniff"，则 script 和 styleSheet 元素会拒绝包含错误的 MIME 类型的响应。这是一种安全功能，有助于防止基于 MIME类型混淆的攻击。</p>

<p>  2 服务器发送含有 &ldquo;X-Content-Type-Options: nosniff&rdquo; 标头的响应时，此更改会影响浏览器的行为。</p>

<p>  3 如果通过 styleSheet 参考检索到的响应中接收到 &ldquo;nosniff&rdquo; 指令，则 Windows Internet Explorer 不会加载“stylesheet”文件，除非 MIME 类型匹配 &ldquo;text/css"。</p>

<p>  4 如果通过 script 参考检索到的响应中接收到 &ldquo;nosniff&rdquo; 指令，则 Internet Explorer 不会加载“script”文件，除非 MIME 类型匹配以下值之一：</p>

<ul>
<li>&ldquo;application/ecmascript&rdquo;</li>
<li>&ldquo;application/javascript&rdquo;</li>
<li>&ldquo;application/x-javascript&rdquo;</li>
<li>&ldquo;text/ecmascript&rdquo;</li>
<li>&ldquo;text/javascript&rdquo;</li>
<li>&ldquo;text/jscript&rdquo;</li>
<li>&ldquo;text/x-javascript&rdquo;</li>
<li>&ldquo;text/vbs&rdquo;</li>
<li>&ldquo;text/vbscript&rdquo;</li>
</ul>


<p>该部分参考<a href="http://msdn.microsoft.com/zh-cn/library/ie/gg622941(v=vs.85).aspx">减少 MIME 类型的安全风险</a></p>

<h3>进阶书籍</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B00GOM5IL4/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00GOM5IL4&linkCode=as2&tag=droidyue-23">深入浅出Node.js</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00GOM5IL4" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B0097CON2S/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B0097CON2S&linkCode=as2&tag=droidyue-23">JavaScript语言精粹</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B0097CON2S" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00BQ7RMW0/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00BQ7RMW0&linkCode=as2&tag=droidyue-23">编写可维护的JavaScript</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00BQ7RMW0" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
</feed>
