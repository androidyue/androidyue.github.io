
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Thinkblog</title>
  <meta name="author" content="androidyue">

  
  <meta name="description" content="In this post, we will use the du command. This command does estimate file space usage; and It will summarize disk usage of each FILE, recursively for &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://androidyue.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Thinkblog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-43841039-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Thinkblog</a></h1>
  
    <h2>IT Technology Articles</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:androidyue.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/11/how-to-summarize-folder-size-in-terminal/">How to Summarize Folder Size in Terminal</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-11T11:49:00+08:00" pubdate data-updated="true">May 11<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/05/11/how-to-summarize-folder-size-in-terminal/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post, we will use the <strong>du</strong> command. This command does estimate file space usage; and It will summarize disk usage of each FILE, recursively for directories.
The description on the arguments we will use.</p>

<blockquote><p>-h, &mdash;human-readable
print sizes in human readable format (e.g., 1K 234M 2G)
-s, &mdash;summarize
display only a total for each argument</p></blockquote>

<h3>How to Summarize a single Folder Size</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#Summarize the current folder size.</span>
</span><span class='line'>11:33:57-androidyue~/googlecode<span class="nv">$ </span>du -sh
</span><span class='line'>85M   .
</span></code></pre></td></tr></table></div></figure>


<h3>Summarize a certain folder size.</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>11:34:03-androidyue~/googlecode<span class="nv">$ </span>du -sh apps-for-android/
</span><span class='line'>11M   apps-for-android/
</span></code></pre></td></tr></table></div></figure>


<h3>How to summarize multiple folders sizes</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>11:35:17-androidyue~/googlecode<span class="nv">$ </span>ls | xargs du -sh
</span><span class='line'>11M   apps-for-android
</span><span class='line'>22M   depot_tools
</span><span class='line'>740K  _gclient_src_fo4RrR
</span><span class='line'>42M   gerrit
</span><span class='line'>11M   reviewboard-read-only
</span></code></pre></td></tr></table></div></figure>


<p>More detailed information</p>

<blockquote><p>ls &ndash; list directory contents<br/>
Description:List  information about the FILEs (the current directory by default)
xargs &ndash; build and execute command lines from standard input</p>

<p>Written with <a href="https://stackedit.io/">StackEdit</a>.</p></blockquote>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/04/26/android-ninepatch-attention/">Android NinePatch Attention</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-26T12:23:00+08:00" pubdate data-updated="true">Apr 26<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/04/26/android-ninepatch-attention/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I have got many crash report data about using NinePath Drwable. I put a .9.png file into the drawable-xhdpi folder and the file did not exist in any other folder. And I got ResourceNotFoundException. I got this following sayings.</p>

<blockquote><p>A NinePatchDrawable graphic is a stretchable bitmap image, which Android will automatically resize to accommodate the contents of the View in which you have placed it as the background. An example use of a NinePatch is the backgrounds used by standard Android buttons — buttons must stretch to accommodate strings of various lengths. A NinePatch drawable is a standard PNG image that includes an extra 1-pixel-wide border. <strong>It must be saved with the extension .9.png, and saved into the res/drawable/ directory of your project.</strong>
<a href="http://developer.android.com/guide/topics/graphics/2d-graphics.html#nine-patch">http://developer.android.com/guide/topics/graphics/2d-graphics.html#nine-patch</a></p></blockquote>

<p>The .9.png files must be saved into the res/drawable directory. Why? I guess the legacy Resouce Loading System implemententation may result in this issue. So at least put one .9.png file into the drawable folder.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/04/26/install-lsusb-in-mac-osx/">Install Lsusb in Mac OSX</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-26T12:13:00+08:00" pubdate data-updated="true">Apr 26<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/04/26/install-lsusb-in-mac-osx/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>To continue doing as the following, make sure you have installed homebrew in your Mac OSX.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">brew</span> <span class="n">update</span> <span class="o">&amp;&amp;</span> <span class="n">brew</span> <span class="n">tap</span> <span class="n">jlhonora</span><span class="o">/</span><span class="n">lsusb</span> <span class="o">&amp;&amp;</span> <span class="n">brew</span> <span class="n">install</span> <span class="n">lsusb</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/04/18/revert-a-certain-file-back-to-a-certain-commit/">Revert a Certain File Back to a Certain Commit</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-18T21:49:00+08:00" pubdate data-updated="true">Apr 18<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/04/18/revert-a-certain-file-back-to-a-certain-commit/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#Grammar</span>
</span><span class='line'><span class="n">git</span> <span class="n">checkout</span> <span class="o">&lt;</span><span class="n">commit</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">filename</span><span class="o">&gt;</span>
</span><span class='line'><span class="c">#Examples</span>
</span><span class='line'><span class="n">git</span> <span class="n">checkout</span> <span class="mi">19</span><span class="n">ea3021303c89449506e99e25de3a061dc5aa75</span> <span class="n">AndroidManifest</span><span class="o">.</span><span class="n">xml</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/04/18/auth-password-cannot-be-read-from-a-file/">Auth Password Cannot Be Read From a File</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-18T21:35:00+08:00" pubdate data-updated="true">Apr 18<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/04/18/auth-password-cannot-be-read-from-a-file/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I am facing this problem which leaves the error message</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="err">&#39;</span><span class="n">Auth</span><span class="err">&#39;</span> <span class="n">password</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">read</span> <span class="n">from</span> <span class="n">a</span> <span class="n">file</span>
</span></code></pre></td></tr></table></div></figure>


<p>Because I have set configuration like this in the .opvn file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">auth</span><span class="o">-</span><span class="n">user</span><span class="o">-</span><span class="n">pass</span> <span class="n">user_password</span><span class="o">.</span><span class="na">config</span>
</span></code></pre></td></tr></table></div></figure>


<p>And after I googled I found one solution. It says You should recomiple the openVPN. Then I did as it said. It works. <br/>
Now Go into the openvpn folder. and follow the below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./configure --enable-password-save
</span><span class='line'>make
</span><span class='line'>sudo make install
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/03/29/use-vim-in-stackedit/">Use Vim in StackEdit</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-29T19:21:00+08:00" pubdate data-updated="true">Mar 29<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/03/29/use-vim-in-stackedit/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>StackEdit is really great online editor. It could connect with Google Drive. And what&rsquo;s more, you can even use Vim in this editor.<br/>
Now add the following snippet into Settings&mdash;Extensions&mdash;UserCustom extension javascript area.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">userCustom</span><span class="p">.</span><span class="nx">onReady</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">ace</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>        <span class="nx">ace</span><span class="p">.</span><span class="nx">require</span> <span class="o">=</span> <span class="nx">require</span>
</span><span class='line'>        <span class="nx">ace</span><span class="p">.</span><span class="nx">define</span> <span class="o">=</span> <span class="nx">define</span>
</span><span class='line'>    <span class="nx">ace</span><span class="p">.</span><span class="nx">require</span><span class="p">([</span><span class="s2">&quot;ace/lib/net&quot;</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">acenet</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">acenet</span><span class="p">.</span><span class="nx">loadScript</span><span class="p">(</span><span class="s2">&quot;http://google-drive-sdk-samples.googlecode.com/hg-history/db27d16a6e84d35bf068ce3864450cb557aa6a8d/php/lib/ace/keybinding-vim.js&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nx">e</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;.ace_editor&quot;</span><span class="p">).</span><span class="nx">env</span><span class="p">.</span><span class="nx">editor</span>
</span><span class='line'>            <span class="nx">ace</span><span class="p">.</span><span class="nx">require</span><span class="p">([</span><span class="s2">&quot;ace/keyboard/vim&quot;</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">acevim</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                                <span class="nx">e</span><span class="p">.</span><span class="nx">setKeyboardHandler</span><span class="p">(</span><span class="nx">acevim</span><span class="p">.</span><span class="nx">handler</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>        <span class="nb">window</span><span class="p">.</span><span class="nx">ace</span> <span class="o">=</span> <span class="nx">ace</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/03/21/fix-notification-switching-position-issue/">Fix Notification Switching Position Issue</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-21T22:14:00+08:00" pubdate data-updated="true">Mar 21<span>st</span>, 2014</time>
        
         | <a href="/blog/2014/03/21/fix-notification-switching-position-issue/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I once faced with a problem. I wrote a piece of code related with notifcation. Everything goes fine except one little issue. I found the ongoing notification switching order. My notification blinked each second.  After Googling I found the reason and resolved the problem.<br/>
In my code I wrote like this</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">notification</span><span class="o">.</span><span class="na">when</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s was the key point. For the notification the when timestamp should be fixed when an activity starts. And the default value is Now(which is the value of System.currentTimeMillis()).I used <strong>a fixed value</strong> and resovled the problem.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">notification</span><span class="o">.</span><span class="na">when</span> <span class="o">=</span> <span class="n">TIMESTAMP_FIXED</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now This is what Google says</p>

<blockquote><p>A timestamp related to this notification, in milliseconds since the epoch. Default value: Now. Choose a timestamp that will be most relevant to the user. For most finite events, this corresponds to the time the event happened (or will happen, in the case of events that have yet to occur but about which the user is being informed). Indefinite events should be timestamped according to when the activity began. Some examples:</p>

<ul>
<li>Notification of a new chat message should be stamped when the message was received.</li>
<li>Notification of an ongoing file download (with a progress bar, for example) should be stamped when the download started.</li>
<li>Notification of a completed file download should be stamped when the download finished.</li>
<li>Notification of an upcoming meeting should be stamped with the time the meeting will begin (that is, in the future).</li>
<li>Notification of an ongoing stopwatch (increasing timer) should be stamped with the watch&rsquo;s start time.</li>
<li>Notification of an ongoing countdown timer should be stamped with the timer&rsquo;s end time.
Reference from <a href="http://developer.android.com/reference/android/app/Notification.html#when">http://developer.android.com/reference/android/app/Notification.html#when</a>
Written with <a href="https://stackedit.io/">StackEdit</a>.</li>
</ul>
</blockquote>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/02/16/fix-no-sound-issue-on-mac/">Fix No Sound Issue on Mac</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-16T13:25:00+08:00" pubdate data-updated="true">Feb 16<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/02/16/fix-no-sound-issue-on-mac/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Now I am dealing with Mac OSX. However I found sometimes this is no sound. People say it&rsquo;s a bug. I have tried some methods. And found this goes for me every time.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>sudo kextunload /System/Library/Extensions/AppleHDA.kext
</span><span class='line'>sudo kextload /System/Library/Extensions/AppleHDA.kext
</span></code></pre></td></tr></table></div></figure>


<p>Put the code into a shell script and run the script whenever the issue occurs.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/02/09/code-snippet-for-media-on-android/">Code Snippet for Media on Android</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-09T19:37:00+08:00" pubdate data-updated="true">Feb 9<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/02/09/code-snippet-for-media-on-android/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A few days ago,I have wrote down this post <a href="http://androidyue.github.io/blog/2014/01/19/scan-media-files-in-android/">http://androidyue.github.io/blog/2014/01/19/scan-media-files-in-android/</a>. Now I will paste my code snippet.</p>

<h3>MediaUtils.java</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">mx</span><span class="o">.</span><span class="na">browser</span><span class="o">.</span><span class="na">utils</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.Locale</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.mx.utils.FileUtils</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.mx.utils.Log</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.content.ContentResolver</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.content.Context</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.content.Intent</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.media.MediaScannerConnection</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.media.MediaScannerConnection.OnScanCompletedListener</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.net.Uri</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.provider.MediaStore.Audio</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.provider.MediaStore.Images</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.provider.MediaStore.Video</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.text.TextUtils</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Utility Methods for Media Library Operations</span>
</span><span class='line'><span class="cm"> * @author androidyue</span>
</span><span class='line'><span class="cm"> * Referrer  http://androidyue.github.io/blog/2014/01/19/scan-media-files-in-android/</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MediaUtils</span> <span class="o">{</span>
</span><span class='line'>  
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">LOGTAG</span> <span class="o">=</span> <span class="s">&quot;MediaUtils&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">  * Scan a media file by sending a broadcast.This is the easiest way.</span>
</span><span class='line'><span class="cm">  * 对方成功接收广播并处理条件  文件必须存在，文件路径必须以Environment.getExternalStorageDirectory().getPath() 的返回值开头</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">sendScanFileBroadcast</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">String</span> <span class="n">filePath</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">filePath</span><span class="o">);</span>
</span><span class='line'>          <span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_MEDIA_SCANNER_SCAN_FILE</span><span class="o">,</span> <span class="n">Uri</span><span class="o">.</span><span class="na">fromFile</span><span class="o">(</span><span class="n">file</span><span class="o">));</span>
</span><span class='line'>          <span class="n">context</span><span class="o">.</span><span class="na">sendBroadcast</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">  * </span>
</span><span class='line'><span class="cm">  * @param context</span>
</span><span class='line'><span class="cm">  * @param paths File paths to scan </span>
</span><span class='line'><span class="cm">  * @param mimeTypes mimeTypes in array;it could be null;then </span>
</span><span class='line'><span class="cm">  * @param callback</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">scanFiles</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">paths</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">mimeTypes</span><span class="o">,</span> <span class="n">OnScanCompletedListener</span> <span class="n">callback</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">paths</span> <span class="o">&amp;&amp;</span> <span class="n">paths</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">MediaScannerConnection</span><span class="o">.</span><span class="na">scanFile</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">paths</span><span class="o">,</span> <span class="n">mimeTypes</span><span class="o">,</span> <span class="n">callback</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">LOGTAG</span><span class="o">,</span> <span class="s">&quot;scanFiles paths = null or paths.length=0 paths=&quot;</span> <span class="o">+</span> <span class="n">paths</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">scanFiles</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">paths</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">mimeTypes</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">scanFiles</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">paths</span><span class="o">,</span> <span class="n">mimeTypes</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">scanFiles</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">paths</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">scanFiles</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">paths</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">removeImageFromLib</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">String</span> <span class="n">filePath</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">ContentResolver</span> <span class="n">resolver</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getContentResolver</span><span class="o">();</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">resolver</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">Images</span><span class="o">.</span><span class="na">Media</span><span class="o">.</span><span class="na">EXTERNAL_CONTENT_URI</span><span class="o">,</span> <span class="n">Images</span><span class="o">.</span><span class="na">Media</span><span class="o">.</span><span class="na">DATA</span> <span class="o">+</span> <span class="s">&quot;=?&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="n">filePath</span><span class="o">});</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">removeAudioFromLib</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">String</span> <span class="n">filePath</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="na">getContentResolver</span><span class="o">().</span><span class="na">delete</span><span class="o">(</span><span class="n">Audio</span><span class="o">.</span><span class="na">Media</span><span class="o">.</span><span class="na">EXTERNAL_CONTENT_URI</span><span class="o">,</span>
</span><span class='line'>              <span class="n">Audio</span><span class="o">.</span><span class="na">Media</span><span class="o">.</span><span class="na">DATA</span> <span class="o">+</span> <span class="s">&quot;=?&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span><span class="n">filePath</span><span class="o">});</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">removeVideoFromLib</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">String</span> <span class="n">filePath</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="na">getContentResolver</span><span class="o">().</span><span class="na">delete</span><span class="o">(</span><span class="n">Video</span><span class="o">.</span><span class="na">Media</span><span class="o">.</span><span class="na">EXTERNAL_CONTENT_URI</span><span class="o">,</span>
</span><span class='line'>              <span class="n">Video</span><span class="o">.</span><span class="na">Media</span><span class="o">.</span><span class="na">DATA</span> <span class="o">+</span> <span class="s">&quot;=?&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span><span class="n">filePath</span><span class="o">});</span>
</span><span class='line'>      
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">removeMediaFromLib</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">String</span> <span class="n">filePath</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">String</span> <span class="n">mimeType</span> <span class="o">=</span> <span class="n">FileUtils</span><span class="o">.</span><span class="na">getFileMimeType</span><span class="o">(</span><span class="n">filePath</span><span class="o">);</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">affectedRows</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">mimeType</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">mimeType</span> <span class="o">=</span> <span class="n">mimeType</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">(</span><span class="n">Locale</span><span class="o">.</span><span class="na">US</span><span class="o">);</span>
</span><span class='line'>          <span class="k">if</span> <span class="o">(</span><span class="n">isImage</span><span class="o">(</span><span class="n">mimeType</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">affectedRows</span> <span class="o">=</span> <span class="n">removeImageFromLib</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">filePath</span><span class="o">);</span>
</span><span class='line'>          <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">isAudio</span><span class="o">(</span><span class="n">mimeType</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">affectedRows</span> <span class="o">=</span> <span class="n">removeAudioFromLib</span><span class="o">(</span><span class="n">context</span> <span class="o">,</span><span class="n">filePath</span><span class="o">);</span>
</span><span class='line'>          <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">isVideo</span><span class="o">(</span><span class="n">mimeType</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">affectedRows</span> <span class="o">=</span> <span class="n">removeVideoFromLib</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">filePath</span><span class="o">);</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">affectedRows</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isAudio</span><span class="o">(</span><span class="n">String</span> <span class="n">mimeType</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">mimeType</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;audio&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isImage</span><span class="o">(</span><span class="n">String</span> <span class="n">mimeType</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">mimeType</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;image&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isVideo</span><span class="o">(</span><span class="n">String</span> <span class="n">mimeType</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">mimeType</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;video&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isMediaFile</span><span class="o">(</span><span class="n">String</span> <span class="n">filePath</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">String</span> <span class="n">mimeType</span> <span class="o">=</span> <span class="n">FileUtils</span><span class="o">.</span><span class="na">getFileMimeType</span><span class="o">(</span><span class="n">filePath</span><span class="o">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="nf">isMediaType</span><span class="o">(</span><span class="n">mimeType</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isMediaType</span><span class="o">(</span><span class="n">String</span> <span class="n">mimeType</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="kt">boolean</span> <span class="n">isMedia</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(!</span><span class="n">TextUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">mimeType</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">mimeType</span> <span class="o">=</span> <span class="n">mimeType</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">(</span><span class="n">Locale</span><span class="o">.</span><span class="na">US</span><span class="o">);</span>
</span><span class='line'>          <span class="n">isMedia</span> <span class="o">=</span> <span class="n">isImage</span><span class="o">(</span><span class="n">mimeType</span><span class="o">)</span> <span class="o">||</span> <span class="n">isAudio</span><span class="o">(</span><span class="n">mimeType</span><span class="o">)</span> <span class="o">||</span> <span class="n">isVideo</span><span class="o">(</span><span class="n">mimeType</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">isMedia</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">  * Before using it,please do have a media type check.</span>
</span><span class='line'><span class="cm">  * @param context</span>
</span><span class='line'><span class="cm">  * @param srcPath</span>
</span><span class='line'><span class="cm">  * @param destPath</span>
</span><span class='line'><span class="cm">  * @return</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">renameMediaFile</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">String</span> <span class="n">srcPath</span><span class="o">,</span> <span class="n">String</span> <span class="n">destPath</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">removeMediaFromLib</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">srcPath</span><span class="o">);</span>
</span><span class='line'>      <span class="n">sendScanFileBroadcast</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">destPath</span><span class="o">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>FileUtils.java</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getFileMimeType</span><span class="o">(</span><span class="n">String</span> <span class="n">filename</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">TextUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">filename</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">lastDotIndex</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="sc">&#39;.&#39;</span><span class="o">);</span>
</span><span class='line'>  <span class="n">String</span> <span class="n">mimetype</span> <span class="o">=</span> <span class="n">MimeTypeMap</span><span class="o">.</span><span class="na">getSingleton</span><span class="o">().</span><span class="na">getMimeTypeFromExtension</span><span class="o">(</span>
</span><span class='line'>          <span class="n">filename</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">lastDotIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="o">).</span><span class="na">toLowerCase</span><span class="o">());</span>
</span><span class='line'>  <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">LOGTAG</span><span class="o">,</span> <span class="s">&quot;getFileMimeType mimeType = &quot;</span> <span class="o">+</span> <span class="n">mimetype</span><span class="o">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">mimetype</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/01/19/scan-media-files-in-android/">Scan Media Files in Android</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-19T19:39:00+08:00" pubdate data-updated="true">Jan 19<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/01/19/scan-media-files-in-android/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I once tried to use MediaScanner to resolve problems; however it turned out to be a failure. Now I make it.This post is to write down why I failed and how I work it out now. I think it could be deeper that other posts.</p>

<h2>Android Media Scanning Mechanism</h2>

<p>Android provides a great application for developers to add created media files to add them into the library. The application is called MediaProvider. Now let&rsquo;s have a glance of MediaProvider. <br/>
The receiver part of its  manifest</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>    <span class="nt">&lt;receiver</span> <span class="na">android:name=</span><span class="s">&quot;MediaScannerReceiver&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;intent-filter&gt;</span>
</span><span class='line'>            <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&quot;android.intent.action.BOOT_COMPLETED&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/intent-filter&gt;</span>
</span><span class='line'>        <span class="nt">&lt;intent-filter&gt;</span>
</span><span class='line'>            <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&quot;android.intent.action.MEDIA_MOUNTED&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;data</span> <span class="na">android:scheme=</span><span class="s">&quot;file&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/intent-filter&gt;</span>
</span><span class='line'>        <span class="nt">&lt;intent-filter&gt;</span>
</span><span class='line'>            <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&quot;android.intent.action.MEDIA_UNMOUNTED&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;data</span> <span class="na">android:scheme=</span><span class="s">&quot;file&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/intent-filter&gt;</span>
</span><span class='line'>        <span class="nt">&lt;intent-filter&gt;</span>
</span><span class='line'>            <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&quot;android.intent.action.MEDIA_SCANNER_SCAN_FILE&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;data</span> <span class="na">android:scheme=</span><span class="s">&quot;file&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/intent-filter&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/receiver&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The MediaScannerReceiver will receive the above intents with right action and data scheme.</p>

<h3>How the MediaScannerRecieve handles the intent</h3>

<ul>
<li>It will scan internal storage only after receiving the <strong>action android.intent.action.BOOT_COMPLETED</strong></li>
<li>All intent but the <strong>android.intent.action.BOOT_COMPLETED</strong> intent should carry the file scheme data</li>
<li>It will scan external storage when receiving the <strong>Intent.ACTION_MEDIA_MOUNTED</strong> intent.</li>
<li>It will scan the single file when receiving the <strong>Intent.ACTION_MEDIA_SCANNER_SCAN_FILE</strong> intent.

<h3>How the MediaScannerService works</h3>

<p>Actually receiver does not do scanning. It will start a service called MediaScannerService.
The service part of its manifest</p></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>   <span class="nt">&lt;service</span> <span class="na">android:name=</span><span class="s">&quot;MediaScannerService&quot;</span> <span class="na">android:exported=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;intent-filter&gt;</span>
</span><span class='line'>            <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&quot;android.media.IMediaScannerService&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/intent-filter&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/service&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>scanFile Method</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">Uri</span> <span class="nf">scanFile</span><span class="o">(</span><span class="n">String</span> <span class="n">path</span><span class="o">,</span> <span class="n">String</span> <span class="n">mimeType</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">volumeName</span> <span class="o">=</span> <span class="n">MediaProvider</span><span class="o">.</span><span class="na">EXTERNAL_VOLUME</span><span class="o">;</span>
</span><span class='line'>    <span class="n">openDatabase</span><span class="o">(</span><span class="n">volumeName</span><span class="o">);</span>
</span><span class='line'>    <span class="n">MediaScanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="n">createMediaScanner</span><span class="o">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">scanner</span><span class="o">.</span><span class="na">scanSingleFile</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">volumeName</span><span class="o">,</span> <span class="n">mimeType</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>scan Method</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">scan</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">directories</span><span class="o">,</span> <span class="n">String</span> <span class="n">volumeName</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// don&#39;t sleep while scanning</span>
</span><span class='line'>    <span class="n">mWakeLock</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">ContentValues</span> <span class="n">values</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ContentValues</span><span class="o">();</span>
</span><span class='line'>    <span class="n">values</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">MediaStore</span><span class="o">.</span><span class="na">MEDIA_SCANNER_VOLUME</span><span class="o">,</span> <span class="n">volumeName</span><span class="o">);</span>
</span><span class='line'>    <span class="n">Uri</span> <span class="n">scanUri</span> <span class="o">=</span> <span class="n">getContentResolver</span><span class="o">().</span><span class="na">insert</span><span class="o">(</span><span class="n">MediaStore</span><span class="o">.</span><span class="na">getMediaScannerUri</span><span class="o">(),</span> <span class="n">values</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Uri</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">&quot;file://&quot;</span> <span class="o">+</span> <span class="n">directories</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
</span><span class='line'>    <span class="n">sendBroadcast</span><span class="o">(</span><span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_MEDIA_SCANNER_STARTED</span><span class="o">,</span> <span class="n">uri</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">volumeName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">MediaProvider</span><span class="o">.</span><span class="na">EXTERNAL_VOLUME</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">openDatabase</span><span class="o">(</span><span class="n">volumeName</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">MediaScanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="n">createMediaScanner</span><span class="o">();</span>
</span><span class='line'>        <span class="n">scanner</span><span class="o">.</span><span class="na">scanDirectories</span><span class="o">(</span><span class="n">directories</span><span class="o">,</span> <span class="n">volumeName</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;exception in MediaScanner.scan()&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">getContentResolver</span><span class="o">().</span><span class="na">delete</span><span class="o">(</span><span class="n">scanUri</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sendBroadcast</span><span class="o">(</span><span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_MEDIA_SCANNER_FINISHED</span><span class="o">,</span> <span class="n">uri</span><span class="o">));</span>
</span><span class='line'>    <span class="n">mWakeLock</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Actually the scan code is not really in the MediaScannerService</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">MediaScanner</span> <span class="nf">createMediaScanner</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">MediaScanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MediaScanner</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span><span class='line'>        <span class="n">Locale</span> <span class="n">locale</span> <span class="o">=</span> <span class="n">getResources</span><span class="o">().</span><span class="na">getConfiguration</span><span class="o">().</span><span class="na">locale</span><span class="o">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">locale</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">String</span> <span class="n">language</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="na">getLanguage</span><span class="o">();</span>
</span><span class='line'>            <span class="n">String</span> <span class="n">country</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="na">getCountry</span><span class="o">();</span>
</span><span class='line'>            <span class="n">String</span> <span class="n">localeString</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">language</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">country</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">scanner</span><span class="o">.</span><span class="na">setLocale</span><span class="o">(</span><span class="n">language</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">country</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">scanner</span><span class="o">.</span><span class="na">setLocale</span><span class="o">(</span><span class="n">language</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">scanner</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s using the android.media.MediaScanner
<a href="https://android.googlesource.com/platform/frameworks/base/+/cd92588/media/java/android/media/MediaScanner.java">https://android.googlesource.com/platform/frameworks/base/+/cd92588/media/java/android/media/MediaScanner.java</a></p>

<h2>How To Scan A Created File</h2>

<p>Now I am going to introduce two ways to add a created file into the media library.</p>

<h3>The Simplest Method</h3>

<p>Just send a broadcast, as we have posted above. Just send a broadcast intent to MediaScannerReceiver.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">String</span> <span class="n">saveAs</span> <span class="o">=</span> <span class="s">&quot;Your_Created_File_Path&quot;</span>
</span><span class='line'><span class="n">Uri</span> <span class="n">contentUri</span> <span class="o">=</span> <span class="n">Uri</span><span class="o">.</span><span class="na">fromFile</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">saveAs</span><span class="o">));</span>
</span><span class='line'><span class="n">Intent</span> <span class="n">mediaScanIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_MEDIA_SCANNER_SCAN_FILE</span><span class="o">,</span><span class="n">contentUri</span><span class="o">);</span>
</span><span class='line'><span class="n">getContext</span><span class="o">().</span><span class="na">sendBroadcast</span><span class="o">(</span><span class="n">mediaScanIntent</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The above method maybe has been seen thousands of times. Actually it should work. However I failed and failed in sending broadcast intent. In the following section. I will point out why the sending broadcast not works. Even though you get well on with sending broadcast,it&rsquo;s strongly recommended to read the Section Why Sending MEDIA_SCANNER_SCAN_FILE broadcast not works.</p>

<h3>Use MediaScannerConnection</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">mediaScan</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">MediaScannerConnection</span><span class="o">.</span><span class="na">scanFile</span><span class="o">(</span><span class="n">getActivity</span><span class="o">(),</span>
</span><span class='line'>            <span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span> <span class="n">file</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">()</span> <span class="o">},</span> <span class="kc">null</span><span class="o">,</span>
</span><span class='line'>            <span class="k">new</span> <span class="nf">OnScanCompletedListener</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>                <span class="nd">@Override</span>
</span><span class='line'>                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onScanCompleted</span><span class="o">(</span><span class="n">String</span> <span class="n">path</span><span class="o">,</span> <span class="n">Uri</span> <span class="n">uri</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">&quot;MediaScanWork&quot;</span><span class="o">,</span> <span class="s">&quot;file &quot;</span> <span class="o">+</span> <span class="n">path</span>
</span><span class='line'>                            <span class="o">+</span> <span class="s">&quot; was scanned seccessfully: &quot;</span> <span class="o">+</span> <span class="n">uri</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">});</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>the scanFile method is introduced since API 8</p>

<h3>Create an instance and call scanFile (String path, String mimeType)</h3>

<p>It&rsquo;s really easy, just read the post <a href="http://developer.android.com/reference/android/media/MediaScannerConnection.html">http://developer.android.com/reference/android/media/MediaScannerConnection.html</a></p>

<h3>How To Scan Mutiple Files</h3>

<ul>
<li>Sending Mutiple Intent.ACTION_MEDIA_SCANNER_SCAN_FILE broadcast intents.</li>
<li>Use the second method by filled the second params with an array of paths.</li>
</ul>


<h2>Why Sending MEDIA_SCANNER_SCAN_FILE broadcast not works</h2>

<p>Actually someone may think sending ACTION_MEDIA_SCANNER_SCAN_FILE works on some devices but not on other devices. Actually it&rsquo;s. Is it a API limit?<br/>
No, It&rsquo;s has someting to do with your file path.
Take a look at this</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onReceive</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">action</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getAction</span><span class="o">();</span>
</span><span class='line'>    <span class="n">Uri</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getData</span><span class="o">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">action</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_BOOT_COMPLETED</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// scan internal storage</span>
</span><span class='line'>        <span class="n">scan</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">MediaProvider</span><span class="o">.</span><span class="na">INTERNAL_VOLUME</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="na">getScheme</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;file&quot;</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>            <span class="c1">// handle intents related to external storage</span>
</span><span class='line'>            <span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="na">getPath</span><span class="o">();</span>
</span><span class='line'>            <span class="n">String</span> <span class="n">externalStoragePath</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="na">getExternalStorageDirectory</span><span class="o">().</span><span class="na">getPath</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;action: &quot;</span> <span class="o">+</span> <span class="n">action</span> <span class="o">+</span> <span class="s">&quot; path: &quot;</span> <span class="o">+</span> <span class="n">path</span><span class="o">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">action</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_MEDIA_MOUNTED</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// scan whenever any volume is mounted</span>
</span><span class='line'>                <span class="n">scan</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">MediaProvider</span><span class="o">.</span><span class="na">EXTERNAL_VOLUME</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">action</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_MEDIA_SCANNER_SCAN_FILE</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                    <span class="n">path</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">path</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="n">externalStoragePath</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">scanFile</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">path</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Every part is right except the intent data. I mean the file path. You may hardcode the filepath. This is my example</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">final</span> <span class="n">String</span> <span class="n">saveAs</span> <span class="o">=</span> <span class="s">&quot;/sdcard/&quot;</span> <span class="o">+</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;_add.png&quot;</span><span class="o">;</span>
</span><span class='line'><span class="n">Uri</span> <span class="n">contentUri</span> <span class="o">=</span> <span class="n">Uri</span><span class="o">.</span><span class="na">fromFile</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">saveAs</span><span class="o">));</span>
</span><span class='line'><span class="n">Intent</span> <span class="n">mediaScanIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_MEDIA_SCANNER_SCAN_FILE</span><span class="o">,</span><span class="n">contentUri</span><span class="o">);</span>
</span><span class='line'><span class="n">getContext</span><span class="o">().</span><span class="na">sendBroadcast</span><span class="o">(</span><span class="n">mediaScanIntent</span><span class="o">);</span>
</span><span class='line'><span class="n">Uri</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">mediaScanIntent</span><span class="o">.</span><span class="na">getData</span><span class="o">();</span>
</span><span class='line'><span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="na">getPath</span><span class="o">();</span>
</span><span class='line'><span class="n">String</span> <span class="n">externalStoragePath</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="na">getExternalStorageDirectory</span><span class="o">().</span><span class="na">getPath</span><span class="o">();</span>
</span><span class='line'><span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">&quot;LOGTAG&quot;</span><span class="o">,</span> <span class="s">&quot;Androidyue onReceive intent= &quot;</span> <span class="o">+</span> <span class="n">mediaScanIntent</span>
</span><span class='line'>                        <span class="o">+</span> <span class="s">&quot;;path=&quot;</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s">&quot;;externalStoragePath=&quot;</span> <span class="o">+</span>
</span><span class='line'>                        <span class="n">externalStoragePath</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>And this is the output log</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>LOGTAG Androidyue onReceive <span class="nv">intent</span><span class="o">=</span> Intent <span class="o">{</span> <span class="nv">act</span><span class="o">=</span>android.intent.action.MEDIA_SCANNER_SCAN_FILE <span class="nv">dat</span><span class="o">=</span>file:///sdcard/1390136305831_add.png <span class="o">}</span>;<span class="nv">path</span><span class="o">=</span>/sdcard/1390136305831_add.png;externalStoragePath<span class="o">=</span>/mnt/sdcard
</span></code></pre></td></tr></table></div></figure>


<p>So in the sending broadcast, your action is right, your data schema  OK, your data path not null;but your path  /sdcard/1390136305831_add.png does not <strong>startswith</strong> the externalStoragePath /mnt/sdcard/
And so the scan file is actually <strong>not called</strong>.
In conclusion your hardcoding path results in the failure.</p>

<h2>Remove From Media Library</h2>

<p>If we deleted a file ,it means that we need to remove the file from the media library.</p>

<h3>Simply sending a broadcast?</h3>

<p>Can we simple sending a broadcast to the MediaScannerReceiver? I also wish it could. But actually it does not work.
Look at this code for the explanation.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="c1">// this function is used to scan a single file</span>
</span><span class='line'><span class="kd">public</span> <span class="n">Uri</span> <span class="nf">scanSingleFile</span><span class="o">(</span><span class="n">String</span> <span class="n">path</span><span class="o">,</span> <span class="n">String</span> <span class="n">volumeName</span><span class="o">,</span> <span class="n">String</span> <span class="n">mimeType</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">initialize</span><span class="o">(</span><span class="n">volumeName</span><span class="o">);</span>
</span><span class='line'>        <span class="n">prescan</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">file</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// lastModified is in milliseconds on Files.</span>
</span><span class='line'>        <span class="kt">long</span> <span class="n">lastModifiedSeconds</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">lastModified</span><span class="o">()</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// always scan the file, so we can return the content://media Uri for existing files</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">mClient</span><span class="o">.</span><span class="na">doScanFile</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">mimeType</span><span class="o">,</span> <span class="n">lastModifiedSeconds</span><span class="o">,</span> <span class="n">file</span><span class="o">.</span><span class="na">length</span><span class="o">(),</span>
</span><span class='line'>                <span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">MediaScanner</span><span class="o">.</span><span class="na">isNoMediaPath</span><span class="o">(</span><span class="n">path</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;RemoteException in MediaScanner.scanFile()&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As the above code points out, It does have a check before the real scanning.
Then how should I do?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">testDeleteFile</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">existingFilePath</span> <span class="o">=</span> <span class="s">&quot;/mnt/sdcard/1390116362913_add.png&quot;</span><span class="o">;</span>
</span><span class='line'>    <span class="n">File</span>  <span class="n">existingFile</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">existingFilePath</span><span class="o">);</span>
</span><span class='line'>    <span class="n">existingFile</span><span class="o">.</span><span class="na">delete</span><span class="o">();</span>
</span><span class='line'>    <span class="n">ContentResolver</span> <span class="n">resolver</span> <span class="o">=</span> <span class="n">getActivity</span><span class="o">().</span><span class="na">getContentResolver</span><span class="o">();</span>
</span><span class='line'>    <span class="n">resolver</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">Images</span><span class="o">.</span><span class="na">Media</span><span class="o">.</span><span class="na">EXTERNAL_CONTENT_URI</span><span class="o">,</span> <span class="n">Images</span><span class="o">.</span><span class="na">Media</span><span class="o">.</span><span class="na">DATA</span> <span class="o">+</span> <span class="s">&quot;=?&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="n">existingFilePath</span><span class="o">});</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The above code works. Just remove from Media Provider</p>

<h2>Special</h2>

<ul>
<li>You could check the external.db or internal.db file under /data/data/com.android.providers.media/ for more detailed information.</li>
</ul>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <a href="http://stackoverflow.com/users/749727/androidyue">
<img src="http://stackoverflow.com/users/flair/749727.png" width="270" height="58" alt="profile for androidyue at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for androidyue at Stack Overflow, Q&amp;A for professional and enthusiast programmers">
</a>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/05/11/how-to-summarize-folder-size-in-terminal/">How to Summarize Folder Size in Terminal</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/26/android-ninepatch-attention/">Android NinePatch Attention</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/26/install-lsusb-in-mac-osx/">Install Lsusb in Mac OSX</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/18/revert-a-certain-file-back-to-a-certain-commit/">Revert a Certain File Back to a Certain Commit</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/18/auth-password-cannot-be-read-from-a-file/">Auth Password Cannot Be Read From a File</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/androidyue">@androidyue</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'androidyue',
            count: 11,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/105362551238192049560?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>


<script type="text/javascript">var switchTo5x=true;</script>
<script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
<script type="text/javascript" src="http://s.sharethis.com/loader.js"></script>

<script type="text/javascript">stLight.options({publisher: "c4f362f5-c619-4481-a7ab-bc73e42dc601", doNotHash: false, doNotCopy: false, hashAddressBar: true});</script>
<script>
    var options={ "publisher": "c4f362f5-c619-4481-a7ab-bc73e42dc601", "position": "right", "ad": { "visible": false, "openDelay": 5, "closeDelay": 0 }, "chicklets": { "items": ["googleplus", "sina", "facebook", "twitter", "linkedin", "pinterest", "tumblr", "email", "sharethis"] } };
    var st_hover_widget = new sharethis.widgets.hoverbuttons(options);
</script>
<section>
<h1>Blogrolls</h1>
<ul>
    <li><a href="http://www.pcyoyo.com/" target="__blank">Pcyoyo</a></li>
</ul>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - androidyue -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'androidyue';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
