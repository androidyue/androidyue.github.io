<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[技术小黑屋]]></title>
  <link href="http://droidyue.com/atom.xml" rel="self"/>
  <link href="http://droidyue.com/"/>
  <updated>2014-10-21T08:28:32+08:00</updated>
  <id>http://droidyue.com/</id>
  <author>
    <name><![CDATA[androidyue]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[人生苦短，让你的Git飞起来吧]]></title>
    <link href="http://droidyue.com/blog/2014/10/15/speed-up-your-git/"/>
    <updated>2014-10-15T21:37:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/10/15/speed-up-your-git</id>
    <content type="html"><![CDATA[<p>git是一款超极优秀的版本控制工具，包括Linus大神的linux项目在内的千千万万的项目在使用。你可以使用Eclipse插件管理，亦可以使用终端工具。</p>

<p>git虽然有着svn不能匹及的本地仓库，但是和svn一样，和远程服务器通信也相当常用。常用的pull和push就是比较常见的命令。</p>

<p>然后，你是不是觉得从远程拉取（pull）到本地是不是很慢，从本地推到服务器端（push）又是不是很耗时呢，是吧，正所谓人生苦短，赶紧加速你的git吧。</p>

<!--more-->


<h2>修改ssh配置</h2>

<p>按照下面的内容修改这个文件<code>vim ~/.ssh/config</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">ControlMaster</span> <span class="n">auto</span>
</span><span class='line'><span class="c1">##ControlPath /tmp/%r@%h:%p</span>
</span><span class='line'><span class="no">ControlPath</span> <span class="sr">/tmp/</span><span class="n">git</span><span class="vi">@github</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="mi">22</span>
</span><span class='line'><span class="no">ControlPersist</span> <span class="n">yes</span>
</span></code></pre></td></tr></table></div></figure>


<h2>一些注解</h2>

<ul>
<li><strong>ControlMaster auto</strong>可以使多个ssh会话共享一个已经存在的连接，如果没有，则自动创建一个连接。</li>
<li><strong>ControlPath /tmp/%r@%h:%p</strong>可以指定想要共享的连接。%r代表远程登录用户名，一般都为git，%h表示目标主机，%p表示端口。</li>
<li><strong>ControlPersist yes</strong> 则可以让共享的连接持有处于连接状态。</li>
</ul>


<h2>常用的ControlPath</h2>

<p>下面包含开源中国，github，gitcafe等代码托管。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">ControlPath</span> <span class="sr">/tmp/</span><span class="n">git</span><span class="vi">@git</span><span class="o">.</span><span class="n">oschina</span><span class="o">.</span><span class="n">net</span><span class="p">:</span><span class="mi">22</span>
</span><span class='line'><span class="no">ControlPath</span> <span class="sr">/tmp/</span><span class="n">git</span><span class="vi">@github</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="mi">22</span>
</span><span class='line'><span class="no">ControlPath</span> <span class="sr">/tmp/</span><span class="n">git</span><span class="vi">@gitcafe</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="mi">22</span>
</span></code></pre></td></tr></table></div></figure>


<p>快来试一试吧，是不是提高了5倍！</p>

<p>注：由于网络的情况，结果可能略有不同。已经很快的但没有感觉改善的同学，可以继续读下去。</p>

<h2>还能更快</h2>

<p>还有一个能提高50倍的方法，不过对于一般开发者不是很常用，如需了解可以参考<a href="http://interrobeng.com/2013/08/25/speed-up-git-5x-to-50x/">Speed Up Git (5x to 50x)</a></p>

<h3>其他</h3>

<ul>
<li> <a href="http://www.amazon.cn/gp/product/1430218339/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=1430218339&linkCode=as2&tag=droidyue-23">成为Git大神很简单，读完这本书</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=1430218339" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[译文：理解Java中的弱引用]]></title>
    <link href="http://droidyue.com/blog/2014/10/12/understanding-weakreference-in-java/"/>
    <updated>2014-10-12T09:56:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/10/12/understanding-weakreference-in-java</id>
    <content type="html"><![CDATA[<p>不久之前，我面试了一些求职Java高级开发工程师的应聘者。我常常会面试他们说，“你能给我介绍一些Java中得弱引用吗？”，如果面试者这样说，“嗯，是不是垃圾回收有关的？”，我就会基本满意了，我并不期待回答是一篇诘究本末的论文描述。</p>

<p>然而事与愿违，我很吃惊的发现，在将近20多个有着平均5年开发经验和高学历背景的应聘者中，居然只有两个人知道弱引用的存在，但是在这两个人之中只有一个人真正了解这方面的知识。在面试过程中，我还尝试提示一些东西，来看看有没有人突然说一声“原来是这个啊”，结果很是让我失望。我开始困惑，为什么这块的知识如此不被重视，毕竟弱引用是一个很有用途的特性，况且这个特性已经在7年前 Java 1.2发布时便引入了。</p>

<!--more-->


<p>好吧，这里我不期待你看完本文之后成为一个弱引用方面的专家，但是我认为至少你应该了解什么是弱引用，如何使用它们，并且什么场景使用。既然它们是一些不知名的概念，我简单就着前面的三个问题来说明一下。</p>

<h2>强引用(Strong Reference)</h2>

<p>强引用就是我们经常使用的引用，其写法如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">StringBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuffer</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面创建了一个StringBuffer对象，并将这个对象的（强）引用存到变量buffer中。是的，就是这个小儿科的操作（请原谅我这样的说法）。强引用最重要的就是它能够让引用变得强（Strong），这就决定了它和垃圾回收器的交互。具体来说，如果一个对象通过一串强引用链接可到达(Strongly reachable)，它是不会被回收的。如果你不想让你正在使用的对象被回收，这就正是你所需要的。</p>

<h3>但是强引用如此之强</h3>

<p>在一个程序里，将一个类设置成不可被扩展是有点不太常见的，当然这个完全可以通过类标记成final实现。或者也可以更加复杂一些，就是通过内部包含了未知数量具体实现的工厂方法返回一个接口(Interface)。举个例子，我们想要使用一个叫做Widget的类，但是这个类不能被继承，所以无法增加新的功能。</p>

<p>但是我们如果想追踪Widget对象的额外信息，我们该怎么办？ 假设我们需要记录每个对象的序列号，但是由于Widget类并不包含这个属性，而且也不能扩展导致我们也不能增加这个属性。其实一点问题也没有，HashMap完全可以解决上述的问题。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">serialNumberMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">widget</span><span class="o">,</span> <span class="n">widgetSerialNumber</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>这表面看上去没有问题，但是widget对象的强引用很有可能会引发问题。我们可以确信当一个widget序列号不需要时，我们应该将这个条目从map中移除。如果我们没有移除的话，可能会导致内存泄露，亦或者我们手动移除时删除了我们正在使用的widgets，会导致有效数据的丢失。其实这些问题很类似，这就是没有垃圾回收机制的语言管理内存时常遇到的问题。但是我们不用去担心这个问题，因为我们使用的时具有垃圾回收机制的Java语言。</p>

<p>另一个强引用可能带来的问题就是缓存,尤其是像图片这样的大文件的缓存。假设你有一个程序需要处理用户提供的图片，通常的做法就是做图片数据缓存，因为从磁盘加载图片代价很大，并且同时我们也想避免在内存中同时存在两份一样的图片数据。</p>

<p>缓存被设计的目的就是避免我们去再次加载哪些不需要的文件。你会很快发现在缓存中会一直包含一个到已经指向内存中图片数据的引用。使用强引用会强制图片数据留在内存，这就需要你来决定什么时候图片数据不需要并且手动从缓存中移除，进而可以让垃圾回收器回收。因此你再一次被强制做垃圾回收器该做的工作，并且人为决定是该清理到哪一个对象。</p>

<h2>弱引用(Weak Reference)</h2>

<p>弱引用简单来说就是将对象留在内存的能力不是那么强的引用。使用WeakReference，垃圾回收器会帮你来决定引用的对象何时回收并且将对象从内存移除。创建弱引用如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">Widget</span><span class="o">&gt;</span> <span class="n">weakWidget</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">Widget</span><span class="o">&gt;(</span><span class="n">widget</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>使用weakWidget.get()就可以得到真实的Widget对象，因为弱引用不能阻挡垃圾回收器对其回收，你会发现（当没有任何强引用到widget对象时）使用get时突然返回null。</p>

<p>解决上述的widget序列数记录的问题，最简单的办法就是使用Java内置的WeakHashMap类。WeakHashMap和HashMap几乎一样，唯一的区别就是它的键（不是值!!!）使用WeakReference引用。当WeakHashMap的键标记为垃圾的时候，这个键对应的条目就会自动被移除。这就避免了上面不需要的Widget对象手动删除的问题。使用WeakHashMap可以很便捷地转为HashMap或者Map。</p>

<h3>引用队列(Reference Queue)</h3>

<p>一旦弱引用对象开始返回null，该弱引用指向的对象就被标记成了垃圾。而这个弱引用对象（非其指向的对象）就没有什么用了。通常这时候需要进行一些清理工作。比如WeakHashMap会在这时候移除没用的条目来避免保存无限制增长的没有意义的弱引用。</p>

<p>引用队列可以很容易地实现跟踪不需要的引用。当你在构造WeakReference时传入一个ReferenceQueue对象，当该引用指向的对象被标记为垃圾的时候，这个引用对象会自动地加入到引用队列里面。接下来，你就可以在固定的周期，处理传入的引用队列，比如做一些清理工作来处理这些没有用的引用对象。</p>

<h2>四种引用</h2>

<p>Java中实际上有四种强度不同的引用，从强到弱它们分别是，强引用，软引用，弱引用和虚引用。上面部分介绍了强引用和弱引用，下面介绍剩下的两个，软引用和虚引用。</p>

<h2>软引用（Soft Reference）</h2>

<p>软引用基本上和弱引用差不多，只是相比弱引用，它阻止垃圾回收期回收其指向的对象的能力强一些。如果一个对象是弱引用可到达，那么这个对象会被垃圾回收器接下来的回收周期销毁。但是如果是软引用可以到达，那么这个对象会停留在内存更时间上长一些。当内存不足时垃圾回收器才会回收这些软引用可到达的对象。</p>

<p>由于软引用可到达的对象比弱引用可达到的对象滞留内存时间会长一些，我们可以利用这个特性来做缓存。这样的话，你就可以节省了很多事情，垃圾回收器会关心当前哪种可到达类型以及内存的消耗程度来进行处理。</p>

<h2>虚引用 （Phantom Reference）</h2>

<p>与软引用，弱引用不同，虚引用指向的对象十分脆弱，我们不可以通过get方法来得到其指向的对象。它的唯一作用就是当其指向的对象被回收之后，自己被加入到引用队列，用作记录该引用指向的对象已被销毁。</p>

<p>当弱引用的指向对象变得弱引用可到达，该弱引用就会加入到引用队列。这一操作发生在对象析构或者垃圾回收真正发生之前。理论上，这个即将被回收的对象是可以在一个不符合规范的析构方法里面重新复活。但是这个弱引用会销毁。虚引用只有在其指向的对象从内存中移除掉之后才会加入到引用队列中。其get方法一直返回null就是为了阻止其指向的几乎被销毁的对象重新复活。</p>

<p>虚引用使用场景主要由两个。它允许你知道具体何时其引用的对象从内存中移除。而实际上这是Java中唯一的方式。这一点尤其表现在处理类似图片的大文件的情况。当你确定一个图片数据对象应该被回收，你可以利用虚引用来判断这个对象回收之后在继续加载下一张图片。这样可以尽可能地避免可怕的内存溢出错误。</p>

<p>第二点，虚引用可以避免很多析构时的问题。finalize方法可以通过创建强引用指向快被销毁的对象来让这些对象重新复活。然而，一个重写了finalize方法的对象如果想要被回收掉，需要经历两个单独的垃圾收集周期。在第一个周期中，某个对象被标记为可回收，进而才能进行析构。但是因为在析构过程中仍有微弱的可能这个对象会重新复活。这种情况下，在这个对象真实销毁之前，垃圾回收器需要再次运行。因为析构可能并不是很及时，所以在调用对象的析构之前，需要经历数量不确定的垃圾收集周期。这就意味着在真正清理掉这个对象的时候可能发生很大的延迟。这就是为什么当大部分堆被标记成垃圾时还是会出现烦人的内存溢出错误。</p>

<p>使用虚引用，上述情况将引刃而解，当一个虚引用加入到引用队列时，你绝对没有办法得到一个销毁了的对象。因为这时候，对象已经从内存中销毁了。因为虚引用不能被用作让其指向的对象重生，所以其对象会在垃圾回收的第一个周期就将被清理掉。</p>

<p>显而易见，finalize方法不建议被重写。因为虚引用明显地安全高效，去掉finalize方法可以虚拟机变得明显简单。当然你也可以去重写这个方法来实现更多。这完全看个人选择。</p>

<h2>总结</h2>

<p>我想看到这里，很多人开始发牢骚了，为什么你要讲一个过去十年的老古董API呢，好吧，以我的经验看，很多的Java程序员并不是很了解这个知识，我认为有一些深入的理解是很必要的，同时我希望大家能从本文中收获一些东西。</p>

<h2>原文信息</h2>

<ul>
<li>文章出自  <a href="https://weblogs.java.net/blog/enicholas/archive/2006/05/understanding_w.html">Understanding Weak References</a></li>
<li>作者为<a href="https://www.java.net/blogs/enicholas">Ethan Nicholas</a>，Yahoo! Publishing Tools team Leader，Yahoo! SiteBuilder Web程序的早期作者。</li>
</ul>


<h2>附注信息</h2>

<p>本文涉及到很多概念对于初次接触的人相对比较难以理解，建议结合英文原文进行研究。</p>

<h3>Java高阶推荐</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B00H1FXTNM/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00H1FXTNM&linkCode=as2&tag=droidyue-23">Java虚拟机规范(Java SE 7版)</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00H1FXTNM" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00IOB0K1Q/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00IOB0K1Q&linkCode=as2&tag=droidyue-23">图灵程序设计丛书:Java性能优化权威指南</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00IOB0K1Q" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00D2ID4PK/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00D2ID4PK&linkCode=as2&tag=droidyue-23">深入理解Java虚拟机:JVM高级特性与最佳实践(第2版)</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00D2ID4PK" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[腾讯云分析问题]]></title>
    <link href="http://droidyue.com/blog/2014/10/12/tencent-analytics-issues/"/>
    <updated>2014-10-12T09:47:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/10/12/tencent-analytics-issues</id>
    <content type="html"><![CDATA[<p>今天使用腾讯云分析按照给出的文档开始集成，遇到了一个问题。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>E/AndroidRuntime<span class="o">(</span> 4606<span class="o">)</span>: FATAL EXCEPTION: pool-1-thread-1
</span><span class='line'>E/AndroidRuntime<span class="o">(</span> 4606<span class="o">)</span>: java.lang.NoClassDefFoundError: com.tencent.mid.api.MidService
</span><span class='line'>E/AndroidRuntime<span class="o">(</span> 4606<span class="o">)</span>:    at com.tencent.stat.j.run<span class="o">(</span>Unknown Source<span class="o">)</span>
</span><span class='line'>E/AndroidRuntime<span class="o">(</span> 4606<span class="o">)</span>:    at java.util.concurrent.ThreadPoolExecutor.runWorker<span class="o">(</span>ThreadPoolExecutor.java:1076<span class="o">)</span>
</span><span class='line'>E/AndroidRuntime<span class="o">(</span> 4606<span class="o">)</span>:    at java.util.concurrent.ThreadPoolExecutor<span class="nv">$Worker</span>.run<span class="o">(</span>ThreadPoolExecutor.java:569<span class="o">)</span>
</span><span class='line'>E/AndroidRuntime<span class="o">(</span> 4606<span class="o">)</span>:    at java.lang.Thread.run<span class="o">(</span>Thread.java:864<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<!--more-->


<h2>原因</h2>

<p>其实原因就是腾讯云分析的文档严重过时了，解决方法就是<strong>在Build Path 除了加入mta-sdk-x.x.x.jar,还要加入mid-sdk-x.x.jar</strong>。</p>

<p>但是腾讯的文档只介绍说集成mta-sdk-x.x.x.jar，我想可能那是大概0.x版本SDK的教程吧。</p>

<h2>吐个槽吧</h2>

<h3>霸王条款</h3>

<p>据说想要知道应用宝的下载数据（下载次数）必须集成腾讯云分析。这是在扛KPI，还是一贯的本性呢？</p>

<h3>过时冗余的文档</h3>

<p>前面提到了文档的严重过时失效，而且其文档存在严重的冗余，据我所知有三处文档，SDK下载包中一份，帮助中心一份，应用管理页面一份。如此这样，一旦修改，成本还是比较大的。</p>

<h3>其他</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B00BSXRLR8/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00BSXRLR8&linkCode=as2&tag=droidyue-23">Android讲义哪家强</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00BSXRLR8" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00LVHTI9U/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00LVHTI9U&linkCode=as2&tag=droidyue-23">每个人的第一行代码</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00LVHTI9U" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B0052VL2WC/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B0052VL2WC&linkCode=as2&tag=droidyue-23">谁说菜鸟不会数据分析</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B0052VL2WC" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[众里寻他千百度，蓦然回首，招聘却在Console驻]]></title>
    <link href="http://droidyue.com/blog/2014/10/09/baidu-console-secret/"/>
    <updated>2014-10-09T21:40:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/10/09/baidu-console-secret</id>
    <content type="html"><![CDATA[<p>无意间发现了百度的一个彩蛋，感觉别出心裁，分享一下哈。</p>

<h2>操作</h2>

<ul>
<li> 使用Chrome（傲游等浏览器）打开<a href="http://www.baidu.com/">百度</a></li>
<li> 右键选择<strong>审查元素</strong></li>
<li> 切换到Console（控制台）标签</li>
</ul>


<h2>你就会发现</h2>

<!--more-->


<p>百度的招聘广告彩蛋出现了。快来试一试吧。
<img src="http://droidyueimg.qiniudn.com/baidu_console.png" title="baidu console secret 789 300" ></p>

<h3>其他</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B00COG458G/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00COG458G&linkCode=as2&tag=droidyue-23">设计师要懂心理学</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00COG458G" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B004I91HCY/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B004I91HCY&linkCode=as2&tag=droidyue-23">简约至上:交互式设计四策略</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B004I91HCY" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00ANS78KE/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00ANS78KE&linkCode=as2&tag=droidyue-23">在你身边,为你设计:腾讯的用户体验设计之道</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00ANS78KE" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[修改Linux系统时间的最简单方法]]></title>
    <link href="http://droidyue.com/blog/2014/10/03/modify-system-time-in-linux-or-mac/"/>
    <updated>2014-10-03T21:07:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/10/03/modify-system-time-in-linux-or-mac</id>
    <content type="html"><![CDATA[<p>在Linux桌面发行版提供了设置系统时间的界面程序，这个设置很简单，但是当你学会了下面的方法之后，你就开始厌烦用GUI界面设置了。</p>

<p>最简单的设置方法 就是创建一个符号链接/etc/localtime，其指向目标设置的时区城市代表（/usr/share/zoneinfo/ 目录下）</p>

<!--more-->


<p>比如我们想把机器的时区修改成亚洲的上海（东八区），我们按照下面操作就可以了。</p>

<p>其中s选项代表是符号链接，f选项代表强制删除目标。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo ln -sf /usr/share/zoneinfo/Asia/Shanghai  /etc/localtime
</span></code></pre></td></tr></table></div></figure>


<p>注意，Asia通常是没有Beijing的，可能没有上海国际化吧，所以如果是东八区就要用上海。</p>

<p>经测试，Mac机器上述命令也是生效的。</p>

<h3>其他</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B00BQTWC0U/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00BQTWC0U&linkCode=as2&tag=droidyue-23">Linux命令行大全</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00BQTWC0U" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00LF4UPWS/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00LF4UPWS&linkCode=as2&tag=droidyue-23">Linux就是这个范儿</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00LF4UPWS" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B003TJNO98/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B003TJNO98&linkCode=as2&tag=droidyue-23">鸟哥的Linux私房菜:基础学习篇</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B003TJNO98" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Android处理图像数据全记录]]></title>
    <link href="http://droidyue.com/blog/2014/10/03/handle-image-data-in-android/"/>
    <updated>2014-10-03T17:42:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/10/03/handle-image-data-in-android</id>
    <content type="html"><![CDATA[<p>Android中处理图像是一件很常见的事情，这里记录备忘一些亲身使用过的处理图片数据的方法。</p>

<h2>转为Bitmap</h2>

<!--more-->


<h3>RGB值转Bitmap</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">Bitmap</span> <span class="nf">createColorBitmap</span><span class="o">(</span><span class="n">String</span> <span class="n">rgb</span><span class="o">,</span> <span class="kt">int</span> <span class="n">width</span><span class="o">,</span> <span class="kt">int</span> <span class="n">height</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">Bitmap</span> <span class="n">bmp</span> <span class="o">=</span> <span class="n">Bitmap</span><span class="o">.</span><span class="na">createBitmap</span><span class="o">(</span><span class="n">width</span><span class="o">,</span> <span class="n">height</span><span class="o">,</span> <span class="n">Bitmap</span><span class="o">.</span><span class="na">Config</span><span class="o">.</span><span class="na">ARGB_8888</span><span class="o">);</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">color</span> <span class="o">=</span> <span class="n">Color</span><span class="o">.</span><span class="na">parseColor</span><span class="o">(</span><span class="n">rgb</span><span class="o">);</span>
</span><span class='line'>      <span class="n">bmp</span><span class="o">.</span><span class="na">eraseColor</span><span class="o">(</span><span class="n">color</span><span class="o">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">bmp</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//Usage</span>
</span><span class='line'><span class="n">Bitmap</span> <span class="n">bmp</span> <span class="o">=</span> <span class="n">createColorBitmap</span><span class="o">(</span><span class="s">&quot;#cce8cf&quot;</span><span class="o">,</span> <span class="mi">200</span><span class="o">,</span> <span class="mi">50</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Color值转Bitmap</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">Bitmap</span> <span class="nf">createColorBitmap</span><span class="o">(</span><span class="kt">int</span> <span class="n">color</span><span class="o">,</span> <span class="kt">int</span> <span class="n">width</span><span class="o">,</span> <span class="kt">int</span> <span class="n">height</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">Bitmap</span> <span class="n">bmp</span> <span class="o">=</span> <span class="n">Bitmap</span><span class="o">.</span><span class="na">createBitmap</span><span class="o">(</span><span class="n">width</span><span class="o">,</span> <span class="n">height</span><span class="o">,</span> <span class="n">Bitmap</span><span class="o">.</span><span class="na">Config</span><span class="o">.</span><span class="na">ARGB_8888</span><span class="o">);</span>
</span><span class='line'>  <span class="n">bmp</span><span class="o">.</span><span class="na">eraseColor</span><span class="o">(</span><span class="n">color</span><span class="o">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">bmp</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="c1">//Usage</span>
</span><span class='line'><span class="n">Bitmap</span> <span class="n">bmp</span> <span class="o">=</span> <span class="n">createColorBitmap</span><span class="o">(</span><span class="n">Color</span><span class="o">.</span><span class="na">BLUE</span><span class="o">,</span> <span class="mi">200</span><span class="o">,</span> <span class="mi">50</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>字节数组转Bitmap</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">Bitmap</span> <span class="nf">getBitmapFromByteArray</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">array</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">BitmapFactory</span><span class="o">.</span><span class="na">decodeByteArray</span><span class="o">(</span><span class="n">array</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">array</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>读取文件转Bitmap</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">Bitmap</span> <span class="nf">getBitmapFromFile</span><span class="o">(</span><span class="n">String</span> <span class="n">pathName</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">BitmapFactory</span><span class="o">.</span><span class="na">decodeFile</span><span class="o">(</span><span class="n">pathName</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>读取资源转Bitmap</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">Bitmap</span> <span class="nf">getBitmapFromResource</span><span class="o">(</span><span class="n">Resources</span> <span class="n">res</span><span class="o">,</span> <span class="kt">int</span> <span class="n">resId</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">BitmapFactory</span><span class="o">.</span><span class="na">decodeResource</span><span class="o">(</span><span class="n">res</span><span class="o">,</span> <span class="n">resId</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>输入流转Bitmap</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">Bitmap</span> <span class="nf">getBitmapFromStream</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">inputStream</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">BitmapFactory</span><span class="o">.</span><span class="na">decodeStream</span><span class="o">(</span><span class="n">inputStream</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Drawable转Bitmap</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Bitmap</span> <span class="n">icon</span> <span class="o">=</span> <span class="n">BitmapFactory</span><span class="o">.</span><span class="na">decodeResource</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getResources</span><span class="o">(),</span><span class="n">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">icon_resource</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>转为Drawable</h2>

<h3>资源转Drawable</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Drawable</span> <span class="n">drawable</span> <span class="o">=</span> <span class="n">getResources</span><span class="o">().</span><span class="na">getDrawable</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">ic_launcher</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Bitmap转Drawable</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Drawable</span> <span class="n">d</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BitmapDrawable</span><span class="o">(</span><span class="n">getResources</span><span class="o">(),</span><span class="n">bitmap</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>图片圆角展示</h2>

<p>通过对图片数据bitmap进行处理即可，其中pixels为边角的半径。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="n">Bitmap</span> <span class="nf">getRoundedCornerBitmap</span><span class="o">(</span><span class="n">Bitmap</span> <span class="n">bitmap</span><span class="o">,</span> <span class="kt">int</span> <span class="n">pixels</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Bitmap</span> <span class="n">output</span> <span class="o">=</span> <span class="n">Bitmap</span><span class="o">.</span><span class="na">createBitmap</span><span class="o">(</span><span class="n">bitmap</span><span class="o">.</span><span class="na">getWidth</span><span class="o">(),</span> <span class="n">bitmap</span>
</span><span class='line'>                <span class="o">.</span><span class="na">getHeight</span><span class="o">(),</span> <span class="n">Config</span><span class="o">.</span><span class="na">ARGB_8888</span><span class="o">);</span>
</span><span class='line'>        <span class="n">Canvas</span> <span class="n">canvas</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Canvas</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">color</span> <span class="o">=</span> <span class="mh">0xff424242</span><span class="o">;</span>
</span><span class='line'>        <span class="kd">final</span> <span class="n">Paint</span> <span class="n">paint</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Paint</span><span class="o">();</span>
</span><span class='line'>        <span class="kd">final</span> <span class="n">Rect</span> <span class="n">rect</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Rect</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">bitmap</span><span class="o">.</span><span class="na">getWidth</span><span class="o">(),</span> <span class="n">bitmap</span><span class="o">.</span><span class="na">getHeight</span><span class="o">());</span>
</span><span class='line'>        <span class="kd">final</span> <span class="n">RectF</span> <span class="n">rectF</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RectF</span><span class="o">(</span><span class="n">rect</span><span class="o">);</span>
</span><span class='line'>        <span class="kd">final</span> <span class="kt">float</span> <span class="n">roundPx</span> <span class="o">=</span> <span class="n">pixels</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">paint</span><span class="o">.</span><span class="na">setAntiAlias</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>        <span class="n">canvas</span><span class="o">.</span><span class="na">drawARGB</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</span><span class='line'>        <span class="n">paint</span><span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="n">color</span><span class="o">);</span>
</span><span class='line'>        <span class="n">canvas</span><span class="o">.</span><span class="na">drawRoundRect</span><span class="o">(</span><span class="n">rectF</span><span class="o">,</span> <span class="n">roundPx</span><span class="o">,</span> <span class="n">roundPx</span><span class="o">,</span> <span class="n">paint</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">paint</span><span class="o">.</span><span class="na">setXfermode</span><span class="o">(</span><span class="k">new</span> <span class="n">PorterDuffXfermode</span><span class="o">(</span><span class="n">Mode</span><span class="o">.</span><span class="na">SRC_IN</span><span class="o">));</span>
</span><span class='line'>        <span class="n">canvas</span><span class="o">.</span><span class="na">drawBitmap</span><span class="o">(</span><span class="n">bitmap</span><span class="o">,</span> <span class="n">rect</span><span class="o">,</span> <span class="n">rect</span><span class="o">,</span> <span class="n">paint</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">output</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>其他</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B00LVHTI9U/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00LVHTI9U&linkCode=as2&tag=droidyue-23">第一行代码:Android</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00LVHTI9U" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00J4DXWDG/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00J4DXWDG&linkCode=as2&tag=droidyue-23">Android编程权威指南</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00J4DXWDG" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00GU73RHA/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00GU73RHA&linkCode=as2&tag=droidyue-23">Android应用UI设计模式</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00GU73RHA" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[细话Java："失效"的private修饰符]]></title>
    <link href="http://droidyue.com/blog/2014/10/02/the-private-modifier-in-java/"/>
    <updated>2014-10-02T17:24:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/10/02/the-private-modifier-in-java</id>
    <content type="html"><![CDATA[<p>在Java编程中，使用private关键字修饰了某个成员，只有这个成员所在的类和这个类的方法可以使用，其他的类都无法访问到这个private成员。</p>

<p>上面描述了private修饰符的基本职能，今天来研究一下private功能失效的情况。</p>

<!--more-->


<h2>Java内部类</h2>

<p>在Java中相信很多人都用过内部类，Java允许在一个类里面定义另一个类，类里面的类就是内部类，也叫做嵌套类。一个简单的内部类实现可以如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">class</span> <span class="nc">OuterClass</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">class</span> <span class="nc">InnerClass</span><span class="o">{</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>今天的问题和Java内部类相关，只涉及到部分和本文研究相关的内部类知识，具体关于Java内部类后续的文章会介绍。</p>

<h2>第一次失效?</h2>

<p>一个我们在编程中经常用到的场景，就是在一个内部类里面访问外部类的private成员变量或者方法，这是可以的。如下面的代码实现。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OuterClass</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">language</span> <span class="o">=</span> <span class="s">&quot;en&quot;</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">region</span> <span class="o">=</span> <span class="s">&quot;US&quot;</span><span class="o">;</span>
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">InnerClass</span> <span class="o">{</span>
</span><span class='line'>      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">printOuterClassPrivateFields</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">String</span> <span class="n">fields</span> <span class="o">=</span> <span class="s">&quot;language=&quot;</span> <span class="o">+</span> <span class="n">language</span> <span class="o">+</span> <span class="s">&quot;;region=&quot;</span> <span class="o">+</span> <span class="n">region</span><span class="o">;</span>
</span><span class='line'>          <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">fields</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">OuterClass</span> <span class="n">outer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OuterClass</span><span class="o">();</span>
</span><span class='line'>      <span class="n">OuterClass</span><span class="o">.</span><span class="na">InnerClass</span> <span class="n">inner</span> <span class="o">=</span> <span class="n">outer</span><span class="o">.</span><span class="na">new</span> <span class="n">InnerClass</span><span class="o">();</span>
</span><span class='line'>      <span class="n">inner</span><span class="o">.</span><span class="na">printOuterClassPrivateFields</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这是为什么呢，不是private修饰的成员只能被成员所述的类才能访问么？难道private真的失效了么？</p>

<h3>编译器在捣鬼？</h3>

<p>我们使用javap命令查看一下生成的两个class文件</p>

<p> OuterClass的反编译结果</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="mi">15</span><span class="o">:</span><span class="mi">30</span> <span class="n">$</span> <span class="n">javap</span> <span class="o">-</span><span class="n">c</span>  <span class="n">OuterClass</span>
</span><span class='line'><span class="n">Compiled</span> <span class="n">from</span> <span class="s">&quot;OuterClass.java&quot;</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OuterClass</span> <span class="kd">extends</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span><span class="o">{</span>
</span><span class='line'><span class="kd">public</span> <span class="nf">OuterClass</span><span class="o">();</span>
</span><span class='line'>  <span class="nl">Code:</span>
</span><span class='line'>   <span class="mi">0</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">1</span><span class="o">:</span>  <span class="n">invokespecial</span>    <span class="err">#</span><span class="mi">11</span><span class="o">;</span> <span class="c1">//Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span>
</span><span class='line'>   <span class="mi">4</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">5</span><span class="o">:</span>  <span class="n">ldc</span>  <span class="err">#</span><span class="mi">13</span><span class="o">;</span> <span class="c1">//String en</span>
</span><span class='line'>   <span class="mi">7</span><span class="o">:</span>  <span class="n">putfield</span> <span class="err">#</span><span class="mi">15</span><span class="o">;</span> <span class="c1">//Field language:Ljava/lang/String;</span>
</span><span class='line'>   <span class="mi">10</span><span class="o">:</span> <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">11</span><span class="o">:</span> <span class="n">ldc</span>  <span class="err">#</span><span class="mi">17</span><span class="o">;</span> <span class="c1">//String US</span>
</span><span class='line'>   <span class="mi">13</span><span class="o">:</span> <span class="n">putfield</span> <span class="err">#</span><span class="mi">19</span><span class="o">;</span> <span class="c1">//Field region:Ljava/lang/String;</span>
</span><span class='line'>   <span class="mi">16</span><span class="o">:</span> <span class="k">return</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">[]);</span>
</span><span class='line'>  <span class="nl">Code:</span>
</span><span class='line'>   <span class="mi">0</span><span class="o">:</span>  <span class="k">new</span>  <span class="err">#</span><span class="mi">1</span><span class="o">;</span> <span class="c1">//class OuterClass</span>
</span><span class='line'>   <span class="mi">3</span><span class="o">:</span>  <span class="n">dup</span>
</span><span class='line'>   <span class="mi">4</span><span class="o">:</span>  <span class="n">invokespecial</span>    <span class="err">#</span><span class="mi">27</span><span class="o">;</span> <span class="c1">//Method &quot;&lt;init&gt;&quot;:()V</span>
</span><span class='line'>   <span class="mi">7</span><span class="o">:</span>  <span class="n">astore_1</span>
</span><span class='line'>   <span class="mi">8</span><span class="o">:</span>  <span class="k">new</span>  <span class="err">#</span><span class="mi">28</span><span class="o">;</span> <span class="c1">//class OuterClass$InnerClass</span>
</span><span class='line'>   <span class="mi">11</span><span class="o">:</span> <span class="n">dup</span>
</span><span class='line'>   <span class="mi">12</span><span class="o">:</span> <span class="n">aload_1</span>
</span><span class='line'>   <span class="mi">13</span><span class="o">:</span> <span class="n">dup</span>
</span><span class='line'>   <span class="mi">14</span><span class="o">:</span> <span class="n">invokevirtual</span>    <span class="err">#</span><span class="mi">30</span><span class="o">;</span> <span class="c1">//Method java/lang/Object.getClass:()Ljava/lang/Class;</span>
</span><span class='line'>   <span class="mi">17</span><span class="o">:</span> <span class="n">pop</span>
</span><span class='line'>   <span class="mi">18</span><span class="o">:</span> <span class="n">invokespecial</span>    <span class="err">#</span><span class="mi">34</span><span class="o">;</span> <span class="c1">//Method OuterClass$InnerClass.&quot;&lt;init&gt;&quot;:(LOuterClass;)V</span>
</span><span class='line'>   <span class="mi">21</span><span class="o">:</span> <span class="n">astore_2</span>
</span><span class='line'>   <span class="mi">22</span><span class="o">:</span> <span class="n">aload_2</span>
</span><span class='line'>   <span class="mi">23</span><span class="o">:</span> <span class="n">invokevirtual</span>    <span class="err">#</span><span class="mi">37</span><span class="o">;</span> <span class="c1">//Method OuterClass$InnerClass.printOuterClassPrivateFields:()V</span>
</span><span class='line'>   <span class="mi">26</span><span class="o">:</span> <span class="k">return</span>
</span><span class='line'>
</span><span class='line'><span class="kd">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">access$0</span><span class="o">(</span><span class="n">OuterClass</span><span class="o">);</span>
</span><span class='line'>  <span class="nl">Code:</span>
</span><span class='line'>   <span class="mi">0</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">1</span><span class="o">:</span>  <span class="n">getfield</span> <span class="err">#</span><span class="mi">15</span><span class="o">;</span> <span class="c1">//Field language:Ljava/lang/String;</span>
</span><span class='line'>   <span class="mi">4</span><span class="o">:</span>  <span class="n">areturn</span>
</span><span class='line'>
</span><span class='line'><span class="kd">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">access$1</span><span class="o">(</span><span class="n">OuterClass</span><span class="o">);</span>
</span><span class='line'>  <span class="nl">Code:</span>
</span><span class='line'>   <span class="mi">0</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">1</span><span class="o">:</span>  <span class="n">getfield</span> <span class="err">#</span><span class="mi">19</span><span class="o">;</span> <span class="c1">//Field region:Ljava/lang/String;</span>
</span><span class='line'>   <span class="mi">4</span><span class="o">:</span>  <span class="n">areturn</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>咦？不对，在OuterClass中我们并没有定义这两个方法</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">access$0</span><span class="o">(</span><span class="n">OuterClass</span><span class="o">);</span>
</span><span class='line'>  <span class="nl">Code:</span>
</span><span class='line'>   <span class="mi">0</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">1</span><span class="o">:</span>  <span class="n">getfield</span> <span class="err">#</span><span class="mi">15</span><span class="o">;</span> <span class="c1">//Field language:Ljava/lang/String;</span>
</span><span class='line'>   <span class="mi">4</span><span class="o">:</span>  <span class="n">areturn</span>
</span><span class='line'>
</span><span class='line'><span class="kd">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">access$1</span><span class="o">(</span><span class="n">OuterClass</span><span class="o">);</span>
</span><span class='line'>  <span class="nl">Code:</span>
</span><span class='line'>   <span class="mi">0</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">1</span><span class="o">:</span>  <span class="n">getfield</span> <span class="err">#</span><span class="mi">19</span><span class="o">;</span> <span class="c1">//Field region:Ljava/lang/String;</span>
</span><span class='line'>   <span class="mi">4</span><span class="o">:</span>  <span class="n">areturn</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>从给出来的注释来看，access$0返回outerClass的language属性；access$1返回outerClass的region属性。并且这两个方法都接受OuterClass的实例作为参数。这两个方法为什么生成呢，有什么作用呢？我们看一下内部类的反编译结果就知道了。</p>

<p><strong>OuterClass$InnerClass的反编译结果</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="mi">15</span><span class="o">:</span><span class="mi">37</span> <span class="n">$</span> <span class="n">javap</span> <span class="o">-</span><span class="n">c</span> <span class="n">OuterClass</span><span class="err">\</span><span class="n">$InnerClass</span>
</span><span class='line'><span class="n">Compiled</span> <span class="n">from</span> <span class="s">&quot;OuterClass.java&quot;</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OuterClass</span><span class="n">$InnerClass</span> <span class="kd">extends</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span><span class="o">{</span>
</span><span class='line'><span class="kd">final</span> <span class="n">OuterClass</span> <span class="k">this</span><span class="n">$0</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="n">OuterClass$InnerClass</span><span class="o">(</span><span class="n">OuterClass</span><span class="o">);</span>
</span><span class='line'>  <span class="nl">Code:</span>
</span><span class='line'>   <span class="mi">0</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">1</span><span class="o">:</span>  <span class="n">aload_1</span>
</span><span class='line'>   <span class="mi">2</span><span class="o">:</span>  <span class="n">putfield</span> <span class="err">#</span><span class="mi">10</span><span class="o">;</span> <span class="c1">//Field this$0:LOuterClass;</span>
</span><span class='line'>   <span class="mi">5</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">6</span><span class="o">:</span>  <span class="n">invokespecial</span>    <span class="err">#</span><span class="mi">12</span><span class="o">;</span> <span class="c1">//Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span>
</span><span class='line'>   <span class="mi">9</span><span class="o">:</span>  <span class="k">return</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">printOuterClassPrivateFields</span><span class="o">();</span>
</span><span class='line'>  <span class="nl">Code:</span>
</span><span class='line'>   <span class="mi">0</span><span class="o">:</span>  <span class="k">new</span>  <span class="err">#</span><span class="mi">20</span><span class="o">;</span> <span class="c1">//class java/lang/StringBuilder</span>
</span><span class='line'>   <span class="mi">3</span><span class="o">:</span>  <span class="n">dup</span>
</span><span class='line'>   <span class="mi">4</span><span class="o">:</span>  <span class="n">ldc</span>  <span class="err">#</span><span class="mi">22</span><span class="o">;</span> <span class="c1">//String language=</span>
</span><span class='line'>   <span class="mi">6</span><span class="o">:</span>  <span class="n">invokespecial</span>    <span class="err">#</span><span class="mi">24</span><span class="o">;</span> <span class="c1">//Method java/lang/StringBuilder.&quot;&lt;init&gt;&quot;:(Ljava/lang/String;)V</span>
</span><span class='line'>   <span class="mi">9</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">10</span><span class="o">:</span> <span class="n">getfield</span> <span class="err">#</span><span class="mi">10</span><span class="o">;</span> <span class="c1">//Field this$0:LOuterClass;</span>
</span><span class='line'>   <span class="mi">13</span><span class="o">:</span> <span class="n">invokestatic</span> <span class="err">#</span><span class="mi">27</span><span class="o">;</span> <span class="c1">//Method OuterClass.access$0:(LOuterClass;)Ljava/lang/String;</span>
</span><span class='line'>   <span class="mi">16</span><span class="o">:</span> <span class="n">invokevirtual</span>    <span class="err">#</span><span class="mi">33</span><span class="o">;</span> <span class="c1">//Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span>
</span><span class='line'>   <span class="mi">19</span><span class="o">:</span> <span class="n">ldc</span>  <span class="err">#</span><span class="mi">37</span><span class="o">;</span> <span class="c1">//String ;region=</span>
</span><span class='line'>   <span class="mi">21</span><span class="o">:</span> <span class="n">invokevirtual</span>    <span class="err">#</span><span class="mi">33</span><span class="o">;</span> <span class="c1">//Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span>
</span><span class='line'>   <span class="mi">24</span><span class="o">:</span> <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">25</span><span class="o">:</span> <span class="n">getfield</span> <span class="err">#</span><span class="mi">10</span><span class="o">;</span> <span class="c1">//Field this$0:LOuterClass;</span>
</span><span class='line'>   <span class="mi">28</span><span class="o">:</span> <span class="n">invokestatic</span> <span class="err">#</span><span class="mi">39</span><span class="o">;</span> <span class="c1">//Method OuterClass.access$1:(LOuterClass;)Ljava/lang/String;</span>
</span><span class='line'>   <span class="mi">31</span><span class="o">:</span> <span class="n">invokevirtual</span>    <span class="err">#</span><span class="mi">33</span><span class="o">;</span> <span class="c1">//Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span>
</span><span class='line'>   <span class="mi">34</span><span class="o">:</span> <span class="n">invokevirtual</span>    <span class="err">#</span><span class="mi">42</span><span class="o">;</span> <span class="c1">//Method java/lang/StringBuilder.toString:()Ljava/lang/String;</span>
</span><span class='line'>   <span class="mi">37</span><span class="o">:</span> <span class="n">astore_1</span>
</span><span class='line'>   <span class="mi">38</span><span class="o">:</span> <span class="n">getstatic</span>    <span class="err">#</span><span class="mi">46</span><span class="o">;</span> <span class="c1">//Field java/lang/System.out:Ljava/io/PrintStream;</span>
</span><span class='line'>   <span class="mi">41</span><span class="o">:</span> <span class="n">aload_1</span>
</span><span class='line'>   <span class="mi">42</span><span class="o">:</span> <span class="n">invokevirtual</span>    <span class="err">#</span><span class="mi">52</span><span class="o">;</span> <span class="c1">//Method java/io/PrintStream.println:(Ljava/lang/String;)V</span>
</span><span class='line'>   <span class="mi">45</span><span class="o">:</span> <span class="k">return</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>下面代码调用access$0的代码,其目的是得到OuterClass的language 私有属性。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="mi">13</span><span class="o">:</span>   <span class="n">invokestatic</span> <span class="err">#</span><span class="mi">27</span><span class="o">;</span> <span class="c1">//Method OuterClass.access$0:(LOuterClass;)Ljava/lang/String;</span>
</span></code></pre></td></tr></table></div></figure>


<p>下面代码调用了access$1的代码，其目的是得到OutherClass的region 私有属性。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="mi">28</span><span class="o">:</span>   <span class="n">invokestatic</span> <span class="err">#</span><span class="mi">39</span><span class="o">;</span> <span class="c1">//Method OuterClass.access$1:(LOuterClass;)Ljava/lang/String;</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>注意：在内部类构造的时候，会将外部类的引用传递进来，并且作为内部类的一个属性，所以内部类会持有一个其外部类的引用。</strong><br/>
this$0就是内部类持有的外部类引用，通过构造方法传递引用并赋值。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">final</span> <span class="n">OuterClass</span> <span class="k">this</span><span class="n">$0</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="n">OuterClass$InnerClass</span><span class="o">(</span><span class="n">OuterClass</span><span class="o">);</span>
</span><span class='line'>  <span class="nl">Code:</span>
</span><span class='line'>   <span class="mi">0</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">1</span><span class="o">:</span>  <span class="n">aload_1</span>
</span><span class='line'>   <span class="mi">2</span><span class="o">:</span>  <span class="n">putfield</span> <span class="err">#</span><span class="mi">10</span><span class="o">;</span> <span class="c1">//Field this$0:LOuterClass;</span>
</span><span class='line'>   <span class="mi">5</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">6</span><span class="o">:</span>  <span class="n">invokespecial</span>    <span class="err">#</span><span class="mi">12</span><span class="o">;</span> <span class="c1">//Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span>
</span><span class='line'>   <span class="mi">9</span><span class="o">:</span>  <span class="k">return</span>
</span></code></pre></td></tr></table></div></figure>


<h3>小结</h3>

<p>这部分private看上去失效可，实际上并没有失效，因为当内部类调用外部类的私有属性时，其真正的执行是调用了编译器生成的属性的静态方法（即acess$0,access$1等）来获取这些属性值。这一切都是编译器的特殊处理。</p>

<h2>这次也失效？</h2>

<p>如果说上面的写法很常用，那么这样的写法是不是很少接触，但是却可以运行。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnotherOuterClass</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">InnerClass</span> <span class="n">inner</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnotherOuterClass</span><span class="o">().</span><span class="na">new</span> <span class="n">InnerClass</span><span class="o">();</span>
</span><span class='line'>      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;InnerClass Filed = &quot;</span> <span class="o">+</span> <span class="n">inner</span><span class="o">.</span><span class="na">x</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">class</span> <span class="nc">InnerClass</span> <span class="o">{</span>
</span><span class='line'>      <span class="kd">private</span> <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>和上面一样，使用javap反编译看一下。不过这次我们先看一下InnerClass的结果</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="mi">16</span><span class="o">:</span><span class="mi">03</span> <span class="n">$</span> <span class="n">javap</span> <span class="o">-</span><span class="n">c</span> <span class="n">AnotherOuterClass</span><span class="err">\</span><span class="n">$InnerClass</span>
</span><span class='line'><span class="n">Compiled</span> <span class="n">from</span> <span class="s">&quot;AnotherOuterClass.java&quot;</span>
</span><span class='line'><span class="kd">class</span> <span class="nc">AnotherOuterClass</span><span class="n">$InnerClass</span> <span class="kd">extends</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span><span class="o">{</span>
</span><span class='line'><span class="kd">final</span> <span class="n">AnotherOuterClass</span> <span class="k">this</span><span class="n">$0</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">AnotherOuterClass$InnerClass</span><span class="o">(</span><span class="n">AnotherOuterClass</span><span class="o">);</span>
</span><span class='line'>  <span class="nl">Code:</span>
</span><span class='line'>   <span class="mi">0</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">1</span><span class="o">:</span>  <span class="n">aload_1</span>
</span><span class='line'>   <span class="mi">2</span><span class="o">:</span>  <span class="n">putfield</span> <span class="err">#</span><span class="mi">12</span><span class="o">;</span> <span class="c1">//Field this$0:LAnotherOuterClass;</span>
</span><span class='line'>   <span class="mi">5</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">6</span><span class="o">:</span>  <span class="n">invokespecial</span>    <span class="err">#</span><span class="mi">14</span><span class="o">;</span> <span class="c1">//Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span>
</span><span class='line'>   <span class="mi">9</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">10</span><span class="o">:</span> <span class="n">bipush</span>   <span class="mi">10</span>
</span><span class='line'>   <span class="mi">12</span><span class="o">:</span> <span class="n">putfield</span> <span class="err">#</span><span class="mi">17</span><span class="o">;</span> <span class="c1">//Field x:I</span>
</span><span class='line'>   <span class="mi">15</span><span class="o">:</span> <span class="k">return</span>
</span><span class='line'>
</span><span class='line'><span class="kd">static</span> <span class="kt">int</span> <span class="n">access$0</span><span class="o">(</span><span class="n">AnotherOuterClass$InnerClass</span><span class="o">);</span>
</span><span class='line'>  <span class="nl">Code:</span>
</span><span class='line'>   <span class="mi">0</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">1</span><span class="o">:</span>  <span class="n">getfield</span> <span class="err">#</span><span class="mi">17</span><span class="o">;</span> <span class="c1">//Field x:I</span>
</span><span class='line'>   <span class="mi">4</span><span class="o">:</span>  <span class="n">ireturn</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>又出现了，编译器又自动生成了一个获取私有属性的后门方法access$0一次来获取x的值。</p>

<p>AnotherOuterClass.class的反编译结果</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="mi">16</span><span class="o">:</span><span class="mi">08</span> <span class="n">$</span> <span class="n">javap</span> <span class="o">-</span><span class="n">c</span> <span class="n">AnotherOuterClass</span>
</span><span class='line'><span class="n">Compiled</span> <span class="n">from</span> <span class="s">&quot;AnotherOuterClass.java&quot;</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnotherOuterClass</span> <span class="kd">extends</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span><span class="o">{</span>
</span><span class='line'><span class="kd">public</span> <span class="nf">AnotherOuterClass</span><span class="o">();</span>
</span><span class='line'>  <span class="nl">Code:</span>
</span><span class='line'>   <span class="mi">0</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">1</span><span class="o">:</span>  <span class="n">invokespecial</span>    <span class="err">#</span><span class="mi">8</span><span class="o">;</span> <span class="c1">//Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span>
</span><span class='line'>   <span class="mi">4</span><span class="o">:</span>  <span class="k">return</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">[]);</span>
</span><span class='line'>  <span class="nl">Code:</span>
</span><span class='line'>   <span class="mi">0</span><span class="o">:</span>  <span class="k">new</span>  <span class="err">#</span><span class="mi">16</span><span class="o">;</span> <span class="c1">//class AnotherOuterClass$InnerClass</span>
</span><span class='line'>   <span class="mi">3</span><span class="o">:</span>  <span class="n">dup</span>
</span><span class='line'>   <span class="mi">4</span><span class="o">:</span>  <span class="k">new</span>  <span class="err">#</span><span class="mi">1</span><span class="o">;</span> <span class="c1">//class AnotherOuterClass</span>
</span><span class='line'>   <span class="mi">7</span><span class="o">:</span>  <span class="n">dup</span>
</span><span class='line'>   <span class="mi">8</span><span class="o">:</span>  <span class="n">invokespecial</span>    <span class="err">#</span><span class="mi">18</span><span class="o">;</span> <span class="c1">//Method &quot;&lt;init&gt;&quot;:()V</span>
</span><span class='line'>   <span class="mi">11</span><span class="o">:</span> <span class="n">dup</span>
</span><span class='line'>   <span class="mi">12</span><span class="o">:</span> <span class="n">invokevirtual</span>    <span class="err">#</span><span class="mi">19</span><span class="o">;</span> <span class="c1">//Method java/lang/Object.getClass:()Ljava/lang/Class;</span>
</span><span class='line'>   <span class="mi">15</span><span class="o">:</span> <span class="n">pop</span>
</span><span class='line'>   <span class="mi">16</span><span class="o">:</span> <span class="n">invokespecial</span>    <span class="err">#</span><span class="mi">23</span><span class="o">;</span> <span class="c1">//Method AnotherOuterClass$InnerClass.&quot;&lt;init&gt;&quot;:(LAnotherOuterClass;)V</span>
</span><span class='line'>   <span class="mi">19</span><span class="o">:</span> <span class="n">astore_1</span>
</span><span class='line'>   <span class="mi">20</span><span class="o">:</span> <span class="n">getstatic</span>    <span class="err">#</span><span class="mi">26</span><span class="o">;</span> <span class="c1">//Field java/lang/System.out:Ljava/io/PrintStream;</span>
</span><span class='line'>   <span class="mi">23</span><span class="o">:</span> <span class="k">new</span>  <span class="err">#</span><span class="mi">32</span><span class="o">;</span> <span class="c1">//class java/lang/StringBuilder</span>
</span><span class='line'>   <span class="mi">26</span><span class="o">:</span> <span class="n">dup</span>
</span><span class='line'>   <span class="mi">27</span><span class="o">:</span> <span class="n">ldc</span>  <span class="err">#</span><span class="mi">34</span><span class="o">;</span> <span class="c1">//String InnerClass Filed =</span>
</span><span class='line'>   <span class="mi">29</span><span class="o">:</span> <span class="n">invokespecial</span>    <span class="err">#</span><span class="mi">36</span><span class="o">;</span> <span class="c1">//Method java/lang/StringBuilder.&quot;&lt;init&gt;&quot;:(Ljava/lang/String;)V</span>
</span><span class='line'>   <span class="mi">32</span><span class="o">:</span> <span class="n">aload_1</span>
</span><span class='line'>   <span class="mi">33</span><span class="o">:</span> <span class="n">invokestatic</span> <span class="err">#</span><span class="mi">39</span><span class="o">;</span> <span class="c1">//Method AnotherOuterClass$InnerClass.access$0:(LAnotherOuterClass$InnerClass;)I</span>
</span><span class='line'>   <span class="mi">36</span><span class="o">:</span> <span class="n">invokevirtual</span>    <span class="err">#</span><span class="mi">43</span><span class="o">;</span> <span class="c1">//Method java/lang/StringBuilder.append:(I)Ljava/lang/StringBuilder;</span>
</span><span class='line'>   <span class="mi">39</span><span class="o">:</span> <span class="n">invokevirtual</span>    <span class="err">#</span><span class="mi">47</span><span class="o">;</span> <span class="c1">//Method java/lang/StringBuilder.toString:()Ljava/lang/String;</span>
</span><span class='line'>   <span class="mi">42</span><span class="o">:</span> <span class="n">invokevirtual</span>    <span class="err">#</span><span class="mi">51</span><span class="o">;</span> <span class="c1">//Method java/io/PrintStream.println:(Ljava/lang/String;)V</span>
</span><span class='line'>   <span class="mi">45</span><span class="o">:</span> <span class="k">return</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中这句调用就是外部类通过内部类的实例获取私有属性x的操作</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="mi">33</span><span class="o">:</span>   <span class="n">invokestatic</span> <span class="err">#</span><span class="mi">39</span><span class="o">;</span> <span class="c1">//Method AnotherOuterClass$InnerClass.access$0:(LAnotherOuterClass$InnerClass;)I</span>
</span></code></pre></td></tr></table></div></figure>


<h3>再来个总结</h3>

<p>其中<a href="http://docs.oracle.com/javase/specs/jls/se7/html/jls-6.html#jls-6.6.1">java官方文档</a> 有这样一句话</p>

<blockquote><p>if the member or constructor is declared private, then access is permitted if and only if it occurs within the body of the top level class (§7.6) that encloses the declaration of the member or constructor.</p></blockquote>

<p>意思是 如果（内部类的）成员和构造方法设定成了私有修饰符，当且仅当其外部类访问时是允许的。</p>

<h2>如何让内部类私有成员不被外部访问</h2>

<p>相信看完上面两部分，你会觉得，内部类的私有成员想不被外部类访问都很困难吧，谁让编译器“爱管闲事”呢，其实也是可以做到的。那就是使用匿名内部类。</p>

<p>由于mRunnable对象的类型为Runnable，而不是匿名内部类的类型（我们无法正常拿到），而Runanble中没有x这个属性，所以mRunnable.x是不被允许的。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PrivateToOuter</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">Runnable</span> <span class="n">mRunnable</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">(){</span>
</span><span class='line'>      <span class="kd">private</span> <span class="kt">int</span> <span class="n">x</span><span class="o">=</span><span class="mi">10</span><span class="o">;</span>
</span><span class='line'>      <span class="nd">@Override</span>
</span><span class='line'>      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
</span><span class='line'>      <span class="n">PrivateToOuter</span> <span class="n">p</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrivateToOuter</span><span class="o">();</span>
</span><span class='line'>      <span class="c1">//System.out.println(&quot;anonymous class private filed= &quot;+ p.mRunnable.x); //not allowed</span>
</span><span class='line'>      <span class="n">p</span><span class="o">.</span><span class="na">mRunnable</span><span class="o">.</span><span class="na">run</span><span class="o">();</span> <span class="c1">// allowed</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>最后总结</h2>

<ul>
<li>在本文中，private表面上看上去失效了，但实际上是没有的，而是在调用时通过间接的方法来获取私有的属性。</li>
<li>Java的内部类构造时持有对外部类的应用，C++不会，这一点和C++不一样。</li>
</ul>


<h3>深入Java细节的书籍</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B0011F7WU4/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B0011F7WU4&linkCode=as2&tag=droidyue-23">Java编程思想</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B0011F7WU4" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B001PTGR52/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B001PTGR52&linkCode=as2&tag=droidyue-23">Sun 公司核心技术丛书:Effective Java中文版</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B001PTGR52" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00D2ID4PK/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00D2ID4PK&linkCode=as2&tag=droidyue-23">深入理解Java虚拟机:JVM高级特性与最佳实践</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00D2ID4PK" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[WebView处理网页位置请求]]></title>
    <link href="http://droidyue.com/blog/2014/10/01/handle-geolocation-request-in-webview/"/>
    <updated>2014-10-01T17:23:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/10/01/handle-geolocation-request-in-webview</id>
    <content type="html"><![CDATA[<p>随着移动设备的激增，LBS（Location Based Service）已然成为趋势，其最关键的还是获取设备的位置信息。native代码获取位置信息轻轻松松可以搞定，实际上网页获取位置信息也不是那么困难。</p>

<p>在HTML5中，提供了一套定位用户信息的接口，当然这个位置信息是通过客户端，准确说是浏览器获取的。</p>

<!--more-->


<p>注意，位置信息属于个人隐私的范围，只有经过用户同意之后才能获取到信息。</p>

<h2>网页如何实现请求位置信息</h2>

<p>使用getCurrentPosition()方法来请求位置信息。<br/>
下面是一个很简单的示例，来展示用户位置信息的经度和纬度。</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'>    <span class="nt">&lt;body&gt;</span>
</span><span class='line'>  <span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">&quot;demo&quot;</span><span class="nt">&gt;</span>Click the button to get your coordinates:<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>  <span class="nt">&lt;button</span> <span class="na">onclick=</span><span class="s">&quot;getLocation()&quot;</span><span class="nt">&gt;</span>Try It<span class="nt">&lt;/button&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;script&gt;</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;demo&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">function</span> <span class="nx">getLocation</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">&quot;getLocation working&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">geolocation</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="nx">navigator</span><span class="p">.</span><span class="nx">geolocation</span><span class="p">.</span><span class="nx">getCurrentPosition</span><span class="p">(</span><span class="nx">showPosition</span><span class="p">,</span><span class="nx">showError</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>              <span class="nx">x</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;Geolocation is not supported by this browser.&quot;</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">function</span> <span class="nx">showPosition</span><span class="p">(</span><span class="nx">position</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">x</span><span class="p">.</span><span class="nx">innerHTML</span><span class="o">=</span><span class="s2">&quot;Latitude: &quot;</span> <span class="o">+</span> <span class="nx">position</span><span class="p">.</span><span class="nx">coords</span><span class="p">.</span><span class="nx">latitude</span> <span class="o">+</span> <span class="s2">&quot;&lt;br&gt;Longitude: &quot;</span> <span class="o">+</span> <span class="nx">position</span><span class="p">.</span><span class="nx">coords</span><span class="p">.</span><span class="nx">longitude</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      
</span><span class='line'>      <span class="kd">function</span> <span class="nx">showError</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">switch</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">case</span> <span class="nx">error</span><span class="p">.</span><span class="nx">PERMISSION_DENIED</span><span class="o">:</span>
</span><span class='line'>              <span class="nx">x</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;User denied the request for Geolocation.&quot;</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="nx">error</span><span class="p">.</span><span class="nx">POSITION_UNAVAILABLE</span><span class="o">:</span>
</span><span class='line'>              <span class="nx">x</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;Location information is unavailable.&quot;</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="nx">error</span><span class="p">.</span><span class="nx">TIMEOUT</span><span class="o">:</span>
</span><span class='line'>              <span class="nx">x</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;The request to get user location timed out.&quot;</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="nx">error</span><span class="p">.</span><span class="nx">UNKNOWN_ERROR</span><span class="o">:</span>
</span><span class='line'>              <span class="nx">x</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;An unknown error occurred.&quot;</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>    <span class="nt">&lt;/script&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>示例阐述</h3>

<ul>
<li> 检测getLocation方法是否可用</li>
<li> 如果可以调用getCurrentPosition方法，否则提示浏览器不支持</li>
<li> 如果getCurrentPosition获取信息成功，返回一个坐标系的对象，并将这个对象作为参数传递到showPosition方法,如果失败，调用showError方法，并将错误码作为showError方法的参数。</li>
<li> showPosition方法展示经度和纬度信息</li>
<li> showError方法用来处理请求错误</li>
</ul>


<p>上述部分参考自<a href="http://www.w3schools.com/HTML/html5_geolocation.asp">html5_geolocation w3cschool</a>，更多高级操作请访问左侧链接。</p>

<h2>WebView如何返回给网页</h2>

<h3>大致操作步骤</h3>

<ul>
<li>在manifest中申请android.permission.ACCESS_FINE_LOCATION 或 android.permission.ACCESS_COARSE_LOCATION 权限。两者都有更好。</li>
<li>设置webivew开启javascript功能，地理定位功能，设置物理定位数据库路径</li>
<li>在onGeolocationPermissionsShowPrompt处理物理位置请求，常用的是提示用户，让用户决定是否允许。</li>
</ul>


<h3>使用的API</h3>

<ul>
<li>android.permission.ACCESS_FINE_LOCATION 通过GPS，基站，Wifi等获取<strong>精确的</strong>位置信息。</li>
<li>android.permission.ACCESS_COARSE_LOCATION 通过基站，Wifi等获取<strong>错略的</strong>位置信息。</li>
<li>onGeolocationPermissionsShowPrompt 位置信息请求回调，通常在这里弹出选择是否赋予权限的对话框</li>
<li>GeolocationPermissions.Callback.invoke(String origin, boolean allow, boolean remember)决定是否真正提供给网页信息，可根据用户的选择结果选择处理。

<h3>实现代码</h3></li>
</ul>


<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">final</span> <span class="n">WebView</span> <span class="n">webView</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WebView</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span><span class='line'><span class="n">addContentView</span><span class="o">(</span><span class="n">webView</span><span class="o">,</span>  <span class="k">new</span> <span class="n">LayoutParams</span><span class="o">(</span><span class="n">LayoutParams</span><span class="o">.</span><span class="na">MATCH_PARENT</span><span class="o">,</span> <span class="n">LayoutParams</span><span class="o">.</span><span class="na">MATCH_PARENT</span><span class="o">)</span>  <span class="o">);</span>
</span><span class='line'><span class="n">WebSettings</span> <span class="n">settings</span> <span class="o">=</span> <span class="n">webView</span><span class="o">.</span><span class="na">getSettings</span><span class="o">();</span>
</span><span class='line'><span class="n">settings</span><span class="o">.</span><span class="na">setJavaScriptEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'><span class="n">settings</span><span class="o">.</span><span class="na">setGeolocationEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'><span class="n">settings</span><span class="o">.</span><span class="na">setGeolocationDatabasePath</span><span class="o">(</span><span class="n">getFilesDir</span><span class="o">().</span><span class="na">getPath</span><span class="o">());</span>
</span><span class='line'>      
</span><span class='line'><span class="n">webView</span><span class="o">.</span><span class="na">setWebChromeClient</span><span class="o">(</span><span class="k">new</span> <span class="n">WebChromeClient</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onGeolocationPermissionsHidePrompt</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="kd">super</span><span class="o">.</span><span class="na">onGeolocationPermissionsHidePrompt</span><span class="o">();</span>
</span><span class='line'>      <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">LOGTAG</span><span class="o">,</span> <span class="s">&quot;onGeolocationPermissionsHidePrompt&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onGeolocationPermissionsShowPrompt</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">origin</span><span class="o">,</span>
</span><span class='line'>                  <span class="kd">final</span> <span class="n">Callback</span> <span class="n">callback</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">AlertDialog</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AlertDialog</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">MainActivity</span><span class="o">.</span><span class="na">this</span><span class="o">);</span>
</span><span class='line'>      <span class="n">builder</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="s">&quot;Allow to access location information?&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="n">OnClickListener</span> <span class="n">dialogButtonOnClickListener</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OnClickListener</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>          <span class="nd">@Override</span>
</span><span class='line'>          <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="n">DialogInterface</span> <span class="n">dialog</span><span class="o">,</span> <span class="kt">int</span> <span class="n">clickedButton</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="k">if</span> <span class="o">(</span><span class="n">DialogInterface</span><span class="o">.</span><span class="na">BUTTON_POSITIVE</span> <span class="o">==</span> <span class="n">clickedButton</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                  <span class="n">callback</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">origin</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span><span class='line'>              <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">DialogInterface</span><span class="o">.</span><span class="na">BUTTON_NEGATIVE</span> <span class="o">==</span> <span class="n">clickedButton</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                  <span class="n">callback</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">origin</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>              <span class="o">}</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>      <span class="o">};</span>
</span><span class='line'>      <span class="n">builder</span><span class="o">.</span><span class="na">setPositiveButton</span><span class="o">(</span><span class="s">&quot;Allow&quot;</span><span class="o">,</span> <span class="n">dialogButtonOnClickListener</span><span class="o">);</span>
</span><span class='line'>      <span class="n">builder</span><span class="o">.</span><span class="na">setNegativeButton</span><span class="o">(</span><span class="s">&quot;Deny&quot;</span><span class="o">,</span> <span class="n">dialogButtonOnClickListener</span><span class="o">);</span>
</span><span class='line'>      <span class="n">builder</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
</span><span class='line'>      <span class="kd">super</span><span class="o">.</span><span class="na">onGeolocationPermissionsShowPrompt</span><span class="o">(</span><span class="n">origin</span><span class="o">,</span> <span class="n">callback</span><span class="o">);</span>
</span><span class='line'>      <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">LOGTAG</span><span class="o">,</span> <span class="s">&quot;onGeolocationPermissionsShowPrompt&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">});</span>
</span><span class='line'><span class="n">webView</span><span class="o">.</span><span class="na">loadUrl</span><span class="o">(</span><span class="s">&quot;file:///android_asset/geolocation.html&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>疑问解答</h2>

<h3>I/SqliteDatabaseCpp(21863): sqlite returned: error code = 14</h3>

<p>原因是你没有设置setGeolocationDatabasePath，按照上面例子设置即可。</p>

<h3>点击之后没有任何变化</h3>

<ul>
<li>检查代码是否按照上面一样，是否有错误。</li>
<li>在第一次请求的是否，需要的反应时间比较长。</li>
</ul>


<h3>检测定位服务是否可用</h3>

<p>当GPS_PROVIDER和NETWORK_PROVIDER有一者可用，定位服务就可以用，当两者都不能用时，即定位服务不可以用。<br/>
注意PASSIVE_PROVIDER不能作为定位服务可用的标志。因为这个provider只会返回其他Provider提供的位置信息，自己无法定位。</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">testGeolocationOK</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">LocationManager</span> <span class="n">manager</span> <span class="o">=</span> <span class="o">(</span><span class="n">LocationManager</span><span class="o">)</span><span class="n">getSystemService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">LOCATION_SERVICE</span><span class="o">);</span>
</span><span class='line'>      <span class="kt">boolean</span> <span class="n">gpsProviderOK</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="na">isProviderEnabled</span><span class="o">(</span><span class="n">LocationManager</span><span class="o">.</span><span class="na">GPS_PROVIDER</span><span class="o">);</span>
</span><span class='line'>      <span class="kt">boolean</span> <span class="n">networkProviderOK</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="na">isProviderEnabled</span><span class="o">(</span><span class="n">LocationManager</span><span class="o">.</span><span class="na">NETWORK_PROVIDER</span><span class="o">);</span>
</span><span class='line'>      <span class="kt">boolean</span> <span class="n">geolocationOK</span> <span class="o">=</span> <span class="n">gpsProviderOK</span> <span class="o">&amp;&amp;</span> <span class="n">networkProviderOK</span><span class="o">;</span>
</span><span class='line'>      <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">LOGTAG</span><span class="o">,</span> <span class="s">&quot;gpsProviderOK = &quot;</span> <span class="o">+</span> <span class="n">gpsProviderOK</span> <span class="o">+</span> <span class="s">&quot;; networkProviderOK = &quot;</span> <span class="o">+</span> <span class="n">networkProviderOK</span> <span class="o">+</span> <span class="s">&quot;; geoLocationOK=&quot;</span> <span class="o">+</span> <span class="n">geolocationOK</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>跳转到位置设置界面</h3>

<p>我们只需要发送一个简单的隐式intent即可启动位置设置界面</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">Settings</span><span class="o">.</span><span class="na">ACTION_LOCATION_SOURCE_SETTINGS</span><span class="o">);</span>
</span><span class='line'><span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>示例代码</h2>

<p><a href="http://pan.baidu.com/s/1gdrHIin">百度云盘</a></p>

<h3>其他</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B007RSKTXQ/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B007RSKTXQ&linkCode=as2&tag=droidyue-23">程序员装B必备：黑轴机械键盘</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B007RSKTXQ" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00E7XVAZA/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00E7XVAZA&linkCode=as2&tag=droidyue-23">位置信息服务(LBS)关键技术及应用</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00E7XVAZA" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00KHG1006/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00KHG1006&linkCode=as2&tag=droidyue-23">基于语义Web的LBS服务架构及其服务发现算法研究</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00KHG1006" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[实时预览Markdown利器]]></title>
    <link href="http://droidyue.com/blog/2014/10/01/great-markdown-viewer-as-a-chrome-extension/"/>
    <updated>2014-10-01T09:21:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/10/01/great-markdown-viewer-as-a-chrome-extension</id>
    <content type="html"><![CDATA[<p>使用MBP15寸有点高不成低不就，接显示器分辨率下降（浪费Retina屏），不接显示器屏幕不是很大。</p>

<p>常用的markdown编辑器设置为左侧编辑器（Editor），右边实时查看器（Viewer）。受制于屏幕尺寸，editor和viewer都显示不完整，于是尝试找一个浏览器渲染markdown文件的插件。于是就发现了markdown-reader。</p>

<!--more-->


<h2>功能点</h2>

<ul>
<li>支持读取markdown文件（http,https,file等协议）</li>
<li>文件变化自动加载刷新</li>
<li>代码高亮</li>
<li>显示内容边框</li>
<li>支持table扩展</li>
</ul>


<h2>示例效果</h2>

<p><img src="http://droidyueimg.qiniudn.com/markdown_view_sample.png" title="markdown reader" ></p>

<h2>使用心得</h2>

<p>很不错的一款插件，支持file协议，检测到文件变化很迅速，目测比百度网盘还要快，排版很棒。</p>

<h2>地址</h2>

<ul>
<li><a href="https://chrome.google.com/webstore/detail/markdown-reader/gpoigdifkoadgajcincpilkjmejcaanc">Chrome Store 地址</a></li>
<li><a href="https://github.com/yaniswang/markdownReader">Github开源仓库</a></li>
</ul>


<h3>其他</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B0051EEQWS/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B0051EEQWS&linkCode=as2&tag=droidyue-23">别告诉我你会记笔记</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B0051EEQWS" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B006BPPKZ8/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B006BPPKZ8&linkCode=as2&tag=droidyue-23">超级整理术:工作效率是整理出来的</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B006BPPKZ8" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B004O9F71K/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B004O9F71K&linkCode=as2&tag=droidyue-23">番茄工作法图解:简单易行的时间管理方法</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B004O9F71K" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[利用WebView实现网页的i18n]]></title>
    <link href="http://droidyue.com/blog/2014/09/30/i18n-web-page-using-webview-in-android/"/>
    <updated>2014-09-30T21:44:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/09/30/i18n-web-page-using-webview-in-android</id>
    <content type="html"><![CDATA[<p>软件如果想在全球获得更多的用户，国际化与本地化（internationalization and localization 简称：i18n 和L10n）是非常必要的。本文将介绍一个很geeky的方法来利用webview实现html的i18n。</p>

<!--more-->


<h2>基本概念</h2>

<p>国际化是指在设计软件，将软件与特定语言及地区脱钩的过程。当软件被移植到不同的语言及地区时，软件本身不用做内部工程上的改变或修正。本地化则是指当移植软件时，加上与特定区域设置有关的信息和翻译文件的过程。</p>

<p>国际化和本地化之间的区别虽然微妙，但却很重要。国际化意味着产品有适用于任何地方的“潜力”；本地化则是为了更适合于“特定”地方的使用，而另外增添的特色。用一项产品来说，国际化只需做一次，但本地化则要针对不同的区域各做一次。 这两者之间是互补的，并且两者合起来才能让一个系统适用于各地。</p>

<p>上述摘自<a href="http://zh.wikipedia.org/wiki/%E5%9B%BD%E9%99%85%E5%8C%96%E4%B8%8E%E6%9C%AC%E5%9C%B0%E5%8C%96">维基百科 国际化与本地化</a></p>

<h2>问题</h2>

<p>如何实现网页的国际化和本地化，支持更多的语言呢？最简单的逻辑可能类似如下伪代码实现</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">isChinese</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">lable</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="s2">&quot;中文&quot;</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isEnglish</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">lable</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="s2">&quot;English&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>但是这样是很有问题的，如果增加了语言必然要修改代码代码，违背了对修改关闭的原则。所以上述并不是一种很好的方法</p>

<h2>更Hacky的实现</h2>

<p>实现思路主要是借助强大的Android系统的资源适配机制（基于设备设备的信息Locale等匹配最合适的资源）。貌似这个是Chrome中网页实现i18n的逻辑。实现步骤主要如下</p>

<ul>
<li>Android程序提供必要多个Locale的资源</li>
<li>将网页需要的文字资源组成JSON交换格式</li>
<li>WebView注入一个变量，变量内容为上一步的JSON数据</li>
<li>网页实现读取资源，为元素设置内容</li>
<li>加载网页</li>
</ul>


<h3>提供多个Locale文字资源</h3>

<h4>values/strings.xml</h4>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;resources&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;city_beijing&quot;</span><span class="nt">&gt;</span>Beijing<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;country_china&quot;</span><span class="nt">&gt;</span>China<span class="nt">&lt;/string&gt;</span>
</span><span class='line'><span class="nt">&lt;/resources&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>values-zh-rCN/strings.xml</h4>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;resources&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;city_beijing&quot;</span><span class="nt">&gt;</span>北京<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;country_china&quot;</span><span class="nt">&gt;</span>中国<span class="nt">&lt;/string&gt;</span>
</span><span class='line'><span class="nt">&lt;/resources&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>接下来的代码</h3>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">WebView</span> <span class="n">myWebView</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WebView</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span><span class='line'><span class="n">addContentView</span><span class="o">(</span><span class="n">myWebView</span><span class="o">,</span> <span class="k">new</span> <span class="n">LayoutParams</span><span class="o">(</span><span class="n">LayoutParams</span><span class="o">.</span><span class="na">MATCH_PARENT</span><span class="o">,</span> <span class="n">LayoutParams</span><span class="o">.</span><span class="na">MATCH_PARENT</span><span class="o">));</span>
</span><span class='line'><span class="c1">//将网页需要的文字资源组成JSON交换格式</span>
</span><span class='line'><span class="n">JSONObject</span> <span class="n">jsObj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JSONObject</span><span class="o">();</span>
</span><span class='line'><span class="k">try</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">jsObj</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;country&quot;</span><span class="o">,</span> <span class="n">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">country_china</span><span class="o">));</span>
</span><span class='line'>  <span class="n">jsObj</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;city&quot;</span><span class="o">,</span> <span class="n">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">city_beijing</span><span class="o">));</span>
</span><span class='line'><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">JSONException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="c1">//WebView注入一个变量，变量内容为上一步的JSON数据</span>
</span><span class='line'><span class="n">String</span> <span class="n">injectString</span> <span class="o">=</span> <span class="s">&quot;var textRes = &quot;</span> <span class="o">+</span> <span class="n">jsObj</span><span class="o">;</span>
</span><span class='line'><span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">LOGTAG</span><span class="o">,</span> <span class="s">&quot;injuectString = &quot;</span> <span class="o">+</span> <span class="n">injectString</span><span class="o">);</span>
</span><span class='line'><span class="n">WebSettings</span> <span class="n">settings</span> <span class="o">=</span> <span class="n">myWebView</span><span class="o">.</span><span class="na">getSettings</span><span class="o">();</span>
</span><span class='line'><span class="n">settings</span><span class="o">.</span><span class="na">setJavaScriptEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'><span class="n">myWebView</span><span class="o">.</span><span class="na">loadUrl</span><span class="o">(</span><span class="s">&quot;javascript:&quot;</span> <span class="o">+</span> <span class="n">injectString</span><span class="o">);</span>
</span><span class='line'><span class="n">myWebView</span><span class="o">.</span><span class="na">loadUrl</span><span class="o">(</span><span class="s">&quot;file:///android_asset/location.html&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>网页实现</h3>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'>  <span class="nt">&lt;head&gt;</span>
</span><span class='line'>      <span class="nt">&lt;title&gt;</span>i18n Test<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;body&gt;</span>
</span><span class='line'>      <span class="nt">&lt;label</span> <span class="na">id=</span><span class="s">&quot;country&quot;</span><span class="nt">&gt;&lt;/label&gt;</span>
</span><span class='line'>      <span class="nt">&lt;lable</span> <span class="na">id=</span><span class="s">&quot;city&quot;</span><span class="nt">&gt;&lt;/lable&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/body&gt;</span>
</span><span class='line'>  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;country&#39;</span><span class="p">).</span><span class="nx">innerText</span><span class="o">=</span> <span class="nx">textRes</span><span class="p">.</span><span class="nx">country</span>
</span><span class='line'>      <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;city&#39;</span><span class="p">).</span><span class="nx">innerText</span> <span class="o">=</span> <span class="nx">textRes</span><span class="p">.</span><span class="nx">city</span>
</span><span class='line'>  <span class="nt">&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>结果</h3>

<ul>
<li>当系统语言为中文简体环境下网页显示<strong>中国 北京</strong></li>
<li>当系统语言为非中文简体环境下网页显示<strong>China Beijing</strong></li>
</ul>


<h3>Demo源码下载</h3>

<p><a href="http://pan.baidu.com/s/1sjwNamL">@百度网盘</a></p>

<h3>其他</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B00ASIN7G8/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00ASIN7G8&linkCode=as2&tag=droidyue-23">这样才可以精通Android</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00ASIN7G8" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B002JCU2TG/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B002JCU2TG&linkCode=as2&tag=droidyue-23">瞬间之美:Web界面设计如何让用户心动</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B002JCU2TG" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[每周一脚本：js设置链接为新标签打开]]></title>
    <link href="http://droidyue.com/blog/2014/09/29/open-url-in-new-tab-using-javascript/"/>
    <updated>2014-09-29T21:59:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/09/29/open-url-in-new-tab-using-javascript</id>
    <content type="html"><![CDATA[<p>由于Markdown在编辑Octopress文章的链接时无法指定打开方式，所以很多时候需要使用html写。后来想了一下，为什么不通过javascript把超链接的打开方式默认成新标签实现呢。</p>

<!--more-->


<p>JQuery中提供了一个DOM元素插入事件 DOMNodeInserted ，我们可以通过监听这个事件，对没有target属性值的a标签设置其target为_blank。这样就实现了默认新标签打开了。</p>

<h3>脚本代码</h3>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="cm">/*To use the  DOMNodeInserted event listening, jquery is required*/</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;DOMNodeInserted&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;a[href^=&quot;http&quot;]&#39;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span>
</span><span class='line'>        <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;_blank&#39;</span><span class="p">)</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3>示例</h3>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;//code.jquery.com/jquery-1.11.0.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;https://rawgit.com/androidyue/weekly-scripts/master/javascript/target_blank_link.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;body&gt;</span>
</span><span class='line'>          <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://droidyue.com&quot;</span><span class="nt">&gt;</span>droidyue<span class="nt">&lt;/a&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>上述示例在浏览器加载之后，就会对a标签添加target=&ldquo;_blank&#8221;属性。</p>

<p><a href="https://github.com/androidyue/weekly-scripts/blob/master/javascript/target_blank_link.js">每周一脚本@Github</a></p>

<h3>其他</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B0089TDFNS/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B0089TDFNS&linkCode=as2&tag=droidyue-23">锋利的jQuery</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B0089TDFNS" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00BQ7RMW0/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00BQ7RMW0&linkCode=as2&tag=droidyue-23">编写可维护的JavaScript</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00BQ7RMW0" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00B14IGUK/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00B14IGUK&linkCode=as2&tag=droidyue-23">安全技术大系:Web前端黑客技术揭秘</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00B14IGUK" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Refused to execute script from because its MIME type (text/plain) is not executable, and strict MIME type checking is enabled]]></title>
    <link href="http://droidyue.com/blog/2014/09/27/refused-to-execute-script-from-because-its-mime-type-text-slash-plain-is-not-executable-and-strict-mime-type-checking-is-enabled/"/>
    <updated>2014-09-27T17:08:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/09/27/refused-to-execute-script-from-because-its-mime-type-text-slash-plain-is-not-executable-and-strict-mime-type-checking-is-enabled</id>
    <content type="html"><![CDATA[<p>今天又与这个问题相遇了,Orz,还是研究一下解决方法和出现原因吧。<br/>
刚刚在github上传了一个js文件，想让这个文件被其他网页引用，于是贴出了这个文件的raw版本的地址。但是却就遇到了这样的问题。</p>

<!--more-->


<p>这就是出现错误的代码</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;http://droidyue-tools.qiniudn.com/jquery.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;https://raw.githubusercontent.com/androidyue/weekly-scripts/master/javascript/target_blank_link.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>  <span class="nt">&lt;div&gt;</span>
</span><span class='line'>    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://droidyue.com&quot;</span><span class="nt">&gt;</span>droidyue.com<span class="nt">&lt;/a&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/div&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>解决方法</h2>

<p>将上面的链接中的<font color="red">raw.githubusercontent.com</font>换成<font color="red">rawgit.com</font>即可，此例中的网址最终为 <b><a href="https://rawgit.com/androidyue/weekly-scripts/master/javascript/target_blank_link.js">https://rawgit.com/androidyue/weekly-scripts/master/javascript/target_blank_link.js</a></b></p>

<h2>原因</h2>

<p>因为raw.githubusercontent.com在Response中设置了<strong>X-Content-Type-Options:nosniff</strong>，告诉浏览器强制检查资源的MIME，进行加载。</p>

<p>下面就是未处理的HTTP Response</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>HTTP/1.1 200 OK
</span><span class='line'>Date: Sat, 27 Sep 2014 09:27:12 GMT
</span><span class='line'>Server: Apache
</span><span class='line'>Access-Control-Allow-Origin: https://render.githubusercontent.com
</span><span class='line'>Content-Security-Policy: default-src <span class="s1">&#39;none&#39;</span>
</span><span class='line'>X-XSS-Protection: 1; <span class="nv">mode</span><span class="o">=</span>block
</span><span class='line'>X-Frame-Options: deny
</span><span class='line'>X-Content-Type-Options: nosniff
</span><span class='line'>Strict-Transport-Security: max-age<span class="o">=</span>31536000
</span><span class='line'>ETag: <span class="s2">&quot;4f10b14e4a81a195976ea05787287a019c8bcf6f&quot;</span>
</span><span class='line'>Content-Type: text/plain; <span class="nv">charset</span><span class="o">=</span>utf-8
</span><span class='line'>Cache-Control: max-age<span class="o">=</span>300
</span><span class='line'>Content-Encoding: gzip
</span><span class='line'>Content-Length: 204
</span><span class='line'>Accept-Ranges: bytes
</span><span class='line'>Via: 1.1 varnish
</span><span class='line'>X-Served-By: cache-lax1426-LAX
</span><span class='line'>X-Cache: HIT
</span><span class='line'>X-Cache-Hits: 1
</span><span class='line'>Vary: Authorization,Accept-Encoding
</span><span class='line'>Expires: Sat, 27 Sep 2014 09:32:12 GMT
</span><span class='line'>Source-Age: 44
</span><span class='line'>Keep-Alive: <span class="nv">timeout</span><span class="o">=</span>10, <span class="nv">max</span><span class="o">=</span>50
</span><span class='line'>Connection: Keep-Alive
</span></code></pre></td></tr></table></div></figure>


<h3>X-Content-Type-Options:nosniff 是神马</h3>

<p>  1 如果服务器发送响应头 &ldquo;X-Content-Type-Options: nosniff&#8221;，则 script 和 styleSheet 元素会拒绝包含错误的 MIME 类型的响应。这是一种安全功能，有助于防止基于 MIME类型混淆的攻击。</p>

<p>  2 服务器发送含有 &ldquo;X-Content-Type-Options: nosniff&rdquo; 标头的响应时，此更改会影响浏览器的行为。</p>

<p>  3 如果通过 styleSheet 参考检索到的响应中接收到 &ldquo;nosniff&rdquo; 指令，则 Windows Internet Explorer 不会加载“stylesheet”文件，除非 MIME 类型匹配 &ldquo;text/css&#8221;。</p>

<p>  4 如果通过 script 参考检索到的响应中接收到 &ldquo;nosniff&rdquo; 指令，则 Internet Explorer 不会加载“script”文件，除非 MIME 类型匹配以下值之一：</p>

<ul>
<li>&ldquo;application/ecmascript&rdquo;</li>
<li>&ldquo;application/javascript&rdquo;</li>
<li>&ldquo;application/x-javascript&rdquo;</li>
<li>&ldquo;text/ecmascript&rdquo;</li>
<li>&ldquo;text/javascript&rdquo;</li>
<li>&ldquo;text/jscript&rdquo;</li>
<li>&ldquo;text/x-javascript&rdquo;</li>
<li>&ldquo;text/vbs&rdquo;</li>
<li>&ldquo;text/vbscript&rdquo;</li>
</ul>


<p>该部分参考<a href="http://msdn.microsoft.com/zh-cn/library/ie/gg622941(v=vs.85).aspx">减少 MIME 类型的安全风险</a></p>

<h3>进阶书籍</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B00GOM5IL4/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00GOM5IL4&linkCode=as2&tag=droidyue-23">深入浅出Node.js</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00GOM5IL4" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B0097CON2S/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B0097CON2S&linkCode=as2&tag=droidyue-23">JavaScript语言精粹</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B0097CON2S" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00BQ7RMW0/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00BQ7RMW0&linkCode=as2&tag=droidyue-23">编写可维护的JavaScript</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00BQ7RMW0" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[MissingFormatArgumentException: Format specifier 's']]></title>
    <link href="http://droidyue.com/blog/2014/09/27/missingformatargumentexception-format-specifier-s/"/>
    <updated>2014-09-27T10:09:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/09/27/missingformatargumentexception-format-specifier-s</id>
    <content type="html"><![CDATA[<p>贴出一个简单的异常，分析一下原因，以及推荐一个相对好一些的替代方法。
如下，如果我们进行字符串格式化提供的值的数量少于字符串格式符（%s）的数量，就会抛出MissingFormatArgumentException异常。</p>

<!--more-->


<h3>错误代码</h3>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">String</span> <span class="n">format</span> <span class="o">=</span> <span class="s">&quot;%s/%s&quot;</span><span class="o">;</span>
</span><span class='line'><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">format</span><span class="o">,</span> <span class="s">&quot;a&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>崩溃信息</h3>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Exception</span> <span class="n">in</span> <span class="n">thread</span> <span class="s">&quot;main&quot;</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">MissingFormatArgumentException</span><span class="o">:</span> <span class="n">Format</span> <span class="n">specifier</span> <span class="sc">&#39;s&#39;</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">Unknown</span> <span class="n">Source</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">Unknown</span> <span class="n">Source</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">Unknown</span> <span class="n">Source</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">Concatenation</span><span class="o">.</span><span class="na">testFormat</span><span class="o">(</span><span class="n">Concatenation</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">17</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">Concatenation</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="n">Concatenation</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">4</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>替代方法</h3>

<p>相比字符串的格式化操作，使用字符串的替换更加安全，避免因为疏忽或者考虑不全等带来的崩溃问题。</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;%country%/%city%&quot;</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">&quot;%country%&quot;</span><span class="o">,</span> <span class="s">&quot;China&quot;</span><span class="o">).</span><span class="na">replace</span><span class="o">(</span><span class="s">&quot;%city%&quot;</span><span class="o">,</span> <span class="s">&quot;Beijing&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>其他</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B0084ASO7E/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B0084ASO7E&linkCode=as2&tag=droidyue-23">数学之美</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B0084ASO7E" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00D36S64K/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00D36S64K&linkCode=as2&tag=droidyue-23">像计算机科学家一样思考Java</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00D36S64K" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00HQW9FMO/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00HQW9FMO&linkCode=as2&tag=droidyue-23">微信公众平台应用开发:方法、技巧与案例</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00HQW9FMO" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[每周一脚本：批量对多个文件增加前缀]]></title>
    <link href="http://droidyue.com/blog/2014/09/22/weekly-script-add-prefix-to-mutiple-files-in-ruby/"/>
    <updated>2014-09-22T17:03:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/09/22/weekly-script-add-prefix-to-mutiple-files-in-ruby</id>
    <content type="html"><![CDATA[<p>最近从设计师那里get了超多的图，结果都是1.png，2.png这样的文件名，自己还需要将这些文件变成可读的文件名，不想一个一个得修改，于是就写了一个简单的脚本，实现批量对多个文件增加前缀的操作，后期修改了一下，分享一下。</p>

<!--more-->


<h2>代码</h2>

<figure class='code'><figcaption><span>lineos:false  add_prefix_files.rb</span><a href='https://raw.githubusercontent.com/androidyue/weekly-scripts/master/ruby/add_prefix_files.rb'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'><span class="c1"># encoding: utf-8</span>
</span><span class='line'>
</span><span class='line'><span class="n">srcDir</span><span class="o">=</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'><span class="n">prefix</span><span class="o">=</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'><span class="n">pattern</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
</span><span class='line'><span class="n">pattern</span> <span class="o">=</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="k">if</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">3</span>
</span><span class='line'>
</span><span class='line'><span class="no">Dir</span><span class="o">[</span><span class="n">srcDir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">pattern</span> <span class="o">].</span><span class="n">each</span><span class="p">{</span><span class="o">|</span><span class="n">child</span><span class="o">|</span>
</span><span class='line'>    <span class="n">childName</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
</span><span class='line'>    <span class="n">destChildName</span> <span class="o">=</span> <span class="n">prefix</span>  <span class="o">+</span> <span class="n">childName</span>
</span><span class='line'>    <span class="n">destChild</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="n">childName</span><span class="p">,</span> <span class="n">destChildName</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">system</span> <span class="s1">&#39;mv %s %s&#39;</span><span class="sx">%[child, destChild]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>如何使用</h2>

<h3>使用的方法</h3>

<ul>
<li><strong>ruby add_prefix_files.rb dest_folder prefix pattern</strong></li>
<li>dest_folder 必选 操作进行的基础目录，并不一定总是直接父目录</li>
<li>prefix      必须 前缀名称  建议结尾以_结束</li>
<li>pattern     可选，如不填写为dest_folder的直接子文件（含目录），否则应用提供的pattern匹配</li>
</ul>


<h3>使用示例</h3>

<p>对当前目录下所有文件增加test_前缀。</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">~</span><span class="sr">/rubydir/</span><span class="n">tools</span><span class="o">/</span><span class="n">add_prefix_files</span><span class="o">.</span><span class="n">rb</span> <span class="o">.</span><span class="n">/</span> <span class="n">test_</span>
</span></code></pre></td></tr></table></div></figure>


<p>对当前目录下res/drawable-hdpi/所有的png文件，增加test_前缀</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="o">~</span><span class="sr">/rubydir/</span><span class="n">tools</span><span class="o">/</span><span class="n">add_prefix_files</span><span class="o">.</span><span class="n">rb</span> <span class="o">.</span><span class="n">/</span> <span class="n">test_</span>  <span class="s2">&quot;res/drawable-hdpi/*.png&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>其他</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/0596009658/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=0596009658&linkCode=as2&tag=droidyue-23">Learning the Bash Shell</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=0596009658" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B0096EXMS8/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B0096EXMS8&linkCode=as2&tag=droidyue-23">Linux命令行与shell脚本编程大全</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B0096EXMS8" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00N75YP74/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00N75YP74&linkCode=as2&tag=droidyue-23">穿布鞋的马云:决定阿里巴巴生死的27个节点</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00N75YP74" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[获取shell脚本所在目录]]></title>
    <link href="http://droidyue.com/blog/2014/09/21/determine-shell-script-located-directory/"/>
    <updated>2014-09-21T17:48:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/09/21/determine-shell-script-located-directory</id>
    <content type="html"><![CDATA[<p>前几天写的<a href="https://portal.qiniu.com/signup?code=3l8cqx1u74rbm" target="_blank">七牛</a>的参赛demo，用bash写了一个便捷安装的脚本，涉及到了路径相关的判断，从<a href="http://stackoverflow.com/questions/59895/can-a-bash-script-tell-what-directory-its-stored-in" target="_blank">stackoverflow</a>，加上自己的实践整理一下。</p>

<!--more-->


<h3>简单版</h3>

<p>下面是一个最简单的实现，可以解决大多数问题，缺陷是对于软链接显示的是软链接所在的目录</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'><span class="nv">DIR</span><span class="o">=</span><span class="s2">&quot;$( cd &quot;</span><span class="k">$(</span> dirname <span class="s2">&quot;$0&quot;</span>  <span class="k">)</span><span class="s2">&quot; &amp;&amp; pwd  )&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>完善版</h3>

<p>这个版本解决了使用<code>ln -s target linkName</code>创造软链接无法正确取到真实脚本的问题。</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'><span class="nv">SOURCE</span><span class="o">=</span><span class="s2">&quot;$0&quot;</span>
</span><span class='line'><span class="k">while</span> <span class="o">[</span> -h <span class="s2">&quot;$SOURCE&quot;</span>  <span class="o">]</span>; <span class="k">do</span> <span class="c"># resolve $SOURCE until the file is no longer a symlink</span>
</span><span class='line'>    <span class="nv">DIR</span><span class="o">=</span><span class="s2">&quot;$( cd -P &quot;</span><span class="k">$(</span> dirname <span class="s2">&quot;$SOURCE&quot;</span>  <span class="k">)</span><span class="s2">&quot; &amp;&amp; pwd  )&quot;</span>
</span><span class='line'>    <span class="nv">SOURCE</span><span class="o">=</span><span class="s2">&quot;$(readlink &quot;</span><span class="nv">$SOURCE</span><span class="s2">&quot;)&quot;</span>
</span><span class='line'>    <span class="o">[[</span> <span class="nv">$SOURCE</span> !<span class="o">=</span> /*  <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">SOURCE</span><span class="o">=</span><span class="s2">&quot;$DIR/$SOURCE&quot;</span> <span class="c"># if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located</span>
</span><span class='line'><span class="k">done</span>
</span><span class='line'><span class="nv">DIR</span><span class="o">=</span><span class="s2">&quot;$( cd -P &quot;</span><span class="k">$(</span> dirname <span class="s2">&quot;$SOURCE&quot;</span>  <span class="k">)</span><span class="s2">&quot; &amp;&amp; pwd  )&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>其他</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/0596009658/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=0596009658&linkCode=as2&tag=droidyue-23">Learning the Bash Shell</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=0596009658" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B0096EXMS8/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B0096EXMS8&linkCode=as2&tag=droidyue-23">Linux命令行与shell脚本编程大全</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B0096EXMS8" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00N75YP74/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00N75YP74&linkCode=as2&tag=droidyue-23">穿布鞋的马云:决定阿里巴巴生死的27个节点</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00N75YP74" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Android中Java和JavaScript交互]]></title>
    <link href="http://droidyue.com/blog/2014/09/20/interaction-between-java-and-javascript-in-android/"/>
    <updated>2014-09-20T21:37:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/09/20/interaction-between-java-and-javascript-in-android</id>
    <content type="html"><![CDATA[<p>Android提供了一个很强大的WebView控件用来处理Web网页，而在网页中，JavaScript又是一个很举足轻重的脚本。本文将介绍如何实现Java代码和Javascript代码的相互调用。</p>

<!--more-->


<h2>如何实现</h2>

<p>实现Java和js交互十分便捷。通常只需要以下几步。</p>

<ul>
<li>WebView开启JavaScript脚本执行</li>
<li>WebView设置供JavaScript调用的交互接口。</li>
<li>客户端和网页端编写调用对方的代码。</li>
</ul>


<h2>本例代码</h2>

<p>为了便于讲解，先贴出全部代码</p>

<h3>Java代码</h3>

<figure class='code'><figcaption><span>lineos:false </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">javajsinteractiondemo</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.annotation.SuppressLint</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.app.Activity</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.view.Menu</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.webkit.JavascriptInterface</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.webkit.WebChromeClient</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.webkit.WebSettings</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.webkit.WebView</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.webkit.WebViewClient</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.widget.Toast</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">LOGTAG</span> <span class="o">=</span> <span class="s">&quot;MainActivity&quot;</span><span class="o">;</span>
</span><span class='line'>  <span class="nd">@SuppressLint</span><span class="o">(</span><span class="s">&quot;JavascriptInterface&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
</span><span class='line'>      <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>
</span><span class='line'>      <span class="kd">final</span> <span class="n">WebView</span> <span class="n">myWebView</span> <span class="o">=</span> <span class="o">(</span><span class="n">WebView</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">myWebView</span><span class="o">);</span>
</span><span class='line'>      <span class="n">WebSettings</span> <span class="n">settings</span> <span class="o">=</span> <span class="n">myWebView</span><span class="o">.</span><span class="na">getSettings</span><span class="o">();</span>
</span><span class='line'>      <span class="n">settings</span><span class="o">.</span><span class="na">setJavaScriptEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>      <span class="n">myWebView</span><span class="o">.</span><span class="na">addJavascriptInterface</span><span class="o">(</span><span class="k">new</span> <span class="n">JsInteration</span><span class="o">(),</span> <span class="s">&quot;control&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="n">myWebView</span><span class="o">.</span><span class="na">setWebChromeClient</span><span class="o">(</span><span class="k">new</span> <span class="n">WebChromeClient</span><span class="o">()</span> <span class="o">{});</span>
</span><span class='line'>      <span class="n">myWebView</span><span class="o">.</span><span class="na">setWebViewClient</span><span class="o">(</span><span class="k">new</span> <span class="n">WebViewClient</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>          <span class="nd">@Override</span>
</span><span class='line'>          <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onPageFinished</span><span class="o">(</span><span class="n">WebView</span> <span class="n">view</span><span class="o">,</span> <span class="n">String</span> <span class="n">url</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="kd">super</span><span class="o">.</span><span class="na">onPageFinished</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="n">url</span><span class="o">);</span>
</span><span class='line'>              <span class="n">testMethod</span><span class="o">(</span><span class="n">myWebView</span><span class="o">);</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>          
</span><span class='line'>      <span class="o">});</span>
</span><span class='line'>      <span class="n">myWebView</span><span class="o">.</span><span class="na">loadUrl</span><span class="o">(</span><span class="s">&quot;file:///android_asset/js_java_interaction.html&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">testMethod</span><span class="o">(</span><span class="n">WebView</span> <span class="n">webView</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">String</span> <span class="n">call</span> <span class="o">=</span> <span class="s">&quot;javascript:sayHello()&quot;</span><span class="o">;</span>
</span><span class='line'>      
</span><span class='line'>      <span class="n">call</span> <span class="o">=</span> <span class="s">&quot;javascript:alertMessage(\&quot;&quot;</span> <span class="o">+</span> <span class="s">&quot;content&quot;</span> <span class="o">+</span> <span class="s">&quot;\&quot;)&quot;</span><span class="o">;</span>
</span><span class='line'>      
</span><span class='line'>      <span class="n">call</span> <span class="o">=</span> <span class="s">&quot;javascript:toastMessage(\&quot;&quot;</span> <span class="o">+</span> <span class="s">&quot;content&quot;</span> <span class="o">+</span> <span class="s">&quot;\&quot;)&quot;</span><span class="o">;</span>
</span><span class='line'>      
</span><span class='line'>      <span class="n">call</span> <span class="o">=</span> <span class="s">&quot;javascript:sumToJava(1,2)&quot;</span><span class="o">;</span>
</span><span class='line'>      <span class="n">webView</span><span class="o">.</span><span class="na">loadUrl</span><span class="o">(</span><span class="n">call</span><span class="o">);</span>
</span><span class='line'>      
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">JsInteration</span> <span class="o">{</span>
</span><span class='line'>      
</span><span class='line'>      <span class="nd">@JavascriptInterface</span>
</span><span class='line'>      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">toastMessage</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">getApplicationContext</span><span class="o">(),</span> <span class="n">message</span><span class="o">,</span> <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_LONG</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      
</span><span class='line'>      <span class="nd">@JavascriptInterface</span>
</span><span class='line'>      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSumResult</span><span class="o">(</span><span class="kt">int</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">LOGTAG</span><span class="o">,</span> <span class="s">&quot;onSumResult result=&quot;</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>前端网页代码</h3>

<figure class='code'><figcaption><span>lineos:false js_java_interaction.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">sayHello</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Hello&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">alertMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">alert</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">toastMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">window</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">toastMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">sumToJava</span><span class="p">(</span><span class="nx">number1</span><span class="p">,</span> <span class="nx">number2</span><span class="p">){</span>
</span><span class='line'>       <span class="nb">window</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">onSumResult</span><span class="p">(</span><span class="nx">number1</span> <span class="o">+</span> <span class="nx">number2</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span><span class='line'>Java-Javascript Interaction In Android
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<h2>调用示例</h2>

<h3>js调用Java</h3>

<p>调用格式为window.jsInterfaceName.methodName(parameterValues)
此例中我们使用的是control作为注入接口名称。</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>function toastMessage(message) {
</span><span class='line'>  window.control.toastMessage(message)
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>function sumToJava(number1, number2){
</span><span class='line'>   window.control.onSumResult(number1 + number2)
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<h3>Java调用JS</h3>

<p>webView调用js的基本格式为webView.loadUrl(&ldquo;javascript:methodName(parameterValues)&rdquo;)</p>

<h4>调用js无参无返回值函数</h4>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">String</span> <span class="n">call</span> <span class="o">=</span> <span class="s">&quot;javascript:sayHello()&quot;</span><span class="o">;</span>
</span><span class='line'><span class="n">webView</span><span class="o">.</span><span class="na">loadUrl</span><span class="o">(</span><span class="n">call</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h4>调用js有参无返回值函数</h4>

<p>注意对于字符串作为参数值需要进行转义双引号。</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">String</span> <span class="n">call</span> <span class="o">=</span> <span class="s">&quot;javascript:alertMessage(\&quot;&quot;</span> <span class="o">+</span> <span class="s">&quot;content&quot;</span> <span class="o">+</span> <span class="s">&quot;\&quot;)&quot;</span><span class="o">;</span>
</span><span class='line'><span class="n">webView</span><span class="o">.</span><span class="na">loadUrl</span><span class="o">(</span><span class="n">call</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h4>调用js有参数有返回值的函数</h4>

<p>Android在4.4之前并没有提供直接调用js函数并获取值的方法，所以在此之前，常用的思路是 java调用js方法，js方法执行完毕，再次调用java代码将值返回。</p>

<h5>1.Java调用js代码</h5>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">String</span> <span class="n">call</span> <span class="o">=</span> <span class="s">&quot;javascript:sumToJava(1,2)&quot;</span><span class="o">;</span>
</span><span class='line'><span class="n">webView</span><span class="o">.</span><span class="na">loadUrl</span><span class="o">(</span><span class="n">call</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h5>2.js函数处理，并将结果通过调用java方法返回</h5>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">sumToJava</span><span class="p">(</span><span class="nx">number1</span><span class="p">,</span> <span class="nx">number2</span><span class="p">){</span>
</span><span class='line'>       <span class="nb">window</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">onSumResult</span><span class="p">(</span><span class="nx">number1</span> <span class="o">+</span> <span class="nx">number2</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h5>3.Java在回调方法中获取js函数返回值</h5>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@JavascriptInterface</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSumResult</span><span class="o">(</span><span class="kt">int</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">LOGTAG</span><span class="o">,</span> <span class="s">&quot;onSumResult result=&quot;</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4><font color="blue">4.4处理</font></h4>

<p>Android 4.4之后使用evaluateJavascript即可。这里展示一个简单的交互示例
具有返回值的js方法</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>function getGreetings() {
</span><span class='line'>      return 1;
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>java代码时用evaluateJavascript方法调用</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">testEvaluateJavascript</span><span class="o">(</span><span class="n">WebView</span> <span class="n">webView</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">webView</span><span class="o">.</span><span class="na">evaluateJavascript</span><span class="o">(</span><span class="s">&quot;getGreetings()&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">ValueCallback</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;()</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onReceiveValue</span><span class="o">(</span><span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">LOGTAG</span><span class="o">,</span> <span class="s">&quot;onReceiveValue value=&quot;</span> <span class="o">+</span> <span class="n">value</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}});</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>输出结果</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>I/MainActivity<span class="o">(</span> 1432<span class="o">)</span>: onReceiveValue <span class="nv">value</span><span class="o">=</span>1
</span></code></pre></td></tr></table></div></figure>


<p>注意</p>

<ul>
<li>上面限定了结果返回结果为String，对于简单的类型会尝试转换成字符串返回，对于复杂的数据类型，建议以字符串形式的json返回。</li>
<li>evaluateJavascript方法必须在UI线程（主线程）调用，因此onReceiveValue也执行在主线程。</li>
</ul>


<h2>疑问解答</h2>

<h3><font color="red">Alert无法弹出</font></h3>

<p>你应该是没有设置WebChromeClient,按照以下代码设置</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">myWebView</span><span class="o">.</span><span class="na">setWebChromeClient</span><span class="o">(</span><span class="k">new</span> <span class="n">WebChromeClient</span><span class="o">()</span> <span class="o">{});</span>
</span></code></pre></td></tr></table></div></figure>


<h3><font color="red">Uncaught ReferenceError: functionName is not defined</font></h3>

<p>问题出现原因，<strong>网页的js代码没有加载完成</strong>，就调用了js方法。解决方法是在网页加载完成之后调用js方法</p>

<figure class='code'><figcaption><span>fileos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">myWebView</span><span class="o">.</span><span class="na">setWebViewClient</span><span class="o">(</span><span class="k">new</span> <span class="n">WebViewClient</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onPageFinished</span><span class="o">(</span><span class="n">WebView</span> <span class="n">view</span><span class="o">,</span> <span class="n">String</span> <span class="n">url</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="kd">super</span><span class="o">.</span><span class="na">onPageFinished</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="n">url</span><span class="o">);</span>
</span><span class='line'>      <span class="c1">//在这里执行你想调用的js函数</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'><span class="o">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3><font color="red">Uncaught TypeError: Object [object Object] has no method</font></h3>

<h4>安全限制问题</h4>

<p>如果只在4.2版本以上的机器出问题，那么就是系统处于安全限制的问题了。Android文档这样说的</p>

<blockquote><p>Caution: If you&rsquo;ve set your targetSdkVersion to 17 or higher, you must add the @JavascriptInterface annotation to any method that you want available your web page code (the method must also be public). If you do not provide the annotation, then the method will not accessible by your web page when running on Android 4.2 or higher.</p></blockquote>

<p>中文大意为</p>

<blockquote><p>警告：如果你的程序目标平台是17或者是更高，你必须要在暴露给网页可调用的方法（这个方法必须是公开的）加上@JavascriptInterface注释。如果你不这样做的话，在4.2以以后的平台上，网页无法访问到你的方法。</p></blockquote>

<h5>两种解决方法</h5>

<ul>
<li>将targetSdkVersion设置成17或更高，引入@JavascriptInterface注释</li>
<li>自己创建一个注释接口名字为@JavascriptInterface，然后将其引入。注意这个接口不能混淆。</li>
</ul>


<p>注，创建@JavascriptInterface代码</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="nd">@interface</span> <span class="n">JavascriptInterface</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>代码混淆问题</h4>

<p>如果在没有混淆的版本运行正常，在混淆后的版本的代码运行错误，并提示Uncaught TypeError: Object [object Object] has no method，那就是你没有做混淆例外处理。
在混淆文件加入类似这样的代码</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">-</span><span class="n">keep</span> <span class="k">class</span> <span class="n">com</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">javajsinteractiondemo</span><span class="vg">$JsInteration</span> <span class="p">{</span>
</span><span class='line'>    <span class="o">*</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3><font color="red">All WebView methods must be called on the same thread</font></h3>

<p>过滤日志曾发现过这个问题。</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">StrictMode</span><span class="o">(</span> <span class="mi">1546</span><span class="o">):</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Throwable</span><span class="o">:</span> <span class="n">A</span> <span class="n">WebView</span> <span class="n">method</span> <span class="n">was</span> <span class="n">called</span> <span class="n">on</span> <span class="n">thread</span> <span class="err">&#39;</span><span class="n">JavaBridge</span><span class="err">&#39;</span><span class="o">.</span> <span class="n">All</span> <span class="n">WebView</span> <span class="n">methods</span> <span class="n">must</span> <span class="n">be</span> <span class="n">called</span> <span class="n">on</span> <span class="n">the</span> <span class="n">same</span> <span class="n">thread</span><span class="o">.</span> <span class="o">(</span><span class="n">Expected</span> <span class="n">Looper</span> <span class="n">Looper</span> <span class="o">(</span><span class="n">main</span><span class="o">,</span> <span class="n">tid</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span><span class="mi">528712</span><span class="n">d4</span><span class="o">}</span> <span class="n">called</span> <span class="n">on</span> <span class="n">Looper</span> <span class="o">(</span><span class="n">JavaBridge</span><span class="o">,</span> <span class="n">tid</span> <span class="mi">121</span><span class="o">)</span> <span class="o">{</span><span class="mi">52</span><span class="n">b6678c</span><span class="o">},</span> <span class="n">FYI</span> <span class="n">main</span> <span class="n">Looper</span> <span class="n">is</span> <span class="n">Looper</span> <span class="o">(</span><span class="n">main</span><span class="o">,</span> <span class="n">tid</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span><span class="mi">528712</span><span class="n">d4</span><span class="o">})</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">StrictMode</span><span class="o">(</span> <span class="mi">1546</span><span class="o">):</span>   <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">webkit</span><span class="o">.</span><span class="na">WebView</span><span class="o">.</span><span class="na">checkThread</span><span class="o">(</span><span class="n">WebView</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">2063</span><span class="o">)</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">StrictMode</span><span class="o">(</span> <span class="mi">1546</span><span class="o">):</span>   <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">webkit</span><span class="o">.</span><span class="na">WebView</span><span class="o">.</span><span class="na">loadUrl</span><span class="o">(</span><span class="n">WebView</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">794</span><span class="o">)</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">StrictMode</span><span class="o">(</span> <span class="mi">1546</span><span class="o">):</span>   <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">xxx</span><span class="o">.</span><span class="na">xxxx</span><span class="o">.</span><span class="na">xxxx</span><span class="o">.</span><span class="na">xxxx</span><span class="o">.</span><span class="na">xxxxxxx</span><span class="n">$JavaScriptInterface</span><span class="o">.</span><span class="na">onCanGoBackResult</span><span class="o">(</span><span class="n">xxxx</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">96</span><span class="o">)</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">StrictMode</span><span class="o">(</span> <span class="mi">1546</span><span class="o">):</span>   <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">chromium</span><span class="o">.</span><span class="na">base</span><span class="o">.</span><span class="na">SystemMessageHandler</span><span class="o">.</span><span class="na">nativeDoRunLoopOnce</span><span class="o">(</span><span class="n">Native</span> <span class="n">Method</span><span class="o">)</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">StrictMode</span><span class="o">(</span> <span class="mi">1546</span><span class="o">):</span>   <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">chromium</span><span class="o">.</span><span class="na">base</span><span class="o">.</span><span class="na">SystemMessageHandler</span><span class="o">.</span><span class="na">handleMessage</span><span class="o">(</span><span class="n">SystemMessageHandler</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">27</span><span class="o">)</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">StrictMode</span><span class="o">(</span> <span class="mi">1546</span><span class="o">):</span>   <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Handler</span><span class="o">.</span><span class="na">dispatchMessage</span><span class="o">(</span><span class="n">Handler</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">102</span><span class="o">)</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">StrictMode</span><span class="o">(</span> <span class="mi">1546</span><span class="o">):</span>   <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Looper</span><span class="o">.</span><span class="na">loop</span><span class="o">(</span><span class="n">Looper</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">136</span><span class="o">)</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">StrictMode</span><span class="o">(</span> <span class="mi">1546</span><span class="o">):</span>   <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">HandlerThread</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">HandlerThread</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">61</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>在js调用后的Java回调线程并不是主线程。如打印日志可验证</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">ThreadInfo</span><span class="o">=</span>Thread<span class="o">[</span>WebViewCoreThread,5,main<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>解决上述的异常，将webview操作放在主线程中即可。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">webView</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">webView</span><span class="o">.</span><span class="na">loadUrl</span><span class="o">(</span><span class="n">YOUR_URL</span><span class="o">).</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3>其他</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B00LVHTI9U/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00LVHTI9U&linkCode=as2&tag=droidyue-23">第一行代码:Android</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00LVHTI9U" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B0097CON2S/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B0097CON2S&linkCode=as2&tag=droidyue-23">JavaScript语言精粹</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B0097CON2S" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00B14IGUK/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00B14IGUK&linkCode=as2&tag=droidyue-23">安全技术大系:Web前端黑客技术揭秘</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00B14IGUK" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[每周一脚本：过滤单个Android程序日志]]></title>
    <link href="http://droidyue.com/blog/2014/09/15/weekly-scripts-grep-android-application-log-in-terminal/"/>
    <updated>2014-09-15T18:55:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/09/15/weekly-scripts-grep-android-application-log-in-terminal</id>
    <content type="html"><![CDATA[<p>在Android软件开发中，增加日志的作用很重要，便于我们了解程序的执行情况和数据。Eclipse开发工具会提供了可视化的工具，但是还是感觉终端效率会高一些，于是自己写了一个python的脚本来通过包名来过滤某一程序的日志。</p>

<h3>原理</h3>

<p>通过包名得到对应的进程ID（可能多个），然后使用adb logcat 过滤进程ID即可得到对应程序的日志。</p>

<!--more-->


<h3>源码</h3>

<figure class='code'><figcaption><span>lineos:false</span><a href='https://raw.githubusercontent.com/androidyue/weekly-scripts/master/python/logcatPkg.py'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/env python</span>
</span><span class='line'><span class="c">#coding:utf-8</span>
</span><span class='line'><span class="c">#This script is aimed to grep logs by application(User should input a packageName and then we look up for the process ids then separate logs by process ids).</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'>
</span><span class='line'><span class="n">packageName</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="n">command</span> <span class="o">=</span> <span class="s">&quot;adb shell ps | grep </span><span class="si">%s</span><span class="s"> | awk &#39;{print $2}&#39;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">packageName</span><span class="p">)</span>
</span><span class='line'><span class="n">p</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span class='line'><span class="c">##for some applications,there are multiple processes,so we should get all the process id</span>
</span><span class='line'><span class="n">pid</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span class='line'><span class="n">filters</span> <span class="o">=</span> <span class="n">pid</span>
</span><span class='line'><span class="k">while</span><span class="p">(</span><span class="n">pid</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
</span><span class='line'>    <span class="n">pid</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
</span><span class='line'>        <span class="n">filters</span> <span class="o">=</span> <span class="n">filters</span> <span class="o">+</span>  <span class="s">&quot;|&quot;</span> <span class="o">+</span> <span class="n">pid</span>
</span><span class='line'>        <span class="c">#print &#39;command = %s;filters=%s&#39;%(command, filters)</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">filters</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="p">:</span>
</span><span class='line'>    <span class="n">cmd</span> <span class="o">=</span> <span class="s">&#39;adb logcat | grep --color=always -E &quot;</span><span class="si">%s</span><span class="s">&quot; &#39;</span><span class="o">%</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>
</span><span class='line'>    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>使用方法</h3>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>python logcatPkg.py com.mx.browser
</span></code></pre></td></tr></table></div></figure>


<h3>最新代码</h3>

<p> <a href="https://raw.githubusercontent.com/androidyue/weekly-scripts/master/python/logcatPkg.py" target="_blank">locatPkg.py</a></p>

<h3>不足</h3>

<ul>
<li> 当脚本执行后，Android程序如果关闭或者重新启动，导致进程ID变化，无法自动继续输出日志，只能再次执行此脚本。</li>
</ul>


<h3>其他</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B00KVLDS20/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00KVLDS20&linkCode=as2&tag=droidyue-23">仅用两周就能自制脚本语言？</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00KVLDS20" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B002A2LQR2/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B002A2LQR2&linkCode=as2&tag=droidyue-23">一个不错的Shell脚本学习指南</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B002A2LQR2" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B005YWYH6C/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B005YWYH6C&linkCode=as2&tag=droidyue-23">Windows 7脚本编程和命令行工具指南</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B005YWYH6C" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[我的七牛参赛作品]]></title>
    <link href="http://droidyue.com/blog/2014/09/13/my-work-for-qiniu-demo/"/>
    <updated>2014-09-13T13:19:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/09/13/my-work-for-qiniu-demo</id>
    <content type="html"><![CDATA[<p>使用Ocopress写博客将近一年多了，大概几个月前同事给我推荐了<a href="https://portal.qiniu.com/signup?code=3l8cqx1u74rbm" target="_blank">七牛</a>做网站的静态文件存储服务，于是果断尝试了一下，发现真实不错。速度不错，而且有免费套餐。很是支持。最近发现七牛有一个demo大赛，于是果断参加了。</p>

<!--more-->


<h2>痛点</h2>

<ul>
<li>域名Godaddy购买，无法备案，不能使用七牛的独立域名绑定</li>
<li>服务器为github pages， 有300M空间限制，所以只能把静态文件放到七牛</li>
<li>每次写带图片等资源的博客，都需要先上传到七牛，然后得到外链地址，贴回到博客，过于繁琐啦。</li>
</ul>


<h2>解决思路</h2>

<p>由于ocotpress程序是将markdown文档转换成纯静态的HTML网页，我们可以在这个转换过程之前或者期间将图片等资源自动上传到七牛服务器，然后替换这些资源的地址为已上传文件的外链。</p>

<h2>实现细节</h2>

<ul>
<li>通过rb-inotify检测文件变化，新文件会直接上传，已经上传过的文件则覆盖更新。避免在生成html网页时大量拥挤上传</li>
<li>进行rake generate时，对没有上传的文件进行上传</li>
<li>通过sqlite数据库，记录文件路径和最后修改时间进行验证。</li>
</ul>


<h2>好处</h2>

<ul>
<li>节省了博客在github中的空间占用，让github空间限制几乎不再存在。只剩纯文本了，能占用多少空间</li>
<li>提高了在国内的访问的速度</li>
<li>使用更多的七牛的服务，比如防盗链等功能。</li>
</ul>


<h2>安装</h2>

<p>如果尚未安装Octopress，请参考<a href="http://blog.segmentfault.com/yaashion_xiang/1190000000364677" target="_blank">本文</a>安装。</p>

<h3>超级简单的一步安装</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd </span>YOUR_OCTOPRESS_ROOT_DIR
</span><span class='line'>curl -o /tmp/install.sh https://gitcafe.com/androidyue/octopress_qiniu/raw/master/install.sh <span class="o">&amp;&amp;</span> bash /tmp/install.sh
</span></code></pre></td></tr></table></div></figure>


<h3>配置文件</h3>

<p>安装过程中，会使用vi打开一个配置文件，文件内容为，文件路径位于家目录下的.qiniu.ini。按照自己的实际情况填写配置即可。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#Qiniu Config File</span>
</span><span class='line'>
</span><span class='line'><span class="c">#Project</span>
</span><span class='line'><span class="o">[</span>octopress<span class="o">]</span>
</span><span class='line'><span class="c">#Your Bucket to Store Images In Octopress</span>
</span><span class='line'><span class="nv">image_bucket</span> <span class="o">=</span> <span class="s2">&quot;your_bucket&quot;</span>
</span><span class='line'><span class="c">#Your Image Folder Path to store the files locally. Usually it&#39;s #{OCTORESS_DIRECTORY}/public/images/</span>
</span><span class='line'><span class="nv">image_dir</span> <span class="o">=</span> <span class="s2">&quot;image_dir_in_octopress&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c">#Auth Info</span>
</span><span class='line'><span class="c">#Generate two following two keys in Qiniu Web Portal</span>
</span><span class='line'><span class="o">[</span>auth<span class="o">]</span>
</span><span class='line'><span class="nv">access_key</span> <span class="o">=</span> <span class="s2">&quot;your_access_key&quot;</span>
</span><span class='line'><span class="nv">secret_key</span> <span class="o">=</span> <span class="s2">&quot;your_secret_key&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>启动程序</h2>

<p>配置完成，轻松执行一个脚本就可以启动监控文件变化自动上传的程序了。当检测目录有文件变化时就会自动上传到七牛的文件服务器。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>YOUR_OCTOPRESS_ROOT_DIR/startQiniu.sh
</span></code></pre></td></tr></table></div></figure>


<h2>文件介绍</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>.
</span><span class='line'>|-- install.sh  <span class="c">#快捷安装脚本</span>
</span><span class='line'>|-- octopress   <span class="c">#覆盖octopress程序的目录</span>
</span><span class='line'>|   <span class="sb">`</span>-- plugins
</span><span class='line'>|       <span class="sb">`</span>-- image_tag.rb <span class="c"># 覆盖Octopress 程序自带的image_tag，实现图片上传到七牛</span>
</span><span class='line'>|-- qiniu       <span class="c">#工具程序的主目录</span>
</span><span class='line'>|   |-- qiniuCLI.rb    <span class="c">#命令行工具，这个工具是所有上传下载请求的对外处理程序，本工具中所有的请求都是直接调用这个工具。</span>
</span><span class='line'>|   |-- .qiniu_config_template.ini <span class="c">#配置文件模板，不要对这个文件直接配置，请使用家目录下的.qiniu.ini进行配置</span>
</span><span class='line'>|   |-- qiniuCore.rb   <span class="c">#最主要的处理脚本。支持从ini文件读取配置，数据库存储文件的上传信息，调用七牛的SDK来完成文件的上传和下载。</span>
</span><span class='line'>|   |-- .qiniu.db      <span class="c">#数据库文件，存储上传的记录</span>
</span><span class='line'>|   |-- qiniuFileNotifier.rb  <span class="c">#监控配置目录变化，自动上传或者覆盖文件。</span>
</span><span class='line'>|   <span class="sb">`</span>-- .setupQiniu.rb <span class="c">#安装需要的gem，复制配置文件到家目录</span>
</span><span class='line'>|-- README.md  <span class="c">#说明文件</span>
</span><span class='line'><span class="sb">`</span>-- startQiniu.sh <span class="c">#检查安装情况并启动文件监控自动上传启动程序</span>
</span></code></pre></td></tr></table></div></figure>


<h2>源码地址</h2>

<ul>
<li><a href="https://gitcafe.com/androidyue/octopress_qiniu" target="_blank">我的七牛参赛作品</a></li>
</ul>


<h3>解答问题</h3>

<ul>
<li>提问：为什么配置文件放在家目录下</li>
<li><p>回答：配置文件中包含了七牛的accessKey和accessSecret，默认的ocotpress受git管理，为了避免将配置文件误加入git管理，传到服务器端造成前面的accessKey和acessSecret泄露，所以放到家目录下。</p></li>
<li><p>提问：既然文件都上传到了，是不是可以删除掉存储到public/images/的文件</p></li>
<li>回答：当然可以，因为生成的网页的图片地址为七牛的外链地址，目前程序没有做主动删除文件的操作。</li>
</ul>


<h3>投票地址</h3>

<p>我的作品名称<strong>octopress_qiniu</strong></p>

<p><a href="http://campaign.gitcafe.com/qiniu-demo?page=11">投票地址</a></p>

<p>最后希望大家多多支持，投我一票哈。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Android根据资源名获取资源ID]]></title>
    <link href="http://droidyue.com/blog/2014/09/12/get-resource-id-by-name-in-android/"/>
    <updated>2014-09-12T22:12:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/09/12/get-resource-id-by-name-in-android</id>
    <content type="html"><![CDATA[<p>接触过Android开发的同学们都知道在Android中访问程序资源基本都是通过资源ID来访问。这样开发起来很简单，并且可以不去考虑各种分辨率，语言等不同资源显式指定。</p>

<!--more-->


<h2>痛点</h2>

<p>但是，有时候也会有一些问题，比如我们根据服务器端的值取图片，但是服务器端绝对不会返回给我们的是资源id，最多是一种和文件名相关联的值，操作资源少的时候，可以维护一个容器进行值与资源ID的映射，但是多的话，就需要另想办法了。</p>

<h3>便捷的方法</h3>

<p>在这种情况下，使用文件名来得到资源ID显得事半功倍。
通过调用Resources的getIdentifier可以很轻松地得到资源ID。
几个简单的示例</p>

<figure class='code'><figcaption><span>lineos:false </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Resources</span> <span class="n">res</span> <span class="o">=</span> <span class="n">getResources</span><span class="o">();</span>
</span><span class='line'><span class="kd">final</span> <span class="n">String</span> <span class="n">packageName</span> <span class="o">=</span> <span class="n">getPackageName</span><span class="o">();</span>
</span><span class='line'><span class="kt">int</span> <span class="n">imageResId</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="na">getIdentifier</span><span class="o">(</span><span class="s">&quot;ic_launcher&quot;</span><span class="o">,</span> <span class="s">&quot;drawable&quot;</span><span class="o">,</span> <span class="n">packageName</span><span class="o">);</span>
</span><span class='line'><span class="kt">int</span> <span class="n">imageResIdByAnotherForm</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="na">getIdentifier</span><span class="o">(</span><span class="n">packageName</span> <span class="o">+</span> <span class="s">&quot;:drawable/ic_launcher&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>  
</span><span class='line'><span class="kt">int</span> <span class="n">musicResId</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="na">getIdentifier</span><span class="o">(</span><span class="s">&quot;test&quot;</span><span class="o">,</span> <span class="s">&quot;raw&quot;</span><span class="o">,</span> <span class="n">packageName</span><span class="o">);</span>
</span><span class='line'>      
</span><span class='line'><span class="kt">int</span> <span class="n">notFoundResId</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="na">getIdentifier</span><span class="o">(</span><span class="s">&quot;activity_main&quot;</span><span class="o">,</span> <span class="s">&quot;drawable&quot;</span><span class="o">,</span> <span class="n">packageName</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">LOGTAG</span><span class="o">,</span> <span class="s">&quot;testGetResourceIds imageResId = &quot;</span> <span class="o">+</span> <span class="n">imageResId</span>
</span><span class='line'>              <span class="o">+</span> <span class="s">&quot;;imageResIdByAnotherForm = &quot;</span> <span class="o">+</span> <span class="n">imageResIdByAnotherForm</span>
</span><span class='line'>              <span class="o">+</span> <span class="s">&quot;;musicResId=&quot;</span> <span class="o">+</span> <span class="n">musicResId</span>
</span><span class='line'>              <span class="o">+</span> <span class="s">&quot;;notFoundResId =&quot;</span> <span class="o">+</span> <span class="n">notFoundResId</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>运行结果</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>I/MainActivity<span class="o">(</span> 4537<span class="o">)</span>: testGetResourceIds <span class="nv">imageResId</span> <span class="o">=</span> 2130837504;imageResIdByAnotherForm <span class="o">=</span> 2130837504;musicResId<span class="o">=</span>2130968576;notFoundResId <span class="o">=</span>0
</span></code></pre></td></tr></table></div></figure>


<h2>看一看API</h2>

<h3>直接API</h3>

<ul>
<li>这个方法用来使用资源名来获取资源ID</li>
<li>完整的资源名为<code>package:type/entry</code>，如果资源名这个参数有完整地指定，后面的defType和defPackage可以省略。</li>
<li>defType和defPackage省略时，需要将其设置成null</li>
<li>注意这个方法不提倡，因为直接通过资源ID访问资源会更加效率高</li>
<li>如果资源没有找到，返回0,在Android资源ID中0不是合法的资源ID。</li>
</ul>


<figure class='code'><figcaption><span>lineos:false android.content.res.Resources.class</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm">     * Return a resource identifier for the given resource name.  A fully</span>
</span><span class='line'><span class="cm">     * qualified resource name is of the form &quot;package:type/entry&quot;.  The first</span>
</span><span class='line'><span class="cm">     * two components (package and type) are optional if defType and</span>
</span><span class='line'><span class="cm">     * defPackage, respectively, are specified here.</span>
</span><span class='line'><span class="cm">     * </span>
</span><span class='line'><span class="cm">     * &lt;p&gt;Note: use of this function is discouraged.  It is much more</span>
</span><span class='line'><span class="cm">     * efficient to retrieve resources by identifier than by name.</span>
</span><span class='line'><span class="cm">     * </span>
</span><span class='line'><span class="cm">     * @param name The name of the desired resource.</span>
</span><span class='line'><span class="cm">     * @param defType Optional default resource type to find, if &quot;type/&quot; is</span>
</span><span class='line'><span class="cm">     *                not included in the name.  Can be null to require an</span>
</span><span class='line'><span class="cm">     *                explicit type.</span>
</span><span class='line'><span class="cm">     * @param defPackage Optional default package to find, if &quot;package:&quot; is</span>
</span><span class='line'><span class="cm">     *                   not included in the name.  Can be null to require an</span>
</span><span class='line'><span class="cm">     *                   explicit package.</span>
</span><span class='line'><span class="cm">     * </span>
</span><span class='line'><span class="cm">     * @return int The associated resource identifier.  Returns 0 if no such</span>
</span><span class='line'><span class="cm">     *         resource was found.  (0 is not a valid resource ID.)</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getIdentifier</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">String</span> <span class="n">defType</span><span class="o">,</span> <span class="n">String</span> <span class="n">defPackage</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="c1">// Ignore</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">mAssets</span><span class="o">.</span><span class="na">getResourceIdentifier</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">defType</span><span class="o">,</span> <span class="n">defPackage</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>间接API</h3>

<p>实际上上述API调用的是AssetManager.class中的native方法。</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm">     * Retrieve the resource identifier for the given resource name.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="cm">/*package*/</span> <span class="kd">native</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">getResourceIdentifier</span><span class="o">(</span><span class="n">String</span> <span class="n">type</span><span class="o">,</span>
</span><span class='line'>                                                       <span class="n">String</span> <span class="n">name</span><span class="o">,</span>
</span><span class='line'>                                                       <span class="n">String</span> <span class="n">defPackage</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>其他</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B00J4DXWDG/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00J4DXWDG&linkCode=as2&tag=droidyue-23">Android编程权威指南</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00J4DXWDG" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B0011F7WU4/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B0011F7WU4&linkCode=as2&tag=droidyue-23">收藏必备：Java编程思想</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B0011F7WU4" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B0011C2P7W/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B0011C2P7W&linkCode=as2&tag=droidyue-23">经典著作：人月神话</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B0011C2P7W" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[十分钟掌握SQLite操作]]></title>
    <link href="http://droidyue.com/blog/2014/09/08/learn-sqlite-in-a-very-fast-way/"/>
    <updated>2014-09-08T20:45:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/09/08/learn-sqlite-in-a-very-fast-way</id>
    <content type="html"><![CDATA[<p>最近用Ruby写了一个七牛的demo参赛作品，使用了sqlite3，用到很多操作，利用假期的时间，简单做一个快速掌握SQLite命令的小入门。</p>

<p>SQLite是一个开放源代码的数据库引擎，具有独立，无服务器依赖，零配置，支持事务等特点。SQLite一直以轻量级为特点，在移动和嵌入式设备上使用广泛，官方称其是世界上部署最广泛的数据库引擎。</p>

<!--more-->


<p>本文主要侧重部分常用操作命令的介绍。试图以最简单的示例来展示如何操作。</p>

<h2>强大的命令集</h2>

<p>首先我们看一下sqlite3提供了哪些强大的命令。</p>

<figure class='code'><figcaption><span>fileos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sqlite&gt; .help
</span><span class='line'>.backup ?DB? FILE      Backup DB <span class="o">(</span>default <span class="s2">&quot;main&quot;</span><span class="o">)</span> to FILE
</span><span class='line'>.bail ON|OFF           Stop after hitting an error.  Default OFF
</span><span class='line'>.databases             List names and files of attached databases
</span><span class='line'>.dump ?TABLE? ...      Dump the database in an SQL text format
</span><span class='line'>                         If TABLE specified, only dump tables matching
</span><span class='line'>                         LIKE pattern TABLE.
</span><span class='line'>.echo ON|OFF           Turn <span class="nb">command echo </span>on or off
</span><span class='line'>.exit                  Exit this program
</span><span class='line'>.explain ?ON|OFF?      Turn output mode suitable <span class="k">for </span>EXPLAIN on or off.
</span><span class='line'>                         With no args, it turns EXPLAIN on.
</span><span class='line'>.header<span class="o">(</span>s<span class="o">)</span> ON|OFF      Turn display of headers on or off
</span><span class='line'>.help                  Show this message
</span><span class='line'>.import FILE TABLE     Import data from FILE into TABLE
</span><span class='line'>.indices ?TABLE?       Show names of all indices
</span><span class='line'>                         If TABLE specified, only show indices <span class="k">for </span>tables
</span><span class='line'>                         matching LIKE pattern TABLE.
</span><span class='line'>.load FILE ?ENTRY?     Load an extension library
</span><span class='line'>.log FILE|off          Turn logging on or off.  FILE can be stderr/stdout
</span><span class='line'>.mode MODE ?TABLE?     Set output mode where MODE is one of:
</span><span class='line'>                         csv      Comma-separated values
</span><span class='line'>                         column   Left-aligned columns.  <span class="o">(</span>See .width<span class="o">)</span>
</span><span class='line'>                         html     HTML &lt;table&gt; code
</span><span class='line'>                         insert   SQL insert statements <span class="k">for </span>TABLE
</span><span class='line'>                         line     One value per line
</span><span class='line'>                         list     Values delimited by .separator string
</span><span class='line'>                         tabs     Tab-separated values
</span><span class='line'>                         tcl      TCL list elements
</span><span class='line'>.nullvalue STRING      Print STRING in place of NULL values
</span><span class='line'>.output FILENAME       Send output to FILENAME
</span><span class='line'>.output stdout         Send output to the screen
</span><span class='line'>.prompt MAIN CONTINUE  Replace the standard prompts
</span><span class='line'>.quit                  Exit this program
</span><span class='line'>.read FILENAME         Execute SQL in FILENAME
</span><span class='line'>.restore ?DB? FILE     Restore content of DB <span class="o">(</span>default <span class="s2">&quot;main&quot;</span><span class="o">)</span> from FILE
</span><span class='line'>.schema ?TABLE?        Show the CREATE statements
</span><span class='line'>                         If TABLE specified, only show tables matching
</span><span class='line'>                         LIKE pattern TABLE.
</span><span class='line'>.separator STRING      Change separator used by output mode and .import
</span><span class='line'>.show                  Show the current values <span class="k">for </span>various settings
</span><span class='line'>.stats ON|OFF          Turn stats on or off
</span><span class='line'>.tables ?TABLE?        List names of tables
</span><span class='line'>                         If TABLE specified, only list tables matching
</span><span class='line'>                         LIKE pattern TABLE.
</span><span class='line'>.timeout MS            Try opening locked tables <span class="k">for </span>MS milliseconds
</span><span class='line'>.vfsname ?AUX?         Print the name of the VFS stack
</span><span class='line'>.width NUM1 NUM2 ...   Set column widths <span class="k">for</span> <span class="s2">&quot;column&quot;</span> mode
</span><span class='line'>.timer ON|OFF          Turn the CPU timer measurement on or off
</span><span class='line'>sqlite&gt;
</span></code></pre></td></tr></table></div></figure>


<h2>以&#8221;.&ldquo;开始的命令规则</h2>

<p>看到了上面的全部命令，可以观察到，所有的命令都是以&#8221;.&ldquo;开始的。而常用的SQL语句是格式自由的，并且可以跨越多行，空白字符（whitespace）和注释可以出现在任何地方。而SQLite中以.开始的命令有更多的限制，具体如下</p>

<ul>
<li>所有命令以 <strong>.</strong> 开始，并且 <strong>.</strong> 的左侧不包含任何空白字符</li>
<li>所有命令必须全部包含在一行输入行中</li>
<li>所有命令不能出现在SQL语句之中</li>
<li>命令不识别注释</li>
</ul>


<h2>常用操作</h2>

<h3>创建一个数据库文件</h3>

<figure class='code'><figcaption><span>fileos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#找一个不存在的文件</span>
</span><span class='line'>09:35:16-androidyue/tmp<span class="nv">$ </span>cat test.db
</span><span class='line'>cat: test.db: No such file or directory
</span><span class='line'>
</span><span class='line'><span class="c">#使用sqlite3 想要创建的数据库文件</span>
</span><span class='line'>09:35:28-androidyue/tmp<span class="nv">$ </span>sqlite3 test.db
</span><span class='line'>
</span><span class='line'><span class="c">#进入sqlite，执行建表语句</span>
</span><span class='line'>sqlite&gt; CREATE TABLE qn_uploaded<span class="o">(</span>filePath VARCHAR<span class="o">(</span>255<span class="o">)</span>, bucket VARCHAR<span class="o">(</span>63<span class="o">)</span>,  lastModified FLOAT<span class="o">)</span>;
</span><span class='line'><span class="c">#退出SQLite</span>
</span><span class='line'>sqlite&gt; .exit
</span><span class='line'>
</span><span class='line'><span class="c">#查看指定的文件，创建成功</span>
</span><span class='line'>09:42:26-androidyue/tmp<span class="nv">$ </span>cat test.db
</span><span class='line'>09:44:45-androidyue/tmp<span class="nv">$ </span>dedqn_uploadedCREATE TABLE qn_uploaded<span class="o">(</span>filePath VARCHAR<span class="o">(</span>255<span class="o">)</span>, bucket VARCHAR<span class="o">(</span>63<span class="o">)</span>,  lastModified FLOAT<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>打开已存在的数据库文件</h3>

<figure class='code'><figcaption><span>fileos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>22:56:15-androidyue~ <span class="nv">$ </span>sqlite3 database_file.db
</span></code></pre></td></tr></table></div></figure>


<h3>查看数据库</h3>

<figure class='code'><figcaption><span>fileos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sqlite&gt; .databases
</span><span class='line'>seq  name             file
</span><span class='line'>---  ---------------  ----------------------------------------------------------
</span><span class='line'>0    main             /home/androidyue/qiniu/.qiniu.db
</span><span class='line'>1    temp
</span></code></pre></td></tr></table></div></figure>


<h3>查看数据表</h3>

<figure class='code'><figcaption><span>fileos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sqlite&gt; .tables
</span><span class='line'>qn_uploaded
</span></code></pre></td></tr></table></div></figure>


<h3>查看建表语句</h3>

<figure class='code'><figcaption><span>fileos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sqlite&gt; .schema qn_uploaded
</span><span class='line'>CREATE TABLE qn_uploaded<span class="o">(</span>filePath VARCHAR<span class="o">(</span>255<span class="o">)</span>, bucket VARCHAR<span class="o">(</span>63<span class="o">)</span>,  lastModified FLOAT<span class="o">)</span>;
</span></code></pre></td></tr></table></div></figure>


<h3>显示字段名称</h3>

<figure class='code'><figcaption><span>fileos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#没有开启</span>
</span><span class='line'>sqlite&gt; <span class="k">select</span> * from qn_uploaded;
</span><span class='line'>/home/androidyue/Documents/octopress/public//images/email.png|droidyue|1410096518.43964
</span><span class='line'>
</span><span class='line'><span class="c">#开启之后</span>
</span><span class='line'>sqlite&gt; .header on
</span><span class='line'>sqlite&gt; <span class="k">select</span> * from qn_uploaded;
</span><span class='line'>filePath|bucket|lastModified
</span><span class='line'>/home/androidyue/Documents/octopress/public//images/email.png|droidyue|1410096518.43964
</span></code></pre></td></tr></table></div></figure>


<h3>导出数据表结构和数据(文本形式)</h3>

<figure class='code'><figcaption><span>fileos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sqlite&gt; .dump qn_uploaded
</span><span class='line'>PRAGMA <span class="nv">foreign_keys</span><span class="o">=</span>OFF;
</span><span class='line'>BEGIN TRANSACTION;
</span><span class='line'>CREATE TABLE qn_uploaded<span class="o">(</span>filePath VARCHAR<span class="o">(</span>255<span class="o">)</span>, bucket VARCHAR<span class="o">(</span>63<span class="o">)</span>,  lastModified FLOAT<span class="o">)</span>;
</span><span class='line'>INSERT INTO <span class="s2">&quot;qn_uploaded&quot;</span> VALUES<span class="o">(</span><span class="s1">&#39;/home/androidyue/Documents/octopress/public/images/dotted-border.png&#39;</span>,<span class="s1">&#39;droidyue&#39;</span>,1410096552.54864<span class="o">)</span>;
</span><span class='line'>COMMIT;
</span></code></pre></td></tr></table></div></figure>


<h2>调整输出</h2>

<p>sqlite3程序可以使用八种不同的格式显示结果。 这些格式是&#8221;csv&#8221;, &ldquo;column&rdquo;, &ldquo;html&rdquo;, &ldquo;insert&rdquo;, &ldquo;line&rdquo;, &ldquo;list&rdquo;, &ldquo;tabs&rdquo;, and &ldquo;tcl&rdquo;. 你可以使用<strong>.mode</strong>命令来进行切换输出格式</p>

<p>默认的输出模式list，使用了list模式，每条查询结果记录都会输出到一行，每一列使用一个分割符分割，默认的分割符是 &ldquo;<strong>|</strong>&#8220;，list模式有一个常用的使用情况，就是当你想对查询结果记性额外处理（比如AWK处理）时，会事半功倍。</p>

<h3>列表模式输出</h3>

<figure class='code'><figcaption><span>fileos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sqlite&gt; <span class="k">select</span> * from qn_uploaded;
</span><span class='line'>/home/androidyue/Documents/octopress/public//images/email.png|droidyue|1410096518.43964
</span></code></pre></td></tr></table></div></figure>


<h3>修改列表模式分割符</h3>

<figure class='code'><figcaption><span>fileos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sqlite&gt; .separator <span class="s2">&quot;, &quot;</span>
</span><span class='line'>sqlite&gt; <span class="k">select</span> * from qn_uploaded;
</span><span class='line'>/home/androidyue/Documents/octopress/public//images/email.png, droidyue, 1410096518.43964
</span></code></pre></td></tr></table></div></figure>


<h3>使用Line模式</h3>

<p>每行的输出格式为 <code>字段名 =  字段值</code></p>

<figure class='code'><figcaption><span>fileos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sqlite&gt; .mode line
</span><span class='line'>sqlite&gt; <span class="k">select</span> * from qn_uploaded;
</span><span class='line'>    <span class="nv">filePath</span> <span class="o">=</span> /home/androidyue/Documents/octopress/public//images/email.png
</span><span class='line'>      <span class="nv">bucket</span> <span class="o">=</span> droidyue
</span><span class='line'><span class="nv">lastModified</span> <span class="o">=</span> 1410096518.43964
</span></code></pre></td></tr></table></div></figure>


<h3>使用列模式</h3>

<figure class='code'><figcaption><span>fileos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sqlite&gt; .mode column
</span><span class='line'>sqlite&gt; <span class="k">select</span> * from qn_uploaded;
</span><span class='line'>/home/androidyue/Documents/octopress/public//images/email.png  droidyue    1410096518.43964
</span><span class='line'>/home/androidyue/Documents/octopress/public/images/rss.png     droidyue    1410096552.54764
</span></code></pre></td></tr></table></div></figure>


<h2>输出内容</h2>

<h3>输出结果</h3>

<p>默认情况下，所有的查询结果都是都是作为标准的输出展示。使用.output可以将输出结果定向到文件中。</p>

<figure class='code'><figcaption><span>fileos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sqlite&gt; .output /tmp/test.txt
</span><span class='line'>sqlite&gt; <span class="k">select</span> * from qn_uploaded;
</span><span class='line'>sqlite&gt; .exit
</span><span class='line'>17:48:54-androidyue~/Documents/octopress/qiniu <span class="o">(</span>master<span class="o">)</span><span class="nv">$ </span>cat /tmp/test.txt
</span><span class='line'>file  bucket         last
</span><span class='line'>----  -------------  ----
</span><span class='line'>/home/androidyue/Documents/octopress/public//images/email.png  droidyue       1410096518.43964
</span><span class='line'>/home/androidyue/Documents/octopress/public/images/rss.png  droidyue       1410096552.54764
</span></code></pre></td></tr></table></div></figure>


<h2>备份和恢复</h2>

<h3>备份</h3>

<figure class='code'><figcaption><span>fileos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#语法 .backup ?DB? FILE      Backup DB (default &quot;main&quot;) to FILE</span>
</span><span class='line'>sqlite&gt; .backup main /tmp/main.txt
</span></code></pre></td></tr></table></div></figure>


<h3>恢复</h3>

<figure class='code'><figcaption><span>fileos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#语法.restore ?DB? FILE     Restore content of DB (default &quot;main&quot;) from FILE</span>
</span><span class='line'>.restore main  /tmp/main.txt
</span></code></pre></td></tr></table></div></figure>


<h3>其他</h3>

<ul>
<li> <a href="http://www.amazon.cn/gp/product/B00COG3W58/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00COG3W58&linkCode=as2&tag=droidyue-23">SQL必知必会</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00COG3W58" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B006K2EHL0/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B006K2EHL0&linkCode=as2&tag=droidyue-23">SQLite权威指南</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B006K2EHL0" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00457W5DO/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00457W5DO&linkCode=as2&tag=droidyue-23">揭示facebook上市背后的秘密</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00457W5DO" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
</feed>
