<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[技术小黑屋]]></title>
  <link href="http://droidyue.com/atom.xml" rel="self"/>
  <link href="http://droidyue.com/"/>
  <updated>2015-08-20T21:12:23+08:00</updated>
  <id>http://droidyue.com/</id>
  <author>
    <name><![CDATA[androidyue]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[深入讲解Android中Activity launchMode]]></title>
    <link href="http://droidyue.com/blog/2015/08/16/dive-into-android-activity-launchmode/"/>
    <updated>2015-08-16T21:22:00+08:00</updated>
    <id>http://droidyue.com/blog/2015/08/16/dive-into-android-activity-launchmode</id>
    <content type="html"><![CDATA[<p>Android系统中的Activity可以说一件很赞的设计，它在内存管理上良好的设计，使得多任务管理在Android系统中运行游刃有余。但是Activity绝非启动展示在屏幕而已，其启动方式也大有学问，本文讲具体介绍Activity的启动模式的诸多细节，纠正一些开发中可能错误的观点，帮助大家深入理解Activity。</p>

<!--more-->


<h2>行文之前</h2>

<p>在正式行文之前，先介绍一些文章提到的概念</p>

<ul>
<li>文章后续会提到Task，这里的Task指的是与用户交互的Activity实例的集合。</li>
<li>Task中的Activity实例以栈的形式存放，这个栈就是Activity的回退栈。</li>
</ul>


<p><strong>本文图片较多，在看图时，请注意观察Activity顶部的title，来区分具体Activity。</strong></p>

<h2>为何有启动模式</h2>

<p>应用中的每一个Activity都是进行不同的事物处理。以邮件客户端为例，InboxActivity目的就是为了展示收件箱，这个Activity不建议创建成多个实例。而ComposeMailActivity则是用来撰写邮件，可以实例化多个此Activity对象。合理地设计Activity对象是否使用已有的实例还是多次创建，会使得交互设计更加良好，也能避免很多问题。至于想要达到前面的目标，就需要使用今天的Activity启动模式。</p>

<h2>如何使用</h2>

<p>使用很简单，只需要在manifest中对应的Activity元素加入<strong>android:launchMode</strong>属性即可。如下述代码</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;activity</span>
</span><span class='line'>    <span class="na">android:name=</span><span class="s">&quot;.SingleTaskActivity&quot;</span>
</span><span class='line'>    <span class="na">android:label=</span><span class="s">&quot;singleTask launchMode&quot;</span>
</span><span class='line'>    <span class="na">android:launchMode=</span><span class="s">&quot;singleTask&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;/activity&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>接下来就是介绍launchMode的四个值的时刻了。</p>

<h2>standard</h2>

<p>这是launchMode的默认值，Activity不包含android:launchMode或者显示设置为standard的Activity就会使用这种模式。</p>

<p>一旦设置成这个值，<strong>每当有一次Intent请求，就会创建一个新的Activity实例</strong>。举个例子，如果有10个撰写邮件的Intent，那么就会创建10个ComposeMailActivity的实例来处理这些Intent。结果很明显，这种模式会创建某个Activity的多个实例。</p>

<h3>Android 5.0之前的表现</h3>

<p>这种Activity新生成的实例会放入发送Intent的Task的栈的顶部。下图为启动同一程序内的Activity。
<img src="http://7jpolu.com1.z0.glb.clouddn.com/pre_lollipop_standard_activity_in_same_app.jpg" title="pre_lollipop_standard_activity_in_same_app" ></p>

<p>下面的图片展示跨程序之间调用，新生成的Activity实例会放入发送Intent的Task的栈的顶部，尽管它们属于不同的程序。
<img src="http://7jpolu.com1.z0.glb.clouddn.com/pre_lollipop_standard_activity_across_app.jpg" title="pre_lollipop_standard_activity_across_app" ></p>

<p>但是当我们打开任务管理器，则会有一点奇怪，应为显示的任务是Gallery，展示的界面确实另一个程序的Activity（因为其位于Task的栈顶）。</p>

<p><img src="http://7jpolu.com1.z0.glb.clouddn.com/pre_lollipop_task_manager_across_app.jpg"></p>

<p>这时候如果我们从Gallery应用切换到拨号应用，再返回到Gallery，看到的还是这个非Gallery的Activity，如果我们想要对Gallery进行操作，必须按Back键返回到Gallery界面才可以。确实有点不太合理。</p>

<h3>Android 5.0及之后表现</h3>

<p>对于同一应用内部Activity启动和5.0之前表现一样，变化的就是不同应用之间Activity启动变得合理了。</p>

<p>跨应用之间启动Activity，会创建一个新的Task，新生成的Activity就会放入刚创建的Task中。如下图</p>

<p><img src="http://7jpolu.com1.z0.glb.clouddn.com/lollipop_across_app_new_task.jpg"></p>

<p>同时任务管理器查看任务也显得更加合理了。</p>

<p><img src="http://7jpolu.com1.z0.glb.clouddn.com/lollipop_task_manager_standard.jpg"></p>

<p>假设之前存在我们的测试程序，然后从Gallery又分享文件到我们的测试程序，则对应的任务管理器展示效果如下。</p>

<p><img src="http://7jpolu.com1.z0.glb.clouddn.com/lollipop_standard_across_app_alread_exists.jpg"></p>

<p>使用场景：standard这种启动模式适合于撰写邮件Activity或者社交网络消息发布Activity。如果你想为每一个intent创建一个Activity处理，那么就是用standard这种模式。</p>

<h2>singleTop</h2>

<p>singleTop其实和standard几乎一样，使用singleTop的Activity也可以创建很多个实例。唯一不同的就是，<strong>如果调用的目标Activity已经位于调用者的Task的栈顶，则不创建新实例，而是使用当前的这个Activity实例，并调用这个实例的onNewIntent方法</strong>。
<img src="http://7jpolu.com1.z0.glb.clouddn.com/singletop.jpg">
在singleTop这种模式下，我们需要处理应用这个模式的Activity的onCreate和onNewIntent两个方法，确保逻辑正常。</p>

<h3>使用场景</h3>

<p>关于singleTop一个典型的使用场景就是搜索功能。假设有一个搜索框，每次搜索查询都会将我们引导至SearchActivity查看结果，为了更好的交互体验，我们在结果页顶部也放置这样的搜索框。</p>

<p>假设一下，SearchActivity启动模式为standard，那么每一个搜索都会创建一个新的SearchActivity实例，10次查询就是10个Activity。当我们想要退回到非SearchActivity，我们需要按返回键10次，这显然太不合理了。</p>

<p>但是如果我们使用singleTop的话，如果SearchActivity在栈顶，当有了新的查询时，不再重新创建SearchAc实例，而是使用当前的SearchActivity来更新结果。当我们需要返回到非SearchActivity只需要按一次返回键即可。使用了singleTop显然比之前要合理。</p>

<h3>总结</h3>

<ul>
<li>只有在调用者和目标Activity在同一Task中，并且目标Activity位于栈顶，才使用现有目标Activity实例，否则创建新的目标Activity实例。</li>
<li>如果是外部程序启动singleTop的Activity，在Android 5.0之前新创建的Activity会位于调用者的Task中，5.0及以后会放入新的Task中。</li>
</ul>


<h2>singleTask</h2>

<p>singleTask这个模式和前面提到的standard和singleTop截然不同。<strong>使用singleTask启动模式的Activity在系统中只会存在一个实例</strong>。如果这个实例已经存在，intent就会通过onNewIntent传递到这个Activity。否则新的Activity实例被创建。</p>

<h3>同一程序内</h3>

<p>如果系统中不存在singleTask Activity的实例，那么就需要创建这个Activity的实例，并且将这个实例放入和调用者相同的Task中并位于栈顶。</p>

<p><img src="http://7jpolu.com1.z0.glb.clouddn.com/singletask_inapp_create_new_instance.jpg"></p>

<p>如果singleTask Activity实例已然存在，那么在Activity回退栈中，所有位于该Activity上面的Activity实例都将被销毁掉（销毁过程会调用Activity生命周期回调），这样使得singleTask Activity实例位于栈顶。与此同时，Intent会通过onNewIntent传递到这个SingleTask Activity实例。</p>

<p><img src="http://7jpolu.com1.z0.glb.clouddn.com/singletask_sameapp_instance_exists.jpg"></p>

<p>然而在Google关于singleTask的<a href="http://developer.android.com/guide/components/tasks-and-back-stack.html">文档</a>有这样一段描述</p>

<blockquote><p>The system creates a new task and instantiates the activity at the root of the new task.</p></blockquote>

<p>意思为 系统会创建一个新的Task，并创建Activity实例放入这个新的Task的底部。</p>

<p>然而实际并非如此，在我的例子中，singleTask Activity并创建并放入了调用者所在的Task，而不是放入新的Task，使用<code>adb shell dumpsys activity</code>便可以进行验证。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Task</span> <span class="n">id</span> <span class="err">#</span><span class="mi">239</span>
</span><span class='line'>  <span class="n">TaskRecord</span><span class="o">{</span><span class="mi">428</span><span class="n">efe30</span> <span class="err">#</span><span class="mi">239</span> <span class="n">A</span><span class="o">=</span><span class="n">com</span><span class="o">.</span><span class="na">thecheesefactory</span><span class="o">.</span><span class="na">lab</span><span class="o">.</span><span class="na">launchmode</span> <span class="n">U</span><span class="o">=</span><span class="mi">0</span> <span class="n">sz</span><span class="o">=</span><span class="mi">2</span><span class="o">}</span>
</span><span class='line'>  <span class="n">Intent</span> <span class="o">{</span> <span class="n">act</span><span class="o">=</span><span class="n">android</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">action</span><span class="o">.</span><span class="na">MAIN</span> <span class="n">cat</span><span class="o">=[</span><span class="n">android</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">category</span><span class="o">.</span><span class="na">LAUNCHER</span><span class="o">]</span> <span class="n">flg</span><span class="o">=</span><span class="mh">0x10000000</span> <span class="n">cmp</span><span class="o">=</span><span class="n">com</span><span class="o">.</span><span class="na">thecheesefactory</span><span class="o">.</span><span class="na">lab</span><span class="o">.</span><span class="na">launchmode</span><span class="o">/.</span><span class="na">StandardActivity</span> <span class="o">}</span>
</span><span class='line'>    <span class="n">Hist</span> <span class="err">#</span><span class="mi">1</span><span class="o">:</span> <span class="n">ActivityRecord</span><span class="o">{</span><span class="mi">429</span><span class="n">a88d0</span> <span class="n">u0</span> <span class="n">com</span><span class="o">.</span><span class="na">thecheesefactory</span><span class="o">.</span><span class="na">lab</span><span class="o">.</span><span class="na">launchmode</span><span class="o">/.</span><span class="na">SingleTaskActivity</span> <span class="n">t239</span><span class="o">}</span>
</span><span class='line'>      <span class="n">Intent</span> <span class="o">{</span> <span class="n">cmp</span><span class="o">=</span><span class="n">com</span><span class="o">.</span><span class="na">thecheesefactory</span><span class="o">.</span><span class="na">lab</span><span class="o">.</span><span class="na">launchmode</span><span class="o">/.</span><span class="na">SingleTaskActivity</span> <span class="o">}</span>
</span><span class='line'>      <span class="n">ProcessRecord</span><span class="o">{</span><span class="mi">42243130</span> <span class="mi">18965</span><span class="o">:</span><span class="n">com</span><span class="o">.</span><span class="na">thecheesefactory</span><span class="o">.</span><span class="na">lab</span><span class="o">.</span><span class="na">launchmode</span><span class="o">/</span><span class="n">u0a123</span><span class="o">}</span>
</span><span class='line'>    <span class="n">Hist</span> <span class="err">#</span><span class="mi">0</span><span class="o">:</span> <span class="n">ActivityRecord</span><span class="o">{</span><span class="mi">425</span><span class="n">fec98</span> <span class="n">u0</span> <span class="n">com</span><span class="o">.</span><span class="na">thecheesefactory</span><span class="o">.</span><span class="na">lab</span><span class="o">.</span><span class="na">launchmode</span><span class="o">/.</span><span class="na">StandardActivity</span> <span class="n">t239</span><span class="o">}</span>
</span><span class='line'>      <span class="n">Intent</span> <span class="o">{</span> <span class="n">act</span><span class="o">=</span><span class="n">android</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">action</span><span class="o">.</span><span class="na">MAIN</span> <span class="n">cat</span><span class="o">=[</span><span class="n">android</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">category</span><span class="o">.</span><span class="na">LAUNCHER</span><span class="o">]</span> <span class="n">flg</span><span class="o">=</span><span class="mh">0x10000000</span> <span class="n">cmp</span><span class="o">=</span><span class="n">com</span><span class="o">.</span><span class="na">thecheesefactory</span><span class="o">.</span><span class="na">lab</span><span class="o">.</span><span class="na">launchmode</span><span class="o">/.</span><span class="na">StandardActivity</span> <span class="o">}</span>
</span><span class='line'>      <span class="n">ProcessRecord</span><span class="o">{</span><span class="mi">42243130</span> <span class="mi">18965</span><span class="o">:</span><span class="n">com</span><span class="o">.</span><span class="na">thecheesefactory</span><span class="o">.</span><span class="na">lab</span><span class="o">.</span><span class="na">launchmode</span><span class="o">/</span><span class="n">u0a123</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>然而想要实现文档的描述也并非不可能，我们需要在设置launchMode为singleTask的同时，再加上taskAffinity属性即可。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;activity</span>
</span><span class='line'>    <span class="na">android:name=</span><span class="s">&quot;.SingleTaskActivity&quot;</span>
</span><span class='line'>    <span class="na">android:label=</span><span class="s">&quot;singleTask launchMode&quot;</span>
</span><span class='line'>    <span class="na">android:launchMode=</span><span class="s">&quot;singleTask&quot;</span>
</span><span class='line'>    <span class="na">android:taskAffinity=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;/activity&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>完成上面的修改，我们看一下效果，Task的变化如下图</p>

<p><img src="http://7jpolu.com1.z0.glb.clouddn.com/singleTaskTaskAffinity.jpg">
同时，系统中的任务管理器效果也会相应变化</p>

<p><img src="http://7jpolu.com1.z0.glb.clouddn.com/singletask_task_affinity_task_manger.jpg"></p>

<h3>跨应用之间</h3>

<p>在跨应用Intent传递时，如果系统中不存在singleTask Activity的实例，那么讲创建一个新的Task，然后创建SingleTask Activity的实例，将其放入新的Task中。Task变化如下。</p>

<p><img src="http://7jpolu.com1.z0.glb.clouddn.com/singletask_across_app_no_instance.jpg">
系统的任务管理器也会如下变化</p>

<p><img src="http://7jpolu.com1.z0.glb.clouddn.com/singletask_acrossapp_no_instance_taskmanager.jpg"></p>

<p>如果singleTask Activity所在的应用进程存在，但是singleTask Activity实例不存在，那么从别的应用启动这个Activity，新的Activity实例会被创建，并放入到所属进程所在的Task中，并位于栈顶位置。</p>

<p><img src="http://7jpolu.com1.z0.glb.clouddn.com/singletask_acrossapp_application_exists_activity_nonexists.jpg"></p>

<p>更复杂的一种情况，如果singleTask Activity实例存在，从其他程序被启动，那么这个Activity所在的Task会被移到顶部，并且在这个Task中，位于singleTask Activity实例之上的所有Activity将会被正常销毁掉。如果我们按返回键，那么我们首先会回退到这个Task中的其他Activity，直到当前Task的Activity回退栈为空时，才会返回到调用者的Task。</p>

<p><img src="http://7jpolu.com1.z0.glb.clouddn.com/singletask_acrossapp_instance_exists_and_back.jpg"></p>

<p>在上图中，当Task2中的相册启动分享调用Task1中的singleTask Activity，而该Activity实例存在，并位于Task1中回退栈中的第三个位置（从上到下顺序），那么位于该Activity上面的两个Activity实例将会被销毁掉，使得该Activity实例位于栈顶。此时Task1中的回退栈只剩两个Activity，如果点击返回，那么会退到的不是相册应用，而是singleTask Activity栈位置下面的Activity，再次点击返回方可返回相册应用。</p>

<h3>使用场景</h3>

<p>该模式的使用场景多类似于邮件客户端的收件箱或者社交应用的时间线Activity。上述两种场景需要对应的Activity只保持一个实例即可，但是也要谨慎使用这种模式，因为它可以在用户未感知的情况下销毁掉其他Activity。</p>

<h2>singleInstance</h2>

<p>这个模式和singleTask差不多，因为他们在系统中都只有一份实例。唯一不同的就是存放singleInstance Activity实例的Task只能存放一个该模式的Activity实例。如果从singleInstance Activity实例启动另一个Activity，那么这个Activity实例会放入其他的Task中。同理，如果singleInstance Activity被别的Activity启动，它也会放入不同于调用者的Task中。</p>

<p><img src="http://7jpolu.com1.z0.glb.clouddn.com/singleInstance_new_instance.jpg">
虽然是两个task，但是在系统的任务管理器中，却始终显示一个，即位于顶部的Task中。</p>

<p><img src="http://7jpolu.com1.z0.glb.clouddn.com/singleInstances_taskmanager.jpg"></p>

<p>另外当我们从任务管理器进入这个应用，是无法通过返回键会退到Task1的。</p>

<p>好在有办法解决这个问题，就是之前提到的<code>taskAffinity=""</code>，为launchMode为singleInstance的Activity加入这个属性即可。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;activity</span>
</span><span class='line'>    <span class="na">android:name=</span><span class="s">&quot;.SingleInstanceActivity&quot;</span>
</span><span class='line'>      <span class="na">android:label=</span><span class="s">&quot;singleInstance launchMode&quot;</span>
</span><span class='line'>    <span class="na">android:launchMode=</span><span class="s">&quot;singleInstance&quot;</span>
</span><span class='line'>    <span class="na">android:taskAffinity=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;/activity&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>再次运行修改的代码，查看任务管理器，这样的结果就合理了。</p>

<p><img src="http://7jpolu.com1.z0.glb.clouddn.com/singleinstance_task_affinity.jpg"></p>

<h3>使用情况</h3>

<p>这种模式的使用情况比较罕见，在Launcher中可能使用。或者你确定你需要使Activity只有一个实例。建议谨慎使用。</p>

<h2>Intent Flags</h2>

<p>除了在manifest文件中设置launchMode之外，还可以在Intnet中设置flag达到同样的效果。如下述代码就可以让StandardActivity已singleTop模式启动。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">StandardActivity</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">StandardActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'><span class="n">intent</span><span class="o">.</span><span class="na">addFlags</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">FLAG_ACTIVITY_SINGLE_TOP</span><span class="o">);</span>
</span><span class='line'><span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>关于Intent Flags这里暂不做重点介绍，具体可以参考<a href="http://developer.android.com/reference/android/content/Intent.html#FLAG_ACTIVITY_BROUGHT_TO_FRONT">官方文档</a></p>

<h2>原文信息</h2>

<ul>
<li><a href="http://inthecheesefactory.com/blog/understand-android-activity-launchmode/en">Understand Android Activity&rsquo;s launchMode: standard, singleTop, singleTask and singleInstance</a></li>
</ul>


<h2>One More Thing</h2>

<p>为了更深刻理解，建议多读几次。如果文章有问题，请在下方评论指出。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[程序员的逗比瞬间（第一季）]]></title>
    <link href="http://droidyue.com/blog/2015/08/08/funny-programmer-season-one/"/>
    <updated>2015-08-08T19:23:00+08:00</updated>
    <id>http://droidyue.com/blog/2015/08/08/funny-programmer-season-one</id>
    <content type="html"><![CDATA[<p>小黑屋里怎么能没有欢乐，苦逼的码农们，我要拯救不开心。</p>

<p>这是程序员的逗比瞬间系列的第一季，文章参考自<a href="http://howtodoinjava.com/2013/03/19/life-of-a-programmer-in-pictures/">Life of a programmer in pictures</a></p>

<!--more-->


<h2>第一次在网页中应用CSS，WTF！</h2>

<p><img src="http://7xkt4i.com1.z0.glb.clouddn.com/the-first-time-you-apply-a-css-to-a-web-page.gif"></p>

<h2>兴致勃勃向别人展示修复了一个bug，结果。。。</h2>

<p><img src="http://7xkt4i.com1.z0.glb.clouddn.com/when-i-show-my-boss-that-ive-fixed-a-bug.gif"></p>

<h2>上传了一段没有测试却正常运行的代码，</h2>

<p><img src="http://7xkt4i.com1.z0.glb.clouddn.com/when-i-upload-a-code-without-tests-and-it-works-as-expected.gif"></p>

<h2>被老板告知我写的功能被毙掉了，呜呜</h2>

<p><img src="http://7xkt4i.com1.z0.glb.clouddn.com/when-my-boss-told-me-that-the-module-ive-been-working-on-will-never-be-used.gif"></p>

<h2>周五好好的代码周一居然不工作了</h2>

<p><img src="http://7xkt4i.com1.z0.glb.clouddn.com/when-something-that-worked-on-friday-doesnt-work-on-monday.gif"></p>

<h2>没有保存就关闭了IDE</h2>

<p><img src="http://7xkt4i.com1.z0.glb.clouddn.com/when-you-close-your-ide-without-saving-the-code.gif"></p>

<h2>花了几个小时写的脚本一运行，居然。。。</h2>

<p><img src="http://7xkt4i.com1.z0.glb.clouddn.com/when-you-run-your-script-the-first-time-after-several-hours-working-on-it.gif"></p>

<h2>没有请教Google就解决了问题，(此处没有度娘神马事)</h2>

<p><img src="http://7xkt4i.com1.z0.glb.clouddn.com/when-you-solve-a-problem-without-googling.gif"></p>

<h2>写了一个脚本，居然把整个数据库给删了(这难道是某超代言的说删就删的某程)</h2>

<p><img src="http://7xkt4i.com1.z0.glb.clouddn.com/when-you-update-a-database-script-and-note-that-you-have-deleted-the-whole-database.gif"></p>

<h2>把一段代码刚刚传到线上(各种战战兢兢，阿弥陀佛)</h2>

<p><img src="http://7xkt4i.com1.z0.glb.clouddn.com/when-you-upload-something-to-the-production-environment.gif"></p>

<h2>领导四处招人修复一个严重bug（我躲我躲，我躲躲）</h2>

<p><img src="http://7xkt4i.com1.z0.glb.clouddn.com/when-your-boss-finds-someone-to-fix-a-critical-bug.gif"></p>

<h2>我的正则表达式写对了</h2>

<p><img src="http://7xkt4i.com1.z0.glb.clouddn.com/when-your-regular-expression-returns-what-you-expect.gif"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[探究android:largeHeap]]></title>
    <link href="http://droidyue.com/blog/2015/08/01/dive-into-android-large-heap/"/>
    <updated>2015-08-01T17:10:00+08:00</updated>
    <id>http://droidyue.com/blog/2015/08/01/dive-into-android-large-heap</id>
    <content type="html"><![CDATA[<p>在日常的Android开发中，我们必然遇到过OutOfMemoryError这样的崩溃，产生的原因无外乎两点，一是内存过小不够用，二是程序设计有误，导致不能释放内存，其中后者情况较多。在解决这个问题时，我们亦或多或少听到android:largeHeap，然而这个概念又是什么呢，它该如何使用，存在哪些问题呢。本文讲比较全面介绍Android中的largeHeap帮助各位全面深入了解这个概念。</p>

<!--more-->


<h2>磨刀不误砍柴工</h2>

<p>为了便于理解，先简单介绍一些和文章相关的基础概念。</p>

<ul>
<li>通常，一个Android程序在运行时会启动一个Dalvik虚拟机（暂不讨论ART模式）</li>
<li>虚拟机的运行时内存一般由堆和栈两大部分构成。</li>
<li>栈是存储方法调用的一片内存数据区。</li>
<li>堆内存占据了虚拟机的大部分内存空间，程序执行时产生的对象就分配在堆内存上。</li>
<li>如果是堆内存没有可用的空间存储生成的对象，JVM会抛出java.lang.OutOfMemoryError。</li>
</ul>


<p>如若具体了解堆和栈，请参考文章<a href="http://droidyue.com/blog/2014/12/07/differences-between-stack-and-heap-in-java/">Java中的堆和栈的区别</a>和<a href="http://droidyue.com/blog/2014/12/21/java-runtime-data-areas/">JVM运行时的数据区</a></p>

<h2>largeHeap介绍</h2>

<p>一个应用如果使用了largeHeap，会请求系统为Dalvik虚拟机分配更大的内存空间。使用起来也很方便，只需在manifest文件application节点加入<strong>android:largeHeap=&ldquo;true&rdquo;</strong>即可。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;application</span> <span class="na">android:icon=</span><span class="s">&quot;@drawable/icon&quot;</span>
</span><span class='line'>  <span class="na">android:allowBackup=</span><span class="s">&quot;false&quot;</span>
</span><span class='line'>  <span class="na">android:label=</span><span class="s">&quot;@string/app_name&quot;</span>
</span><span class='line'>  <span class="na">android:debuggable=</span><span class="s">&quot;true&quot;</span>
</span><span class='line'>  <span class="na">android:theme=</span><span class="s">&quot;@android:style/Theme.Black&quot;</span>
</span><span class='line'>    <span class="na">android:largeHeap=</span><span class="s">&quot;true&quot;</span>
</span><span class='line'><span class="nt">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>largeHeap有多大</h2>

<p>在Android中，有如下两个方法可以帮助我们查看当前内存大小</p>

<ul>
<li>ActivityManager.getMemoryClass()获得内用正常情况下内存的大小</li>
<li>ActivityManager.getLargeMemoryClass()可以获得开启largeHeap最大的内存大小</li>
</ul>


<p>然而largeHeap这个最大值是如何决定的呢？想要了解这个问题，我们就需要看一下Android系统中的一个文件。</p>

<p>这个文件路径是<code>/system/build.prop</code>，由于文件比较大，这里我们只截取关于dalvik内存的配置信息，如下。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">dalvik</span><span class="o">.</span><span class="na">vm</span><span class="o">.</span><span class="na">heapstartsize</span><span class="o">=</span><span class="mi">8</span><span class="n">m</span>
</span><span class='line'><span class="n">dalvik</span><span class="o">.</span><span class="na">vm</span><span class="o">.</span><span class="na">heapgrowthlimit</span><span class="o">=</span><span class="mi">192</span><span class="n">m</span>
</span><span class='line'><span class="n">dalvik</span><span class="o">.</span><span class="na">vm</span><span class="o">.</span><span class="na">heapsize</span><span class="o">=</span><span class="mi">512</span><span class="n">m</span>
</span><span class='line'><span class="n">dalvik</span><span class="o">.</span><span class="na">vm</span><span class="o">.</span><span class="na">heaptargetutilization</span><span class="o">=</span><span class="mf">0.75</span>
</span><span class='line'><span class="n">dalvik</span><span class="o">.</span><span class="na">vm</span><span class="o">.</span><span class="na">heapminfree</span><span class="o">=</span><span class="mi">2</span><span class="n">m</span>
</span><span class='line'><span class="n">dalvik</span><span class="o">.</span><span class="na">vm</span><span class="o">.</span><span class="na">heapmaxfree</span><span class="o">=</span><span class="mi">8</span><span class="n">m</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面有诸多配置，但从字面意思也不难理解，为了正确理解，有必要逐一解释一下。</p>

<p><strong>dalvik.vm.heapstartsize=8m</strong></p>

<p>相当于虚拟机的 -Xms配置，该项用来设置堆内存的初始大小。</p>

<p><strong>dalvik.vm.heapgrowthlimit=192m</strong></p>

<p>相当于虚拟机的 -XX:HeapGrowthLimit配置，该项用来设置一个标准的应用的最大堆内存大小。一个标准的应用就是没有使用android:largeHeap的应用。</p>

<p><strong>dalvik.vm.heapsize=512m</strong></p>

<p>相当于虚拟机的 -Xmx配置，该项设置了使用android:largeHeap的应用的最大堆内存大小。</p>

<p><strong>dalvik.vm.heaptargetutilization=0.75</strong></p>

<p>相当于虚拟机的 -XX:HeapTargetUtilization,该项用来设置当前理想的堆内存利用率。其取值位于0与1之间。当GC进行完垃圾回收之后，Dalvik的堆内存会进行相应的调整，通常结果是当前存活的对象的大小与堆内存大小做除法，得到的值为这个选项的设置，即这里的0.75。注意，这只是一个参考值，<a href="http://grepcode.com/file/repo1.maven.org/maven2/org.robovm/robovm-rt/1.0.0/dalvik/system/VMRuntime.java#VMRuntime.setTargetHeapUtilization%28float%29">Dalvik虚拟机也可以忽略此设置</a>。</p>

<p><strong>dalvik.vm.heapminfree=2m</strong>与<strong>dalvik.vm.heapmaxfree=8m</strong></p>

<p>dalvik.vm.heapminfree对应的是-XX:HeapMinFree配置，用来设置单次堆内存调整的最小值。<strong>dalvik.vm.heapmaxfree</strong>对应的是-XX:HeapMaxFree配置，用来设置单次堆内存调整的最大值。通常情况下，还需要结合上面的 -XX:HeapTargetUtilization的值，才能确定内存调整时，需要调整的大小。</p>

<h2>largeHeap需要权限么</h2>

<p>为何有此疑问呢？ 原因是这样的。 首先一个设备的内存是固定的，当我们使用了largeHeap之后就可以使我们的程序内存增加，但这部分增加的内存有可能是源自被系统杀掉的后台程序。所以，使用largeHeap理论上是有可能杀掉其他的程序的。</p>

<p>然而，结果就是不需要权限，Google在一开始就是这样，只需要简单在Application元素上加入android:largeHeap=&ldquo;true&#8221;就能正常使用。</p>

<h2>largeHeap对GC的影响</h2>

<p>拥有了更多的内存，是不是就意味着要花更多的时间遍历对象垃圾回收呢？其实不然。</p>

<p>首先largeHeap自Android 4.0开始支持，而并发的垃圾回收方式从Android 2.3开始引入。</p>

<p>在引入并发垃圾回收之前，系统采用了Stop-the-World回收方式，进行一次垃圾回收通常消耗几百毫秒，这是很影响交互和响应的。</p>

<p>引入并发垃圾回收之后,在GC开始和结束的阶段会有短暂的暂停时间，通常在10毫秒以内。</p>

<p>因此在支持largeHeap的系统上都采用了并发垃圾回收，GC的Pause Time不会很长，对交互响应影响甚微。</p>

<h2>慎用largeHeap</h2>

<p>对于largeHeap的使用，我们该持有的谨慎的态度，largeHeap可以使用，但是要谨慎。</p>

<p>对于本身对内存要求过大的图片或者视频应用，我们可以使用largeHeap。</p>

<p>除上面的情况，如果仅仅是为了解决OutOfMemoryError这样的问题，而尝试使用largeHeap分配更大内存的这种指标不治本的方法不可取。对待这样的OOM问题，建议阅读以下几篇文章，了解Android中内存泄露和垃圾回收，从代码上去查找问题，从根本上解决问题。</p>

<h2>推荐文章</h2>

<ul>
<li><a href="http://droidyue.com/blog/2014/12/28/in-android-handler-classes-should-be-static-or-leaks-might-occur/">Android中Handler引起的内存泄露</a></li>
<li><a href="http://droidyue.com/blog/2015/04/12/avoid-memory-leaks-on-context-in-android/">避免Android中Context引起的内存泄露</a></li>
<li><a href="http://droidyue.com/blog/2014/11/02/note-for-google-io-memory-management-for-android-chinese-edition/">Google IO：Android内存管理主题演讲记录</a></li>
</ul>


<script type="text/javascript" src="http://droidyue.b0.upaiyun.com/js/blog/book_copyright.js"></script>


<script type="text/javascript">
    showBookCopyright();
</script>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[使用Android lint发现并解决高版本API问题]]></title>
    <link href="http://droidyue.com/blog/2015/07/25/use-android-lint-to-find-higher-api-usage/"/>
    <updated>2015-07-25T16:51:00+08:00</updated>
    <id>http://droidyue.com/blog/2015/07/25/use-android-lint-to-find-higher-api-usage</id>
    <content type="html"><![CDATA[<p>在编写代码时，为了实现一些功能，我们需要使用高版本的API，比如SharedPreference的Editor中的apply方法为API 9开始引入，在API 9 以上的机器使用没有问题，但是在API 8上，如果运行时执行了这段代码，就会崩溃，问题相当严重。尤其是该问题出现在正式版中，后果不堪设想。本文将介绍如何使用lint发现并解决这些问题。</p>

<!--more-->


<h2>lint是什么</h2>

<p>lint是Android提供的一个静态代码分析的工具，使用这个工具可以帮助我们找出Android项目中潜在的bug，安全，性能，可用性，辅助性和国际化等问题，同时还可以查找出错误拼写，提示开发者更正。</p>

<h3>lint的工作流程</h3>

<p><img src="http://7jpolu.com1.z0.glb.clouddn.com/lint_workflow.png"></p>

<p>上图为lint的工作流程图，下面为一些元素的简短说明。</p>

<p><strong>程序源文件</strong></p>

<p>程序源文件就是Android工程的组成部分，包括Java和xml文件，图标以及混淆配置文件</p>

<p><strong>lint.xml文件</strong></p>

<p>lint配置文件，用来排除某些检查或者自定义检测问题的严重程度。</p>

<p><strong>lint工具</strong></p>

<p>一个静态代码扫描工具，对Android工程进行扫描分析，可以从终端执行命令，也可以从Android Studio等IDE中使用。lint工具可以帮助我们找到Android应用性能和代码质量问题。在正式发布应用之前，强烈建议使用lint检查并修复发现的问题。</p>

<p><strong>lint检查结果</strong></p>

<p>lint的检查结果可以从终端，Android Studio等IDE工具，或者生成结果文件查看。每一个问题都会标明在文件中的位置行数，以及关于该问题的说明等信息。</p>

<h2>查找问题</h2>

<p>知道了lint如何工作，就只需执行lint查找问题，有了明确的问题，才能有的放矢地解决。</p>

<h3>Android Sutdio</h3>

<p>选择菜单Analyze&mdash;>Configure Current File Analysis&mdash;>Configure Inspections 清空所有的检查项，然后如下图勾选<strong>Calling new methods on older versions</strong> 和 <strong>Using inlined constants on older versions</strong></p>

<p><img src="http://7jpolu.com1.z0.glb.clouddn.com/android_studio_lint_custom.png"></p>

<p>然后执行Analyze&mdash;> Inspect Code，然后查看底部的Inspection即可</p>

<h3>command line</h3>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd </span>project_root_dir
</span><span class='line'>lint --check NewApi,InlinedApi --html /tmp/api_check.html ./
</span></code></pre></td></tr></table></div></figure>


<p>无需多时，结果就会以html形式写入/tmp/api_check.html文件</p>

<h3>Gradle Command Line</h3>

<p>配置build.gradle</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">android</span><span class="o">{</span>
</span><span class='line'>    <span class="c1">//some other config</span>
</span><span class='line'>    <span class="n">lintOptions</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">abortOnError</span> <span class="kc">false</span>
</span><span class='line'>        <span class="n">xmlReport</span> <span class="kc">false</span>
</span><span class='line'>        <span class="n">check</span> <span class="err">&#39;</span><span class="n">NewApi</span><span class="err">&#39;</span><span class="o">,</span> <span class="err">&#39;</span><span class="n">InlinedApi</span><span class="err">&#39;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后执行下面的命令</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd </span>project_root_dir
</span><span class='line'>./gradlew lint
</span></code></pre></td></tr></table></div></figure>


<p>结果会输出到工程目录build/outputs/lint-results.html。</p>

<h2>如何解决</h2>

<p>结合上面的输出结果，我们接下来要做的就是如何解决，如下为一些解决思路。</p>

<h3>必然执行高版本API</h3>

<ul>
<li>如果是NewApi警告，考虑其他方法代替。比如String.isEmpty自API 9才引入，但是使用TextUtils.isEmpty替换。</li>
<li>如果是InlinedApi警告，可以自定义与常量同值的另一个常量。</li>
<li>使用反射，对于不太重要的方法，我们可以使用反射来解决问题。</li>
</ul>


<h3>或然执行高版本API</h3>

<p>如果该段代码进行了API Level限制，确保高版本API不会在低版本设置执行，只需对这个警告设置为忽略即可。</p>

<h2>实战解决</h2>

<p>以下代码所属工程最低支持2.2系统，即API 8。</p>

<h3>NewApi有警报代码</h3>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">testNewApi</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">PreferenceManager</span><span class="o">.</span><span class="na">getDefaultSharedPreferences</span><span class="o">(</span><span class="n">getApplicationContext</span><span class="o">()).</span><span class="na">edit</span><span class="o">().</span><span class="na">putBoolean</span><span class="o">(</span><span class="s">&quot;first_use&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">).</span><span class="na">apply</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面代码中的apply方法为Android API 9引入，使用lint检查会提示警告。</p>

<h3>方案一</h3>

<p>按照API Level不同，选择不同的方法,对于API 9以下使用commit，API 9及其以上使用apply</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">testNewApi</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">SharedPreferences</span><span class="o">.</span><span class="na">Editor</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">PreferenceManager</span><span class="o">.</span><span class="na">getDefaultSharedPreferences</span><span class="o">(</span><span class="k">this</span><span class="o">).</span><span class="na">edit</span><span class="o">();</span>
</span><span class='line'>    <span class="n">editor</span><span class="o">.</span><span class="na">putBoolean</span><span class="o">(</span><span class="s">&quot;first_launch&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">Build</span><span class="o">.</span><span class="na">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&gt;=</span> <span class="n">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">GINGERBREAD</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">editor</span><span class="o">.</span><span class="na">apply</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">editor</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>方案二</h3>

<p>对于确定不会在低版本运行的情况，我们可以增加@TargetApi加上对应的API引入的版本即可。</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@TargetApi</span><span class="o">(</span><span class="n">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">GINGERBREAD</span><span class="o">)</span>
</span><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">testNewApi</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">SharedPreferences</span><span class="o">.</span><span class="na">Editor</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">PreferenceManager</span><span class="o">.</span><span class="na">getDefaultSharedPreferences</span><span class="o">(</span><span class="k">this</span><span class="o">).</span><span class="na">edit</span><span class="o">();</span>
</span><span class='line'>    <span class="n">editor</span><span class="o">.</span><span class="na">putBoolean</span><span class="o">(</span><span class="s">&quot;first_launch&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">).</span><span class="na">apply</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>方案三</h3>

<p>同样确保新API不会在低版本运行，也可以忽略警报。</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@SuppressLint</span><span class="o">(</span><span class="s">&quot;NewApi&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">testNewApi</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">SharedPreferences</span><span class="o">.</span><span class="na">Editor</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">PreferenceManager</span><span class="o">.</span><span class="na">getDefaultSharedPreferences</span><span class="o">(</span><span class="k">this</span><span class="o">).</span><span class="na">edit</span><span class="o">();</span>
</span><span class='line'>    <span class="n">editor</span><span class="o">.</span><span class="na">putBoolean</span><span class="o">(</span><span class="s">&quot;first_launch&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">).</span><span class="na">apply</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>但是这种方案不推荐</strong>，是直接对方法的警告忽略，如果继续在方法中增加代码，则不利于发现问题，比如</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@SuppressLint</span><span class="o">(</span><span class="s">&quot;NewApi&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">testNewApi</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">SharedPreferences</span><span class="o">.</span><span class="na">Editor</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">PreferenceManager</span><span class="o">.</span><span class="na">getDefaultSharedPreferences</span><span class="o">(</span><span class="k">this</span><span class="o">).</span><span class="na">edit</span><span class="o">();</span>
</span><span class='line'>    <span class="n">editor</span><span class="o">.</span><span class="na">putBoolean</span><span class="o">(</span><span class="s">&quot;first_launch&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">).</span><span class="na">apply</span><span class="o">();</span>
</span><span class='line'>    <span class="s">&quot;&quot;</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">();</span> <span class="c1">//新增加代码，不容易发现问题</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>含有InlinedApi警告的代码</h3>

<p>下面代码过于简单，只是为了打印一个API 19引入的int常量值。</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">testInlinedApi</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">&quot;MainActivity&quot;</span><span class="o">,</span> <span class="s">&quot;inlinedValue=&quot;</span> <span class="o">+</span> <span class="n">View</span><span class="o">.</span><span class="na">ACCESSIBILITY_LIVE_REGION_ASSERTIVE</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>对于这个问题的方案很简答，就是自己定义一个常量，其值与高版本的API常量相同，然后使用这个自定义常量即可。如下代码</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">testInlinedApi</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">final</span> <span class="kt">int</span> <span class="n">VIEW_ACCESSIBILITY_LIVE_REGION_ASSERTIVE</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
</span><span class='line'>    <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">&quot;MainActivity&quot;</span><span class="o">,</span> <span class="s">&quot;inlinedValue=&quot;</span> <span class="o">+</span> <span class="n">VIEW_ACCESSIBILITY_LIVE_REGION_ASSERTIVE</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>小问题</h2>

<ul>
<li>如果没有lint命令，需要将Android中的sdk/tools/目录加入PATH即可。</li>
</ul>


<script type="text/javascript" src="http://droidyue.b0.upaiyun.com/js/blog/book_copyright.js"></script>


<script type="text/javascript">
    showBookCopyright();
</script>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[说说Android中的ANR]]></title>
    <link href="http://droidyue.com/blog/2015/07/18/anr-in-android/"/>
    <updated>2015-07-18T17:53:00+08:00</updated>
    <id>http://droidyue.com/blog/2015/07/18/anr-in-android</id>
    <content type="html"><![CDATA[<p>有过Android开发经历的人都不会对ANR陌生，它和崩溃一样是程序设计的问题。本文将以较为深入的视角来介绍什么是ANR，出现场景，如何避免以及如何定位分析ANR,希望可以帮助大家在编写程序时有所帮助。</p>

<!--more-->


<h2>什么是ANR</h2>

<p>ANR全称<code>Application Not Responding</code>，意思就是程序未响应。如果一个应用无法响应用户的输入，系统就会弹出一个ANR对话框，如下图所示,用户可以自行选择继续等待亦或者是停止当前程序。</p>

<p><img src="http://7jpolu.com1.z0.glb.clouddn.com/android_anr.png"></p>

<h2>出现场景</h2>

<ul>
<li>主线程被IO操作（从4.0之后网络IO不允许在主线程中）阻塞。</li>
<li>主线程中存在耗时的计算</li>
<li>主线程中错误的操作，比如Thread.wait或者Thread.sleep等</li>
</ul>


<p>Android系统会监控程序的响应状况，一旦出现下面两种情况，则弹出ANR对话框</p>

<ul>
<li>应用在<strong>5秒</strong>内未响应用户的输入事件（如按键或者触摸）</li>
<li>BroadcastReceiver未在<strong>10秒</strong>内完成相关的处理</li>
</ul>


<h2>如何避免</h2>

<p>基本的思路就是将IO操作在工作线程来处理，减少其他耗时操作和错误操作</p>

<ul>
<li>使用<a href="http://droidyue.com/blog/2014/11/08/bad-smell-of-asynctask-in-android/">AsyncTask</a>处理耗时IO操作。</li>
<li>使用Thread或者HandlerThread时，调用Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND)设置优先级，否则仍然会降低程序响应，因为默认Thread的优先级和主线程相同。</li>
<li>使用<a href="http://droidyue.com/blog/2014/12/28/in-android-handler-classes-should-be-static-or-leaks-might-occur/">Handler</a>处理工作线程结果，而不是使用Thread.wait()或者Thread.sleep()来阻塞主线程。</li>
<li>Activity的onCreate和onResume回调中尽量避免耗时的代码</li>
<li>BroadcastReceiver中onReceive代码也要尽量减少耗时，建议使用IntentService处理。</li>
</ul>


<h2>画龙点睛</h2>

<p>通常100到200毫秒就会让人察觉程序反应慢，为了更加提升响应，可以使用下面的几种方法</p>

<ul>
<li>如果程序正在后台处理用户的输入，建议使用让用户得知进度，比如使用ProgressBar控件。</li>
<li>程序启动时可以选择加上欢迎界面，避免让用户察觉卡顿。</li>
<li>使用Systrace和TraceView找出影响响应的问题。</li>
</ul>


<h2>如何定位</h2>

<p>如果开发机器上出现问题，我们可以通过查看<code>/data/anr/traces.txt</code>即可，最新的ANR信息在最开始部分。我们从stacktrace中即可找到出问题的具体行数。本例中问题出现在MainActivity.java 27行，因为这里调用了Thread.sleep方法。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">root</span><span class="nd">@htc_m8tl</span><span class="o">:/</span> <span class="err">#</span> <span class="n">cat</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">anr</span><span class="o">/</span><span class="n">traces</span><span class="o">.</span><span class="na">txt</span> <span class="o">|</span> <span class="n">more</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="o">-----</span> <span class="n">pid</span> <span class="mi">30307</span> <span class="n">at</span> <span class="mi">2015</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">30</span> <span class="mi">14</span><span class="o">:</span><span class="mi">51</span><span class="o">:</span><span class="mi">14</span> <span class="o">-----</span>
</span><span class='line'><span class="n">Cmd</span> <span class="nl">line:</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">androidyue</span><span class="o">.</span><span class="na">bitmapdemo</span>
</span><span class='line'>
</span><span class='line'><span class="nl">JNI:</span> <span class="n">CheckJNI</span> <span class="n">is</span> <span class="n">off</span><span class="o">;</span> <span class="n">workarounds</span> <span class="n">are</span> <span class="n">off</span><span class="o">;</span> <span class="n">pins</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">globals</span><span class="o">=</span><span class="mi">272</span>
</span><span class='line'>
</span><span class='line'><span class="n">DALVIK</span> <span class="nl">THREADS:</span>
</span><span class='line'><span class="o">(</span><span class="nl">mutexes:</span> <span class="n">tll</span><span class="o">=</span><span class="mi">0</span> <span class="n">tsl</span><span class="o">=</span><span class="mi">0</span> <span class="n">tscl</span><span class="o">=</span><span class="mi">0</span> <span class="n">ghl</span><span class="o">=</span><span class="mi">0</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="s">&quot;main&quot;</span> <span class="n">prio</span><span class="o">=</span><span class="mi">5</span> <span class="n">tid</span><span class="o">=</span><span class="mi">1</span> <span class="n">TIMED_WAIT</span>
</span><span class='line'>  <span class="o">|</span> <span class="n">group</span><span class="o">=</span><span class="s">&quot;main&quot;</span> <span class="n">sCount</span><span class="o">=</span><span class="mi">1</span> <span class="n">dsCount</span><span class="o">=</span><span class="mi">0</span> <span class="n">obj</span><span class="o">=</span><span class="mh">0x416eaf18</span> <span class="n">self</span><span class="o">=</span><span class="mh">0x416d8650</span>
</span><span class='line'>  <span class="o">|</span> <span class="n">sysTid</span><span class="o">=</span><span class="mi">30307</span> <span class="n">nice</span><span class="o">=</span><span class="mi">0</span> <span class="n">sched</span><span class="o">=</span><span class="mi">0</span><span class="o">/</span><span class="mi">0</span> <span class="n">cgrp</span><span class="o">=</span><span class="n">apps</span> <span class="n">handle</span><span class="o">=</span><span class="mi">1074565528</span>
</span><span class='line'>  <span class="o">|</span> <span class="n">state</span><span class="o">=</span><span class="n">S</span> <span class="n">schedstat</span><span class="o">=(</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="o">)</span> <span class="n">utm</span><span class="o">=</span><span class="mi">5</span> <span class="n">stm</span><span class="o">=</span><span class="mi">4</span> <span class="n">core</span><span class="o">=</span><span class="mi">3</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">VMThread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">Native</span> <span class="n">Method</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1044</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1026</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">androidyue</span><span class="o">.</span><span class="na">bitmapdemo</span><span class="o">.</span><span class="na">MainActivity</span><span class="n">$1</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">MainActivity</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">27</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">Activity</span><span class="o">.</span><span class="na">runOnUiThread</span><span class="o">(</span><span class="n">Activity</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">4794</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">androidyue</span><span class="o">.</span><span class="na">bitmapdemo</span><span class="o">.</span><span class="na">MainActivity</span><span class="o">.</span><span class="na">onResume</span><span class="o">(</span><span class="n">MainActivity</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">33</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">Instrumentation</span><span class="o">.</span><span class="na">callActivityOnResume</span><span class="o">(</span><span class="n">Instrumentation</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1282</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">Activity</span><span class="o">.</span><span class="na">performResume</span><span class="o">(</span><span class="n">Activity</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">5405</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果是线上版本引起的，Google Play后台有相关的数据可以帮助查看分析并解决问题。</p>

<h2>细致分析</h2>

<p>  <strong>提问</strong>: BroadcastReceiver过了60秒居然没有ANR？ 现场代码如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NetworkReceiver</span> <span class="kd">extends</span> <span class="n">BroadcastReceiver</span><span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">LOGTAG</span> <span class="o">=</span> <span class="s">&quot;NetworkReceiver&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onReceive</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">LOGTAG</span><span class="o">,</span> <span class="s">&quot;onReceive intent=&quot;</span> <span class="o">+</span> <span class="n">intent</span><span class="o">);</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">60000</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">LOGTAG</span><span class="o">,</span> <span class="s">&quot;onReceive end&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>
  <strong>回答</strong>：实际上已经发生了ANR，只是没有进行对话框弹出而已。这种ANR就是background ANR，即后台程序的ANR，我们可以通过过滤日志验证</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">adb</span> <span class="n">logcat</span> <span class="o">|</span> <span class="n">grep</span> <span class="s">&quot;NetworkReceiver|ActivityManager|WindowManager&quot;</span>
</span><span class='line'><span class="n">I</span><span class="o">/</span><span class="n">NetworkReceiver</span><span class="o">(</span> <span class="mi">4109</span><span class="o">):</span> <span class="n">onReceive</span> <span class="n">intent</span><span class="o">=</span><span class="n">Intent</span> <span class="o">{</span> <span class="n">act</span><span class="o">=</span><span class="n">android</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">conn</span><span class="o">.</span><span class="na">CONNECTIVITY_CHANGE</span> <span class="n">flg</span><span class="o">=</span><span class="mh">0x8000010</span> <span class="n">cmp</span><span class="o">=</span><span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">androidyue</span><span class="o">.</span><span class="na">bitmapdemo</span><span class="o">/.</span><span class="na">NetworkReceiver</span> <span class="o">(</span><span class="n">has</span> <span class="n">extras</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'><span class="n">I</span><span class="o">/</span><span class="n">ActivityManager</span><span class="o">(</span>  <span class="mi">462</span><span class="o">):</span> <span class="n">No</span> <span class="n">longer</span> <span class="n">want</span> <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">exchange</span> <span class="o">(</span><span class="n">pid</span> <span class="mi">1054</span><span class="o">):</span> <span class="n">empty</span> <span class="err">#</span><span class="mi">17</span>
</span><span class='line'><span class="n">I</span><span class="o">/</span><span class="n">NetworkReceiver</span><span class="o">(</span> <span class="mi">4109</span><span class="o">):</span> <span class="n">onReceive</span> <span class="n">end</span>
</span><span class='line'><span class="n">W</span><span class="o">/</span><span class="n">BroadcastQueue</span><span class="o">(</span>  <span class="mi">462</span><span class="o">):</span> <span class="n">Receiver</span> <span class="n">during</span> <span class="nl">timeout:</span> <span class="n">ResolveInfo</span><span class="o">{</span><span class="mi">5342</span><span class="n">dde4</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">androidyue</span><span class="o">.</span><span class="na">bitmapdemo</span><span class="o">.</span><span class="na">NetworkReceiver</span> <span class="n">p</span><span class="o">=</span><span class="mi">0</span> <span class="n">o</span><span class="o">=</span><span class="mi">0</span> <span class="n">m</span><span class="o">=</span><span class="mh">0x108000</span><span class="o">}</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">ActivityManager</span><span class="o">(</span>  <span class="mi">462</span><span class="o">):</span> <span class="n">ANR</span> <span class="n">in</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">androidyue</span><span class="o">.</span><span class="na">bitmapdemo</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">ActivityManager</span><span class="o">(</span>  <span class="mi">462</span><span class="o">):</span> <span class="nl">Reason:</span> <span class="n">Broadcast</span> <span class="n">of</span> <span class="n">Intent</span> <span class="o">{</span> <span class="n">act</span><span class="o">=</span><span class="n">android</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">conn</span><span class="o">.</span><span class="na">CONNECTIVITY_CHANGE</span> <span class="n">flg</span><span class="o">=</span><span class="mh">0x8000010</span> <span class="n">cmp</span><span class="o">=</span><span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">androidyue</span><span class="o">.</span><span class="na">bitmapdemo</span><span class="o">/.</span><span class="na">NetworkReceiver</span> <span class="o">(</span><span class="n">has</span> <span class="n">extras</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">ActivityManager</span><span class="o">(</span>  <span class="mi">462</span><span class="o">):</span> <span class="nl">Load:</span> <span class="mf">0.37</span> <span class="o">/</span> <span class="mf">0.2</span> <span class="o">/</span> <span class="mf">0.14</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">ActivityManager</span><span class="o">(</span>  <span class="mi">462</span><span class="o">):</span> <span class="n">CPU</span> <span class="n">usage</span> <span class="n">from</span> <span class="mi">26047</span><span class="n">ms</span> <span class="n">to</span> <span class="mi">0</span><span class="n">ms</span> <span class="nl">ago:</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">ActivityManager</span><span class="o">(</span>  <span class="mi">462</span><span class="o">):</span>   <span class="mf">0.4</span><span class="o">%</span> <span class="mi">58</span><span class="o">/</span><span class="nl">adbd:</span> <span class="mi">0</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mf">0.4</span><span class="o">%</span> <span class="n">kernel</span> <span class="o">/</span> <span class="nl">faults:</span> <span class="mi">1501</span> <span class="n">minor</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">ActivityManager</span><span class="o">(</span>  <span class="mi">462</span><span class="o">):</span>   <span class="mf">0.3</span><span class="o">%</span> <span class="mi">462</span><span class="o">/</span><span class="nl">system_server:</span> <span class="mf">0.1</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mf">0.1</span><span class="o">%</span> <span class="n">kernel</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">ActivityManager</span><span class="o">(</span>  <span class="mi">462</span><span class="o">):</span>   <span class="mi">0</span><span class="o">%</span> <span class="mi">4109</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">androidyue</span><span class="o">.</span><span class="na">bitmapdemo</span><span class="o">:</span> <span class="mi">0</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mi">0</span><span class="o">%</span> <span class="n">kernel</span> <span class="o">/</span> <span class="nl">faults:</span> <span class="mi">6</span> <span class="n">minor</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">ActivityManager</span><span class="o">(</span>  <span class="mi">462</span><span class="o">):</span> <span class="mf">1.5</span><span class="o">%</span> <span class="nl">TOTAL:</span> <span class="mf">0.5</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mf">0.9</span><span class="o">%</span> <span class="n">kernel</span> <span class="o">+</span> <span class="mi">0</span><span class="o">%</span> <span class="n">softirq</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">ActivityManager</span><span class="o">(</span>  <span class="mi">462</span><span class="o">):</span> <span class="n">CPU</span> <span class="n">usage</span> <span class="n">from</span> <span class="mi">87</span><span class="n">ms</span> <span class="n">to</span> <span class="mi">589</span><span class="n">ms</span> <span class="nl">later:</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">ActivityManager</span><span class="o">(</span>  <span class="mi">462</span><span class="o">):</span>   <span class="mf">1.8</span><span class="o">%</span> <span class="mi">58</span><span class="o">/</span><span class="nl">adbd:</span> <span class="mi">0</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mf">1.8</span><span class="o">%</span> <span class="n">kernel</span> <span class="o">/</span> <span class="nl">faults:</span> <span class="mi">30</span> <span class="n">minor</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">ActivityManager</span><span class="o">(</span>  <span class="mi">462</span><span class="o">):</span>     <span class="mf">1.8</span><span class="o">%</span> <span class="mi">58</span><span class="o">/</span><span class="nl">adbd:</span> <span class="mi">0</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mf">1.8</span><span class="o">%</span> <span class="n">kernel</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">ActivityManager</span><span class="o">(</span>  <span class="mi">462</span><span class="o">):</span> <span class="mi">4</span><span class="o">%</span> <span class="nl">TOTAL:</span> <span class="mi">0</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mi">4</span><span class="o">%</span> <span class="n">kernel</span>
</span><span class='line'><span class="n">W</span><span class="o">/</span><span class="n">ActivityManager</span><span class="o">(</span>  <span class="mi">462</span><span class="o">):</span> <span class="n">Killing</span> <span class="n">ProcessRecord</span><span class="o">{</span><span class="mi">5326</span><span class="n">d418</span> <span class="mi">4109</span><span class="o">:</span><span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">androidyue</span><span class="o">.</span><span class="na">bitmapdemo</span><span class="o">/</span><span class="n">u0a10063</span><span class="o">}:</span> <span class="n">background</span> <span class="n">ANR</span>
</span><span class='line'><span class="n">I</span><span class="o">/</span><span class="n">ActivityManager</span><span class="o">(</span>  <span class="mi">462</span><span class="o">):</span> <span class="n">Process</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">androidyue</span><span class="o">.</span><span class="na">bitmapdemo</span> <span class="o">(</span><span class="n">pid</span> <span class="mi">4109</span><span class="o">)</span> <span class="n">has</span> <span class="n">died</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>除了日志，我们还可以根据前面提到的查看traces.txt文件。</p>

<p><strong>提问</strong>:可以更容易了解background ANR么？</p>

<p><strong>回答</strong>:当然可以，在Android开发者选项&mdash;>高级&mdash;>显示所有”应用程序无响应“勾选即可对后台ANR也进行弹窗显示，方便查看了解程序运行情况。</p>

<h2>参考文章</h2>

<ul>
<li><a href="http://developer.android.com/intl/zh-cn/training/articles/perf-anr.html">Keeping Your App Responsive</a></li>
</ul>


<script type="text/javascript" src="http://droidyue.b0.upaiyun.com/js/blog/book_copyright.js"></script>


<script type="text/javascript">
    showBookCopyright();
</script>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[在Mac上为其他设备开启代理]]></title>
    <link href="http://droidyue.com/blog/2015/07/11/start-proxy-server-on-mac/"/>
    <updated>2015-07-11T17:36:00+08:00</updated>
    <id>http://droidyue.com/blog/2015/07/11/start-proxy-server-on-mac</id>
    <content type="html"><![CDATA[<p>前些日子，想要查看一个Release版本的HTTP请求，由于已经是发布版本，日志已然关闭，遂开始从HTTP代理的思路着手。</p>

<p>本文是偏于操作的总结，行文目的是快速解决诸如上面的问题，不是为了深入了解squidman。如需深入俩接，请参考文章尾部的进阶推荐内容。</p>

<!--more-->


<h3>Fiddler铩羽而归</h3>

<p>首先尝试了鼎鼎有名的Fiddler，Fiddler是一款基于.NET的应用，天然运行在Windows系统上。但是想要安装到Mac上则需要安装.NET运行时，可是一旦启动Fiddler代理就无缘无故崩溃，最后不得不铩羽而归，另谋他路。</p>

<h3>SquidMan</h3>

<p>SquidMan是一款Mac上的图形化的squid代理服务器的安装管理工具。使用squid服务器软件可以帮助我们实现如下功能</p>

<ul>
<li>缓存下载内容，减少网络带宽，加速网页浏览。</li>
<li>作为代理服务器，供其他设备使用。</li>
</ul>


<p>这里我们用到的是其代理功能。</p>

<p>巧妇难为无米之炊，首先要做的就是安装squidman，从<a href="http://squidman.net/squidman/">这里</a>下载对应的版本并安装，然后进行启动即可。</p>

<h3>客户端配置</h3>

<p>以下操作的WIFI热点应该为Mac设备与客户端设备同时连接的热点，以确保在同一局域网中。
代理服务器的IP地址使用<code>ifconfig</code>查看，端口默认为8087。
以Android设备为例</p>

<p>设置&mdash;>WLAN&mdash;>长按目标WIFI热点&mdash;>修改网络&mdash;>勾选显示高级选项&mdash;>修改代理为手动，填出代理服务器的地址和端口，保存即可。</p>

<h3>查看日志</h3>

<h4>终端查看</h4>

<p>个人喜欢使用终端查看，使用tail命令查看访问日志一目了然。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">tail</span> <span class="o">-</span><span class="mi">200</span><span class="n">f</span> <span class="o">~/</span><span class="n">Library</span><span class="o">/</span><span class="n">Logs</span><span class="o">/</span><span class="n">squid</span><span class="o">/</span><span class="n">squid</span><span class="o">-</span><span class="n">access</span><span class="o">.</span><span class="na">log</span>
</span></code></pre></td></tr></table></div></figure>


<h4>客户端查看</h4>

<p>使用SquidMan客户端查看也是一种选择，选择Window&mdash;>Tools即可看到如下的界面</p>

<p><img src="http://7jpolu.com1.z0.glb.clouddn.com/squidman_tools.png"></p>

<p>Access Log不会自动追加最新的请求日志，需要再次点击Access Log按钮才可以。</p>

<h3>问题解决</h3>

<h4>无法访问网络 403</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="mf">1434336922.275</span>   <span class="mi">1140</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.100</span> <span class="n">TCP_DENIED</span><span class="o">/</span><span class="mi">403</span> <span class="mi">4286</span> <span class="n">GET</span> <span class="nl">http:</span><span class="c1">//m.baidu.com/? - HIER_NONE/- text/html</span>
</span><span class='line'><span class="mf">1434336922.594</span>     <span class="mi">71</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.100</span> <span class="n">TCP_DENIED</span><span class="o">/</span><span class="mi">403</span> <span class="mi">3979</span> <span class="n">GET</span> <span class="nl">http:</span><span class="c1">//www.squid-cache.org/Artwork/SN.png - HIER_NONE/- text/html</span>
</span></code></pre></td></tr></table></div></figure>


<p>日志全部显示为TCP_DENIED/403，表明Squidman拒绝了来自客户端的请求</p>

<p>解决方法，在配置文件中找到如下代码</p>

<p><img src="http://7jpolu.com1.z0.glb.clouddn.com/squidman_403.png" title="" ></p>

<p>替换为<code>http_access allow all</code>，即允许所有的HTTP访问，停止Squiman，然后重新启动，如果失败，再次点击重新启动即可。</p>

<h4>无法查看GET参数</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="mf">1434340562.396</span>    <span class="mi">339</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.100</span> <span class="n">TCP_MISS</span><span class="o">/</span><span class="mi">200</span> <span class="mi">82471</span> <span class="n">GET</span> <span class="nl">http:</span><span class="c1">//m.baidu.com/s? - HIER_DIRECT/115.239.210.14 text/html</span>
</span></code></pre></td></tr></table></div></figure>


<p>默认情况下，从日志中是无法看到GET查询参数的，因为在写入日志前，程序已经过滤掉了这些数据。通过在配置中加入<code>strip_query_terms off</code>保存，重新启动，再次查看日志，就可以看到查询参数了。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="mf">1434340777.200</span>    <span class="mi">287</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.100</span> <span class="n">TCP_MISS</span><span class="o">/</span><span class="mi">200</span> <span class="mi">82272</span> <span class="n">GET</span> <span class="nl">http:</span><span class="c1">//m.baidu.com/s?from=1097d&amp;word=%E6%8A%80%E6%9C%AF%E5%B0%8F%E9%BB%91%E5%B1%8B - HIER_DIRECT/115.239.210.14 text/html</span>
</span></code></pre></td></tr></table></div></figure>


<h3>进阶推荐</h3>

<ul>
<li><a href="http://wiki.squid-cache.org/ConfigExamples">Squid Config Examples</a></li>
<li><a href="http://www.squid-cache.org/Doc/config/">Squid configuration References</a></li>
<li><a href="http://www.amazon.cn/gp/product/B008AEI8A2/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B008AEI8A2&amp;linkCode=as2&amp;tag=droidyue-23">鸟哥的Linux私房菜:服务器架设篇</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[为什么高端人才会使用拍卖选工作]]></title>
    <link href="http://droidyue.com/blog/2015/07/06/wei-shi-yao-gao-duan-ren-cai-hui-shi-yong-pai-mai-xuan-gong-zuo/"/>
    <updated>2015-07-06T20:58:00+08:00</updated>
    <id>http://droidyue.com/blog/2015/07/06/wei-shi-yao-gao-duan-ren-cai-hui-shi-yong-pai-mai-xuan-gong-zuo</id>
    <content type="html"><![CDATA[<p><strong>本文为<a href="http://droidredirect.sinaapp.com/100offer_redirect.php">100offer</a>合作文章，由100offer为本网站提供专业的职场相关的文章，感兴趣的或者有跳槽的童鞋们不防读一读</strong>。</p>

<p>想象一下，当你在一个网站上递交你的简历后，你会像珐琅彩瓷一样被各个公司竞相拍卖，确定到合适的「买主」之后，专车把你送到面试的地点；入职当天，你会收到精心准备的小礼物，通过试用期后，你还会收到 3000 元的奖金奖励！</p>

<!--more-->


<p>程序员粘永把简历挂在网站后不久，就接到一个 HR的电话，「太快了」，不到一周，他就得到了心仪已久的公司 Strikingly 的面试机会，顺利入职。</p>

<p>啧啧，听上去像是广告一样。</p>

<p>但这是个真实的故事，这个网站叫100offer。在星巴克初次见面，100offer 创始人贾智凡向我介绍：我们在做这样一件事——帮中高端程序员高效地选一份更好的工作。</p>

<p>「4万名程序员，2600家互联网公司，参加拍卖的程序员90%至少拿到一个offer，平均每人可收到12个靠谱面试机会。」这是100offer 上线8个月交出的成绩，不久前他们拿到了2000万人民币A轮融资。</p>

<h3>牛人用「拍卖方式」来选工作，有什么合理性？</h3>

<p>相比于迷茫又急于找到工作的应届生，进入职场多年的中高端人才的选择则非常慎重——有着明确的薪资提升与发展空间的需求，所以猎头和朋友推荐是过去的常用途径。然而凭借猎头和人脉圈，提供的选择机会终究是有限的，中高端人才找工作很容易，但「选」到满意的工作实属不易。</p>

<p>「拍卖」，则提供了独特的价值：一次申请，匿名挑选2600家公司，总有很多猎头和人脉圈无法触及的「惊喜」机会；与此同时相比于「广告密集、色彩缤纷」的招聘网站，拍卖网站帮高端人才做了一次信用保证，求职者完全变身稀缺品，企业需要刻不容缓争抢。</p>

<p>「求职人群中，应届生很容易得到来自前辈与亲友的建议与指点，而且各方面要求相对较低，中高端程序员则往往无法在普通招聘网站中满足待遇升值的需求，这同样也是100offer的机遇。」贾智凡强调，「人才拍卖不是招聘网站，我们只服务于缺选择不缺工作的高端人才，帮他们高效地选一份更好的工作」。</p>

<h3>求职者和招聘方需求相互矛盾，拍卖产品偏向谁？</h3>

<p><img src="http://7xk6z0.com1.z0.glb.clouddn.com/100offer_office.jpg"></p>

<p>「招聘方和求职方的需求是矛盾的，候选人希望企业信息足够透明，再向企业透露信息，企业方则希望尽快获得简历，可以直接打电话。我们非常重视求职方的体验。」</p>

<p>在星巴克，这个看上去不善言辞的创业者一边喝着茶一边回答我的疑问。在产品功能的轻重缓急上，他已经考虑了很多。通常情况下，他要低头思考几秒钟，才给出答案。</p>

<p>「每一个通过100offer入职的候选人，会收到3000元奖金；同时100offer向企业收取一定费用」，从100offer的选择上可以看出对求职者的极度偏向。</p>

<h3>拍卖产品是如何一步步打动高端用户的？</h3>

<p>其实，100offer的定位非常严苛：一线互联网公司、2年以上工作经验、年薪20万起。这部分用户理性、缜密、渴望自由并佩服真正有本事的成功者，同时过去大多使用猎头和朋友推荐，100offer需要攻克的是互联网领域最难被说服的用户。</p>

<p>2014年7月100offer上线，「起初时挺焦虑的，毕竟从零开始，也没人相信我们，但后来觉得反正也没啥可失去的，慢慢内心就柔软淡定了。」贾智凡说。100offer前1000个用户来源于程序员社区V2EX，「其实大家只是出于猎奇的心态，并来试试验证下真实性。那时用户少，我们1个半月拍卖一次，每次50~100个优质候选人。」</p>

<p>但再怎么样，这些高端用户被猎头、朋友、HR围绕，其实并不缺一个机会，「他们缺少的是好的选择，100offer所解决的，就是帮他们高效地选更好的工作」，贾智凡介绍，上线不到一年时间，100offer每周开始一次新的拍卖，100~200人，这也证实了100offer的价值。「对于这批用户，真正打动他们的是真实的效果。」</p>

<p>在竞争激烈的招聘领域，这家网站的独特思路让我看起来和所有其他的网站都不太一样。</p>

<p><img src="http://7xk6z0.com1.z0.glb.clouddn.com/100offer_timeline.jpg"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[程序员必读的六本书]]></title>
    <link href="http://droidyue.com/blog/2015/07/04/six-books-every-programer-must-read/"/>
    <updated>2015-07-04T18:37:00+08:00</updated>
    <id>http://droidyue.com/blog/2015/07/04/six-books-every-programer-must-read</id>
    <content type="html"><![CDATA[<p>作为一名程序员，日常的工作除了上班撸代码就是加班撸代码了。撸码其实不难，无非询问Google，StackOverflow，解决方法和demo一箩筐，可是撸的一手好代码着实不易。无独有偶，码农一抓一大把，优秀的程序员却不易寻觅。优秀的程序员既不可能出自各种天花乱坠的培训机构，更不可能来自挖掘机摇篮山东布鲁斯特，大多数优秀的程序员有一个共同点，那就是自学。</p>

<p>为什么是自学呢？首先大学的教育不可能让你成为专家级别的程序员，其次为了能从团队脱颖而出必然付出更多的努力来学习。自学其实是一种很强有力的能力，一旦掌握，许多技术和问题都可以轻松搞定。</p>

<p>中学物理常客牛顿曾说，”如果我比别人看得更远，那是因为我站在巨人的肩上“。他山之石，可以攻玉。阅读大师巨匠的作品无疑是最有效的自学方式之一。业界知名的Bob大叔是代码整洁和面向对象编程的坚定支持推进者，其在这方面的著作可以称得上权威。Martin Fowler同样名声在外，他的关于重构的著作<a href="http://droidredirect.sinaapp.com/book_refactor.php">《重构&mdash;-改善既有代码的设计》</a>应该是人手一本。阅读诸如上面两位大家的著作，对技术提到大有裨益。</p>

<!--more-->


<p>本文讲列举六本业界牛人的著作，也是编程书籍中经典的经典，这几本书并非简单的教程书籍，而是教给你方法和思想来解决现实遇到的问题，提高编码的技艺和境界。</p>

<h3>重构&mdash;-改善既有代码的设计</h3>

<p><img class="left" src="http://7jpolu.com1.z0.glb.clouddn.com/refactor.jpeg" width="218" title="refactor" >
何为重构，一言以蔽之，就是在不改变外部行为的前提下，有条不紊地改善代码。本书虽然使用Java语言书写示例代码，但是其概念与思想同样适合于其他语言。书中，作者以一些平淡无奇，甚至带有坏味道的代码开始，一步一步地修改转变成更加灵活，可重用的代码。通过书中的示例，你会清楚地明白什么才是整洁的代码。重构其实依然成为经验丰富的程序员的必备技能，当你想要改善重构代码时，读一读这本书就会让你有章可循，豁然开朗。<br/>
查看详细：<a href="http://droidredirect.sinaapp.com/book_refactor.php">亚马逊</a></p>

<br/>


<br/>


<h3>代码整洁之道</h3>

<p><img class="left" src="http://7jpolu.com1.z0.glb.clouddn.com/clean_code.jpeg">
这是我最喜欢的一本书，不止一次我将它推荐给我的同事，读者还有学生。我认为它可以称得上软件开发与编码方便最好的一本书。Bob大叔我想无需做介绍，他写过一个关于敏捷开发的系列书籍，我的书架上就有他的 <a href="http://www.amazon.cn/gp/product/B0031M9GHC/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B0031M9GHC&amp;linkCode=as2&amp;tag=droidyue-23">《代码整洁之道》</a>,<a href="http://www.amazon.cn/gp/product/B0098NRHHY/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B0098NRHHY&amp;linkCode=as2&amp;tag=droidyue-23">《程序员的职业素养》</a>，
<a href="http://www.amazon.cn/gp/product/B00116MMA8/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B00116MMA8&amp;linkCode=as2&amp;tag=droidyue-23">《敏捷软件开发(原则模式与实践)》</a>，<a href="http://www.amazon.cn/gp/product/B00116MMA8/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B00116MMA8&amp;linkCode=as2&amp;tag=droidyue-23">《敏捷软件开发(原则模式与实践)》</a>，<a href="http://www.amazon.cn/gp/product/0131428489/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=0131428489&amp;linkCode=as2&amp;tag=droidyue-23">《UML for Java For Programmers》</a>， 《Extreme Programming in Practice》等这些书籍。虽然他的这些书有点老旧，但是这些书仍然很有价值，纵使数十年之后，这些书依旧受用，尤其是在面向对象编程方面。
 本书不仅仅是告诉你要做什么，还教会你什么不能做。书中有关于代码味道的一个章节，全面列举了大多数程序员遇到的各种错误，其后的章节则详细描述如何纠正这些错误。比如如何将过长的switch声明转换成遵循开放闭合原则的模型，如何利用集成和多态。再次啰嗦一下，这本书确实值得每个程序员拥有。和上本书一样，书中的例子使用Java语言，但依然适合使用其他面向对象编程语言的开发者阅读。想要撸的一手好码，这本书必不可少。<br/>
查看详细:<a href="http://www.amazon.cn/gp/product/B0031M9GHC/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B0031M9GHC&amp;linkCode=as2&amp;tag=droidyue-23">亚马逊</a></p>

<h3>代码大全</h3>

<p><img class="left" src="http://7jpolu.com1.z0.glb.clouddn.com/code_complete.jpeg"></p>

<p>想必这本书大家都曾阅读过，这就是鼎鼎大名的《代码大全》，从某个角度看，它其实就是C++版的《代码整洁之道》。本书的目标就是帮开发者使用做高质的代码写出更好的软件。同样书中也涉及了编程中常见问题和最佳实践。这本书也可以称得上是必读书籍，尤其是对于C和C++程序员。《代码大全(第2版)》中所论述的技术不仅填补了初级与高级编程实践之间的空白，而且也为程序员们提供了一个有关软件开发技术的信息来源。《代码大全(第2版)》对经验丰富的程序员、技术带头人、自学的程序员及没有太多编程经验的学生都是大有裨益的。可以说，只要你具有一定的编程基础，想成为一名优秀的程序员，阅读《代码大全(第2版)》都不会让你失望。<br/>
查看详细:<a href="http://www.amazon.cn/gp/product/B0061XKRXA/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B0061XKRXA&amp;linkCode=as2&amp;tag=droidyue-23">亚马逊</a></p>

<h3>单元测试的艺术</h3>

<p><img class="left" src="http://7jpolu.com1.z0.glb.clouddn.com/the_art_of_unit_test.jpeg">
如果非要做一件改善项目，提高开发者水平的事情，我想那就是让开发者掌握单元测试的能力。对于专业的开发者来说，单元测试是一项必备的技能，多数的程序员却不具备TDD（测试驱动开发）的能力。我虽然在不太遵循TDD这种模式，但是也会为自己写的或维护的代码编写单元测试。对于工程来说，开源项目基本都严格遵守执行单元测试，而很多商业的工程则在单元测试方面有所缺失。一个拥有单元测试的项目会变得更加容易维护和更改。本书会介绍成功的项目与失败项目的差别，可维护的代码库与不可维护的代码库之间的区别。本书示例为.NET代码，但这并不会影响你了解单元测试。如果你是一名技术负责人或者项目负责人，这本书可以帮你更好地把控项目代码质量。如果你看Java更舒服的话，也可以看一看这本书<a href="http://www.amazon.cn/gp/product/B007NDAPHK/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B007NDAPHK&amp;linkCode=as2&amp;tag=droidyue-23">《JUnit实战(第2版)》</a>。<br/>
查看详细:<a href="http://www.amazon.cn/gp/product/B00MBQMFLI/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B00MBQMFLI&amp;linkCode=as2&amp;tag=droidyue-23">亚马逊</a></p>

<h3>精益软件开发管理之道</h3>

<p><img class="left" src="http://7jpolu.com1.z0.glb.clouddn.com/Leading_Lean_Software_Developer.jpeg">
《精益软件开发管理之道》是一本软件开发方法学的书。作者从24个不同的视角，在更大的空间、时间、行业、文化背景下，考察了敏捷和精益方法。《精益软件开发管理之道》详细阐述了敏捷和精益开发方法取得成功的深层原因。《精益软件开发管理之道》包括以下内容：系统思考，以适当足够的方式关注客户；技术杰出，介绍了杰出软件开发的基础-低耦合的架构、测试驱动的开发过程等；可靠交付，讨论了工作流和日程计划，以及反馈的重要作用；无情改进，讨论了所有精益组织的基本特点：持续不断、永不满足的改进；卓越的人，卓越的结果来自于卓越的人；一致的领导，讨论在领导团队中达成一致。<br/>
查看详细：<a href="http://www.amazon.cn/gp/product/B0056E8SUO/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B0056E8SUO&amp;linkCode=as2&amp;tag=droidyue-23">亚马逊</a></p>

<br/>


<br/>


<h3>设计模式 可复用面向对象软件的基础</h3>

<p><img class="left" src="http://7jpolu.com1.z0.glb.clouddn.com/design_patterns.jpeg">
这本书要么你读过，要么就是听说过，这就是经典的GOF（Gang of Four 中文译为四人帮）设计模式一书。该书作者为四人，分别是Eric Gamma, Richard Helm, Ralph Johnson, 和John Vissides。四位顶尖的面向对象领域专家精心选取了最具价值的设计实践，加以分类整理和命名，并用简洁而易于重用的形式表达出来。本书已经成为面向对象技术人员的圣经和词典，书中定义的23个模式逐渐成为开发界技术交流所必备的基础知识和语汇。使用这些设计模式，我们可以设计出灵活，优雅和可重用的可扩展的设计。<br/>
查看详细：<a href="http://www.amazon.cn/gp/product/B001130JN8/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B001130JN8&amp;linkCode=as2&amp;tag=droidyue-23">亚马逊</a></p>

<br/>


<br/>


<br/>


<br/>


<h3>颈椎病康复指南</h3>

<p>最新更新，原文不包含本书，应读者评论要求，特意加入此书。</p>

<p>写代码不仅是头脑的工作，更是体力的付出。长年累月，身体必然出现问题。脂肪肝，脊椎病等等。希望这本书可以给你脊椎病恢复提供指导。<br/>
查看详细：<a href="http://www.amazon.cn/gp/product/B0085UMKXC/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B0085UMKXC&amp;linkCode=as2&amp;tag=droidyue-23">亚马逊</a></p>

<h3>原文参考</h3>

<ul>
<li><a href="http://javarevisited.blogspot.com/2014/09/top-6-books-to-learn-programming-coding.html">6 Books to Learn and Master Programming and Coding &ndash; Must Read</a></li>
<li>原文为墙外地址</li>
<li>本文对原文有删减和修改</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[这就是观察者模式]]></title>
    <link href="http://droidyue.com/blog/2015/06/27/desgign-pattern-observer/"/>
    <updated>2015-06-27T10:40:00+08:00</updated>
    <id>http://droidyue.com/blog/2015/06/27/desgign-pattern-observer</id>
    <content type="html"><![CDATA[<p>观察者模式是软件设计模式中的一种，使用也比较普遍，尤其是在GUI编程中。关于设计模式的文章，网络上写的都比较多，而且很多文章写的也不错，虽然说有一种重复早轮子的嫌疑，但此轮子非彼轮子，侧重点不同，思路也不同，讲述方式也不近相同。</p>

<!--more-->


<h2>定义</h2>

<p>关于定义，最准确的莫过于<a href="http://www.amazon.cn/gp/product/B0011FBU34/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B0011FBU34&amp;linkCode=as2&amp;tag=droidyue-23">Head First设计模式</a>中写到的。</p>

<blockquote><p>观察者模式定义了一个一对多的依赖关系，让一个或多个观察者对象监听一个主题对象。这样一来，当被观察者状态发生改变时，需要通知相应的观察者，使这些观察者对象能够自动更新。</p></blockquote>

<h2>关键要素</h2>

<h3>主题</h3>

<p>主题是观察者观察的对象，一个主题必须具备下面三个特征。</p>

<ul>
<li>持有监听的观察者的引用</li>
<li>支持增加和删除观察者</li>
<li>主题状态改变，通知观察者</li>
</ul>


<h3>观察者</h3>

<p>当主题发生变化，收到通知进行具体的处理是观察者必须具备的特征。</p>

<h2>为什么要用这种模式</h2>

<p>这里举一个例子来说明，牛奶送奶站就是主题，订奶客户为监听者，客户从送奶站订阅牛奶后，会每天收到牛奶。如果客户不想订阅了，可以取消，以后就不会收到牛奶。</p>

<h3>松耦合</h3>

<ul>
<li>观察者增加或删除无需修改主题的代码，只需调用主题对应的增加或者删除的方法即可。</li>
<li>主题只负责通知观察者，但无需了解观察者如何处理通知。举个例子，送奶站只负责送递牛奶，不关心客户是喝掉还是洗脸。</li>
<li>观察者只需等待主题通知，无需观察主题相关的细节。还是那个例子，客户只需关心送奶站送到牛奶，不关心牛奶由哪个快递人员，使用何种交通工具送达。</li>
</ul>


<h3>通知不错过</h3>

<p>由于被动接受，正常情况下不会错过主题的改变通知。而主动获取的话，由于时机选取问题，可能导致错过某些状态。</p>

<h2>Java实现</h2>

<p>Java中有观察者模式使用的API</p>

<ul>
<li>java.util.Observable 这是一个类，而非接口，主题需要继承这个类。</li>
<li>java.util.Observer   这是一个接口，监听者需要实现这个接口。</li>
</ul>


<h3>示例代码</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">import</span> <span class="nn">java.util.Observable</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.Observer</span><span class="o">;</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainRoot</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">Observer</span> <span class="n">consumer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Consumer</span><span class="o">();</span>
</span><span class='line'>      <span class="n">MilkProvider</span> <span class="n">provider</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MilkProvider</span><span class="o">();</span>
</span><span class='line'>      <span class="n">provider</span><span class="o">.</span><span class="na">addObserver</span><span class="o">(</span><span class="n">consumer</span><span class="o">);</span>
</span><span class='line'>      <span class="n">provider</span><span class="o">.</span><span class="na">milkProduced</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MilkProvider</span> <span class="kd">extends</span> <span class="n">Observable</span> <span class="o">{</span>
</span><span class='line'>      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">milkProduced</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">setChanged</span><span class="o">();</span><span class="c1">//状态改变，必须调用</span>
</span><span class='line'>          <span class="n">notifyObservers</span><span class="o">();</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Consumer</span> <span class="kd">implements</span> <span class="n">Observer</span> <span class="o">{</span>
</span><span class='line'>      <span class="nd">@Override</span>
</span><span class='line'>      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">(</span><span class="n">Observable</span> <span class="n">arg0</span><span class="o">,</span> <span class="n">Object</span> <span class="n">arg1</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Consumer update...&quot;</span> <span class="o">+</span> <span class="n">arg0</span> <span class="o">+</span> <span class="s">&quot;;arg1=&quot;</span> <span class="o">+</span> <span class="n">arg1</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>上述代码完成了</p>

<ul>
<li>将consumer加入主题provider的观察者行列</li>
<li>provider设置状态变化，通知持有的观察者</li>
<li>观察者consumer收到通知，打印日志处理</li>
</ul>


<h3>setChanged为何物</h3>

<p>其实上述代码中存在这样一处代码<code>setChanged();</code>，如果在通知之前没有调用这个方法，观察者是收不到通知的，这是为什么呢</p>

<p>这里我们看一下setChanged的源码</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">protected</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">setChanged</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">changed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>很简单，然后找一下谁使用changed这个值</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">boolean</span> <span class="nf">hasChanged</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">changed</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>notifyObservers的代码</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">notifyObservers</span><span class="o">(</span><span class="n">Object</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>    <span class="n">Observer</span><span class="o">[]</span> <span class="n">arrays</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">hasChanged</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">clearChanged</span><span class="o">();</span>
</span><span class='line'>          <span class="n">size</span> <span class="o">=</span> <span class="n">observers</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
</span><span class='line'>          <span class="n">arrays</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Observer</span><span class="o">[</span><span class="n">size</span><span class="o">];</span>
</span><span class='line'>          <span class="n">observers</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="n">arrays</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">arrays</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">for</span> <span class="o">(</span><span class="n">Observer</span> <span class="n">observer</span> <span class="o">:</span> <span class="n">arrays</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">observer</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>但是为什么要加入这样一个开关呢？可能原因大致有三点</p>

<p>  1.筛选有效通知，只有有效通知可以调用setChanged。比如，我的微信朋友圈一条状态，好友A点赞，后续该状态的点赞和评论并不是每条都通知A，只有A的好友触发的操作才会通知A。</p>

<p>  2.便于撤销通知操作，在主题中，我们可以设置很多次setChanged，但是在最后由于某种原因需要取消通知，我们可以使用clearChanged轻松解决问题。</p>

<p>  3.主动权控制，由于setChanged为protected,而notifyObservers方法为public，这就导致存在外部随意调用notifyObservers的可能，但是外部无法调用setChanged，因此真正的控制权应该在主题这里。</p>

<h3>主动获取</h3>

<p>观察者模式即所谓的推送方式，然而推送并非完美无缺。比如主题变化会推送大量的数据，而其中的一些观察者只需要某项数据，此时观察者就需要在具体实现中花费时间筛选数据。</p>

<p>这确实是个问题，想要解决也不难，需要主题为某些数据提供getter方法，观察者只需调用getter取数据处理即可。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>  <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MilkProvider</span> <span class="kd">extends</span> <span class="n">Observable</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">milkProduced</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">setChanged</span><span class="o">();</span><span class="c1">//状态改变，必须调用</span>
</span><span class='line'>      <span class="n">notifyObservers</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">float</span> <span class="nf">getPrice</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="mf">2.5f</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Consumer</span> <span class="kd">implements</span> <span class="n">Observer</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">(</span><span class="n">Observable</span> <span class="n">arg0</span><span class="o">,</span> <span class="n">Object</span> <span class="n">arg1</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">MilkProvider</span> <span class="n">provider</span> <span class="o">=</span> <span class="o">(</span><span class="n">MilkProvider</span><span class="o">)</span><span class="n">arg0</span><span class="o">;</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;milk price =&quot;</span> <span class="o">+</span> <span class="n">provider</span><span class="o">.</span><span class="na">getPrice</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>不足与隐患</h2>

<p>主要的问题表现在内存管理上，主要由以下两点</p>

<ul>
<li>主题持有观察者的引用，如果未正常处理从主题中删除观察者，会导致观察者无法被回收。</li>
<li>如果观察者具体实现代码有问题，会导致主题和观察者对象形成循环引用，在某些采用引用计数的垃圾回收器可能导致无法回收。</li>
</ul>


<h2>书山有路</h2>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B00INI842W/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B00INI842W&amp;linkCode=as2&amp;tag=droidyue-23">设计模式之禅</a></li>
<li><a href="http://www.amazon.cn/gp/product/B0011FBU34/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B0011FBU34&amp;linkCode=as2&amp;tag=droidyue-23">Head First设计模式</a></li>
<li><a href="http://www.amazon.cn/gp/product/B001130JN8/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B001130JN8&amp;linkCode=as2&amp;tag=droidyue-23">设计模式 可复用面向对象软件的基础 </a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Google Play Services 7.5新增API及多项特性]]></title>
    <link href="http://droidyue.com/blog/2015/06/23/google-play-services-7-dot-5-adds-new-capabilities/"/>
    <updated>2015-06-23T21:00:00+08:00</updated>
    <id>http://droidyue.com/blog/2015/06/23/google-play-services-7-dot-5-adds-new-capabilities</id>
    <content type="html"><![CDATA[<h3>版权说明</h3>

<p>本文为 InfoQ 中文站特供稿件，首发地址为：<a href="http://www.infoq.com/cn/news/2015/06/google-play-services-75">文章链接</a>。如需转载，请与 InfoQ 中文站联系。</p>

<h3>摘要</h3>

<p>最近的Google I/O开发者大会上，Google宣布推出7.5版的Google Play服务，该版本在特性方面增加了诸如智能密码锁和实例ID等功能。在API方面，增加了Google云推送和Google Cast相关的API，同时在Android Wear设备上支持访问Google地图API。</p>

<!--more-->


<h3>正文</h3>

<p>最近的Google I/O开发者大会上，Google<a href="http://android-developers.blogspot.com.es/2015/05/a-closer-look-at-google-play-services-75.html">宣布</a>推出7.5版的Google Play服务，该版本在特性方面增加了诸如智能密码锁和实例ID等功能。在API方面，增加了Google云推送和Google Cast相关的API，同时在Android Wear设备上支持访问Google地图API。</p>

<p><strong>智能密码锁</strong></p>

<p><a href="https://developers.google.com/identity/smartlock-passwords/android/">智能密码锁</a>为了简化登陆流程，增加了名为<a href="https://developer.android.com/reference/com/google/android/gms/auth/api/credentials/CredentialsApi.html">CredentialsApi</a>的API和UI，并允许我们对已保存的证书进行检索和保存以备后用。密码管理器是从Chrome浏览器的密码管理器演变而来。了解更多关于该功能细节，请查阅InfoQ<a href="http://www.infoq.com/news/2015/06/google-smart-lock-passwords">具体介绍文章</a>。</p>

<p><strong>实例ID，身份与授权</strong></p>

<p><a href="https://developers.google.com/instance-id/reference">实例ID</a>是一项云服务，该服务用来提供一个唯一的ID来唯一性鉴定应用实例。使用的场景比如确定哪一个应用实例正在发送请求等问题。实例ID还可以用来生成安全令牌，使用安全令牌可以授权第三方应用访问你的应用的服务器端控制的资源，同时安全令牌也可以用来验证一个应用的真实性。</p>

<p><strong>Google云推送</strong></p>

<p>上面提到的实例ID与<a href="https://developer.android.com/google/gcm/index.html">Google云推送</a>紧密相关，Google云推送作为一个服务，既可以接收来自服务器端的信息也可以从客户端向服务器端传送数据。此外，Google云推送还新加入了一个API允许应用设置一个或多个话题进而帮助消息能够精准推送。不仅如此，该服务还增加了一个新的类<a href="https://developer.android.com/reference/com/google/android/gms/gcm/GcmNetworkManager.html">GcmNetworkManager</a>，使用这个类，当服务器端有新信息时，应用与服务器端进行数据同步更加容易。GcmNetworkManager支持对常见行为的处理，比如等待网络连接，设备充电，网络重试和回退等，另外它还支持对后台网络操作的调度进行优化。</p>

<p><strong>Google Cast</strong></p>

<p>众所周知，Google Cast是一套将设备内容呈现到电视或者音响的解决方案，新增的<a href="https://developers.google.com/cast/docs/remote">远程显示API</a>使得管理镜像显示更加容易，另外通过增加媒体队列使得<a href="https://developer.android.com/reference/com/google/android/gms/cast/RemoteMediaPlayer.html">RemoteMediaPlayer</a>可以无缝支持媒体重放。</p>

<p><strong>Google地图和Google Fit</strong></p>

<p>正如一开始提到的，在Android Wear设备上可以使用Google<a href="http://developer.android.com/reference/com/google/android/gms/maps/package-summary.html">地图API</a>了。</p>

<p><a href="https://developers.google.com/fit/">Google Fit</a>，用来构建健康应用解决方案，现在可以使用新增加的<a href="https://developer.android.com/reference/com/google/android/gms/fitness/RecordingApi.html">RecordingApi</a>收集行走距离和燃烧的卡路里数据。</p>

<p>Google Play服务是一个有着系统级别权限的并且可升级的服务和API。正如InfoQ<a href="http://www.infoq.com/news/2013/09/play-services-beat-fragmentation">指出的</a>那样，”在这种情况下，Google可以在宣布之后数天内铺开这些新特性“，如果没有这项服务，则需要底层系统的更新。因为Play服务完全由Google控制，OEM厂商无法修改，所以该服务在缓解软件碎片化问题上起了很关键的作用。</p>

<p><strong>查看英文原文：</strong><a href="http://www.infoq.com/news/2015/06/google-play-services-75">Google Play Services 7.5 Adds New Capabilities, APIs, and More</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[说说依赖注入]]></title>
    <link href="http://droidyue.com/blog/2015/06/13/talk-show-about-dependency-injection/"/>
    <updated>2015-06-13T22:59:00+08:00</updated>
    <id>http://droidyue.com/blog/2015/06/13/talk-show-about-dependency-injection</id>
    <content type="html"><![CDATA[<p>在面向对象编程中，我们经常处理处理的问题就是解耦，程序的耦合性越低表明这个程序的可读性以及可维护性越高。控制反转(Inversion of Control或IoC)就是常用的面向对象编程的设计原则，使用这个原则我们可以降低耦合性。其中依赖注入是控制反转最常用的实现。</p>

<!--more-->


<h2>什么是依赖</h2>

<p>依赖是程序中常见的现象，比如类Car中用到了GasEnergy类的实例energy，通常的做法就是在Car类中显式地创建GasEnergy类的实例，并赋值给energy。如下面的代码</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">interface</span> <span class="nc">Energy</span> <span class="o">{</span>
</span><span class='line'>      
</span><span class='line'><span class="o">}</span>
</span><span class='line'>  
</span><span class='line'><span class="kd">class</span> <span class="nc">GasEnergy</span> <span class="kd">implements</span> <span class="n">Energy</span> <span class="o">{</span>
</span><span class='line'>      
</span><span class='line'><span class="o">}</span>
</span><span class='line'>  
</span><span class='line'><span class="kd">class</span> <span class="nc">Car</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">Energy</span> <span class="n">energy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GasEnergy</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>存在问题</h2>

<ul>
<li>类Car承担了多余的责任，负责energy对象的创建，这必然存在了严重的耦合性。举一个现实中的例子，一辆汽车使用哪种能源不是由汽车来决定，而是由汽车制造商（CarMaker）来决定，这是汽车制造商的责任。</li>
<li>可扩展性，假设我们想修改能源为电动力，那么我们必然要修改Car这个类，明显不符合开放闭合原则。</li>
<li>不利于单元测试。</li>
</ul>


<h2>依赖注入</h2>

<p>依赖注入是这样的一种行为，在类Car中不主动创建GasEnergy的对象，而是通过外部传入GasEnergy对象形式来设置依赖。
常用的依赖注入有如下三种方式</p>

<h3>构造器注入</h3>

<p>将需要的依赖作为构造方法的参数传递完成依赖注入。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">class</span> <span class="nc">Car</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">Energy</span> <span class="n">mEnergy</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">public</span> <span class="nf">Car</span><span class="o">(</span><span class="n">Energy</span> <span class="n">energy</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">mEnergy</span> <span class="o">=</span> <span class="n">energy</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Setter方法注入</h3>

<p>增加setter方法，参数为需要注入的依赖亦可完成依赖注入。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">class</span> <span class="nc">Car</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">Energy</span> <span class="n">mEnergy</span><span class="o">;</span>
</span><span class='line'>      
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEnergy</span><span class="o">(</span><span class="n">Energy</span> <span class="n">energy</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">mEnergy</span>  <span class="o">=</span> <span class="n">energy</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>接口注入</h3>

<p>接口注入，闻其名不言而喻，就是为依赖注入创建一套接口，依赖作为参数传入，通过调用统一的接口完成对具体实现的依赖注入。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">interface</span> <span class="nc">EnergyConsumerInterface</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEnergy</span><span class="o">(</span><span class="n">Energy</span> <span class="n">energy</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>  
</span><span class='line'><span class="kd">class</span> <span class="nc">Car</span> <span class="kd">implements</span> <span class="n">EnergyConsumerInterface</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">Energy</span> <span class="n">mEnergy</span><span class="o">;</span>
</span><span class='line'>      
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEnergy</span><span class="o">(</span><span class="n">Energy</span> <span class="n">energy</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">mEnergy</span>  <span class="o">=</span> <span class="n">energy</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>接口注入和setter方法注入类似，不同的是接口注入使用了统一的方法来完成注入，而setter方法注入的方法名称相对比较随意。</p>

<h2>框架取舍</h2>

<p>依赖注入有很多框架，最有名的就是Guice，当然Spring也支持依赖注入。Guice采用的是运行时读取注解，通过反射的形式生成依赖并进行注入。这种形式不太适合Android移动设备，毕竟这些操作都在运行时处理，对性能要求较高。</p>

<p>Dagger则是Android开发适合的依赖注入库，其同样采用类注解的形式，不同的是它是在编译时生成辅助类，等到在运行时使用生成的辅助类完成依赖注入。</p>

<h3>用还是不用</h3>

<p>其实注入框架用还是不用，是一个问题，如若使用框架，则要求团队每一个人都要遵守说明来编写代码解决依赖注入。而这些框架其实也并非很容易就能上手，学习系数相对复杂，难以掌握，这也是需要考虑的问题。</p>

<p>个人观点为不推荐也不反对使用这些框架，但是觉得有些时候我们寄希望于一个框架，不如平时注意这些问题，人为避免何尝不是对自己的一种基本要求呢？</p>

<h2>依赖查找</h2>

<p>依赖查找和依赖注入一样属于控制反转原则的具体实现，不同于依赖注入的被动接受，依赖查找这是主动请求，在需要的时候通过调用框架提供的方法来获取对象，获取时需要提供相关的配置文件路径、key等信息来确定获取对象的状态。</p>

<h2>书籍推荐</h2>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B004G8P90S/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B004G8P90S&amp;linkCode=as2&amp;tag=droidyue-23">研磨设计模式</a></li>
<li><a href="http://www.amazon.cn/gp/product/B00INI842W/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B00INI842W&amp;linkCode=as2&amp;tag=droidyue-23">设计模式之禅</a></li>
<li><a href="http://www.amazon.cn/gp/product/B0011FBU34/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B0011FBU34&amp;linkCode=as2&amp;tag=droidyue-23">Head First设计模式</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[垃圾回收器如何处理循环引用]]></title>
    <link href="http://droidyue.com/blog/2015/06/05/how-garbage-collector-handles-circular-references/"/>
    <updated>2015-06-05T23:24:00+08:00</updated>
    <id>http://droidyue.com/blog/2015/06/05/how-garbage-collector-handles-circular-references</id>
    <content type="html"><![CDATA[<p>垃圾回收是一门编程语言中必不可少的一部分，不论是手动释放内存的C和C++，还是自动回收垃圾的Java和C#等语言。对于Java这样的语言，一般的开发者不强求关心对象回收和内存释放，但是理解垃圾回收对开发工作还是大有裨益的。</p>

<!--more-->


<p>在编程语言中，普遍存在着循环引用这样的问题，垃圾回收器是如何处理循环引用呢，常用的垃圾回收有引用计数和引用对象遍历两种实现，它们各自又是如何处理循环引用呢？本文讲以JVM中的GC为例逐一回答这些问题。</p>

<h2>何为循环引用</h2>

<p>如果有两个或者以上的对象，它们彼此引用，就会造成循环引用。如下面的例子</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">class</span> <span class="nc">Node</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">Node</span> <span class="n">next</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">Node</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Node</span><span class="o">();</span>
</span><span class='line'><span class="n">Node</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Node</span><span class="o">();</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
</span><span class='line'><span class="n">b</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>代码中，a对象引用了b对象，b对象也引用了a对象，这种情况下a对象和b对象就形成了循环引用。</p>

<h2>引用计数GC处理</h2>

<h3>什么是引用计数</h3>

<p>引用计数是一种垃圾回收的形式，每一个对象都会有一个计数来记录有多少指向它的引用。其引用计数会变换如下面的场景</p>

<ul>
<li>当对象增加一个引用，比如赋值给变量，属性或者传入一个方法，引用计数执行加1运算。</li>
<li>当对象减少一个引用，比如变量离开作用域，属性被赋值为另一个对象引用，属性所在的对象被回收或者之前传入参数的方法返回，引用计数执行减1操作。</li>
<li>当引用计数变为0，代表该对象不被引用，可以标记成垃圾进行回收。</li>
</ul>


<h3>如何处理</h3>

<p>实际上单纯的基于引用计数实现的计数器无法处理循环引用带来的问题。</p>

<p>CPython的垃圾回收就是采用引用计数,采用引用计数的主垃圾回收器会清理垃圾，对于那些因为循环引用无法清理的对象，CPython会不时启动一个辅助的基于引用遍历的垃圾回收器来清理它们。</p>

<h2>引用遍历GC处理</h2>

<h3>什么是引用对象遍历</h3>

<p>垃圾回收器从被称为GC Roots的点开始遍历遍历对象，凡是可以达到的点都会标记为存活，堆中不可到达的对象都会标记成垃圾，然后被清理掉。
GC Roots有哪些</p>

<ul>
<li>类，由系统类加载器加载的类。这些类从不会被卸载，它们可以通过静态属性的方式持有对象的引用。注意，一般情况下由自定义的类加载器加载的类不能成为GC Roots</li>
<li>线程，存活的线程</li>
<li>Java方法<a href="http://droidyue.com/blog/2014/12/07/differences-between-stack-and-heap-in-java/">栈</a>中的局部变量或者参数</li>
<li><a href="http://droidyue.com/blog/2014/12/21/java-runtime-data-areas/">JNI方法栈</a>中的局部变量或者参数</li>
<li>JNI全局引用</li>
<li>用做同步监控的对象</li>
<li>被JVM持有的对象，这些对象由于特殊的目的不被GC回收。这些对象可能是系统的类加载器，一些重要的异常处理类，一些为处理异常预留的对象，以及一些正在执行类加载的自定义的类加载器。但是具体有哪些前面提到的对象依赖于具体的JVM实现。</li>
</ul>


<h3>如何处理</h3>

<p>基于引用对象遍历的垃圾回收器可以处理循环引用，只要是涉及到的对象不能从GC Roots<a href="http://droidyue.com/blog/2014/10/12/understanding-weakreference-in-java/">强引用</a>可到达，垃圾回收器都会进行清理来释放内存。</p>

<h2>总结</h2>

<p>基于引用计数的垃圾回收器无法处理循环引用导致的内存泄露问题，但是其在主流的JVM中很少，几乎所有的JVM都是采用引用对象遍历的方法，垃圾回收器都会处理循环引用潜在的问题。</p>

<h2>一本书</h2>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B00D2ID4PK/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B00D2ID4PK&amp;linkCode=as2&amp;tag=droidyue-23">深入理解Java虚拟机:JVM高级特性与最佳实践(第2版)</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Android中HTTP相关的API]]></title>
    <link href="http://droidyue.com/blog/2015/05/30/android-http-clients/"/>
    <updated>2015-05-30T23:09:00+08:00</updated>
    <id>http://droidyue.com/blog/2015/05/30/android-http-clients</id>
    <content type="html"><![CDATA[<p>Android中大多数应用都会发送和接受HTTP请求，在Android API中主要由两个HTTP请求的相关类，一个是HttpURLConnection，另一个是Apache HTTP Client。这两个类实现的HTTP请求都支持HTTPS协议，基于流的上传和下载，可配置超时时间，IPv6和连接池。</p>

<!--more-->


<h2>Apache HTTP Client</h2>

<p>DefaultHttpClient和同类的AndroidHttpClient都是可扩展的类。它们有大量且灵活的API，适用于网页浏览器开发。同时它们比较稳定并且bug较少。但是繁多的API的现实下，对其改善与保持兼容性不可得兼，明显Android团队的精力已然不在Apache HTTP Client。</p>

<h2>HttpURLConnection</h2>

<p>HttpURLConnection是一个通用，轻量的实现，可以满足大多数的程序进行HTTP请求。这个类虽然一开始比较简陋，但是其主要的几个API使得我们更容易进行稳定改善。</p>

<h3>连接池污染</h3>

<p>在冻酸奶（Android 2.2）之前，HttpURLConnection有着一些烦人的bug。最烦人的就是调用一个可读的InputStream的close方法会污染连接池。我们需要禁用连接池绕开这个问题，如下代码可以禁用连接池。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">disableConnectionReuseIfNecessary</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// HTTP connection reuse which was buggy pre-froyo</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">Build</span><span class="o">.</span><span class="na">VERSION</span><span class="o">.</span><span class="na">SDK</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">FROYO</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&quot;http.keepAlive&quot;</span><span class="o">,</span> <span class="s">&quot;false&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>压缩数据与大小</h3>

<p>从2.3开始，我们默认对返回的响应进行了压缩，HttpURLConnection会自动为发出去的请求加上<code>Accept-Encoding: gzip</code>这个头信息。如果gzip压缩的响应有问题，可以通过下面代码禁用gzip。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">urlConnection</span><span class="o">.</span><span class="na">setRequestProperty</span><span class="o">(</span><span class="s">&quot;Accept-Encoding&quot;</span><span class="o">,</span> <span class="s">&quot;identity&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>由于HTTP中的Content-Length头信息返回的是压缩后的大小，所以我们不能使用getContentLength()来计算未压缩数据的大小。正确的做法应该是读取HTTP响应中的字节，直到InputStream.read()方法返回为-1.</p>

<h3>HTTPs改进</h3>

<p>从Gingerbread开始，增加了对HTTPs链接的优化。在进行HTTPs请求之前，HttpsURLConnection会尝试使用服务器名字指示(Server Name Indication)，这种技术可以让多个HTTPs主机共享一个IP地址。在HTTPs请求中，HttpsURLConnection也支持压缩和会话标签（Session Tickets）。一旦连接失败，HttpsURLConnection会不使用上面的三个特性进行重试。这样即可以保证在连接时高效率地连接到最新的服务器，也可以在不破坏兼容性的同时连接到旧服务器。</p>

<h3>响应缓存</h3>

<p>从4.0开始，HttpURLConnection引入了响应缓存机制。一旦缓存创建，后续的HTTP请求会按照下面情况处理</p>

<ul>
<li>完全缓存的响应会直接从本地存储中读取，响应很快，不需要网络连接。</li>
<li>有条件的缓存必须由服务端进行freshness验证，比如client发出一个请求，如&#8221;Give me /foo.png if it changed since yesterday&#8221;，然后服务器端要么返回最新的内容，要么返回304未修改的状态。如果内容不变，则不下载。</li>
<li>没有缓存的响应需要服务器处理，然后这些请求被缓存下来。</li>
</ul>


<p>对于低于4.0的版本，我们可以使用反射开启响应的缓存机制</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">enableHttpResponseCache</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="kt">long</span> <span class="n">httpCacheSize</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="o">;</span> <span class="c1">// 10 MiB</span>
</span><span class='line'>        <span class="n">File</span> <span class="n">httpCacheDir</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">getCacheDir</span><span class="o">(),</span> <span class="s">&quot;http&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&quot;android.net.http.HttpResponseCache&quot;</span><span class="o">)</span>
</span><span class='line'>            <span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&quot;install&quot;</span><span class="o">,</span> <span class="n">File</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">long</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'>            <span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">httpCacheDir</span><span class="o">,</span> <span class="n">httpCacheSize</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">httpResponseCacheNotAvailable</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>当然，这里还需要服务器端设置HTTP缓存相关的头信息。</p>

<h2>哪家强</h2>

<p>在2.3之前的版本，Apache的HTTP请求响应实现比较稳定，bug也少，所以在那些版本上它的最好。</p>

<p>但是在2.3之后，毫无疑问，HttpURLConnection是最好的。它API精简实用，默认支持压缩，响应缓存等。最重要的这是Android团队重点投入的，而Apache的版本已经被抛弃了。所以还是使用HttpURLConnection吧。</p>

<h2>原文信息</h2>

<ul>
<li><a href="http://android-developers.blogspot.com/2011/09/androids-http-clients.html">Android’s HTTP Clients</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Gmail托管邮箱发邮件认证失败]]></title>
    <link href="http://droidyue.com/blog/2015/05/22/gmail-535-5-dot-7-8-error-authentication-failed/"/>
    <updated>2015-05-22T21:47:00+08:00</updated>
    <id>http://droidyue.com/blog/2015/05/22/gmail-535-5-dot-7-8-error-authentication-failed</id>
    <content type="html"><![CDATA[<p>Gmail是一款很优秀的邮件工具，我一直使用Gmail来托管公司的邮箱，利用最棒的过滤器进行过滤垃圾邮件。前段时间公司邮箱密码更换，使用了新的密码后导致了只能收邮件不能发邮件，每次发邮件都会提示这样的错误。</p>

<!--more-->


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Delivery</span> <span class="n">to</span> <span class="n">the</span> <span class="n">following</span> <span class="n">recipient</span> <span class="n">failed</span> <span class="nl">permanently:</span>
</span><span class='line'>     <span class="n">someone</span><span class="nd">@example.net</span>
</span><span class='line'><span class="n">Technical</span> <span class="n">details</span> <span class="n">of</span> <span class="n">permanent</span> <span class="nl">failure:</span>
</span><span class='line'><span class="n">Google</span> <span class="n">tried</span> <span class="n">to</span> <span class="n">deliver</span> <span class="n">your</span> <span class="n">message</span><span class="o">,</span> <span class="n">but</span> <span class="n">it</span> <span class="n">was</span> <span class="n">rejected</span> <span class="n">by</span> <span class="n">the</span> <span class="n">relay</span> <span class="n">smtp</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">net</span> <span class="n">by</span> <span class="n">smtp</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">net</span><span class="o">.</span> <span class="o">[</span><span class="n">xx</span><span class="o">.</span><span class="na">xx</span><span class="o">.</span><span class="na">xxx</span><span class="o">.</span><span class="na">xx</span><span class="o">].</span>
</span><span class='line'>
</span><span class='line'><span class="n">The</span> <span class="n">error</span> <span class="n">that</span> <span class="n">the</span> <span class="n">other</span> <span class="n">server</span> <span class="n">returned</span> <span class="nl">was:</span>
</span><span class='line'><span class="mi">535</span> <span class="mf">5.7</span><span class="o">.</span><span class="mi">8</span> <span class="nl">Error:</span> <span class="n">authentication</span> <span class="nl">failed:</span> <span class="n">authentication</span> <span class="n">failure</span>
</span><span class='line'> <span class="o">(</span><span class="n">SMTP</span> <span class="n">AUTH</span> <span class="n">failed</span> <span class="n">with</span> <span class="n">the</span> <span class="n">remote</span> <span class="n">server</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>后来Google查找<code>gmail SMTP AUTH failed with the remote server</code>便找到了这篇文章，于是简单整理一下了解决方法。</p>

<h2>如何修复</h2>

<p>  1.进入Gmail中的设置<br/>
  2.选择<strong>Accounts and Import</strong><br/>
  3.找到<strong>Send Mail As</strong>区域，找到刚刚出现错误的邮箱那一项，点击<strong>edit info</strong><br/>
  4.上一步会出现一个弹窗，点击<strong>Next Step</strong><br/>
  5.更新你最新的密码，按实际情况选择TLS，SSL或者不安全连接。然后点击<strong>Save Changes</strong><br/>
  6.尝试发邮件吧，一切都正常了。</p>

<h2>感谢参考文章</h2>

<ul>
<li><a href="http://www.webholism.com/blog/sara/gmail-suddenly-stopped-sending-my-business-emails/">Gmail Suddenly Stopped Sending My Business Emails</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[JAR包未加入APK程序]]></title>
    <link href="http://droidyue.com/blog/2015/05/15/jar-not-in-apk/"/>
    <updated>2015-05-15T20:45:00+08:00</updated>
    <id>http://droidyue.com/blog/2015/05/15/jar-not-in-apk</id>
    <content type="html"><![CDATA[<p>前段时间打包遇到了一个问题，jar包不能加入到apk包中。从Eclipse中完全可以，一旦放到服务器端进行打包就出现了问题。</p>

<!--more-->


<p>使用<code>ant debug -d</code>得到的信息如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="o">[</span><span class="n">dx</span><span class="o">]</span> <span class="n">trouble</span> <span class="nl">processing:</span>
</span><span class='line'>       <span class="o">[</span><span class="n">dx</span><span class="o">]</span> <span class="n">bad</span> <span class="kd">class</span> <span class="nc">file</span> <span class="n">magic</span> <span class="o">(</span><span class="n">cafebabe</span><span class="o">)</span> <span class="n">or</span> <span class="n">version</span> <span class="o">(</span><span class="mf">0033.0000</span><span class="o">)</span>
</span><span class='line'>       <span class="o">[</span><span class="n">dx</span><span class="o">]</span> <span class="o">...</span><span class="na">while</span> <span class="n">parsing</span> <span class="n">com</span><span class="o">/</span><span class="n">solo</span><span class="o">/</span><span class="n">adsdk</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="n">a</span><span class="o">.</span><span class="na">class</span>
</span><span class='line'>       <span class="o">[</span><span class="n">dx</span><span class="o">]</span> <span class="o">...</span><span class="na">while</span> <span class="n">processing</span> <span class="n">com</span><span class="o">/</span><span class="n">solo</span><span class="o">/</span><span class="n">adsdk</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="n">a</span><span class="o">.</span><span class="na">class</span>
</span><span class='line'>       <span class="o">[</span><span class="n">dx</span><span class="o">]</span>
</span><span class='line'>       <span class="o">[</span><span class="n">dx</span><span class="o">]</span> <span class="n">trouble</span> <span class="nl">processing:</span>
</span><span class='line'>       <span class="o">[</span><span class="n">dx</span><span class="o">]</span> <span class="n">bad</span> <span class="kd">class</span> <span class="nc">file</span> <span class="n">magic</span> <span class="o">(</span><span class="n">cafebabe</span><span class="o">)</span> <span class="n">or</span> <span class="n">version</span> <span class="o">(</span><span class="mf">0033.0000</span><span class="o">)</span>
</span><span class='line'>       <span class="o">[</span><span class="n">dx</span><span class="o">]</span> <span class="o">...</span><span class="na">while</span> <span class="n">parsing</span> <span class="n">com</span><span class="o">/</span><span class="n">solo</span><span class="o">/</span><span class="n">adsdk</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="n">b</span><span class="o">.</span><span class="na">class</span>
</span><span class='line'>       <span class="o">[</span><span class="n">dx</span><span class="o">]</span> <span class="o">...</span><span class="na">while</span> <span class="n">processing</span> <span class="n">com</span><span class="o">/</span><span class="n">solo</span><span class="o">/</span><span class="n">adsdk</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="n">b</span><span class="o">.</span><span class="na">class</span>
</span><span class='line'>       <span class="o">[</span><span class="n">dx</span><span class="o">]</span>
</span><span class='line'>       <span class="o">[</span><span class="n">dx</span><span class="o">]</span> <span class="n">trouble</span> <span class="nl">processing:</span>
</span><span class='line'>       <span class="o">[</span><span class="n">dx</span><span class="o">]</span> <span class="n">bad</span> <span class="kd">class</span> <span class="nc">file</span> <span class="n">magic</span> <span class="o">(</span><span class="n">cafebabe</span><span class="o">)</span> <span class="n">or</span> <span class="n">version</span> <span class="o">(</span><span class="mf">0033.0000</span><span class="o">)</span>
</span><span class='line'>       <span class="o">[</span><span class="n">dx</span><span class="o">]</span> <span class="o">...</span><span class="na">while</span> <span class="n">parsing</span> <span class="n">com</span><span class="o">/</span><span class="n">solo</span><span class="o">/</span><span class="n">adsdk</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="n">AdsLoader</span><span class="o">.</span><span class="na">class</span>
</span><span class='line'>       <span class="o">[</span><span class="n">dx</span><span class="o">]</span> <span class="o">...</span><span class="na">while</span> <span class="n">processing</span> <span class="n">com</span><span class="o">/</span><span class="n">solo</span><span class="o">/</span><span class="n">adsdk</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="n">AdsLoader</span><span class="o">.</span><span class="na">class</span>
</span><span class='line'>       <span class="o">[</span><span class="n">dx</span><span class="o">]</span>
</span><span class='line'>       <span class="o">[</span><span class="n">dx</span><span class="o">]</span> <span class="n">trouble</span> <span class="nl">processing:</span>
</span><span class='line'>       <span class="o">[</span><span class="n">dx</span><span class="o">]</span> <span class="n">bad</span> <span class="kd">class</span> <span class="nc">file</span> <span class="n">magic</span> <span class="o">(</span><span class="n">cafebabe</span><span class="o">)</span> <span class="n">or</span> <span class="n">version</span> <span class="o">(</span><span class="mf">0033.0000</span><span class="o">)</span>
</span><span class='line'>       <span class="o">[</span><span class="n">dx</span><span class="o">]</span> <span class="o">...</span><span class="na">while</span> <span class="n">parsing</span> <span class="n">com</span><span class="o">/</span><span class="n">solo</span><span class="o">/</span><span class="n">adsdk</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="n">UrlConfig</span><span class="o">.</span><span class="na">class</span>
</span><span class='line'>       <span class="o">[</span><span class="n">dx</span><span class="o">]</span> <span class="o">...</span><span class="na">while</span> <span class="n">processing</span> <span class="n">com</span><span class="o">/</span><span class="n">solo</span><span class="o">/</span><span class="n">adsdk</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="n">UrlConfig</span><span class="o">.</span><span class="na">class</span>
</span></code></pre></td></tr></table></div></figure>


<p>相比到这里，原因不言则明，原来是jar包的编译版本比工程编译的版本不一致，真实的情况是前后比后者编译版本高。
经过分析，jar包的编译环境是Java 7， 而工程打包的编译环境是Java 6.</p>

<h2>如何解决</h2>

<p>解决这个问题也简单，不出如下做法</p>

<ul>
<li>更换成Java 6编译出来的jar包</li>
<li>使用java 7 打包工程。</li>
</ul>


<h2>如何得知jar包编译版本</h2>

<h3>解压jar包</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">jar</span> <span class="n">fx</span> <span class="n">android</span><span class="o">-</span><span class="n">support</span><span class="o">-</span><span class="n">v4</span><span class="o">.</span><span class="na">jar</span>
</span></code></pre></td></tr></table></div></figure>


<p>解压后查看当前目录，会多出一个文件夹，这里是名字为android的文件夹。</p>

<h3>查看文件信息</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="mi">11</span><span class="o">:</span><span class="mi">52</span> <span class="n">$</span> <span class="n">file</span> <span class="n">android</span><span class="o">/</span><span class="n">support</span><span class="o">/</span><span class="n">v4</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">ConnectivityManagerCompat</span><span class="o">.</span><span class="na">class</span>
</span><span class='line'><span class="n">android</span><span class="o">/</span><span class="n">support</span><span class="o">/</span><span class="n">v4</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">ConnectivityManagerCompat</span><span class="o">.</span><span class="na">class</span><span class="o">:</span> <span class="n">compiled</span> <span class="n">Java</span> <span class="kd">class</span> <span class="nc">data</span><span class="o">,</span> <span class="n">version</span> <span class="mf">49.0</span> <span class="o">(</span><span class="n">Java</span> <span class="mf">1.5</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>查找版本</h3>

<p>上面我们得到了<code>version 49.0 (Java 1.5)</code>，有些情况下我们得到的只有<code>version 49.0</code>需要查找下面的列表</p>

<h4>版本映射</h4>

<ul>
<li>45.3 = Java 1.1</li>
<li>46 = Java 1.2</li>
<li>47 = Java 1.3</li>
<li>48 = Java 1.4</li>
<li>49 = Java 5</li>
<li>50 = Java 6</li>
<li>51 = Java 7</li>
<li>52 = Java 8</li>
</ul>


<h3>参考文章</h3>

<ul>
<li><a href="http://stackoverflow.com/questions/3313532/what-version-of-javac-built-my-jar">What version of javac built my jar?</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Google Play商店推广那些事]]></title>
    <link href="http://droidyue.com/blog/2015/05/11/google-play-tuiguang/"/>
    <updated>2015-05-11T21:43:00+08:00</updated>
    <id>http://droidyue.com/blog/2015/05/11/google-play-tuiguang</id>
    <content type="html"><![CDATA[<p>Play商店是Android的官方商店，虽然在大陆无法访问，但是这里依旧是重要的版本发布市场，尤其是对于那些国际化的产品。对于拓宽海外市场，付费推广就是一部分不可忽视的措施。而Android付费推广必然就是Play商店推广。本文主要从技术方面讲解，如何统计推广数据，以及在开发过程中遇到的一些疑问和困惑。</p>

<!--more-->


<h2>生成推广链接</h2>

<p>想要进行推广，必须有推广链接。Google提供了生成推广链接的地址<a href="https://developers.google.com/analytics/devguides/collection/android/v2/campaigns#google-play-url-builder">Google Play URL Builder</a>,遗憾的是这个地址被墙了，不过可以使用<a href="http://www.digitangle.co.uk/toolsandresources/google-play-url-builder/#sthash.HLdt4vXJ.dpbs">这个地址</a>，可能稍微慢一点。</p>

<p><img src="http://7jpolu.com1.z0.glb.clouddn.com/play_url_builder.png"></p>

<h3>简单描述</h3>

<ul>
<li>Package Name 必填  应用的包名，如com.example.application</li>
<li>Campaign Source 必填 推广的来源，比如google, citysearch, newsletter4</li>
<li>Campaign Medium 选填  推广的媒介，比如cpc, banner, email</li>
<li>Campaign Term   选填 推广的关键字 比如 running+shoes</li>
<li>Campaign Content 选填 推广内容描述</li>
<li>Campaign Name  选填 可以填写 产品名，推广代号或者是推广口号</li>
</ul>


<p>生成的推广地址就是<a href="https://play.google.com/store/apps/details?id=com.mx.browser&amp;referrer=utm_source%3Ddroidyue.com%26utm_medium%3Dadlink%26utm_term%3Dandroid%252Bbrowser%26utm_content%3DBest%2520and%2520Fast%2520Browser%26utm_campaign%3Dandroidyue_123">https://play.google.com/store/apps/details?id=com.mx.browser&amp;referrer=utm_source%3Ddroidyue.com%26utm_medium%3Dadlink%26utm_term%3Dandroid%252Bbrowser%26utm_content%3DBest%2520and%2520Fast%2520Browser%26utm_campaign%3Dandroidyue_123</a></p>

<h2>推广如何工作的</h2>

<p>有了上面的推广链接，我们有必要了解一下Play商店的推广是如何工作的。</p>

<p>  1.用户从网页或者应用中点击Play商店推广链接跳转到Play商店应用的页面下载。<br/>
  2.应用下载完成并安装后，Google Play商店会发送一个<strong>INSTALL_REFERRER</strong>的Intent广播，该Intent中包含了推广链接中的参数。<br/>
  3.应用收到<strong>INSTALL_REFERRER</strong>广播之后，从Intent中读取参数，上报推广数据。</p>

<h2>统计推广数据</h2>

<h3>1.manifest声明receiver，接收<strong>INSTALL_REFERRER</strong>广播</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;receiver</span> <span class="na">android:name=</span><span class="s">&quot;.PlayCampaignReceiver&quot;</span> <span class="na">android:exported=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;intent-filter&gt;</span>
</span><span class='line'>              <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&quot;com.android.vending.INSTALL_REFERRER&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>          <span class="nt">&lt;/intent-filter&gt;</span>  
</span><span class='line'><span class="nt">&lt;/receiver&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2.实现PlayCampaignReceiver，处理<strong>INSTALL_REFERRER</strong>广播</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">droidyue</span><span class="o">.</span><span class="na">playstorereferrertester</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.content.BroadcastReceiver</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.content.Context</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.content.Intent</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PlayCampaignReceiver</span> <span class="kd">extends</span> <span class="n">BroadcastReceiver</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">LOGTAG</span> <span class="o">=</span> <span class="s">&quot;PlayCampaignReceiver&quot;</span><span class="o">;</span>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onReceive</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">LOGTAG</span><span class="o">,</span> <span class="s">&quot;onReceive intent=&quot;</span> <span class="o">+</span> <span class="n">intent</span><span class="o">);</span>
</span><span class='line'>      <span class="c1">//处理referrer参数</span>
</span><span class='line'>      <span class="n">String</span> <span class="n">referrer</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getStringExtra</span><span class="o">(</span><span class="s">&quot;referrer&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="c1">//some other code</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>多个Receiver</h2>

<p>有些时候我们可能有这样的需求，我们需要多个Receiver监听<strong>INSTALL_REFERRER</strong>广播，其实是可以的。</p>

<h3>代码调用</h3>

<p>这一种是比较推荐的实现方式，比较简单，就是在一个Receiver的onReceive中，实例化另一个Receiver并调用其onReceive方法。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PlayCampaignReceiver</span> <span class="kd">extends</span> <span class="n">BroadcastReceiver</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">LOGTAG</span> <span class="o">=</span> <span class="s">&quot;PlayCampaignReceiver&quot;</span><span class="o">;</span>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onReceive</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">LOGTAG</span><span class="o">,</span> <span class="s">&quot;onReceive intent=&quot;</span> <span class="o">+</span> <span class="n">intent</span><span class="o">);</span>
</span><span class='line'>      <span class="c1">//调用另一个Receiver实例的onReceive方法</span>
</span><span class='line'>      <span class="k">new</span> <span class="nf">AnotherPlayCampaignReceiver</span><span class="o">().</span><span class="na">onReceive</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">intent</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>manifest声明</h3>

<p>通过manifest的增加另一个监听<strong>INSTALL_REFERRER</strong>广播的Receiver的形式理论上也可以，但是之前的Google文档中说这种方式有问题，不建议使用。之前Google统计关于市场推广的描述为</p>

<blockquote><p>Note: Only one BroadcastReceiver class can be specified per application. Should you need to incorporate two or more BroadcastReceivers from different SDKs, you will need to create your own BroadcastReceiver class that will receive all broadcasts and call the appropriate BroadcastReceivers for each type of Broadcast.</p></blockquote>

<h2>何时收到推广数据</h2>

<p>关于何时收到推广数据的问题争论颇多，基本上又两个答案：安装完成之后和打一次打开程序时。这两个答案可以说是都对或者都错。</p>

<p>在3.1之前，<strong>INSTALL_REFERRER</strong>广播 确实是在程序安装之后发送的。 <br/>
在3.1之后，<strong>INSTALL_REFERRER</strong>广播 就变成了在程序第一次启动的时候进行的。</p>

<p>那么这又是作何原因呢，其真实的原因就是在3.1 API 12之后，Android系统引入了停止状态，也就是说一个刚下载的程序，在用户手动点击图标启动之前，是收不到正常的广播的。只有当处于非停止状态的应用才能收到<strong>INSTALL_REFERRER</strong>广播。所以广播的发送就选择在程序第一次启动时。  更多关于<a href="http://droidyue.com/blog/2014/07/14/look-inside-android-package-stop-state-since-honeycomb-mr1/">Android中的停止状态</a></p>

<p>为了进一步验证这个发送广播实际，我在Play Store上传了一个测试程序，可以使用这个地址<a href="https://play.google.com/store/apps/details?id=com.droidyue.playstorereferrertester&amp;referrer=utm_source%3Ddroidyue.com%26utm_medium%3Dblog%26utm_term%3Dtest%252Bapp%26utm_content%3Dtest%252Bapp%26utm_campaign%3Dandroidyue_123456">https://play.google.com/store/apps/details?id=com.droidyue.playstorereferrertester&amp;referrer=utm_source%3Ddroidyue.com%26utm_medium%3Dblog%26utm_term%3Dtest%252Bapp%26utm_content%3Dtest%252Bapp%26utm_campaign%3Dandroidyue_123456</a>从Play Store下载测试一下，过滤日志<code>adb logcat | grep PlayCampaignReceiver</code>测试。</p>

<p>注意：这里的第一次安装可以是从Play Store 应用中点打开按钮，也可以是从Launcher中点击应用图标。前面两种情况都是可以接收到广播的。</p>

<h2>别的包也会收到么</h2>

<p>这也是一个被争论的问题，当然我也是通过上面的包验证了，答案就是不会的。<strong>INSTALL_REFERRER</strong>只会发给那个推广安装的程序。</p>

<h2>例外情况</h2>

<p>从网页到客户端的安装是无法发送<strong>INSTALL_REFERRER</strong>广播的。</p>

<h2>奇怪问题</h2>

<h3>协议为哪个</h3>

<p>其实有人会奇怪，究竟推广链接是market还是https协议，答案是都可以，但是推荐使用https协议的链接，首先的既定事实是Google Play URL Builder默认生成的就是https协议链接，另外https是一个被广泛采用的协议，设想如果一个market协议链接在PC浏览器上被点击是怎样的一种体验呢？答案不言自明。</p>

<h2>参考文章</h2>

<ul>
<li><a href="https://developers.google.com/analytics/devguides/collection/android/v2/campaigns#overview">Campaign Measurement </a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[关闭Mac屏幕右上角QQ通知]]></title>
    <link href="http://droidyue.com/blog/2015/04/26/guanbi-mac-qq-tishi/"/>
    <updated>2015-04-26T12:02:00+08:00</updated>
    <id>http://droidyue.com/blog/2015/04/26/guanbi-mac-qq-tishi</id>
    <content type="html"><![CDATA[<p>前段时间看到QQ提示更新，于是手贱了一次升级到了QQ for Mac V4.0.1,最不爽的一件事在屏幕的右上角多出来了一个横幅，内容就是别人发给你的消息的内容。</p>

<!--more-->


<p>如下图</p>

<p><img src="http://7jpolu.com1.z0.glb.clouddn.com/qq_notification.png" title="QQ Notification" ></p>

<p>这是多么脑残的产品想出来的啊，多么地泄露隐私啊。于是果断查看QQ设置，没有办法取消横幅展示。于是另寻办法。</p>

<p>实际上在Mac系统中有对通知的设置，打开<strong>系统偏好设置</strong> &mdash; <strong>通知</strong> 找到QQ，然后将<strong>QQ提示样式</strong>设置成无即可。如下图</p>

<p><img src="http://7jpolu.com1.z0.glb.clouddn.com/qq_notification_turn_off.png" title="Turn off QQ Notification" ></p>

<p>同理，Mac版微信也可以进行这样的设置。</p>

<h3>推荐一本书</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B00P0GDLGO/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B00P0GDLGO&amp;linkCode=as2&amp;tag=droidyue-23">苹果Mac OSX高手真经</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[避免Android中Context引起的内存泄露]]></title>
    <link href="http://droidyue.com/blog/2015/04/12/avoid-memory-leaks-on-context-in-android/"/>
    <updated>2015-04-12T21:28:00+08:00</updated>
    <id>http://droidyue.com/blog/2015/04/12/avoid-memory-leaks-on-context-in-android</id>
    <content type="html"><![CDATA[<p>Context是我们在编写Android程序经常使用到的对象，意思为上下文对象。 常用的有Activity的Context还是有Application的Context。Activity用来展示活动界面，包含了很多的视图，而视图又含有图片，文字等资源。在Android中内存泄露很容易出现，而持有很多对象内存占用的Activity更加容易出现内存泄露，开发者需要特别注意这个问题。</p>

<p>本文讲介绍Android中Context，更具体的说是Activity内存泄露的情况，以及如何避免Activity内存泄露，加速应用性能。</p>

<!--more-->


<h2>Drawable引起的内存泄露</h2>

<p>Drawable引起内存泄露这个问题是比较隐晦，难以察觉的。在阅读了Romain Guy的<a href="http://android-developers.blogspot.com.tr/2009/01/avoiding-memory-leaks.html">Avoiding memory leaks</a>，结合grepcode查看源码才明白了。</p>

<p>在Android系统中，当我们进行了屏幕旋转，默认情况下，会销毁掉当前的Activity，并创建一个新的Activity并保持之前的状态。在这个过程中，Android系统会重新加载程序的UI视图和资源。假设我们有一个程序用到了一个很大的Bitmap图像，我们不想每次屏幕旋转时都重新加载这个Bitmap对象，最简单的办法就是将这个Bitmap对象使用static修饰。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="n">Drawable</span> <span class="n">sBackground</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">state</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">state</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">TextView</span> <span class="n">label</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TextView</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span><span class='line'>  <span class="n">label</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">&quot;Leaks are bad&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">sBackground</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">sBackground</span> <span class="o">=</span> <span class="n">getDrawable</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">large_bitmap</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="n">label</span><span class="o">.</span><span class="na">setBackgroundDrawable</span><span class="o">(</span><span class="n">sBackground</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">setContentView</span><span class="o">(</span><span class="n">label</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>但是上面的方法在屏幕旋转时有可能引起内存泄露，无论是咋一看还是仔细看这段代码，都很难发现哪里引起了内存泄露。</p>

<p>当一个Drawable绑定到了View上，实际上这个View对象就会成为这个Drawable的一个callback成员变量，上面的例子中静态的sBackground持有TextView对象lable的引用，而lable只有Activity的引用，而Activity会持有其他更多对象的引用。sBackground生命周期要长于Activity。当屏幕旋转时，Activity无法被销毁，这样就产生了内存泄露问题。</p>

<p>2.3.7及以下版本Drawable的setCallback方法的实现</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">setCallback</span><span class="o">(</span><span class="n">Callback</span> <span class="n">cb</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">mCallback</span> <span class="o">=</span> <span class="n">cb</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>好在从4.0.1开始，引入了<a href="http://droidyue.com/blog/2014/10/12/understanding-weakreference-in-java/">弱引用</a>处理这个问题，弱引用在GC回收时，不会阻止GC回收其指向的对象，避免了内存泄露问题。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">setCallback</span><span class="o">(</span><span class="n">Callback</span> <span class="n">cb</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">mCallback</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">Callback</span><span class="o">&gt;(</span><span class="n">cb</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>单例引起的内存泄露</h2>

<p>单例是我们比较简单常用的一种设计模式,然而如果单例使用不当也会导致内存泄露。
比如这样一个例子,我们使用饿汉式初始化单例，AppSettings我们需要持有一个Context作为成员变量，如果我们按照下面的实现其实是有问题。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AppSettings</span> <span class="o">{</span>    
</span><span class='line'>    <span class="kd">private</span> <span class="n">Context</span> <span class="n">mAppContext</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="n">AppSettings</span> <span class="n">sInstance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AppSettings</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//some other codes</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="n">AppSettings</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">sInstance</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">setup</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">mAppContext</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>sInstance作为静态对象，其生命周期要长于普通的对象，其中也包含Activity，当我们进行屏幕旋转，默认情况下，系统会销毁当前Activity，然后当前的Activity被一个单例持有，导致垃圾回收器无法进行回收，进而产生了内存泄露。</p>

<p>解决的方法就是不持有Activity的引用，而是持有Application的Context引用。代码如下修改</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">setup</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">mAppContext</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">();</span> 
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>访问这里了解更多关于<a href="http://droidyue.com/blog/2015/01/11/looking-into-singleton/">单例模式的问题</a></p>

<h2>条条方法返回Context</h2>

<p>通常我们想要获取Context对象，主要有以下四种方法</p>

<ul>
<li>View.getContext,返回当前View对象的Context对象，通常是当前正在展示的Activity对象。</li>
<li>Activity.getApplicationContext,获取当前Activity所在的(应用)进程的Context对象，通常我们使用Context对象时，要优先考虑这个全局的进程Context。</li>
<li>ContextWrapper.getBaseContext():用来获取一个ContextWrapper进行装饰之前的Context，可以使用这个方法，这个方法在实际开发中使用并不多，也不建议使用。</li>
<li>Activity.this 返回当前的Activity实例，如果是UI控件需要使用Activity作为Context对象，但是默认的Toast实际上使用ApplicationContext也可以。</li>
</ul>


<h2>其他内存泄露问题</h2>

<ul>
<li><a href="http://droidyue.com/blog/2014/11/08/bad-smell-of-asynctask-in-android/">Android中糟糕的AsyncTask</a></li>
<li><a href="http://droidyue.com/blog/2014/12/28/in-android-handler-classes-should-be-static-or-leaks-might-occur/">Android中Handler引起的内存泄露</a></li>
<li><a href="http://droidyue.com/blog/2014/11/29/why-onsharedpreferencechangelistener-was-not-called/">Google为何这样设计OnSharedPreferenceChangeListener</a></li>
</ul>


<h2>避免内存泄露须谨记</h2>

<ul>
<li>不要让生命周期长于Activity的对象持有到Activity的引用</li>
<li>尽量使用Application的Context而不是Activity的Context</li>
<li>尽量不要在Activity中使用非静态内部类，因为非静态内部类会隐式持有外部类实例的引用（具体可以查看<a href="http://droidyue.com/blog/2014/10/02/the-private-modifier-in-java/">细话Java：&#8221;失效&#8221;的private修饰符</a>了解）。如果使用静态内部类，将外部实例引用作为<a href="http://droidyue.com/blog/2014/10/12/understanding-weakreference-in-java/">弱引用</a>持有。</li>
<li>垃圾回收不能解决内存泄露，了解<a href="http://droidyue.com/blog/2014/11/02/note-for-google-io-memory-management-for-android-chinese-edition/">Android中垃圾回收机制</a></li>
</ul>


<h2>参考文章</h2>

<ul>
<li><a href="http://android-developers.blogspot.com.tr/2009/01/avoiding-memory-leaks.html">Avoiding memory leaks</a></li>
<li><a href="http://stackoverflow.com/questions/10641144/difference-between-getcontext-getapplicationcontext-getbasecontext-and">Difference between getContext() , getApplicationContext() , getBaseContext() and “this”</a></li>
<li><a href="http://stackoverflow.com/questions/1026973/android-whats-the-difference-between-the-various-methods-to-get-a-context">Android &ndash; what&rsquo;s the difference between the various methods to get a Context?</a></li>
</ul>


<h2>好书推荐</h2>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B009VV6EG8/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B009VV6EG8&amp;linkCode=as2&amp;tag=droidyue-23">Android应用性能优化</a></li>
<li><a href="http://www.amazon.cn/gp/product/B00IOB0K1Q/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B00IOB0K1Q&amp;linkCode=as2&amp;tag=droidyue-23">图灵程序设计丛书:Java性能优化权威指南</a></li>
<li><a href="http://www.amazon.cn/gp/product/B009GT0H4U/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B009GT0H4U&amp;linkCode=as2&amp;tag=droidyue-23">Java程序性能优化:让你的Java程序更快、更稳定</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Java中的自动装箱与拆箱]]></title>
    <link href="http://droidyue.com/blog/2015/04/07/autoboxing-and-autounboxing-in-java/"/>
    <updated>2015-04-07T07:31:00+08:00</updated>
    <id>http://droidyue.com/blog/2015/04/07/autoboxing-and-autounboxing-in-java</id>
    <content type="html"><![CDATA[<p>自动装箱和拆箱从Java 1.5开始引入，目的是将原始类型值转自动地转换成对应的对象。自动装箱与拆箱的机制可以让我们在Java的变量赋值或者是方法调用等情况下使用原始类型或者对象类型更加简单直接。</p>

<p>如果你在Java1.5下进行过编程的话，你一定不会陌生这一点，你不能直接地向集合(Collections)中放入原始类型值，因为集合只接收对象。通常这种情况下你的做法是，将这些原始类型的值转换成对象，然后将这些转换的对象放入集合中。使用Integer,Double,Boolean等这些类我们可以将原始类型值转换成对应的对象，但是从某些程度可能使得代码不是那么简洁精炼。为了让代码简练，Java 1.5引入了具有在原始类型和对象类型自动转换的装箱和拆箱机制。但是自动装箱和拆箱并非完美，在使用时需要有一些注意事项，如果没有搞明白自动装箱和拆箱，可能会引起难以察觉的bug。</p>

<p>本文将介绍，什么是自动装箱和拆箱，自动装箱和拆箱发生在什么时候，以及要注意的事项。</p>

<!--more-->


<h2>什么是自动装箱和拆箱</h2>

<p>自动装箱就是Java自动将原始类型值转换成对应的对象，比如将int的变量转换成Integer对象，这个过程叫做装箱，反之将Integer对象转换成int类型值，这个过程叫做拆箱。因为这里的装箱和拆箱是自动进行的非人为转换，所以就称作为自动装箱和拆箱。原始类型byte,short,char,int,long,float,double和boolean对应的封装类为Byte,Short,Character,Integer,Long,Float,Double,Boolean。</p>

<h2>自动装箱拆箱要点</h2>

<ul>
<li>自动装箱时编译器调用valueOf将原始类型值转换成对象，同时自动拆箱时，编译器通过调用类似intValue(),doubleValue()这类的方法将对象转换成原始类型值。</li>
<li>自动装箱是将boolean值转换成Boolean对象，byte值转换成Byte对象，char转换成Character对象，float值转换成Float对象，int转换成Integer，long转换成Long，short转换成Short，自动拆箱则是相反的操作。</li>
</ul>


<h2>何时发生自动装箱和拆箱</h2>

<p>自动装箱和拆箱在Java中很常见，比如我们有一个方法，接受一个对象类型的参数，如果我们传递一个原始类型值，那么Java会自动讲这个原始类型值转换成与之对应的对象。最经典的一个场景就是当我们向ArrayList这样的容器中增加原始类型数据时或者是创建一个参数化的类，比如下面的ThreadLocal。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">intList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;();</span>
</span><span class='line'><span class="n">intList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span> <span class="c1">//autoboxing - primitive to object</span>
</span><span class='line'><span class="n">intList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span> <span class="c1">//autoboxing</span>
</span><span class='line'>
</span><span class='line'><span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">intLocal</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;();</span>
</span><span class='line'><span class="n">intLocal</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span> <span class="c1">//autoboxing</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="n">intList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span> <span class="c1">// unboxing</span>
</span><span class='line'><span class="kt">int</span> <span class="n">local</span> <span class="o">=</span> <span class="n">intLocal</span><span class="o">.</span><span class="na">get</span><span class="o">();</span> <span class="c1">// unboxing in Java</span>
</span></code></pre></td></tr></table></div></figure>


<h2>举例说明</h2>

<p>上面的部分我们介绍了自动装箱和拆箱以及它们何时发生，我们知道了自动装箱主要发生在两种情况，一种是赋值时，另一种是在方法调用的时候。为了更好地理解这两种情况，我们举例进行说明。</p>

<h3>赋值时</h3>

<p>这是最常见的一种情况，在Java 1.5以前我们需要手动地进行转换才行，而现在所有的转换都是由编译器来完成。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="c1">//before autoboxing</span>
</span><span class='line'><span class="n">Integer</span> <span class="n">iObject</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
</span><span class='line'><span class="n">Int</span> <span class="n">iPrimitive</span> <span class="o">=</span> <span class="n">iObject</span><span class="o">.</span><span class="na">intValue</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//after java5</span>
</span><span class='line'><span class="n">Integer</span> <span class="n">iObject</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span> <span class="c1">//autobxing - primitive to wrapper conversion</span>
</span><span class='line'><span class="kt">int</span> <span class="n">iPrimitive</span> <span class="o">=</span> <span class="n">iObject</span><span class="o">;</span> <span class="c1">//unboxing - object to primitive conversion</span>
</span></code></pre></td></tr></table></div></figure>


<h3>方法调用时</h3>

<p>这是另一个常用的情况，当我们在方法调用时，我们可以传入原始数据值或者对象，同样编译器会帮我们进行转换。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="n">Integer</span> <span class="nf">show</span><span class="o">(</span><span class="n">Integer</span> <span class="n">iParam</span><span class="o">){</span>
</span><span class='line'>   <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;autoboxing example - method invocation i: &quot;</span> <span class="o">+</span> <span class="n">iParam</span><span class="o">);</span>
</span><span class='line'>   <span class="k">return</span> <span class="n">iParam</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//autoboxing and unboxing in method invocation</span>
</span><span class='line'><span class="n">show</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span> <span class="c1">//autoboxing</span>
</span><span class='line'><span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">show</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span> <span class="c1">//unboxing because return type of method is Integer</span>
</span></code></pre></td></tr></table></div></figure>


<p>show方法接受Integer对象作为参数，当调用<code>show(3)</code>时，会将int值转换成对应的Integer对象，这就是所谓的自动装箱，show方法返回Integer对象，而<code>int result = show(3);</code>中result为int类型，所以这时候发生自动拆箱操作，将show方法的返回的Integer对象转换成int值。</p>

<h2>自动装箱的弊端</h2>

<p>自动装箱有一个问题，那就是在一个循环中进行自动装箱操作的情况，如下面的例子就会创建多余的对象，影响程序的性能。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Integer</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'> <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1000</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">5000</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
</span><span class='line'>   <span class="n">sum</span><span class="o">+=</span><span class="n">i</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面的代码<code>sum+=i</code>可以看成<code>sum = sum + i</code>，但是<code>+</code>这个操作符不适用于Integer对象，首先sum进行自动拆箱操作，进行数值相加操作，最后发生自动装箱操作转换成Integer对象。其内部变化如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">sum</span> <span class="o">=</span> <span class="n">sum</span><span class="o">.</span><span class="na">intValue</span><span class="o">()</span> <span class="o">+</span> <span class="n">i</span><span class="o">;</span>
</span><span class='line'><span class="n">Integer</span> <span class="n">sum</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Integer</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>由于我们这里声明的sum为Integer类型，在上面的循环中会创建将近4000个无用的Integer对象，在这样庞大的循环中，会降低程序的性能并且加重了垃圾回收的工作量。因此在我们编程时，需要注意到这一点，正确地声明变量类型，避免因为自动装箱引起的性能问题。</p>

<h2>重载与自动装箱</h2>

<p>当重载遇上自动装箱时，情况会比较有些复杂，可能会让人产生有些困惑。在1.5之前，value(int)和value(Integer)是完全不相同的方法，开发者不会因为传入是int还是Integer调用哪个方法困惑，但是由于自动装箱和拆箱的引入，处理重载方法时稍微有点复杂。一个典型的例子就是ArrayList的remove方法，它有<code>remove(index)</code>和<code>remove(Object)</code>两种重载，我们可能会有一点小小的困惑，其实这种困惑是可以验证并解开的，通过下面的例子我们可以看到，当出现这种情况时，不会发生自动装箱操作。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">(</span><span class="kt">int</span> <span class="n">num</span><span class="o">){</span>
</span><span class='line'>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;method with primitive argument&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">(</span><span class="n">Integer</span> <span class="n">num</span><span class="o">){</span>
</span><span class='line'>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;method with wrapper argument&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//calling overloaded method</span>
</span><span class='line'><span class="n">AutoboxingTest</span> <span class="n">autoTest</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AutoboxingTest</span><span class="o">();</span>
</span><span class='line'><span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
</span><span class='line'><span class="n">autoTest</span><span class="o">.</span><span class="na">test</span><span class="o">(</span><span class="n">value</span><span class="o">);</span> <span class="c1">//no autoboxing </span>
</span><span class='line'><span class="n">Integer</span> <span class="n">iValue</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
</span><span class='line'><span class="n">autoTest</span><span class="o">.</span><span class="na">test</span><span class="o">(</span><span class="n">iValue</span><span class="o">);</span> <span class="c1">//no autoboxing</span>
</span><span class='line'>
</span><span class='line'><span class="nl">Output:</span>
</span><span class='line'><span class="n">method</span> <span class="n">with</span> <span class="n">primitive</span> <span class="n">argument</span>
</span><span class='line'><span class="n">method</span> <span class="n">with</span> <span class="n">wrapper</span> <span class="n">argument</span>
</span></code></pre></td></tr></table></div></figure>


<h2>要注意的事项</h2>

<p>自动装箱和拆箱可以使代码变得简洁,但是其也存在一些问题和极端情况下的问题，以下几点需要我们加强注意。</p>

<h3>对象相等比较</h3>

<p>这是一个比较容易出错的地方，&#8221;==&ldquo;可以用于原始值进行比较，也可以用于对象进行比较，当用于对象与对象之间比较时，比较的不是对象代表的值，而是检查两个对象是否是同一对象，这个比较过程中没有自动装箱发生。进行对象值比较不应该使用&rdquo;==&ldquo;，而应该使用对象对应的equals方法。看一个能说明问题的例子。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AutoboxingTest</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[])</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Example 1: == comparison pure primitive – no autoboxing</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">i1</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">i2</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;i1==i2 : &quot;</span> <span class="o">+</span> <span class="o">(</span><span class="n">i1</span> <span class="o">==</span> <span class="n">i2</span><span class="o">));</span> <span class="c1">// true</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Example 2: equality operator mixing object and primitive</span>
</span><span class='line'>        <span class="n">Integer</span> <span class="n">num1</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="c1">// autoboxing</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">num2</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;num1 == num2 : &quot;</span> <span class="o">+</span> <span class="o">(</span><span class="n">num1</span> <span class="o">==</span> <span class="n">num2</span><span class="o">));</span> <span class="c1">// true</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Example 3: special case - arises due to autoboxing in Java</span>
</span><span class='line'>        <span class="n">Integer</span> <span class="n">obj1</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="c1">// autoboxing will call Integer.valueOf()</span>
</span><span class='line'>        <span class="n">Integer</span> <span class="n">obj2</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="c1">// same call to Integer.valueOf() will return same</span>
</span><span class='line'>                            <span class="c1">// cached Object</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;obj1 == obj2 : &quot;</span> <span class="o">+</span> <span class="o">(</span><span class="n">obj1</span> <span class="o">==</span> <span class="n">obj2</span><span class="o">));</span> <span class="c1">// true</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Example 4: equality operator - pure object comparison</span>
</span><span class='line'>        <span class="n">Integer</span> <span class="n">one</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Integer</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span> <span class="c1">// no autoboxing</span>
</span><span class='line'>        <span class="n">Integer</span> <span class="n">anotherOne</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Integer</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;one == anotherOne : &quot;</span> <span class="o">+</span> <span class="o">(</span><span class="n">one</span> <span class="o">==</span> <span class="n">anotherOne</span><span class="o">));</span> <span class="c1">// false</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nl">Output:</span>
</span><span class='line'><span class="n">i1</span><span class="o">==</span><span class="n">i2</span> <span class="o">:</span> <span class="kc">true</span>
</span><span class='line'><span class="n">num1</span> <span class="o">==</span> <span class="n">num2</span> <span class="o">:</span> <span class="kc">true</span>
</span><span class='line'><span class="n">obj1</span> <span class="o">==</span> <span class="n">obj2</span> <span class="o">:</span> <span class="kc">true</span>
</span><span class='line'><span class="n">one</span> <span class="o">==</span> <span class="n">anotherOne</span> <span class="o">:</span> <span class="kc">false</span>
</span></code></pre></td></tr></table></div></figure>


<p>值得注意的是第三个小例子，这是一种极端情况。obj1和obj2的初始化都发生了自动装箱操作。但是处于节省内存的考虑，JVM会缓存-128到127的Integer对象。因为obj1和obj2实际上是同一个对象。所以使用&#8221;==&ldquo;比较返回true。</p>

<h3>容易混乱的对象和原始数据值</h3>

<p>另一个需要避免的问题就是混乱使用对象和原始数据值，一个具体的例子就是当我们在一个原始数据值与一个对象进行比较时，如果这个对象没有进行初始化或者为Null，在自动拆箱过程中obj.xxxValue，会抛出NullPointerException,如下面的代码</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="n">Integer</span> <span class="n">count</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//NullPointerException on unboxing</span>
</span><span class='line'><span class="k">if</span><span class="o">(</span> <span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">){</span>
</span><span class='line'>  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Count is not started yet&quot;</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>缓存的对象</h3>

<p>这个问题就是我们上面提到的极端情况，在Java中，会对-128到127的Integer对象进行缓存，当创建新的Integer对象时，如果符合这个这个范围，并且已有存在的相同值的对象，则返回这个对象，否则创建新的Integer对象。</p>

<p>在Java中另一个节省内存的例子就是<a href="http://droidyue.com/blog/2014/12/21/string-literal-pool-in-java/">字符串常量池</a>,感兴趣的同学可以了解一下。</p>

<h3>生成无用对象增加GC压力</h3>

<p>因为自动装箱会隐式地创建对象，像前面提到的那样，如果在一个循环体中，会创建无用的中间对象，这样会增加GC压力，拉低程序的性能。所以在写循环时一定要注意代码，避免引入不必要的自动装箱操作。</p>

<p>如想了解垃圾回收和内存优化，可以查看本文<a href="http://droidyue.com/blog/2014/11/02/note-for-google-io-memory-management-for-android-chinese-edition/">Google IO：Android内存管理主题演讲记录</a></p>

<p>总的来说，自动装箱和拆箱着实为开发者带来了很大的方便，但是在使用时也是需要格外留意，避免引起出现文章提到的问题。</p>

<h2>原文信息</h2>

<ul>
<li><a href="http://javarevisited.blogspot.com/2012/07/auto-boxing-and-unboxing-in-java-be.html">What is Autoboxing and Unboxing in Java – Example Tutorial and Corner cases</a></li>
</ul>


<h2>好书推荐</h2>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B0011F7WU4/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B0011F7WU4&amp;linkCode=as2&amp;tag=droidyue-23">Java编程思想(第4版) </a></li>
<li><a href="http://www.amazon.cn/gp/product/B00G9KF4JC/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B00G9KF4JC&amp;linkCode=as2&amp;tag=droidyue-23">Java核心技术(卷1):基础知识</a></li>
<li><a href="http://www.amazon.cn/gp/product/B00D2ID4PK/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B00D2ID4PK&amp;linkCode=as2&amp;tag=droidyue-23">深入理解Java虚拟机:JVM高级特性与最佳实践</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[读懂Java中的Socket编程]]></title>
    <link href="http://droidyue.com/blog/2015/03/08/sockets-programming-in-java/"/>
    <updated>2015-03-08T16:09:00+08:00</updated>
    <id>http://droidyue.com/blog/2015/03/08/sockets-programming-in-java</id>
    <content type="html"><![CDATA[<p>Socket,又称为套接字，Socket是计算机网络通信的基本的技术之一。如今大多数基于网络的软件，如浏览器，即时通讯工具甚至是P2P下载都是基于Socket实现的。本文会介绍一下基于TCP/IP的Socket编程，并且如何写一个客户端/服务器程序。</p>

<!--more-->


<h2>餐前甜点</h2>

<p>Unix的输入输出(IO)系统遵循Open-Read-Write-Close这样的操作范本。当一个用户进程进行IO操作之前，它需要调用Open来指定并获取待操作文件或设备读取或写入的权限。一旦IO操作对象被打开，那么这个用户进程可以对这个对象进行一次或多次的读取或写入操作。Read操作用来从IO操作对象读取数据，并将数据传递给用户进程。Write操作用来将用户进程中的数据传递（写入）到IO操作对象。 当所有的Read和Write操作结束之后，用户进程需要调用Close来通知系统其完成对IO对象的使用。</p>

<p>在Unix开始支持进程间通信（InterProcess Communication，简称IPC）时，IPC的接口就设计得类似文件IO操作接口。在Unix中，一个进程会有一套可以进行读取写入的IO描述符。IO描述符可以是文件，设备或者是通信通道（socket套接字）。一个文件描述符由三部分组成：创建（打开socket），读取写入数据（接受和发送到socket）还有销毁（关闭socket）。</p>

<p>在Unix系统中，类BSD版本的IPC接口是作为TCP和UDP协议之上的一层进行实现的。消息的目的地使用socket地址来表示。一个socket地址是由网络地址和端口号组成的通信标识符。</p>

<p>进程间通信操作需要一对儿socket。进程间通信通过在一个进程中的一个socket与另一个进程中得另一个socket进行数据传输来完成。当一个消息执行发出后，这个消息在发送端的socket中处于排队状态，直到下层的网络协议将这些消息发送出去。当消息到达接收端的socket后，其也会处于排队状态，直到接收端的进程对这条消息进行了接收处理。</p>

<h2>TCP和UDP通信</h2>

<p>关于socket编程我们有两种通信协议可以进行选择。一种是数据报通信，另一种就是流通信。</p>

<h3>数据报通信</h3>

<p>数据报通信协议，就是我们常说的UDP（User Data Protocol 用户数据报协议）。UDP是一种无连接的协议，这就意味着我们每次发送数据报时，需要同时发送本机的socket描述符和接收端的socket描述符。因此，我们在每次通信时都需要发送额外的数据。</p>

<h3>流通信</h3>

<p>流通信协议，也叫做TCP(Transfer Control Protocol，传输控制协议)。和UDP不同，TCP是一种基于连接的协议。在使用流通信之前，我们必须在通信的一对儿socket之间建立连接。其中一个socket作为服务器进行监听连接请求。另一个则作为客户端进行连接请求。一旦两个socket建立好了连接，他们可以单向或双向进行数据传输。</p>

<p>读到这里，我们多少有这样的疑问，我们进行socket编程使用UDP还是TCP呢。选择基于何种协议的socket编程取决于你的具体的客户端-服务器端程序的应用场景。下面我们简单分析一下TCP和UDP协议的区别，或许可以帮助你更好地选择使用哪种。</p>

<p>在UDP中，每次发送数据报时，需要附带上本机的socket描述符和接收端的socket描述符。而由于TCP是基于连接的协议，在通信的socket对之间需要在通信之前建立连接，因此会有建立连接这一耗时存在于TCP协议的socket编程。</p>

<p>在UDP中，数据报数据在大小上有64KB的限制。而TCP中也不存在这样的限制。一旦TCP通信的socket对建立了连接，他们之间的通信就类似IO流，所有的数据会按照接受时的顺序读取。</p>

<p>UDP是一种不可靠的协议，发送的数据报不一定会按照其发送顺序被接收端的socket接受。然后TCP是一种可靠的协议。接收端收到的包的顺序和包在发送端的顺序是一致的。</p>

<p>简而言之，TCP适合于诸如远程登录(rlogin,telnet)和文件传输（FTP）这类的网络服务。因为这些需要传输的数据的大小不确定。而UDP相比TCP更加简单轻量一些。UDP用来实现实时性较高或者丢包不重要的一些服务。在局域网中UDP的丢包率都相对比较低。</p>

<h2>Java中的socket编程</h2>

<p>下面的部分我将通过一些示例讲解一下如何使用socket编写客户端和服务器端的程序。</p>

<p>注意：在接下来的示例中，我将使用基于TCP/IP协议的socket编程，因为这个协议远远比UDP/IP使用的要广泛。并且所有的socket相关的类都位于java.net包下，所以在我们进行socket编程时需要引入这个包。</p>

<h3>客户端编写</h3>

<h4>开启Socket</h4>

<p>如果在客户端，你需要写下如下的代码就可以打开一个socket。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">String</span> <span class="n">host</span> <span class="o">=</span> <span class="s">&quot;127.0.0.1&quot;</span><span class="o">;</span>
</span><span class='line'><span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">8919</span><span class="o">;</span>
</span><span class='line'><span class="n">Socket</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Socket</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面代码中，host即客户端需要连接的机器，port就是服务器端用来监听请求的端口。在选择端口时，需要注意一点，就是0~1023这些端口都已经被系统预留了。这些端口为一些常用的服务所使用，比如邮件，FTP和HTTP。当你在编写服务器端的代码，选择端口时，请选择一个大于1023的端口。</p>

<h4>写入数据</h4>

<p>接下来就是写入请求数据，我们从客户端的socket对象中得到OutputStream对象，然后写入数据后。很类似文件IO的处理代码。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClientSocket</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[])</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">String</span> <span class="n">host</span> <span class="o">=</span> <span class="s">&quot;127.0.0.1&quot;</span><span class="o">;</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">8919</span><span class="o">;</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">Socket</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Socket</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
</span><span class='line'>          <span class="n">Writer</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OutputStreamWriter</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">());</span>
</span><span class='line'>          <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">&quot;Hello From Client&quot;</span><span class="o">);</span>
</span><span class='line'>          <span class="n">writer</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
</span><span class='line'>          <span class="n">writer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span><span class='line'>          <span class="n">client</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>关闭IO对象</h4>

<p>类似文件IO，在读写数据完成后，我们需要对IO对象进行关闭，以确保资源的正确释放。</p>

<h3>服务器端编写</h3>

<h4>打开服务器端的socket</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">8919</span><span class="o">;</span>
</span><span class='line'><span class="n">ServerSocket</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="o">(</span><span class="n">port</span><span class="o">);</span>
</span><span class='line'><span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面的代码创建了一个服务器端的socket，然后调用accept方法监听并获取客户端的请求socket。accept方法是一个阻塞方法，在服务器端与客户端之间建立联系之前会一直等待阻塞。</p>

<h4>读取数据</h4>

<p>通过上面得到的socket对象获取InputStream对象，然后安装文件IO一样读取数据即可。这里我们将内容打印出来。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServerClient</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">8919</span><span class="o">;</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">ServerSocket</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="o">(</span><span class="n">port</span><span class="o">);</span>
</span><span class='line'>                <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
</span><span class='line'>            <span class="n">Reader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
</span><span class='line'>            <span class="kt">char</span> <span class="n">chars</span><span class="o">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="o">[</span><span class="mi">1024</span><span class="o">];</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">len</span><span class="o">;</span>
</span><span class='line'>            <span class="n">StringBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
</span><span class='line'>            <span class="k">while</span> <span class="o">((</span><span class="n">len</span><span class="o">=</span><span class="n">reader</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">chars</span><span class="o">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>               <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">chars</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">len</span><span class="o">));</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Receive from client message=: &quot;</span> <span class="o">+</span> <span class="n">builder</span><span class="o">);</span>
</span><span class='line'>            <span class="n">reader</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span><span class='line'>            <span class="n">socket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span><span class='line'>            <span class="n">server</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>关闭IO对象</h4>

<p>还是不能忘记的，最后需要正确地关闭IO对象，以确保资源的正确释放。</p>

<h3>附注一个例子</h3>

<p>这里我们增加一个例子，使用socket实现一个回声服务器，就是服务器会将客户端发送过来的数据传回给客户端。代码很简单。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.net.*</span><span class="o">;</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EchoServer</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[])</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// declaration section:</span>
</span><span class='line'>        <span class="c1">// declare a server socket and a client socket for the server</span>
</span><span class='line'>        <span class="c1">// declare an input and an output stream</span>
</span><span class='line'>        <span class="n">ServerSocket</span> <span class="n">echoServer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="n">String</span> <span class="n">line</span><span class="o">;</span>
</span><span class='line'>        <span class="n">DataInputStream</span> <span class="n">is</span><span class="o">;</span>
</span><span class='line'>        <span class="n">PrintStream</span> <span class="n">os</span><span class="o">;</span>
</span><span class='line'>        <span class="n">Socket</span> <span class="n">clientSocket</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="c1">// Try to open a server socket on port 9999</span>
</span><span class='line'>        <span class="c1">// Note that we can&#39;t choose a port less than 1023 if we are not</span>
</span><span class='line'>        <span class="c1">// privileged users (root)</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>           <span class="n">echoServer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="o">(</span><span class="mi">9999</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>           <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="c1">// Create a socket object from the ServerSocket to listen and accept </span>
</span><span class='line'>        <span class="c1">// connections.</span>
</span><span class='line'>        <span class="c1">// Open input and output streams</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>               <span class="n">clientSocket</span> <span class="o">=</span> <span class="n">echoServer</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
</span><span class='line'>               <span class="n">is</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataInputStream</span><span class="o">(</span><span class="n">clientSocket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
</span><span class='line'>               <span class="n">os</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrintStream</span><span class="o">(</span><span class="n">clientSocket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">());</span>
</span><span class='line'>               <span class="c1">// As long as we receive data, echo that data back to the client.</span>
</span><span class='line'>               <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                 <span class="n">line</span> <span class="o">=</span> <span class="n">is</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
</span><span class='line'>                 <span class="n">os</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>
</span><span class='line'>               <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>               <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>编译运行上面的代码，进行如下请求，就可以看到客户端请求携带的数据的内容。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="mi">15</span><span class="o">:</span><span class="mi">00</span> <span class="n">$</span> <span class="n">curl</span> <span class="nl">http:</span><span class="c1">//127.0.0.1:9999/?111</span>
</span><span class='line'><span class="n">GET</span> <span class="o">/?</span><span class="mi">111</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
</span><span class='line'><span class="n">User</span><span class="o">-</span><span class="nl">Agent:</span> <span class="n">curl</span><span class="o">/</span><span class="mf">7.37</span><span class="o">.</span><span class="mi">1</span>
</span><span class='line'><span class="nl">Host:</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="o">:</span><span class="mi">9999</span>
</span><span class='line'><span class="nl">Accept:</span> <span class="o">*/*</span>
</span></code></pre></td></tr></table></div></figure>


<h2>总结</h2>

<p>进行客户端-服务器端编程还是比较有趣的，同时在Java中进行socket编程要比其他语言（如C）要简单快速编写。</p>

<p>java.net这个包里面包含了很多强大灵活的类供开发者进行网络编程，在进行网络编程中，建议使用这个包下面的API。同时Sun.*这个包也包含了很多的网络编程相关的类，但是不建议使用这个包下面的API，因为这个包可能会改变，另外这个包不能保证在所有的平台都有包含。</p>

<h2>原文信息</h2>

<ul>
<li>原文地址：<a href="http://www.javaworld.com/article/2077322/core-java/core-java-sockets-programming-in-java-a-tutorial.html?null">Sockets programming in Java: A tutorial</a></li>
</ul>


<h2>好书推荐</h2>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B00116OTVS/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B00116OTVS&amp;linkCode=as2&amp;tag=droidyue-23">TCP/IP详解卷1:协议</a></li>
<li><a href="http://www.amazon.cn/gp/product/B002FB7KG4/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B002FB7KG4&amp;linkCode=as2&amp;tag=droidyue-23">TCP/IP详解•卷2：实现</a></li>
<li><a href="http://www.amazon.cn/gp/product/B002WC7NKO/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B002WC7NKO&amp;linkCode=as2&amp;tag=droidyue-23">TCP.IP详解(卷3):TCP事务协议.HTTP和UNIX域协议</a></li>
</ul>

]]></content>
  </entry>
  
</feed>
