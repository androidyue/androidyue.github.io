<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[技术小黑屋]]></title>
  <link href="http://droidyue.com/atom.xml" rel="self"/>
  <link href="http://droidyue.com/"/>
  <updated>2014-11-19T22:27:02+08:00</updated>
  <id>http://droidyue.com/</id>
  <author>
    <name><![CDATA[androidyue]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Atom订阅转成RSS2.0]]></title>
    <link href="http://droidyue.com/blog/2014/11/18/convert-atom-to-rss/"/>
    <updated>2014-11-18T21:33:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/11/18/convert-atom-to-rss</id>
    <content type="html"><![CDATA[<p>Octopress博客自带的只Atom协议的订阅，但是最近提交收录网站时，需要使用RSS协议。于是利用周末简单实现了一下。</p>

<!--more-->


<h2>Atom和RSS</h2>

<p>以下为维基百科对Atom和RSS的解释。</p>

<blockquote><p>RSS（简易信息聚合）是一种消息来源格式规范，用以聚合经常发布更新数据的网站，例如博客文章、新闻、音频或视频的网摘。RSS文件（或称做摘要、网络摘要、或频更新，提供到频道）包含了全文或是节录的文字，再加上发用者所订阅之网摘布数据和授权的元数据。</p>

<p>Atom是一對彼此相關的標準。Atom供稿格式（Atom Syndication Format）是用於網站消息來源，基于XML的文档格式；而Atom出版協定（Atom Publishing Protocol，簡稱AtomPub或APP）是用於新增及修改網路資源，基于HTTP的协议。</p>

<p>Atom借鉴了各种版本RSS的使用经验，被許多的聚合工具广泛使用在发布和使用上。Atom供稿格式設計作為RSS的替代品；而Atom出版協定用來取代現有的多種發布方式（如Blogger API和LiveJournal XML-RPC Client/Server Protocol）。而值得一提的是Google提供的多種服务正在使用Atom。Google Data API（GData）亦基於Atom。</p></blockquote>

<p>可以访问<a href="http://zh.wikipedia.org/zh/Atom_(%E6%A8%99%E6%BA%96)#Atom.E8.88.87RSS_2.0.E7.9A.84.E6.AF.94.E8.BC.83" target="_blank">Atom與RSS 2.0的比較</a>，了解更详细的内容。</p>

<p>由此可知，Atom是现在和未来的主要供稿格式，而RSS是一个已经声明被冻结的格式。</p>

<h2>Atom转换成RSS</h2>

<ul>
<li>clone下这个工程<a href="https://github.com/androidyue/atom2rss">https://github.com/androidyue/atom2rss</a></li>
<li>使用<code>php atom2rss.php input_file output_file</code>即可完成转换。</li>
</ul>


<h3>atom2rss.php</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'>    <span class="nv">$source</span> <span class="o">=</span> <span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>    <span class="nv">$toFile</span> <span class="o">=</span> <span class="nv">$argv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span class='line'>    <span class="nv">$atom2rssXsl</span> <span class="o">=</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;/atom2rss.xsl&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$chan</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DOMDocument</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$chan</span><span class="o">-&gt;</span><span class="na">load</span><span class="p">(</span><span class="nv">$source</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$sheet</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DOMDocument</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$sheet</span><span class="o">-&gt;</span><span class="na">load</span><span class="p">(</span><span class="nv">$atom2rssXsl</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$processor</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XSLTProcessor</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$processor</span><span class="o">-&gt;</span><span class="na">registerPHPFunctions</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$processor</span><span class="o">-&gt;</span><span class="na">importStylesheet</span><span class="p">(</span><span class="nv">$sheet</span><span class="p">);</span>
</span><span class='line'>    <span class="nb">date_default_timezone_set</span><span class="p">(</span><span class="s2">&quot;Asia/Shanghai&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$processor</span><span class="o">-&gt;</span><span class="na">transformToXML</span><span class="p">(</span><span class="nv">$chan</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$result</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">file_put_contents</span><span class="p">(</span><span class="nv">$toFile</span><span class="p">,</span> <span class="nv">$result</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>主要依赖的就是进行转换的atom2rss.xml规则。
上述代码可以根据自己的需要设置时区。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby执行shell命令的六种方法]]></title>
    <link href="http://droidyue.com/blog/2014/11/18/six-ways-to-run-shell-in-ruby/"/>
    <updated>2014-11-18T21:17:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/11/18/six-ways-to-run-shell-in-ruby</id>
    <content type="html"><![CDATA[<p>在Ruby中，执行shell命令是一件不奇怪的事情，Ruby提供了大概6种方法供开发者进行实现。这些方法都很简单，本文将具体介绍一下如何在Ruby脚本中进行调用终端命令。</p>

<!--more-->


<h2>exec</h2>

<p>exec会将指定的命令替换掉当前进程中的操作,指定命令结束后，进程结束。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">exec</span> <span class="s1">&#39;echo &quot;hello world&quot;&#39;</span>
</span><span class='line'><span class="nb">print</span> <span class="s1">&#39;abc&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>执行上述的命令，结果如下，我们可以看到没有abc的输出，可以看出来，在执行<code>echo "hello world"</code>命令后进程就结束了。不会继续执行后面的<code>print 'abc'</code>。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">ruby</span> <span class="n">testCommand</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="n">hello</span> <span class="n">world</span>
</span></code></pre></td></tr></table></div></figure>


<p>使用exec一个头疼的事情就是没有办法知道shell命令执行成功还是失败。</p>

<h2>system</h2>

<p>system和exec相似，但是system执行的命令不会是在当前进程，而是在一个新创建的进程。system会返回布尔值来表明命令执行结果是成功还是失败。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">irb</span>
</span><span class='line'><span class="o">&gt;</span> <span class="nb">system</span> <span class="s1">&#39;echo &quot;hello $HOSTNAME&quot;&#39;</span>
</span><span class='line'><span class="n">hello</span> <span class="n">androidyue</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'><span class="o">&gt;</span> <span class="nb">puts</span> <span class="vg">$?</span>
</span><span class='line'><span class="n">pid</span> <span class="mi">11845</span> <span class="nb">exit</span> <span class="mi">0</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="kp">nil</span>
</span><span class='line'><span class="o">&gt;</span> <span class="nb">system</span> <span class="s1">&#39;false&#39;</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="kp">false</span>
</span><span class='line'><span class="o">&gt;</span> <span class="nb">puts</span> <span class="vg">$?</span>
</span><span class='line'><span class="n">pid</span> <span class="mi">11858</span> <span class="nb">exit</span> <span class="mi">1</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="kp">nil</span>
</span><span class='line'><span class="o">&gt;&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>system会将进程的退出的状态码赋值给$?，如果程序正常退出，$?的值为0，否则为非0。通过检测退出的状态码我们可以在ruby脚本中抛出异常或者进行重试操作。</p>

<p>注：在Unix-like系统中进程的退出状态码以0和非0表示，0代表成功，非0代表失败。</p>

<p>system可以告诉我们命令执行是成功还是失败，但是有些时候我们需要得到执行命令的输出，并在脚本中使用。显然system无法直接满足，需要我们使用反引号来实现。</p>

<h2>反引号(`)</h2>

<p>使用反引号是shell中常用的获取命令输出内容的方法，在ruby中也是可以，而且一点都需要做改变。使用反引号执行命令也会将命令在另一个进程中执行。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p448</span> <span class="p">:</span><span class="mo">013</span> <span class="o">&gt;</span> <span class="n">today</span> <span class="o">=</span> <span class="sb">`date`</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="s2">&quot;Sat Nov 15 19:28:55 CST 2014</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p448</span> <span class="p">:</span><span class="mo">014</span> <span class="o">&gt;</span> <span class="vg">$?</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="c1">#&lt;Process::Status: pid 11925 exit 0&gt; </span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p448</span> <span class="p">:</span><span class="mo">015</span> <span class="o">&gt;</span> <span class="vg">$?</span><span class="o">.</span><span class="n">to_i</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="mi">0</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p448</span> <span class="p">:</span><span class="mo">016</span> <span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面的方法如此简单，我们可以直接对返回的字符串结果进行操作。</p>

<p>注意，$?已经不再是上述的那样单纯的退出状态码了，它实际上是一个Process::Status对象。我们从中不仅可以知道进程的退出状态码也可以知道进程的ID。使用<code>$?.to_i</code>会得到退出的状态码，使用<code>$?.to_s</code>会得到包含了进程id，退出状态码等信息的字符串。</p>

<p>使用反引号的一个结果就是我们只能得到标准的输出（stdout）而不能得到标准的错误信息(stderr),比如下面的例子，我们执行一个输出错误字符串的perl脚本。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="err">$</span> <span class="n">irb</span>
</span><span class='line'>  <span class="o">&gt;&gt;</span> <span class="n">warning</span> <span class="o">=</span> <span class="sb">`perl -e &quot;warn &#39;dust in the wind&#39;&quot;`</span>
</span><span class='line'>  <span class="n">dust</span> <span class="k">in</span> <span class="n">the</span> <span class="n">wind</span> <span class="n">at</span> <span class="o">-</span><span class="n">e</span> <span class="n">line</span> <span class="mi">1</span><span class="o">.</span>
</span><span class='line'>  <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>  <span class="o">&gt;&gt;</span> <span class="nb">puts</span> <span class="n">warning</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">=&gt;</span> <span class="kp">nil</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看出，warning并没有得到出错的信息，这就表明反引号无法得到标准错误的信息。</p>

<h2>IO#popen</h2>

<p>IO#popen也是一种执行命令的方法,其命令也是在另外的进程中执行。使用popen你可以像操作IO对象一样处理标准输入和输出。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">irb</span>
</span><span class='line'><span class="o">&gt;&gt;</span> <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">f</span><span class="o">.</span><span class="n">gets</span> <span class="p">}</span>
</span><span class='line'><span class="no">Mon</span> <span class="no">Mar</span> <span class="mi">12</span> <span class="mi">18</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">56</span> <span class="no">PDT</span> <span class="mi">2007</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="kp">nil</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Open3#popen3</h2>

<p>在标准的Ruby库中还提供了一个Open3。使用这个类我们可以很容易的对标准输入，输出，错误进行处理。这里我们使用一个可以交互的工具dc。dc是一种逆波兰表达式（又叫做后缀表达式，每一运算符都置于其运算对象之后）的计算器，支持从标准输入读取数学表达式。在这个例子中，我们将两个数值和一个操作符进行压栈处理。然后使用p来输出结果。比如我们输入5和10，然后输入+，然后会得到15\n的输出。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="err">$</span> <span class="n">irb</span>
</span><span class='line'>  <span class="o">&gt;&gt;</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="no">Open3</span><span class="o">.</span><span class="n">popen3</span><span class="p">(</span><span class="s1">&#39;dc&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="o">=&gt;</span> <span class="o">[</span><span class="c1">#&lt;IO:0x6e5474&gt;, #&lt;IO:0x6e5438&gt;, #&lt;IO:0x6e53d4&gt;]</span>
</span><span class='line'>  <span class="o">&gt;&gt;</span> <span class="n">stdin</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'>  <span class="o">=&gt;</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="o">&gt;&gt;</span> <span class="n">stdin</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span class='line'>  <span class="o">=&gt;</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="o">&gt;&gt;</span> <span class="n">stdin</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="o">=&gt;</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="o">&gt;&gt;</span> <span class="n">stdin</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="o">=&gt;</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="o">&gt;&gt;</span> <span class="n">stdout</span><span class="o">.</span><span class="n">gets</span>
</span><span class='line'>  <span class="o">=&gt;</span> <span class="s2">&quot;15</span><span class="se">\n</span><span class="s2">&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>使用这个方法，我们不仅可以读取到命令的输出还可以对命令进行输入操作。这个方法对于进行交互操作很方便。通过popen3，我们还可以得到标准的错误信息。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="c1"># (irb continued...)</span>
</span><span class='line'>  <span class="o">&gt;&gt;</span> <span class="n">stdin</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="s2">&quot;asdfasdfasdfasdf&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="o">=&gt;</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="o">&gt;&gt;</span> <span class="n">stderr</span><span class="o">.</span><span class="n">gets</span>
</span><span class='line'>  <span class="o">=&gt;</span> <span class="s2">&quot;dc: stack empty</span><span class="se">\n</span><span class="s2">&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>但是，在ruby 1.8.5中popen3有一个缺陷，进程的退出状态没有写入到$?中。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="err">$</span> <span class="n">irb</span>
</span><span class='line'>  <span class="o">&gt;&gt;</span> <span class="nb">require</span> <span class="s2">&quot;open3&quot;</span>
</span><span class='line'>  <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'>  <span class="o">&gt;&gt;</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="no">Open3</span><span class="o">.</span><span class="n">popen3</span><span class="p">(</span><span class="s1">&#39;false&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="o">=&gt;</span> <span class="o">[</span><span class="c1">#&lt;IO:0x6f39c0&gt;, #&lt;IO:0x6f3984&gt;, #&lt;IO:0x6f3920&gt;]</span>
</span><span class='line'>  <span class="o">&gt;&gt;</span> <span class="vg">$?</span>
</span><span class='line'>  <span class="o">=&gt;</span> <span class="c1">#&lt;Process::Status: pid=26285,exited(0)&gt;</span>
</span><span class='line'>  <span class="o">&gt;&gt;</span> <span class="vg">$?</span><span class="o">.</span><span class="n">to_i</span>
</span><span class='line'>  <span class="o">=&gt;</span> <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure>


<p>为什么是0，false命令执行后的退出状态应该是非0才对，由于这个缺陷，我们需要了解一下Open4</p>

<h2>Open4#popen4</h2>

<p>Open4#popen4使用起来和Open3#popen3差不多，而且我们也可以得到程序的退出状态。popen4还可以返回一个子进程ID。你也可以通过Process::waitpid2 加上对应的进程ID获得进程退出状态。但是前提是要安装open4的gem。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="err">$</span> <span class="n">irb</span>
</span><span class='line'>  <span class="o">&gt;&gt;</span> <span class="nb">require</span> <span class="s2">&quot;open4&quot;</span>
</span><span class='line'>  <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'>  <span class="o">&gt;&gt;</span> <span class="n">pid</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="ss">Open4</span><span class="p">:</span><span class="ss">:popen4</span> <span class="s2">&quot;false&quot;</span>
</span><span class='line'>  <span class="o">=&gt;</span> <span class="o">[</span><span class="mi">26327</span><span class="p">,</span> <span class="c1">#&lt;IO:0x6dff24&gt;, #&lt;IO:0x6dfee8&gt;, #&lt;IO:0x6dfe84&gt;]</span>
</span><span class='line'>  <span class="o">&gt;&gt;</span> <span class="vg">$?</span>
</span><span class='line'>  <span class="o">=&gt;</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="o">&gt;&gt;</span> <span class="n">pid</span>
</span><span class='line'>  <span class="o">=&gt;</span> <span class="mi">26327</span>
</span><span class='line'>  <span class="o">&gt;&gt;</span> <span class="n">ignored</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="ss">Process</span><span class="p">:</span><span class="ss">:waitpid2</span> <span class="n">pid</span>
</span><span class='line'>  <span class="o">=&gt;</span> <span class="o">[</span><span class="mi">26327</span><span class="p">,</span> <span class="c1">#&lt;Process::Status: pid=26327,exited(1)&gt;]</span>
</span><span class='line'>  <span class="o">&gt;&gt;</span> <span class="n">status</span><span class="o">.</span><span class="n">to_i</span>
</span><span class='line'>  <span class="o">=&gt;</span> <span class="mi">256</span>
</span></code></pre></td></tr></table></div></figure>


<h2>原文</h2>

<ul>
<li><a href="http://tech.natemurray.com/2007/03/ruby-shell-commands.html">http://tech.natemurray.com/2007/03/ruby-shell-commands.html</a></li>
<li>在原文基础上，进行了部分删减。</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[译文：理解Android中垃圾回收日志信息]]></title>
    <link href="http://droidyue.com/blog/2014/11/08/understanding-garbage-collection-output-messages-in-android/"/>
    <updated>2014-11-08T18:16:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/11/08/understanding-garbage-collection-output-messages-in-android</id>
    <content type="html"><![CDATA[<p>如果你是一名Android开发者并且常常看程序日志的话，那么下面的这些信息对你来说可能一点都不陌生。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">GC_CONCURRENT</span> <span class="n">freed</span> <span class="mi">178</span><span class="n">K</span><span class="o">,</span> <span class="mi">41</span><span class="o">%</span> <span class="n">free</span> <span class="mi">3673</span><span class="n">K</span><span class="o">/</span><span class="mi">6151</span><span class="n">K</span><span class="o">,</span> <span class="n">external</span> <span class="mi">0</span><span class="n">K</span><span class="o">/</span><span class="mi">0</span><span class="n">K</span><span class="o">,</span> <span class="n">paused</span> <span class="mi">2</span><span class="n">ms</span><span class="o">+</span><span class="mi">2</span><span class="n">ms</span>
</span><span class='line'><span class="n">GC_EXPLICIT</span> <span class="n">freed</span> <span class="mi">6</span><span class="n">K</span><span class="o">,</span> <span class="mi">41</span><span class="o">%</span> <span class="n">free</span> <span class="mi">3667</span><span class="n">K</span><span class="o">/</span><span class="mi">6151</span><span class="n">K</span><span class="o">,</span> <span class="n">external</span> <span class="mi">0</span><span class="n">K</span><span class="o">/</span><span class="mi">0</span><span class="n">K</span><span class="o">,</span> <span class="n">paused</span> <span class="mi">29</span><span class="n">ms</span>
</span><span class='line'><span class="n">GC_CONCURRENT</span> <span class="n">freed</span> <span class="mi">379</span><span class="n">K</span><span class="o">,</span> <span class="mi">42</span><span class="o">%</span> <span class="n">free</span> <span class="mi">3856</span><span class="n">K</span><span class="o">/</span><span class="mi">6535</span><span class="n">K</span><span class="o">,</span> <span class="n">external</span> <span class="mi">0</span><span class="n">K</span><span class="o">/</span><span class="mi">0</span><span class="n">K</span><span class="o">,</span> <span class="n">paused</span> <span class="mi">2</span><span class="n">ms</span><span class="o">+</span><span class="mi">3</span><span class="n">ms</span>
</span><span class='line'><span class="n">GC_EXPLICIT</span> <span class="n">freed</span> <span class="mi">144</span><span class="n">K</span><span class="o">,</span> <span class="mi">41</span><span class="o">%</span> <span class="n">free</span> <span class="mi">3898</span><span class="n">K</span><span class="o">/</span><span class="mi">6535</span><span class="n">K</span><span class="o">,</span> <span class="n">external</span> <span class="mi">0</span><span class="n">K</span><span class="o">/</span><span class="mi">0</span><span class="n">K</span><span class="o">,</span> <span class="n">paused</span> <span class="mi">32</span><span class="n">ms</span>
</span><span class='line'><span class="n">GC_CONCURRENT</span> <span class="n">freed</span> <span class="mi">334</span><span class="n">K</span><span class="o">,</span> <span class="mi">40</span><span class="o">%</span> <span class="n">free</span> <span class="mi">4091</span><span class="n">K</span><span class="o">/</span><span class="mi">6727</span><span class="n">K</span><span class="o">,</span> <span class="n">external</span> <span class="mi">0</span><span class="n">K</span><span class="o">/</span><span class="mi">0</span><span class="n">K</span><span class="o">,</span> <span class="n">paused</span> <span class="mi">2</span><span class="n">ms</span><span class="o">+</span><span class="mi">3</span><span class="n">ms</span>
</span></code></pre></td></tr></table></div></figure>


<p>但是这些到底是什么，又有什么含义呢？</p>

<!--more-->


<p>上面的这几行就是Android系统垃圾回收的部分输出信息。每当垃圾回收被触发的时候，你就可以通过logcat查看到这样的信息。这样短短的一行的日志有着很大的信息量。比如通过日志我们可以发现程序可能有内存（泄露）问题。本文将具体介绍这些日志信息的每一部分的含义来帮助帮助大家更好地了解垃圾回收的运行情况。</p>

<h2>原因</h2>

<p><font color="red">GC_CONCURRENT</font> freed 178K, 41% free 3673K/6151K, external 0K/0K, paused 2ms+2ms <br/>
<font color="red">GC_EXPLICIT</font> freed 6K, 41% free 3667K/6151K, external 0K/0K, paused 29ms</p>

<p>红颜色标出的部分就是垃圾回收触发的原因。在Android中有五种类型的垃圾回收触发原因。</p>

<ul>
<li><strong>GC_CONCURRENT</strong> 当堆内存增长到一定程度时会触发。此时触发可以对堆中的没有用的对象及时进行回收，腾出空间供新的对象申请，避免进行不必要的增大堆内存的操作。</li>
<li><strong>GC_EXPLICIT</strong>   当程序中调用System.gc()方法触发。这个方法应避免出现在程序中调用。因为JVM有足够的能力来控制垃圾回收。</li>
<li><strong>GC_EXTERNAL_MALLOC</strong> 当Bitmap和NIO Direct ByteBuffer对象分配外部存储（机器内存，非Dalvik堆内存）触发。这个日志只有在2.3之前存在，从2.3系统开始，垃圾回收进行了调整，前面的对象都会存储到Dalivik堆内存中。所以在2.3系统之后，你就再也不会看到这种信息了。</li>
<li><strong>GC_FOR_MALLOC</strong> 当堆内存已满，系统需要更多内存的时候触发。这条日志出现后意味着JVM要暂停你的程序进行垃圾回收操作。</li>
<li><strong>GC_HPROF_DUMP_HEAP</strong> 当创建一个内存分析文件HPROF时触发。</li>
</ul>


<h2>结果</h2>

<p>GC_CONCURRENT <font color="red">freed 178K</font>, 41% free 3673K/6151K, external 0K/0K, paused 2ms+2ms <br/>
GC_EXPLICIT <font color="red">freed 6K</font>, 41% free 3667K/6151K, external 0K/0K, paused 29ms</p>

<p>这部分数据告诉我们JVM进行垃圾回收释放了多少空间。</p>

<h2>堆内存数据</h2>

<p>GC_CONCURRENT freed 178K, <font color="red">41% free 3673K/6151K</font>, external 0K/0K, paused 2ms+2ms <br/>
GC_EXPLICIT freed 6K, <font color="red">41% free 3667K/6151K</font>, external 0K/0K, paused 29ms</p>

<p>这部分告诉我们堆内存中可用内存占的比例，当前活跃的对象总的空间，以及当前堆的总大小。所以这里的数据就是41%的堆内存可用，已经使用了3673K，总的堆内存大小为6151K。</p>

<h2>外部存储数据</h2>

<p>GC_EXTERNAL_ALLOC freed 1125K, 47% free 6310K/11847K,  <font color="red">external 1051K/1103K</font>, paused 46ms<br/>
GC_EXTERNAL_ALLOC freed 295K, 47% free 6335K/11847K,  <font color="red">external 1613K/1651K</font>, paused 41ms</p>

<p>这部分数据告诉我们外部存储（位于机器内存）对象的数据。在2.3之前，bitmap对象存放在机器内存。因此在第一条数据中我们可以看到以有1051K使用，外部存储为1103K。</p>

<p>上面两行数据相差100毫秒，我们可以看到第一条数据表明外部存储快满了，由于GC_EXTERNAL_ALLOC被触发，外部存储空间扩大到了1651K。</p>

<h2>垃圾回收暂停时间</h2>

<p>GC_CONCURRENT freed 178K, 41% free 3673K/6151K, external 0K/0K, <font color="red">paused 2ms+2ms</font> <br/>
GC_EXPLICIT freed 6K, 41% free 3667K/6151K, external 0K/0K, <font color="red">paused 29ms</font></p>

<p>这部分数据表明垃圾回收消耗的时间。在GC_CONCURRENT回收时，你会发现两个暂停时间。一个是在回收开始的暂停时间，另一个时在回收结束的暂停时间。GC_CONCURRENT从2.3开始引入，相比之前的程序全部暂停的垃圾回收机制，它的暂停时间要小的多。一般少于5毫秒。因为GC_CONCURRENT的绝大多数操作在一个单独的线程中进行。</p>

<p>本文中内容摘自 Google I/O 2011: Memory management for Android Apps，如果感兴趣，请访问<a href="http://droidyue.com/blog/2014/11/02/note-for-google-io-memory-management-for-android-chinese-edition/">这里</a>了解更多。</p>

<h2>原文地址</h2>

<p><a href="https://sites.google.com/site/pyximanew/blog/androidunderstandingddmslogcatmemoryoutputmessages">https://sites.google.com/site/pyximanew/blog/androidunderstandingddmslogcatmemoryoutputmessages</a></p>

<h2>其他</h2>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B009VV6EG8/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B009VV6EG8&linkCode=as2&tag=droidyue-23">Android应用性能优化</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B009VV6EG8" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[啰嗦一下android中的NetworkOnMainThreadException]]></title>
    <link href="http://droidyue.com/blog/2014/11/08/look-into-android-dot-os-dot-networkonmainthreadexception/"/>
    <updated>2014-11-08T15:26:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/11/08/look-into-android-dot-os-dot-networkonmainthreadexception</id>
    <content type="html"><![CDATA[<p>相信很多Android开发者很多都遇到过android.os.NetworkOnMainThreadException 这个异常，意思就是主线程进行网络操作异常。这个问题比较简单，但是网络上有着鱼龙混杂的答案，这里想花点时间做一个比较完整的描述。</p>

<!--more-->


<h2>严格模式</h2>

<p>在早期的Android版本（2.3之前）中，Google并没有提供一个很严格的程序编写要求，所以在那时我们可以在主线程中执行本地IO操作，网络操作等这些不规范的行为。后来在2.3的姜饼（GINGERBREAD）开始提供了一个开发者工具，这就是StrictMode严格模式。</p>

<p>严格模式可以帮助开发者发现主线程中的磁盘操作和网络操作，开发者根据严格模式的输出信息可以改善程序来更好地响应用户操作，来较少ANR（程序未响应）的问题。</p>

<p>android.os.NetworkOnMainThreadException这个异常从Android 3.0（API 11）引入，出现情况为主线程进行网络操作。</p>

<h3>代码开启StrictMode</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="k">if</span> <span class="o">(</span><span class="n">Build</span><span class="o">.</span><span class="na">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&gt;=</span> <span class="n">VERSION_CODES</span><span class="o">.</span><span class="na">GINGERBREAD</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">ThreadPolicy</span><span class="o">.</span><span class="na">Builder</span> <span class="n">threadPolicyBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StrictMode</span><span class="o">.</span><span class="na">ThreadPolicy</span><span class="o">.</span><span class="na">Builder</span><span class="o">();</span>
</span><span class='line'>  <span class="n">threadPolicyBuilder</span><span class="o">.</span><span class="na">detectDiskReads</span><span class="o">().</span><span class="na">detectDiskWrites</span><span class="o">().</span><span class="na">detectNetwork</span><span class="o">().</span><span class="na">penaltyLog</span><span class="o">();</span>
</span><span class='line'>  <span class="n">StrictMode</span><span class="o">.</span><span class="na">setThreadPolicy</span><span class="o">(</span><span class="n">threadPolicyBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
</span><span class='line'>  <span class="n">VmPolicy</span><span class="o">.</span><span class="na">Builder</span> <span class="n">vmPolicyBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">VmPolicy</span><span class="o">.</span><span class="na">Builder</span><span class="o">();</span>
</span><span class='line'>  <span class="n">vmPolicyBuilder</span><span class="o">.</span><span class="na">detectLeakedSqlLiteObjects</span><span class="o">().</span><span class="na">penaltyLog</span><span class="o">();</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">Build</span><span class="o">.</span><span class="na">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&gt;=</span> <span class="n">VERSION_CODES</span><span class="o">.</span><span class="na">HONEYCOMB</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">vmPolicyBuilder</span><span class="o">.</span><span class="na">detectLeakedClosableObjects</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">StrictMode</span><span class="o">.</span><span class="na">setVmPolicy</span><span class="o">(</span><span class="n">vmPolicyBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>特别注意</h3>

<ul>
<li>严格模式不应该在发布版本时开启</li>
</ul>


<h2>治标不治本的办法</h2>

<p>下面的这段代码会让严格模式允许所有的磁盘操作和网络操作。但是这并没有改变真正解决问题，主线程中照样还是有网络操作，可能导致程序出现未响应的情况。所以这是一个很糟糕的解决方法，问题的解决思路应该是将网络操作移到非主线程进行，而不是这种掩耳盗铃的做法。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">StrictMode</span><span class="o">.</span><span class="na">ThreadPolicy</span> <span class="n">policy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StrictMode</span><span class="o">.</span><span class="na">ThreadPolicy</span><span class="o">.</span><span class="na">Builder</span><span class="o">().</span><span class="na">permitAll</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
</span><span class='line'><span class="n">StrictMode</span><span class="o">.</span><span class="na">setThreadPolicy</span><span class="o">(</span><span class="n">policy</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>p.s. 这个很笨的方法居然在Stackoverflow上有很多人认为有用，难以理解。</p>

<h2>AsyncTask也不好</h2>

<p>先实现一个我们用来测试的请求网络的方法</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">doGetRequest</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">HttpGet</span> <span class="n">method</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpGet</span><span class="o">(</span><span class="s">&quot;http://droidyue.com&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="n">AbstractHttpClient</span> <span class="n">http</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultHttpClient</span><span class="o">();</span>
</span><span class='line'>      <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">HttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">method</span><span class="o">);</span>
</span><span class='line'>          <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">LOGTAG</span><span class="o">,</span> <span class="s">&quot;doGetRequest responseCode=&quot;</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="na">getStatusLine</span><span class="o">().</span><span class="na">getStatusCode</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;; ThreadInfo=&quot;</span> <span class="o">+</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">());</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClientProtocolException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>使用AsyncTask可以将网络操作移到了AsyncTask的线程，可以避免NetworkOnMainThreadException异常。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="k">new</span> <span class="n">AsyncTask</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">,</span> <span class="n">Integer</span><span class="o">,</span> <span class="n">Void</span><span class="o">&gt;()</span> <span class="o">{</span>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">protected</span> <span class="n">Void</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="n">Void</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">doGetRequest</span><span class="o">();</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}.</span><span class="na">execute</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<h3>AsyncTask的弊端</h3>

<ul>
<li>上述AsyncTask为一个匿名内部类的对象,由于Java中非static内部类实例会持有外部类实例的引用,AsyncTask实例持有Activity的引用,这样很容易引起内存泄露</li>
<li>按照Android官方文档支出,AsyncTask被推荐为处理短时间(10秒以内)的操作,即本地的轻量IO操作.不适合使用网络这样时间不定的操作.</li>
</ul>


<p>更详细的关于AsyncTask请参考<a href="http://droidyue.com/blog/2014/11/08/bad-smell-of-asynctask-in-android/">Android中糟糕的AsyncTask</a></p>

<h2>这样也不好</h2>

<p>既然AsyncTask可能导致内存泄露并且不适用于长时间操作,那么这样呢</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="k">new</span> <span class="nf">Thread</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="kd">super</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</span><span class='line'>      <span class="n">doGetRequest</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}.</span><span class="na">start</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>这样还是不够好,虽然单独线程可以处理长时间的操作,但是问题还是依旧</p>

<ul>
<li>内存泄露问题依旧可能存在</li>
<li>如果多次重复进行这样的操作,每次重新创建新的Thread不好.</li>
</ul>


<h2>解决上述两处内部类可能引起的内存泄露问题</h2>

<ul>
<li>将AsyncTask或者Thread的子类作为单独的文件,不持有Activity的强引用</li>
<li>将AsyncTask或者Thread的子类使用static修饰,则不会隐式持有Activity的强引用</li>
<li>如果是匿名内部类，则需要将其对象设置成成员属性，使用static修饰就不会隐式持有Activity的强引用。</li>
</ul>


<h2>解决问题哪家强</h2>

<p>解决了上述的内存泄露基本可以做到比较完美的实现,或者使用Loaders实现也不错。关于线程重用问题，可以使用Executors.newSingleThreadExecutor()来解决。具体方案因情况而定。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[译文：Android中糟糕的AsyncTask]]></title>
    <link href="http://droidyue.com/blog/2014/11/08/bad-smell-of-asynctask-in-android/"/>
    <updated>2014-11-08T14:33:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/11/08/bad-smell-of-asynctask-in-android</id>
    <content type="html"><![CDATA[<p>AsyncTask是一个很常用的API，尤其异步处理数据并将数据应用到视图的操作场合。其实AsyncTask并不是那么好，甚至有些糟糕。本文我会讲AsyncTask会引起哪些问题，如何修复这些问题，并且关于AsyncTask的一些替代方案。</p>

<h2>AsyncTask</h2>

<p>从Android API 3（1.5 Cupcake）开始，AsyncTask被引入用来帮助开发者更简单地管理线程。实际上在Android 1.0和1.1也是有类似的实现，那就是UserTask。UserTask和AsyncTask有着相同的API及实现，但是由于由于1.0和1.1的设备份额微乎其微，这里的概念就不会涉及到UserTask。</p>

<!--more-->


<h2>生命周期</h2>

<p>关于AsyncTask存在一个这样广泛的误解，很多人认为一个在Activity中的AsyncTask会随着Activity的销毁而销毁。然后事实并非如此。AsyncTask会一直执行doInBackground()方法直到方法执行结束。一旦上述方法结束，会依据情况进行不同的操作。</p>

<ul>
<li>如果cancel(boolean)调用了，则执行onCancelled(Result)方法</li>
<li>如果cancel(boolean)没有调用，则执行onPostExecute(Result)方法</li>
</ul>


<p>AsyncTask的cancel方法需要一个布尔值的参数，参数名为mayInterruptIfRunning,意思是<code>如果正在执行是否可以打断</code>,如果这个值设置为true，表示这个任务可以被打断，否则，正在执行的程序会继续执行直到完成。如果在doInBackground()方法中有一个循环操作，我们应该在循环中使用isCancelled()来判断，如果返回为true，我们应该避免执行后续无用的循环操作。</p>

<p>总之，我们使用AsyncTask需要确保AsyncTask正确地取消。</p>

<h2>不好好工作的cancel()</h2>

<p>简而言之的答案，<strong>有时候起作用</strong>。</p>

<p>如果你调用了AsyncTask的cancel(false)，doInBackground()仍然会执行到方法结束，只是不会去调用onPostExecute()方法。但是实际上这是让应用程序执行了没有意义的操作。那么是不是我们调用cancel(true)前面的问题就能解决呢？并非如此。如果mayInterruptIfRunning设置为true，会使任务尽早结束，但是如果的doInBackground()有不可打断的方法会失效，比如这个BitmapFactory.decodeStream() IO操作。但是你可以提前关闭IO流并捕获这样操作抛出的异常。但是这样会使得cancel()方法没有任何意义。</p>

<h2>内存泄露</h2>

<p>还有一种常见的情况就是，在Activity中使用非静态匿名内部AsyncTask类，由于Java内部类的特点，AsyncTask内部类会持有外部类的隐式引用。详细请参考<a href="http://droidyue.com/blog/2014/10/02/the-private-modifier-in-java/">细话Java：&#8221;失效&#8221;的private修饰符</a>,由于AsyncTask的生命周期可能比Activity的长，当Activity进行销毁AsyncTask还在执行时，由于AsyncTask持有Activity的引用，导致Activity对象无法回收，进而产生内存泄露。</p>

<h2>结果丢失</h2>

<p>另一个问题就是在屏幕旋转等造成Activity重新创建时AsyncTask数据丢失的问题。当Activity销毁并创新创建后，还在运行的AsyncTask会持有一个Activity的非法引用即之前的Activity实例。导致onPostExecute()没有任何作用。</p>

<h2>串行还是并行</h2>

<p>关于AsyncTask时串行还是并行有很多疑问，这很正常，因为它经过多次的修改。如果你并不明白什么时串行还是并行，可以通过接下来的例子了解，假设我们在一个方法体里面有如下两行代码</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="k">new</span> <span class="nf">AsyncTask1</span><span class="o">().</span><span class="na">execute</span><span class="o">();</span>
</span><span class='line'><span class="k">new</span> <span class="nf">AsyncTask2</span><span class="o">().</span><span class="na">execute</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面的两个任务时同时执行呢，还是AsyncTask1执行结束之后，AsyncTask2才能执行呢？实际上是结果依据API不同而不同。</p>

<h3>在1.6(Donut)之前:</h3>

<p>在第一版的AsyncTask，任务是串行调度。一个任务执行完成另一个才能执行。由于串行执行任务，使用多个AsyncTask可能会带来有些问题。所以这并不是一个很好的处理异步（尤其是需要将结果作用于UI试图）操作的方法。</p>

<h3>从1.6到2.3(Gingerbread)</h3>

<p>后来Android团队决定让AsyncTask并行来解决1.6之前引起的问题，这个问题是解决了，新的问题又出现了。很多开发者实际上依赖于顺序执行的行为。于是很多并发的问题蜂拥而至。</p>

<h3>3.0（Honeycomb）到现在</h3>

<p>好吧，开发者可能并不喜欢让AsyncTask并行，于是Android团队又把AsyncTask改成了串行。当然这一次的修改并没有完全禁止AsyncTask并行。你可以通过设置executeOnExecutor(Executor)来实现多个AsyncTask并行。关于API文档的描述如下</p>

<blockquote><p>If we want to make sure we have control over the execution, whether it will run serially or parallel, we can check at runtime with this code to make sure it runs parallel:</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">AsyncTask</span> <span class="n">as</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">Build</span><span class="o">.</span><span class="na">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&lt;=</span> <span class="n">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">HONEYCOMB_MR1</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">as</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">as</span><span class="o">.</span><span class="na">executeOnExecutor</span><span class="o">(</span><span class="n">AsyncTask</span><span class="o">.</span><span class="na">THREAD_POOL_EXECUTOR</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="c1">//(This code does not work for API lvl 1 to 3)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>真的需要AsyncTask么</h2>

<p>并非如此，使用AsyncTask虽然可以以简短的代码实现异步操作，但是正如本文提到的，你需要让AsyncTask正常工作的话，需要注意很多条条框框。推荐的一种进行异步操作的技术就是使用Loaders。这个方法从Android 3.0 (Honeycomb)开始引入，在android支持包中也有包含。可以通过查看官方的文档来详细了解<a href="http://developer.android.com/guide/components/loaders.html">Loaders</a>。</p>

<p>本次译文对原文有少部分删减修改处理。</p>

<h2>引用推荐</h2>

<ul>
<li><a href="http://bon-app-etit.blogspot.hk/2013/04/the-dark-side-of-asynctask.html">原文地址(墙外的 Orz)</a></li>
<li><a href="http://grepcode.com/file/repository.grepcode.com/java/ext/com.google.android/android/4.4.4_r1/android/os/AsyncTask.java#AsyncTask">Grepcode AsyncTsk 源码参考</a></li>
<li><a href="http://blog.danlew.net/2014/06/21/the-hidden-pitfalls-of-asynctask/">另一篇介绍AsyncTask陷阱的文章</a></li>
<li><a href="http://www.amazon.cn/gp/product/B009OLU8EE/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B009OLU8EE&linkCode=as2&tag=droidyue-23">罗升阳的Android系统源代码情景分析</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B009OLU8EE" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Google IO：Android内存管理主题演讲记录]]></title>
    <link href="http://droidyue.com/blog/2014/11/02/note-for-google-io-memory-management-for-android-chinese-edition/"/>
    <updated>2014-11-02T14:44:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/11/02/note-for-google-io-memory-management-for-android-chinese-edition</id>
    <content type="html"><![CDATA[<p>翻出了3年前的Google IO大会的主题演讲  <strong>Google IO 2011 Memory management for Android Apps</strong>，该演讲介绍了Android系统在垃圾回收上的变化和如何发现并内存泄露以及如何管理Android中的内存。本演讲对开发者还是有很大的帮助。</p>

<p>目前全文内容为英文，但是大部分很容易理解。以下内容在原有基础上，进行了分段整理,更加便于阅读。</p>

<!--more-->


<h2>视频</h2>

<iframe height=498 width=510 src="http://player.youku.com/embed/XMzI3NDA5MzQ4" frameborder=0 allowfullscreen></iframe>


<h2>演讲全文内容</h2>

<p>  Hi everybody,</p>

<p>  My name’s Patrick Dubroy and today I’m going to talk to you about memory management for Android. So I’m really happy to see so
many people here who care about memory management, especially near the end of the day.</p>

<p>  So let’s get started. So I’m sure you all remember this device. This is the T-Mobile G1. Hugo talked about it in the keynote yesterday. It was released about two and a half years ago. So, is there anybody here who actually developed on the G1? All right, impressive. That’s about maybe
40% of the room. So you may remember that the G1 came with 192 megabytes of RAM. And in fact, most of that was used up by the system. There wasn’t a whole lot left over for apps.</p>

<p>  Fast forward a few years later, we have the Motorola Xoom released just a couple of months ago. The Xoom comes with a gigabyte of RAM. Now some people might hear this and think, OK, my troubles are over. I never have to worry about memory management again. And of course, given that we have a whole room here, you guys are all smart people and you realize that that’s not true. And there are a couple of reasons for this. First of all, the Xoom has six and a half times the resolution that the G1 had. So you’ve got six and a half times as many pixels on screen. That means you’re probably
going to need to use more memory. You got more bitmaps for example. The other thing is that on tablets, you really want to create a new kind
of application. You know, the rich, immersive applications, like this YouTube app, for example. These are going to take a lot of memory. There’s tons of bitmaps in here. Those use up a lot of memory. Also, the Xoom we’re talking about a pretty new device. This is basically bleeding edge hardware. Most your customers are not going to be using something that’s only two months old. So of course, you want to support people who are using older hardware as well.</p>

<p>  Finally, maybe you’re all familiar with Parkinson’s Law, which says that work always take as much time as you have. And really, it’s kind of the same for software. So, no matter how much memory you have, you’re going to find a way to use it and wish you had just a little bit more.</p>

<p>  What I want to talk about today are basically two different things. First of all, I want to cover some of the changes that we’ve made in Gingerbread and Honeycomb that affect how your app uses memory. That’s your cameo. All right, so as I was saying, there are two different things I want to cover today. So first of all, I want to talk about some of the changes we’ve made in Gingerbread and Honeycomb that affect how your apps use memory. And basically, memory management in general. In the second half of the talk I want to talk about some tools you can use to better understand how your app is using memory. And if you have memory leaks,how you can figure out where those memory leaks are.</p>

<p>  So just to set expectations for this talk, I’m going to make them some assumptions about the stuff you’ve done and it’ll really help you get the most out of this if you’re familiar with these concepts. So I’m hoping that you’ve all written Android apps before. And it looked like about half the room had developed on the G1, so that’s probably true. I hope that most of you have heard of the Dalvik heap. You have a basic idea of what I’m talking about when I talk about heap memory. I’m sure you’re familiar with the garbage collector. You have a basic idea hopefully of what garbage collection is and how it works. And probably, most of you have seen an OutOfMememoryError before and you have a basic idea of why you get it and what you can do to deal with it.</p>

<p>  So first, let’s talk about heap size. So you may know that in Android, there’s a hard limit on your application’s heap size. And there’s a couple reasons for this. So first of all, one of the great features of Android is that it has full multitasking. So you actually have multiple programs running at once. And so obviously, each one can’t use all of your devices memory. We also don’t want a runaway app to just start getting bigger and bigger and bloating the entire system. You always want your dialer to work, your launcher the work, that sort of thing. So there’s this hard limit
on heap size and if your application needs to allocate more memory and you’ve gone up to that heap size limit already,then you’re basically going to get an out of memory error. So this heap size limit is device dependent. It’s changed a lot over the years. On the G1 it was 16 megabytes. On the Xoom it’s now 48 megabytes. So it’s a little bit bigger.</p>

<p>  If you’re writing an app and you want to know, OK, how much heap space do I have available? You know, maybe you want to decide how much stuff to keep in a cache for example. There’s a method you can use in ActivityManager, getMemoryClass that will return an integer value in megabytes, which is your heap size. Now these limits were designed assuming that you know almost any app that you would want to build on Android should be able to fit under
these limits.</p>

<p>  Of course, there are some apps that are really memory intensive. And as I said, on the tablet, we really want to build almost a new class of application. It’s quite a different than the kind of things you were building on phones. So we thought, if someone wants to build an image editor, for example, on the Xoom, they should be able to do that. But an image editor’s a really memory intensive application. It’s unlikely that you could
build a good one that used less than 48 megabytes of heap.
  So in Honeycomb we’ve added a new option that allows applications like this to get a larger heap size. Basically, , you can put something in your AndroidManifest, largeHeap equals true. And that will allow your application to use more heap. And similarly, there’s a
method you can use to determine how much memory you have available to you. The ActivityManager getLargeMemoryClass method again, will return an integer
value of this large heap size.</p>

<p>  Now before we go any further, I want to give a big warning here. You know, this is not something you should be doing just because you got an out of
memory error, or you think that your app deserves a bigger heap. You’re not going to be doing yourself any favors because your app is going to perform
more poorly because bigger heap means you’re going to spend more time at garbage collection. Also, your users are probably going to notice because all their other apps are getting kicked out of memory. It’s really something you want to reserve for when you really understand OK, I’m using tons of memory and I know exactly why I’m using that memory, and I really need to use that memory. That’s the only time that you
should be using this large heap option. So I mentioned garbage collection. And that it takes longer when
you have a bigger heap.
  Let’s talk a little bit about garbage collection. So I just want to go through a quick explanation here of what garbage collection is doing. So basically, you have a set of objects. First of all, let’s say these blue objects here, these are the objects in your heap. And they form a kind of graph. They’ve got references to each other. Some of those objects are alive, some of them are not used anymore. So what the GC does is it starts from a set of objects that we call the roots. These are the objects that the GC knows is alive.</p>

<p>  For example, variables that are alive on a thread stack, J and I global references, we treat objects in the zygote as heap, or as roots as well. So basically, the GC starts with those objects and starts visiting the other objects. And basically, traversing through the whole graph to find out which objects are
referenced directly or indirectly from the GC roots. At the end of this process, you’ve got some objects left over, which the GC never visited. Those are your garbage. They can be collected. So it’s a pretty simple concept. And you can see why when I said that you have bigger heaps you’re going to have larger pause times. Because the garbage collector
basically has to traverse your entire live set of objects. If you’re using say the large heap option and you’ve got 256 megs of heap, well, that’s a lot of memory for the garbage collector to walk over. You’re going to see longer
pause times with that.</p>

<p>  We have some good news though. In Gingerbread, there have been some great changes to the garbage collector that make
things a lot better. So in Gingerbre– sorry, pre-Gingerbread, the state of the garbage collector was that we had to stop
the world collector. So what this means is that basically, when a garbage collection is in progress, your
application is stopped. All your application threads are completely stopped while the collection is proceeding. This is a pretty standard things. These pauses generally tend to be pretty short. What we found was that pause times as heaps were getting bigger, these were getting to be a little bit too long. So we were seeing stuff up 50 to 100 milliseconds. And if you’re trying to build a really responsive app that kind of pause time is not really acceptable.</p>

<p>  So in Gingerbread, we now have a concurrent garbage collector. It does most of its work concurrently, which means that your application is not stopped for the duration of the garbage collection. Basically, we have another thread that’s running at the same time as your application that can perform garbage collection work. You’ll see basically two short pauses. One at the beginning of a collection and one near the end. But these pause times are going to be much, much lower. Usually you’ll see two, three, four, or five milliseconds for your pause time. So that’s a significant improvement. Pause times about 10% of what they used to be. So that’s a really good change that we have in Gingerbread.</p>

<p>  Now if you’re building memory heavy apps, there’s a good chance you’re using a lot of bitmaps. We found that in a lot of apps you have maybe 50 or 75% of your heap is taken up by bitmaps. And in Honeycomb because you’re going to be developing on tablets, this gets even worse. Because your images are bigger to fill the screen. So before Honeycomb, the way we managed bitmaps was this. So the blue area up here is the Dalvik heap and this yellow object is a bitmap object. Now bitmap objects are always the same size in the heap no matter what their resolution is. The backing memory for the bitmap is actually stored in another object. So the pixel data is stored separately. Now before Honeycomb what we did was this pixel data was actually native memory. It was allocated using malloc outside the Dalvik heap. And this had a few consequences. If you wanted to free this memory you could either call recycle, which would free the memory synchronously. But if you didn’t call recycle and you were waiting for your bitmap to get garbage collected,we had to rely on the finalizer to free the backing memory for the bitmap. And if you’re familiar with finalization, you probably know that it’s an inherently unreliable process. Just by its nature it takes several collections, usually for finalization to complete. So this can cause problems with bitmap heavy app as you had to wait for several garbage
collections before your pixel data was reclaimed. And this could be a lot of memory because bitmap pixel data is quite a significant portion of the heap. This also made things harder to debug. If you were using standard
memory analysis tools like the Eclipse Memory Analyzer, it couldn’t actually see this native memory. You would see this tiny bitmap object. Sure, but that doesn’t tell you very much. You don’t mind if you have a 10 by 10 bitmap. But if you have a 512 by 512 bitmap it’s a big difference. Finally, the other problem that we had with this approach was that it required full stop the world garbage collections in order to reclaim the backing memory, assuming that you didn’t call recycle,that is.</p>

<p>  The good news is in Honeycomb we’ve changed the way this works. And the bitmap pixel data is now allocated inside the Dalvik heap. So this means it can be freed synchronously by the GC on the same cycle that your bitmap
gets collected. It’s also easier to debug because you can see this backing memory in standard analysis tools like Eclipse Memory Analyzer. And I’m going to do a demo in a few minutes and you’ll see really, how much more useful this is when you can see that memory. Finally, this strategy is more amenable to concurrent and partial garbage collections, which means we can generally keep those pause times down. So those are the two biggest changes that we’ve introduced in Gingerbread and Honeycomb that affect how your apps use memory.</p>

<p>  And now I want to dive in to some tools that you can use to better understand how much memory your app’s using. And if you have memory leaks, better understanding where those leaks are and generally, how your app is using memory. The most basic tool you can use for understanding your apps memory usage is to look at your log messages. So these are the log messages that you see in DDMS in the logcat view. You can also see them at the command line using adb logcat. And every time a garbage collection happens in your process, you’re going to see a message that looks something like this one. And I just want to go through the different parts of this message, so you can better understand what it’s telling you.</p>

<p>  The first thing we have is the reason for the garbage collection. Kind of what triggered it and what kind of collection is it. This one here was a concurrent collection. So a concurrent collection is triggered by basically, as your heap starts to fill up, we kick off our concurrent garbage collection so that it can hopefully complete before your heap gets full.</p>

<p>  Other kinds of collections that you’ll see in the log messages. GC for malloc is one of them. That’s what happens when say, we didn’t complete the concurrent collection in time and your application had to allocate more memory. The heap was full, so we had to stop and do a garbage collection.</p>

<p>  You’ll see GC external alloc, which is for externally allocated memory, like the bitmap pixel data which I mentioned. It’s also used for NIO direct byte buffers. Now this external memory as I mentioned, has gone away in Honeycomb. Basically everything is allocated inside the Dalvik heap now. So you won’t see this in your log messages in Honeycomb and later.</p>

<p>  You’ll also see a message if you do an HPROF, if you create an HPROF profile. And finally, the last one I want to mention is GC explicit. You’ll see this generally when you’re calling system.gc, which is something that
you know you really should avoid doing. In general, you should trust in the garbage collector. We’ve got some information
also about the amount of memory that was freed on this collection. There’s some statistics
about the heap. So the heap in this case, was 65% free after the collection completed. There’s about three and a half
megs of live objects and the total heap size here is listed as well. It’s almost 10 megs, 9,991 K. There’s some information about externally allocated memory, which is the bitmap pixel data and also, NIO direct byte buffers. The two numbers here, the first number is the amount of external memory that your app has allocated. The second number is a
sort of soft limit. When you’ve allocated that much memory, we’re going to kick off a GC. Finally, you’ll see the pause
times for that collection. And this is where you’re going to see the effect of your heap size. Larger heaps are going to
have larger pause times.</p>

<p>  The good news is for a concurrent collection, you’re going to see these pause times generally pretty low. Concurrent collections are going to show two pause times. There’s one short pause at the beginning of the collection and one most of the way through. Non-concurrent collections you’ll see a single pause time, and this is generally going to be quite a bit higher. So looking at your log messages is a really basic way to understand how much memory your app is using. But it doesn’t really tell you, where am I using that memory? What objects are using this memory?</p>

<p>  And the best way to do that is using heap dumps. So a heap dump is basically a binary file that contains information about all of the objects in your heap. You can create a heap dump using DDMS by clicking on the icon, this somewhat
cryptic icon. I think that mentioned it in the previous talk. There’s also an API for
creating heap dumps. In general, I find using DDMS is fine. There are times when you want to create a heap dump at a very, very specific point in time. Maybe when you’re trying to track down a memory leak. So it can be helpful
to use that API. You may need to convert the heap dump to the standard HPROF format. You’ll only need to do that if
you’re using the standalone version of DDMS. If you’re using the Eclipse plug-in, the ADT plug-in, it will
automatically convert it. But the conversion is pretty simple. There’s a tool in the Android
SDK, which you can use to do it. And after you’ve converted it to the standard HPROF format, you can analyze it with standard heap analysis tools, like MAT or jhat.</p>

<p>And I’m going to show an example of MAT, which is the shorter way of saying the Eclipse Memory Analyzer. And before I jump into the demo, I want to talk about memory leaks. So there’s kind of a misconception that in a managed run time, you can’t have memory leaks. And I’m sure you guys know that’s not true. Having a garbage collector does not prevent memory leaks. A memory leak in a managed runtime is a little bit different though, than a memory leak in C or C++. Basically, a leak is when you have a reference to an unused object that’s preventing that object from being garbage collected. And sometimes you can have a reference to a single object, but that object points to a bunch of other objects. And basically, that single reference is preventing a large group of objects
from being collected.</p>

<p>One thing to watch out for in Android. I see people sometimes and I’ve done this myself, accidentally create a memory
leak by holding a long lived reference to an activity. So you need to be really careful with that and maybe it’s you’re holding a reference to the context and that’s what happens. You can also do it by keeping a long lived reference to a view or to a drawable, because these will also hold a reference to the activity that
they were originally in. And the reason that this is a problem, the reason this causes a memory leak is this. So you’ve got your activity, it contains a viewgroup, a linearlayout or something, and it contains some views. And we’ve got a reference from the framework to the currently visible activity.</p>

<p>  But in Android, when you have a rotation event, so you rotate your device, what we do is actually build up a new view hierarchy because you need to load new resources, you may have a brand new layout for landscape or portrait, you may
have differently sized icons or bitmaps. And then we basically remove the reference to the old view hierarchy and point
to the new one. And the idea is that this old view hierarchy sure get garbage collected. But if you’re holding a reference to that, you’re going to prevent it from getting garbage collected. And that’s why it’s a problem to hold the long lived reference to an activity or even to a view because in fact, the arrows connecting these objects should be going in both directions. Because you’ve got pointers all the way up. So if you do have a memory leak, a really good way to figure out where it is using the Eclipse Memory Analyzer.</p>

<p>  I’m going to do a demo of that, but I want to first cover some of the concepts behind the Memory Analyzer, so that when I do the demo you’ll better understand what I’m showing you. So the Eclipse Memory Analyzer can be downloaded from the eclipse.org site. It comes in a couple of flavors. There’s an Eclipse plug-in version, there’s also a standalone version. I’m going to be demonstrating the standalone version. I just personally prefer not to have Eclipse have all these different plug-ins. I kind of like to keep things a little bit separate. But they’re basically the same. Now, Memory Analyzer has some important concepts that you’ll see a lot.</p>

<p>  It talks about shallow heap and retained heap. So the shallow heap of an object is just how large is this object, it’s
size and bytes. It’s really simple. So let’s say that all of these objects are 100 bytes. So they’re shallow heap
is 100 bytes. It’s easy. The retained heap is something different. Basically, the retained heap says, if I have an object here and I were to free this object, what other objects is it pointing to? And could those be freed at the same time? And so you calculate the retained heap in terms of, what is the total size of objects that could be freed by freeing this one object? So maybe it’s best to understand with an example. So this object down on the right-hand side in yellow, this guy doesn’t point to any other objects. So his retained size is pretty easy to calculate. His retained heap is 100. This guy on top, he has a pointer to one other object. But he’s not holding that object alive. There are other pointers to that same object. So this guy’s retained heap is also just 100 bytes. Because if we were to remove
this object, it’s not going to free up any other objects. The object down at the end however, it’s basically keeping all the other objects alive. So its retained heap is 400 because if we could free that object, we could free all the other objects well, on this slide anyway. So you might be wondering, how do you go about calculating the retain heap?</p>

<p>So you’re going to see this in Memory Analyzer. And actually, knowing how it calculates the retained heap is quite useful. So the Memory Analyzer uses a concept called the denominator tree. This is a concept from graph theory. Basically, if you have a node A and a node B, A is said to be the dominator of B if every path to B goes through A. And so you might see how that could help us figure out what the retained heap of an object is. So another example here. So let’s start with A. It’s kind of the root. B and C are only accessible through A. So it’s pretty straightforward. They’re children of A and the dominator tree. E is also only accessible through C. So it’s a child of C in the dominator tree. D is a little bit interesting here. D can be accessed through B or C, but A is on every path to D. So that means that A is
the parent of D and the dominator tree. And now you’re going to see this dominator tree concept also pop up in Memory
Analyzer in its UI. And it can be really helpful for tracking down memory leaks.</p>

<p>  So let’s jump in and do a demo of debugging and memory leak with MAT. So what I’m going to use for this demo is the Honeycomb gallery’s sample application. It’s a simple application that comes with the Android SDK the basically just demonstrates some of the features of Honeycomb. And really, all it is is a little app the lets you page through some photos. Pretty simple. Now I’ve done something kind of naughty here. I’ve introduced a memory leak into this application. And I’ll show you how I’ve done that. Sorry, I better switch to the slides again.</p>

<p>  So you’ll see here I have the
source code, an excerpt of the source code from the activity. And so what I’ve done here is I’ve introduced this inner class called leaky. And this is not a static inner class. So you may know that if you create a non-static inner class, it actually keeps a reference to the enclosing object. And this is because from a non-static inner class, you can actually refer to the instance variables of the enclosing object. So it’s going to retain a reference to the activity here. That’s fine as long as this object doesn’t live longer than the activity. But I’ve got this static field and statics live longer than any particular instance. And in my on create method, what I’ve done is instantiated the leaky object and stored it into the static field. So if you want to be able to visualize this, I basically got my view hierarchy that starts with the main activity. I’ve instantiated this leaky object and he has a reference to the main activity because that was its enclosing class. Finally, I have the main activity class, which is conceptually a different area of memory than any particular instance. And there’s a static variable pointing to the leaky object. So maybe you can see how this is going to cause a memory leak when I rotate the screen. So let’s jump in and take a look at this memory leak. So if you want to figure out whether you have a memory leak, one of the easiest ways is to just kind of look at your log messages. So I’m just going to do that. I’m going to do it at the command line. I can just type logcat. And I want to restrict it to the particular process that I’ve got running here. I don’t want to see all of the log messages on the system. So I’m just going to grab on the process ID. There we see a bunch a log messages, including some garbage collection messages. And the number you want to look
at is basically the first number here in the 9805K. The first number in your heap size. This is the amount of live objects in the system. And if you’re looking for a memory leak, that’s what you want to look at. So I’m going to flip through some of the photos here. And you’ll see that that number stays pretty constant. We’re up to 9872. But basically, the heap usage is pretty constant. Now when I rotate this device, we’re going to be a bunch of garbage collections happen. That heap usage goes up and it doesn’t go down again. So we’re now up to 12 megs of heap. So we leaked about two and a half megs. So whenever you see your memory go up in kind of a step function like that, it steps up and just never goes back down, that’s a good sign you have a memory leak.</p>

<p>  So once you know that you have a leak, what you’ll want to do is create a heap dump, so you can go about debugging it. So I’m going to do that right now. I’ll open up DDMS. You just need to select the process that you care about and click on this icon up in the toolbar that says dump HPROF file. That’ll create a heap dump. It takes a few seconds because
it’s dumping basically a huge binary file out to disk. And then I can just save it in a file called dump.hprof. And then, because I’m using this standalone version of DDMS here, I need to convert this file. As I mentioned, if you’re using
the ADT plug-in for Eclipse and using DDMS in there, you don’t need to go through this conversion step. But it’s really simple. Now that I’ve converted it, I can open up the Eclipse Memory Analyzer and take a look at this heap dump. So there’s not much to see in the Memory Analyzer until you’ve opened up a heap dump, which we can do just from the file menu. Open heap dump. And I’ll open up this converted heap dump, which I just created. Doesn’t take very long for it to load up.</p>

<p>  And the first thing you’ll see is this pie chart. This is showing the biggest objects in the system by retained size. Now this alone doesn’t really tell us too much. You can see that down in the bottom left here, when I mouse over the various slices of the pie, it’s telling me what kind of object I’ve got. But that doesn’t really tell us too much. If we want to get some more information, you want to look down here. There are two views. The histogram view and the dominator tree. And these are the ones that I find most useful and I’m going to show to you. Let’s take a look at
the dominator tree. You remember the concept I explained. This is how it can be useful in tracking down a memory leak. So what we’ve got here is basically a list of instances or a list of objects in this system organized. There’s a column here. Organized by the amount of retained heap. So when you’ve got a memory leak, looking at the amount of retained heap is often a good way to look at things because that’s going to have the biggest effect on how much memory you’re using. And chances are, if you’ve noticed that you’ve got a leak, you’re leaking a significant amount. So let me just Xoom in here. Hopefully you guys can see this a bit better. So at the very top of the list
we have the resources class. That’s not too surprising because our resources we have to load lots of bitmaps. That’s going to hold lots of memory alive. That’s fine. These two bitmap objects are interesting. I’ve got these two large
bitmaps, more than two and a half megs each. It’s funny because that sounds about like the amount of memory that I was leaking. So if I want to investigate a bit further, I can right click on one of these objects and choose path to GC roots. And I’ll chose excluding weak references because I want to see what’s keeping that object alive. And a weak reference is not going to keep it alive. So this opened up a new tab and what do you know? It actually points right to my leak. So when you’re creating leaks in your application, make sure you name it something really
helpful like this so you can find it easily.</p>

<p>AUDIENCE: [LAUGHTER]</p>

<p>PATRICK DUBROY: So some of you might have noticed this, that if there’s only a single path to this object, because that’s all I can see here, why didn’t this leak object show up in the dominator tree? I mentioned that the dominator tree should show you the largest objects by their amount of retained heap. And well this is a single object that’s responsible for retaining the bitmap. So the reason for that is that the Eclipse Memory Analyzer, when it calculates the dominator
tree, it actually doesn’t treat weak references separately. It basically just treats them like a normal reference. So you’ll see that if I actually right click on this guy again and say path to GC roots, and say with all references, then there’s actually another path to this object. But it’s a weak reference. Generally you don’t need to be too concerned about weak references because they’re not going to prevent your object from being garbage collected. But that’s why the leak object didn’t show up in the dominator tree. So the dominator tree is one really, really useful way of tracking down a memory leak. Another thing I like to use is the histogram view. So I mentioned that in Android, it’s common to leak memory by keeping long lived references to an activity. So you may want to actually go and look at the number instances of your main activity class that you have.</p>

<p>And the histogram view lets you do that. So the histogram view just shows a list of all the classes in its system and right now it’s sorted based on the amount of shallow heap occupied by classes in the system. So at the very top there, we
see we have byte arrays. And the reason for this is that byte arrays are now the backing memory for pixel data. And you know, this is a perfect example of why it’s really useful that we now have the pixel data inside the heap. Because if you’re using this on Gingerbread or earlier, you’re not going to see byte arrays at the top. Because that memory with allocated in native memory. So we could also, if we were concerned about these byte array objects, we might want to right click on it and say list objects with incoming references. And we’ve got our two large byte array objects here. We can right click on one and say, path to GC roots, excluding weak references. So this guy looks to have several paths, which keep it alive. Nothing looks out of the ordinary to me. And when you’re trying to find a memory leak, there’s not really a magic answer for how you find a leak. You really have to understand your system and understand what objects are alive, why they’re alive, during the various parts of your application. But you’ll see if I look at this other byte array object, and again, do path to GC roots excluding weak references, well, I’ve found my leak again. So this was another way that I might have found this if it weren’t so obvious from the dominator tree.</p>

<p>  The histogram view can also help us look for our activity instances. So there’s a lot of classes obviously in the system. Our activity is not here. There’s 2,200 classes. But luckily, Eclipse Memory Analyzer has this handy little filter view at the top. You can just start typing a regular expression. And it’ll return you all the classes that match that. So here we’ve got our main activity. And it tells us that there are actually two instances of this main activity. And that should kind of be a red flag. Normally you should expect to see only a single instance of your main activity alive.Now I mentioned during the screen rotation, we build up a new view hierarchy, there’s going to be a brief time where there’s two instances alive. But for the most part, you should expect to see one here. So I might think, OK, this is a red flag.</p>

<p>  Let’s take a look. So I can right click on this object and list objects with incoming references. So I want to look at what instances do I have and what’s pointing to them? And so I’ve got two instances here. If I right click on one of them and choose path to GC roots, excluding weak references, I’ve again, found my memory leak. And in looking at this, I might realize that, oh, I really didn’t intend to do this. I didn’t mean to keep this reference there. So that’s another way that you could have found the leak. So now that we’ve discovered where our memory leak is, why don’t we actually go ahead and fix it. So in this case, the problem was that we had a non-static inner class. So we could fix this by making it a static inner class. And then it wouldn’t actually keep a reference to the enclosing activity. The other thing we could do is actually just not store it in a static variable. So it’s fine if this leaky
object has a reference to the activity, as long as it doesn’t live longer than the activity. So let’s do that. Let’s just make this a regular instance variable and not a static. So then I can go in here recompile this and push it to the device.
  And hopefully, we should see that our memory leak has been eliminated. Sorry, what we actually want to do is look at our log output in order to see how much memory we’re using. So I’m just going to fire up the process here, take a look at the process ID. And again, just do adb logcat just on that process. So as I page through the photos again, we see lots of GC messages. When I rotate, we’re going to see the memory usage goes up for a minute there. But after a few collections, it does go back down to its previous value. So we’ve successfully eliminated the leak there. And this is great. You always want to eliminate memory leaks.</p>

<p>   So that’s an example of using the Eclipse Memory Analyzer to debug a memory leak. Eclipse Memory Analyzer is a really powerful tool. It’s a little bit complex. It actually took me quite a while to figure out that these were the two best tools for the job. So you really want to watch out for these memory leaks. So I gave an example here of retaining a long lived reference to an activity. If you’ve got our context, a view, a drawable, all of these things you need to
watch out for. Don’t hold long lived references to those. It can also happen with non-static inner classes, which is what I demonstrated there as well. Runnable is actually one that can bite you sometimes. You know, you create a new runnable. You have a deferred event that’s going to run in like five minutes. If user rotates the screen that deferred runnable is going to hold your previous activity instance alive for five minutes. So that’s not good.</p>

<p>  You also want to watch out for caches. Sometimes you have a cache and you want to keep memory alive, so that you can load images faster let’s say. But you may inadvertently hold things alive too long. So that covers basically, the core parts of the Eclipse Memory Analyzer, and gives you a basic understanding of memory leaks. If you’d like to get more information about Memory Analyzer, the download link you can find on the eclipse.org/mat site. Markus Kohler who’s one of the original team members of Eclipse Memory Analyzer, he has a blog called the Java Performance Blog. This is really great. He’s got tons of great articles on there about MAT and different ways you can use it to understand your applications memory usage.</p>

<p>  I’ve also got an article that I wrote on the Android Developer Blog called memory analysis for Android applications. It covers a lot of the same stuff that I did in my demo here. And Romain Guy also has a good article on avoiding memory leaks in Android. So I hope that’s been helpful, I hope you guys have a better understanding now of how you
can figure out your apps memory usage.</p>

<p>  And I’ve talked about two of the biggest changes that we’ve made in Gingerbread and
Honeycomb that affect how your apps use memory. Thanks.</p>

<p>[APPLAUSE]</p>

<p>So I can take questions from the floor if anyone has any. Or you all want to get out and get to a pub and have a beer?</p>

<p>AUDIENCE: Hi, you mentioned that if you use NIO in Honeycomb your objects are going to be not in native memory and now they’re going to be managed memory. How does that affect performance if you’re doing a NIO, is that going to be any slower, like very intense on network?</p>

<p>PATRICK DUBROY: No, I mean it shouldn’t affect. So I should say that there is still a way to allocate native memory for your NIO byte buffers. I’m not that familiar with the NIO APIs, but I believe there’s a way in JNI you can
allocate your own memory. So in that case, you’ll still be using native memory. But either way, it’s
just memory. It’s just allocated in a different place. So there’s nothing that makes
the Dalvik heap memory slower than other memory.</p>

<p>AUDIENCE: So you’re saying how in Honeycomb the bitmaps are stored in the Dalvik heap, but in previous versions to that it was stored on native memory. Does that mean that bitmaps had a different amount of heap size? Or is that still all counted in the 16 or 24 megabytes that previous versions had?</p>

<p>PATRICK DUBROY: Yeah, good question. The accounting limits are still the same. That was accounted for previously. You might have noticed if you ever ran into your heap limit, you would be looking at your heap size and like, I haven’t hit the limit yet, why am I’m getting out of memory? That was actually accounted for, so it was your total heap size plus the amount of externally allocated memory that was your limit. So that hasn’t changed.</p>

<p>AUDIENCE: Hello. I have a question on when does the garbage collector kicks in. Is is when a number of
objects in memory or the size of the heap?</p>

<p>PATRICK DUBROY: Well, it depends on what kind of garbage collection you’re talking about. The concurrent garbage collector–</p>

<p>AUDIENCE: Yeah, the concurrent. Yes.</p>

<p>PATRICK DUBROY: Yeah, so that I believe is the amount of basically, how full your heap is getting.</p>

<p>AUDIENCE: Because I noticed that when you do a lot of [INAUDIBLE] provide operations, so you have like [INAUDIBLE] list of operations, the garbage collector kicks in. But actually don’t collect any objects because you’re just filling in the array of objects that you want to insert into a database. And that’s grow quite quickly. And that tends to slow down a
bit, the application without actually solving any heap size.</p>

<p>PATRICK DUBROY: Yeah, I’m not sure if the GC looks at– so you’re basically saying, I guess, that the collector is kicking in. It’s not actually able to collect anything, so it shouldn’t–</p>

<p>AUDIENCE: But it keeps trying.</p>

<p>PATRICK DUBROY: Yeah, it should be smart enough. Yeah, I don’t believe we actually look at those kind of statistics yet. But I mean it seems reasonable. Yeah.</p>

<p>AUDIENCE: I was wondering if you guys have some plans for making a profiler for applications or more tools for analyzing memory and all that stuff?</p>

<p>PATRICK DUBROY: No plans that I know of. Is there anything in particular that you need? I mean I think the Eclipse
Memory Analyzer is a really powerful tool and I use it in my day-to-day work quite a bit. So I’ve certainly never found
that it it was missing certain features that I needed.</p>

<p>AUDIENCE: Yeah, probably because there are some old versions from Android that show memory leaks or something. But for example, on Eclair, there were some stuff with the– something there.</p>

<p>PATRICK DUBROY: Yeah, I mean we don’t have any immediate plans I don’t think to running specific tools.</p>

<p>AUDIENCE: OK, thank you.</p>

<p>PATRICK DUBROY: Oh, sorry I’ve been– yeah.</p>

<p>AUDIENCE: To my understanding, the native part of a bitmap memory before was actually an instance of the SKIA library, of one of the SKIA library bitmap classes. So is this still there or is it gone now that there is no more native memory allocated?</p>

<p>PATRICK DUBROY: No, SKIA is still part of this stack there. Basically at the point where SKIA calls out to allocate memory, we actually just call back into the VM and allocate the memory there rather than calling malloc. So it’s still basically the same mechanism, but the memory’s just coming from a different place.</p>

<p>AUDIENCE: OK. AUDIENCE: I thought that when I was using my application, I checked the heap size. While using the application the heap size was not significantly going up. But the amount of memory used by the application, which is listed in the applications tab under the running applications is going up significantly. Sometimes even doubling. I know that this is a different heap that is shown there. It’s actually the process heap, right? Can you tell me what the
background of that is that this is shown there because might like– I don’t have a memory leak and users complain about my application leaking memory. Because for the user it looks like it’s leaking memory.</p>

<p>PATRICK DUBROY: Right. Because you’re saying there’s stuff that’s attributed to your process that are showing up in the– basically, in system memory?</p>

<p>AUDIENCE: Yeah. So it’s showing the system memory in the applications tab, which is not really linked to my heap memory. So that is going up, but I can only control the heap memory. If I don’t have a native application I cannot control everything else.</p>

<p>PATRICK DUBROY: I mean there are going to be various things in the system that are going to get larger. For example, like your JIT code caches. As the JIT kicks in and is allocating memory, like it needs to store the compiled
code somewhere. So there’s definitely other parts of this system that allocate memory that’s going to kind of get charged to your application. But I can’t think of why. I can’t think of anything that would be out of the ordinary really that should cause problems.</p>

<p>AUDIENCE: But do you know if this will be changed maybe in the future? That this number is not shown there because for me, it doesn’t make sense to show this number to the end user because he doesn’t understand what it means.</p>

<p>PATRICK DUBROY: I see. Where is he seeing the number?</p>

<p>AUDIENCE: In the running applications tab. If he goes to settings, running applications, he can see the memory usage per
application and that’s actually the system memory.</p>

<p>PATRICK DUBROY: I see. Yeah, I’m not sure what our plans are with that. Sorry. I can take a look and I’m not
actually sure where it’s getting that number from.</p>

<p>AUDIENCE: OK, thanks.</p>

<p>AUDIENCE: My question’s about reasonable expectations of out of memory errors. Is it possible to completely
eliminate them? We’ve been working for a while in getting rid of all the out of memory errors and down to one in about every 17,000 sessions. Should we keep troubleshooting. I mean, I’d like to get it down to zero, but is that reasonable or?</p>

<p>PATRICK DUBROY: So there are certain scenarios where if you’re really close to your memory limit, so if your applications live memory size is really close to that limit, the garbage collector’s fundamentally kind of asynchronous. So if you’re really close to the limit, there can be times where you’re just trying to allocate so fast that the garbage collector
can’t keep up. So you can be actually sort of out running the garbage collector. So certainly it’s possible to
build applications that never see an out of memory error.
  But on the other hand, there are certain types of applications that are going to be running really, really close to the limits. One thing you can use if you have caches or things that you can free up, there are several ways to figure out that you’re getting close to the heap memory limit. I believe there’s a callback you can get notification that we’re getting low on memory. Although, the name escapes me. But you can also look at that, the Activity Manager, get memory class to get a sense of how much memory you have available on the system. And you know, maybe you can keep like smaller caches or leave the initialize objects rather than initializing them all in the constructor or something like that. It really depends on the application whether you expect to be running close to that heap limit or not.</p>

<p>AUDIENCE: You recommended not to call system.gc manually if you can help it. Is there any way to reliably
free bitmap memory pre-Honeycomb?</p>

<p>PATRICK DUBROY: Yes. Pre-Honeycomb?</p>

<p>AUDIENCE: Yes.</p>

<p>PATRICK DUBROY: You can call recycle on the bitmap.</p>

<p>AUDIENCE: Yeah, but it can still take several passes apparently.</p>

<p>PATRICK DUBROY: No. If you call recycle that will immediately free the backing memory. The bitmap itself, that’s like
80 bytes or something.</p>

<p>AUDIENCE: There are also bitmaps like drawables that you can’t manually recycle the bitmaps that the drawable object creates.</p>

<p>PATRICK DUBROY: OK.</p>

<p>AUDIENCE: The backing bitmaps for those.</p>

<p>PATRICK DUBROY: I see. No, I mean there are still some cases I guess where system.gc is the
right approach.</p>

<p>[UNINTELLIGIBLE PHRASE]</p>

<p>PATRICK DUBROY: OK, which objects are you talking about in–</p>

<p>AUDIENCE: My experience is when I have image drawables that are used some where in my layout and I know they’re no longer needed. Some of them are fairly large and it seems like–</p>

<p>PATRICK DUBROY: You can call recycle on those I believe.</p>

<p>AUDIENCE: OK. My experience is that it will cause other problems when I do that.</p>

<p>PATRICK DUBROY: If you’re still using them, then you can’t– I mean, you can only recycle
that when you’re not using it.</p>

<p>AUDIENCE: Sure. OK.</p>

<p>AUDIENCE: For native code that uses a lot of mallocs, what’s the best way to manage that memory?</p>

<p>PATRICK DUBROY: That’s a very good question. When you’ve got native code, I mean mostly what I was covering here was managing memory from the Dalvik side of things. I don’t know that I have any real pointers. I mean that’s one of the reasons why programming in a managed runtime is very nice. Is that you don’t have to deal with manually managing your memory. I don’t have any great advice for that.</p>

<p>AUDIENCE: Does the app that calls into the native libraries, is it aware of, at least on an aggravate level, how much memory is being used or is it completely a separate–</p>

<p>PATRICK DUBROY: I don’t believe there’s any way to account for if you’re calling into the library and it’s calling malloc. I don’t know that there’s any way to account for that memory from your application side.</p>

<p>AUDIENCE: But that garbage collector will run when you start allocating memory, will it not?</p>

<p>PATRICK DUBROY: It’ll run when you start allocating like objects in Dalvik. It doesn’t have any knowledge of calls to malloc.</p>

<p>AUDIENCE: You’ll just get an out of memory or a failed malloc if you–</p>

<p>PATRICK DUBROY: Yeah. Sure. It’s going to be the same mechanisms as any C or C++ program. Malloc is going to return
a null pointer. Yes?</p>

<p>AUDIENCE:
[UNINTELLIGIBLE PHRASE]</p>

<p>PATRICK DUBROY: Pardon me?</p>

<p>AUDIENCE:
[UNINTELLIGIBLE PHRASE]
PATRICK DUBROY: Oh, OK. That’s news to me. Malloc can’t fail on Android.</p>

<p>AUDIENCE:
[UNINTELLIGIBLE PHRASE]</p>

<p> PATRICK DUBROY: I see. OK.</p>

<p>AUDIENCE: Can you repeat that?</p>

<p>PATRICK DUBROY: Romain tells me that malloc can’t fail on Android.</p>

<p>AUDIENCE:
[UNINTELLIGIBLE PHRASE]</p>

<p>PATRICK DUBROY: I see. So I think this is the old Linux lazy– yeah. It’ll successfully allocate the
virtual memory, but Linux can actually hand out more virtual memory than it can actually commit. So you can get problems. Like when your system is totally, totally out of native memory, you’re going to see crashes.</p>

<p>AUDIENCE: So native memory is completely separate from anything Dalvik?</p>

<p>PATRICK DUBROY: Yes. Well, I mean, sorry, I should say, like Dalvik is still allocating its own memory like
for the heap through the native mechanisms. So it’s reserving the same virtual memory pages that other applications are using.</p>

<p>AUDIENCE: But if your system memory is–</p>

<p>PATRICK DUBROY: Yeah, if your system memory is out, you’re in trouble.</p>

<p>AUDIENCE: But Dalvik won’t get a notice say, hey, better start garbage collecting?</p>

<p>PATRICK DUBROY: Well, no.</p>

<p>AUDIENCE: The flag for using larger heap, does that require a permission, like users permission or something like that?</p>

<p>PATRICK DUBROY: I can’t remember whether we added that or not. I don’t think that it does.</p>

<p>AUDIENCE: Like the whole– could it been like a permission thing? But if it’s not then–</p>

<p>PATRICK DUBROY: Yeah, I mean the idea I think is that– yeah, you’re right. I mean it can affect the system as a whole because you’re going to have apps that are using a lot more memory, which is why I gave that big
warning, that this is not something that you should be using unless you know that you really need it.</p>

<p>AUDIENCE: Yeah. But [INAUDIBLE]. OK.</p>

<p>PATRICK DUBROY: I don’t think there’s a permission for it, though.</p>

<p>AUDIENCE: What if the app kind of runs in the background for weeks at a time? So I do everything I can to
simulate a leak, click everywhere I can, but I see the leaks if the app runs two or three days and then
I get [INAUDIBLE].</p>

<p>PATRICK DUBROY: One thing you could try is if you can use the APIs to determine how much
free memory you have. I don’t know if there’s any way you can actually kind of notice in your application that
it started leaking. But you could write out an HPROF file when you notice that you’ve gotten to a certain
point, your heap is getting smaller and smaller. So there is some debug information there that you could use. So if you have like some beta testers, who could actually send you these dumps, then you could do that. So write out the HPROF file
to SD card or something.</p>

<p>AUDIENCE: So maybe I can just write an HPROF file every–</p>

<p>PATRICK DUBROY: I wouldn’t do that. I mean they’re quite large. You don’t want to be doing that on a regular basis. But if you detect that things have gone really, really wrong and you’re about to die, in an alpha version or something for testing that’s one way you could do it. But I definitely wouldn’t recommend putting an app in the market that’s dumping like very large files to the SD card for no reason.</p>

<p>AUDIENCE: OK.</p>

<p>PATRICK DUBROY: OK, Thanks a lot.</p>

<h2>下载</h2>

<p><a href="http://pan.baidu.com/s/1i3zLPjf">http://pan.baidu.com/s/1i3zLPjf</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Note for Google IO Memory Management For Android]]></title>
    <link href="http://droidyue.com/blog/2014/11/02/note-for-google-io-memory-management-for-android/"/>
    <updated>2014-11-02T14:12:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/11/02/note-for-google-io-memory-management-for-android</id>
    <content type="html"><![CDATA[<p>This is the subtitle for Google I/O 2011: Memory management for Android Apps.</p>

<h2>The Video</h2>

<iframe width="640" height="360" src="http://droidyue.com//www.youtube.com/embed/_CruQY55HOk" frameborder="0" allowfullscreen></iframe>


<h2>The Subtitles</h2>

<p>  Hi everybody,</p>

<p>  My name’s Patrick Dubroy and today I’m going to talk to you about memory management for Android. So I’m really happy to see so
many people here who care about memory management, especially near the end of the day.</p>

<p>  So let’s get started. So I’m sure you all remember this device. This is the T-Mobile G1. Hugo talked about it in the keynote yesterday. It was released about two and a half years ago. So, is there anybody here who actually developed on the G1? All right, impressive. That’s about maybe
40% of the room. So you may remember that the G1 came with 192 megabytes of RAM. And in fact, most of that was used up by the system. There wasn’t a whole lot left over for apps.</p>

<p>  <!--more-->
  Fast forward a few years later, we have the Motorola Xoom released just a couple of months ago. The Xoom comes with a gigabyte of RAM. Now some people might hear this and think, OK, my troubles are over. I never have to worry about memory management again. And of course, given that we have a whole room here, you guys are all smart people and you realize that that’s not true. And there are a couple of reasons for this. First of all, the Xoom has six and a half times the resolution that the G1 had. So you’ve got six and a half times as many pixels on screen. That means you’re probably
going to need to use more memory. You got more bitmaps for example. The other thing is that on tablets, you really want to create a new kind
of application. You know, the rich, immersive applications, like this YouTube app, for example. These are going to take a lot of memory. There’s tons of bitmaps in here. Those use up a lot of memory. Also, the Xoom we’re talking about a pretty new device. This is basically bleeding edge hardware. Most your customers are not going to be using something that’s only two months old. So of course, you want to support people who are using older hardware as well.</p>

<p>  Finally, maybe you’re all familiar with Parkinson’s Law, which says that work always take as much time as you have. And really, it’s kind of the same for software. So, no matter how much memory you have, you’re going to find a way to use it and wish you had just a little bit more.</p>

<p>  What I want to talk about today are basically two different things. First of all, I want to cover some of the changes that we’ve made in Gingerbread and Honeycomb that affect how your app uses memory. That’s your cameo. All right, so as I was saying, there are two different things I want to cover today. So first of all, I want to talk about some of the changes we’ve made in Gingerbread and Honeycomb that affect how your apps use memory. And basically, memory management in general. In the second half of the talk I want to talk about some tools you can use to better understand how your app is using memory. And if you have memory leaks,how you can figure out where those memory leaks are.</p>

<p>  So just to set expectations for this talk, I’m going to make them some assumptions about the stuff you’ve done and it’ll really help you get the most out of this if you’re familiar with these concepts. So I’m hoping that you’ve all written Android apps before. And it looked like about half the room had developed on the G1, so that’s probably true. I hope that most of you have heard of the Dalvik heap. You have a basic idea of what I’m talking about when I talk about heap memory. I’m sure you’re familiar with the garbage collector. You have a basic idea hopefully of what garbage collection is and how it works. And probably, most of you have seen an OutOfMememoryError before and you have a basic idea of why you get it and what you can do to deal with it.</p>

<p>  So first, let’s talk about heap size. So you may know that in Android, there’s a hard limit on your application’s heap size. And there’s a couple reasons for this. So first of all, one of the great features of Android is that it has full multitasking. So you actually have multiple programs running at once. And so obviously, each one can’t use all of your devices memory. We also don’t want a runaway app to just start getting bigger and bigger and bloating the entire system. You always want your dialer to work, your launcher the work, that sort of thing. So there’s this hard limit
on heap size and if your application needs to allocate more memory and you’ve gone up to that heap size limit already,then you’re basically going to get an out of memory error. So this heap size limit is device dependent. It’s changed a lot over the years. On the G1 it was 16 megabytes. On the Xoom it’s now 48 megabytes. So it’s a little bit bigger.</p>

<p>  If you’re writing an app and you want to know, OK, how much heap space do I have available? You know, maybe you want to decide how much stuff to keep in a cache for example. There’s a method you can use in ActivityManager, getMemoryClass that will return an integer value in megabytes, which is your heap size. Now these limits were designed assuming that you know almost any app that you would want to build on Android should be able to fit under
these limits.</p>

<p>  Of course, there are some apps that are really memory intensive. And as I said, on the tablet, we really want to build almost a new class of application. It’s quite a different than the kind of things you were building on phones. So we thought, if someone wants to build an image editor, for example, on the Xoom, they should be able to do that. But an image editor’s a really memory intensive application. It’s unlikely that you could
build a good one that used less than 48 megabytes of heap.
  So in Honeycomb we’ve added a new option that allows applications like this to get a larger heap size. Basically, , you can put something in your AndroidManifest, largeHeap equals true. And that will allow your application to use more heap. And similarly, there’s a
method you can use to determine how much memory you have available to you. The ActivityManager getLargeMemoryClass method again, will return an integer
value of this large heap size.</p>

<p>  Now before we go any further, I want to give a big warning here. You know, this is not something you should be doing just because you got an out of
memory error, or you think that your app deserves a bigger heap. You’re not going to be doing yourself any favors because your app is going to perform
more poorly because bigger heap means you’re going to spend more time at garbage collection. Also, your users are probably going to notice because all their other apps are getting kicked out of memory. It’s really something you want to reserve for when you really understand OK, I’m using tons of memory and I know exactly why I’m using that memory, and I really need to use that memory. That’s the only time that you
should be using this large heap option. So I mentioned garbage collection. And that it takes longer when
you have a bigger heap.
  Let’s talk a little bit about garbage collection. So I just want to go through a quick explanation here of what garbage collection is doing. So basically, you have a set of objects. First of all, let’s say these blue objects here, these are the objects in your heap. And they form a kind of graph. They’ve got references to each other. Some of those objects are alive, some of them are not used anymore. So what the GC does is it starts from a set of objects that we call the roots. These are the objects that the GC knows is alive.</p>

<p>  For example, variables that are alive on a thread stack, J and I global references, we treat objects in the zygote as heap, or as roots as well. So basically, the GC starts with those objects and starts visiting the other objects. And basically, traversing through the whole graph to find out which objects are
referenced directly or indirectly from the GC roots. At the end of this process, you’ve got some objects left over, which the GC never visited. Those are your garbage. They can be collected. So it’s a pretty simple concept. And you can see why when I said that you have bigger heaps you’re going to have larger pause times. Because the garbage collector
basically has to traverse your entire live set of objects. If you’re using say the large heap option and you’ve got 256 megs of heap, well, that’s a lot of memory for the garbage collector to walk over. You’re going to see longer
pause times with that.</p>

<p>  We have some good news though. In Gingerbread, there have been some great changes to the garbage collector that make
things a lot better. So in Gingerbre– sorry, pre-Gingerbread, the state of the garbage collector was that we had to stop
the world collector. So what this means is that basically, when a garbage collection is in progress, your
application is stopped. All your application threads are completely stopped while the collection is proceeding. This is a pretty standard things. These pauses generally tend to be pretty short. What we found was that pause times as heaps were getting bigger, these were getting to be a little bit too long. So we were seeing stuff up 50 to 100 milliseconds. And if you’re trying to build a really responsive app that kind of pause time is not really acceptable.</p>

<p>  So in Gingerbread, we now have a concurrent garbage collector. It does most of its work concurrently, which means that your application is not stopped for the duration of the garbage collection. Basically, we have another thread that’s running at the same time as your application that can perform garbage collection work. You’ll see basically two short pauses. One at the beginning of a collection and one near the end. But these pause times are going to be much, much lower. Usually you’ll see two, three, four, or five milliseconds for your pause time. So that’s a significant improvement. Pause times about 10% of what they used to be. So that’s a really good change that we have in Gingerbread.</p>

<p>  Now if you’re building memory heavy apps, there’s a good chance you’re using a lot of bitmaps. We found that in a lot of apps you have maybe 50 or 75% of your heap is taken up by bitmaps. And in Honeycomb because you’re going to be developing on tablets, this gets even worse. Because your images are bigger to fill the screen. So before Honeycomb, the way we managed bitmaps was this. So the blue area up here is the Dalvik heap and this yellow object is a bitmap object. Now bitmap objects are always the same size in the heap no matter what their resolution is. The backing memory for the bitmap is actually stored in another object. So the pixel data is stored separately. Now before Honeycomb what we did was this pixel data was actually native memory. It was allocated using malloc outside the Dalvik heap. And this had a few consequences. If you wanted to free this memory you could either call recycle, which would free the memory synchronously. But if you didn’t call recycle and you were waiting for your bitmap to get garbage collected,we had to rely on the finalizer to free the backing memory for the bitmap. And if you’re familiar with finalization, you probably know that it’s an inherently unreliable process. Just by its nature it takes several collections, usually for finalization to complete. So this can cause problems with bitmap heavy app as you had to wait for several garbage
collections before your pixel data was reclaimed. And this could be a lot of memory because bitmap pixel data is quite a significant portion of the heap. This also made things harder to debug. If you were using standard
memory analysis tools like the Eclipse Memory Analyzer, it couldn’t actually see this native memory. You would see this tiny bitmap object. Sure, but that doesn’t tell you very much. You don’t mind if you have a 10 by 10 bitmap. But if you have a 512 by 512 bitmap it’s a big difference. Finally, the other problem that we had with this approach was that it required full stop the world garbage collections in order to reclaim the backing memory, assuming that you didn’t call recycle,that is.</p>

<p>  The good news is in Honeycomb we’ve changed the way this works. And the bitmap pixel data is now allocated inside the Dalvik heap. So this means it can be freed synchronously by the GC on the same cycle that your bitmap
gets collected. It’s also easier to debug because you can see this backing memory in standard analysis tools like Eclipse Memory Analyzer. And I’m going to do a demo in a few minutes and you’ll see really, how much more useful this is when you can see that memory. Finally, this strategy is more amenable to concurrent and partial garbage collections, which means we can generally keep those pause times down. So those are the two biggest changes that we’ve introduced in Gingerbread and Honeycomb that affect how your apps use memory.</p>

<p>  And now I want to dive in to some tools that you can use to better understand how much memory your app’s using. And if you have memory leaks, better understanding where those leaks are and generally, how your app is using memory. The most basic tool you can use for understanding your apps memory usage is to look at your log messages. So these are the log messages that you see in DDMS in the logcat view. You can also see them at the command line using adb logcat. And every time a garbage collection happens in your process, you’re going to see a message that looks something like this one. And I just want to go through the different parts of this message, so you can better understand what it’s telling you.</p>

<p>  The first thing we have is the reason for the garbage collection. Kind of what triggered it and what kind of collection is it. This one here was a concurrent collection. So a concurrent collection is triggered by basically, as your heap starts to fill up, we kick off our concurrent garbage collection so that it can hopefully complete before your heap gets full.</p>

<p>  Other kinds of collections that you’ll see in the log messages. GC for malloc is one of them. That’s what happens when say, we didn’t complete the concurrent collection in time and your application had to allocate more memory. The heap was full, so we had to stop and do a garbage collection.</p>

<p>  You’ll see GC external alloc, which is for externally allocated memory, like the bitmap pixel data which I mentioned. It’s also used for NIO direct byte buffers. Now this external memory as I mentioned, has gone away in Honeycomb. Basically everything is allocated inside the Dalvik heap now. So you won’t see this in your log messages in Honeycomb and later.</p>

<p>  You’ll also see a message if you do an HPROF, if you create an HPROF profile. And finally, the last one I want to mention is GC explicit. You’ll see this generally when you’re calling system.gc, which is something that
you know you really should avoid doing. In general, you should trust in the garbage collector. We’ve got some information
also about the amount of memory that was freed on this collection. There’s some statistics
about the heap. So the heap in this case, was 65% free after the collection completed. There’s about three and a half
megs of live objects and the total heap size here is listed as well. It’s almost 10 megs, 9,991 K. There’s some information about externally allocated memory, which is the bitmap pixel data and also, NIO direct byte buffers. The two numbers here, the first number is the amount of external memory that your app has allocated. The second number is a
sort of soft limit. When you’ve allocated that much memory, we’re going to kick off a GC. Finally, you’ll see the pause
times for that collection. And this is where you’re going to see the effect of your heap size. Larger heaps are going to
have larger pause times.</p>

<p>  The good news is for a concurrent collection, you’re going to see these pause times generally pretty low. Concurrent collections are going to show two pause times. There’s one short pause at the beginning of the collection and one most of the way through. Non-concurrent collections you’ll see a single pause time, and this is generally going to be quite a bit higher. So looking at your log messages is a really basic way to understand how much memory your app is using. But it doesn’t really tell you, where am I using that memory? What objects are using this memory?</p>

<p>  And the best way to do that is using heap dumps. So a heap dump is basically a binary file that contains information about all of the objects in your heap. You can create a heap dump using DDMS by clicking on the icon, this somewhat
cryptic icon. I think that mentioned it in the previous talk. There’s also an API for
creating heap dumps. In general, I find using DDMS is fine. There are times when you want to create a heap dump at a very, very specific point in time. Maybe when you’re trying to track down a memory leak. So it can be helpful
to use that API. You may need to convert the heap dump to the standard HPROF format. You’ll only need to do that if
you’re using the standalone version of DDMS. If you’re using the Eclipse plug-in, the ADT plug-in, it will
automatically convert it. But the conversion is pretty simple. There’s a tool in the Android
SDK, which you can use to do it. And after you’ve converted it to the standard HPROF format, you can analyze it with standard heap analysis tools, like MAT or jhat.</p>

<p>And I’m going to show an example of MAT, which is the shorter way of saying the Eclipse Memory Analyzer. And before I jump into the demo, I want to talk about memory leaks. So there’s kind of a misconception that in a managed run time, you can’t have memory leaks. And I’m sure you guys know that’s not true. Having a garbage collector does not prevent memory leaks. A memory leak in a managed runtime is a little bit different though, than a memory leak in C or C++. Basically, a leak is when you have a reference to an unused object that’s preventing that object from being garbage collected. And sometimes you can have a reference to a single object, but that object points to a bunch of other objects. And basically, that single reference is preventing a large group of objects
from being collected.</p>

<p>One thing to watch out for in Android. I see people sometimes and I’ve done this myself, accidentally create a memory
leak by holding a long lived reference to an activity. So you need to be really careful with that and maybe it’s you’re holding a reference to the context and that’s what happens. You can also do it by keeping a long lived reference to a view or to a drawable, because these will also hold a reference to the activity that
they were originally in. And the reason that this is a problem, the reason this causes a memory leak is this. So you’ve got your activity, it contains a viewgroup, a linearlayout or something, and it contains some views. And we’ve got a reference from the framework to the currently visible activity.</p>

<p>  But in Android, when you have a rotation event, so you rotate your device, what we do is actually build up a new view hierarchy because you need to load new resources, you may have a brand new layout for landscape or portrait, you may
have differently sized icons or bitmaps. And then we basically remove the reference to the old view hierarchy and point
to the new one. And the idea is that this old view hierarchy sure get garbage collected. But if you’re holding a reference to that, you’re going to prevent it from getting garbage collected. And that’s why it’s a problem to hold the long lived reference to an activity or even to a view because in fact, the arrows connecting these objects should be going in both directions. Because you’ve got pointers all the way up. So if you do have a memory leak, a really good way to figure out where it is using the Eclipse Memory Analyzer.</p>

<p>  I’m going to do a demo of that, but I want to first cover some of the concepts behind the Memory Analyzer, so that when I do the demo you’ll better understand what I’m showing you. So the Eclipse Memory Analyzer can be downloaded from the eclipse.org site. It comes in a couple of flavors. There’s an Eclipse plug-in version, there’s also a standalone version. I’m going to be demonstrating the standalone version. I just personally prefer not to have Eclipse have all these different plug-ins. I kind of like to keep things a little bit separate. But they’re basically the same. Now, Memory Analyzer has some important concepts that you’ll see a lot.</p>

<p>  It talks about shallow heap and retained heap. So the shallow heap of an object is just how large is this object, it’s
size and bytes. It’s really simple. So let’s say that all of these objects are 100 bytes. So they’re shallow heap
is 100 bytes. It’s easy. The retained heap is something different. Basically, the retained heap says, if I have an object here and I were to free this object, what other objects is it pointing to? And could those be freed at the same time? And so you calculate the retained heap in terms of, what is the total size of objects that could be freed by freeing this one object? So maybe it’s best to understand with an example. So this object down on the right-hand side in yellow, this guy doesn’t point to any other objects. So his retained size is pretty easy to calculate. His retained heap is 100. This guy on top, he has a pointer to one other object. But he’s not holding that object alive. There are other pointers to that same object. So this guy’s retained heap is also just 100 bytes. Because if we were to remove
this object, it’s not going to free up any other objects. The object down at the end however, it’s basically keeping all the other objects alive. So its retained heap is 400 because if we could free that object, we could free all the other objects well, on this slide anyway. So you might be wondering, how do you go about calculating the retain heap?</p>

<p>So you’re going to see this in Memory Analyzer. And actually, knowing how it calculates the retained heap is quite useful. So the Memory Analyzer uses a concept called the denominator tree. This is a concept from graph theory. Basically, if you have a node A and a node B, A is said to be the dominator of B if every path to B goes through A. And so you might see how that could help us figure out what the retained heap of an object is. So another example here. So let’s start with A. It’s kind of the root. B and C are only accessible through A. So it’s pretty straightforward. They’re children of A and the dominator tree. E is also only accessible through C. So it’s a child of C in the dominator tree. D is a little bit interesting here. D can be accessed through B or C, but A is on every path to D. So that means that A is
the parent of D and the dominator tree. And now you’re going to see this dominator tree concept also pop up in Memory
Analyzer in its UI. And it can be really helpful for tracking down memory leaks.</p>

<p>  So let’s jump in and do a demo of debugging and memory leak with MAT. So what I’m going to use for this demo is the Honeycomb gallery’s sample application. It’s a simple application that comes with the Android SDK the basically just demonstrates some of the features of Honeycomb. And really, all it is is a little app the lets you page through some photos. Pretty simple. Now I’ve done something kind of naughty here. I’ve introduced a memory leak into this application. And I’ll show you how I’ve done that. Sorry, I better switch to the slides again.</p>

<p>  So you’ll see here I have the
source code, an excerpt of the source code from the activity. And so what I’ve done here is I’ve introduced this inner class called leaky. And this is not a static inner class. So you may know that if you create a non-static inner class, it actually keeps a reference to the enclosing object. And this is because from a non-static inner class, you can actually refer to the instance variables of the enclosing object. So it’s going to retain a reference to the activity here. That’s fine as long as this object doesn’t live longer than the activity. But I’ve got this static field and statics live longer than any particular instance. And in my on create method, what I’ve done is instantiated the leaky object and stored it into the static field. So if you want to be able to visualize this, I basically got my view hierarchy that starts with the main activity. I’ve instantiated this leaky object and he has a reference to the main activity because that was its enclosing class. Finally, I have the main activity class, which is conceptually a different area of memory than any particular instance. And there’s a static variable pointing to the leaky object. So maybe you can see how this is going to cause a memory leak when I rotate the screen. So let’s jump in and take a look at this memory leak. So if you want to figure out whether you have a memory leak, one of the easiest ways is to just kind of look at your log messages. So I’m just going to do that. I’m going to do it at the command line. I can just type logcat. And I want to restrict it to the particular process that I’ve got running here. I don’t want to see all of the log messages on the system. So I’m just going to grab on the process ID. There we see a bunch a log messages, including some garbage collection messages. And the number you want to look
at is basically the first number here in the 9805K. The first number in your heap size. This is the amount of live objects in the system. And if you’re looking for a memory leak, that’s what you want to look at. So I’m going to flip through some of the photos here. And you’ll see that that number stays pretty constant. We’re up to 9872. But basically, the heap usage is pretty constant. Now when I rotate this device, we’re going to be a bunch of garbage collections happen. That heap usage goes up and it doesn’t go down again. So we’re now up to 12 megs of heap. So we leaked about two and a half megs. So whenever you see your memory go up in kind of a step function like that, it steps up and just never goes back down, that’s a good sign you have a memory leak.</p>

<p>  So once you know that you have a leak, what you’ll want to do is create a heap dump, so you can go about debugging it. So I’m going to do that right now. I’ll open up DDMS. You just need to select the process that you care about and click on this icon up in the toolbar that says dump HPROF file. That’ll create a heap dump. It takes a few seconds because
it’s dumping basically a huge binary file out to disk. And then I can just save it in a file called dump.hprof. And then, because I’m using this standalone version of DDMS here, I need to convert this file. As I mentioned, if you’re using
the ADT plug-in for Eclipse and using DDMS in there, you don’t need to go through this conversion step. But it’s really simple. Now that I’ve converted it, I can open up the Eclipse Memory Analyzer and take a look at this heap dump. So there’s not much to see in the Memory Analyzer until you’ve opened up a heap dump, which we can do just from the file menu. Open heap dump. And I’ll open up this converted heap dump, which I just created. Doesn’t take very long for it to load up.</p>

<p>  And the first thing you’ll see is this pie chart. This is showing the biggest objects in the system by retained size. Now this alone doesn’t really tell us too much. You can see that down in the bottom left here, when I mouse over the various slices of the pie, it’s telling me what kind of object I’ve got. But that doesn’t really tell us too much. If we want to get some more information, you want to look down here. There are two views. The histogram view and the dominator tree. And these are the ones that I find most useful and I’m going to show to you. Let’s take a look at
the dominator tree. You remember the concept I explained. This is how it can be useful in tracking down a memory leak. So what we’ve got here is basically a list of instances or a list of objects in this system organized. There’s a column here. Organized by the amount of retained heap. So when you’ve got a memory leak, looking at the amount of retained heap is often a good way to look at things because that’s going to have the biggest effect on how much memory you’re using. And chances are, if you’ve noticed that you’ve got a leak, you’re leaking a significant amount. So let me just Xoom in here. Hopefully you guys can see this a bit better. So at the very top of the list
we have the resources class. That’s not too surprising because our resources we have to load lots of bitmaps. That’s going to hold lots of memory alive. That’s fine. These two bitmap objects are interesting. I’ve got these two large
bitmaps, more than two and a half megs each. It’s funny because that sounds about like the amount of memory that I was leaking. So if I want to investigate a bit further, I can right click on one of these objects and choose path to GC roots. And I’ll chose excluding weak references because I want to see what’s keeping that object alive. And a weak reference is not going to keep it alive. So this opened up a new tab and what do you know? It actually points right to my leak. So when you’re creating leaks in your application, make sure you name it something really
helpful like this so you can find it easily.</p>

<p>AUDIENCE: [LAUGHTER]</p>

<p>PATRICK DUBROY: So some of you might have noticed this, that if there’s only a single path to this object, because that’s all I can see here, why didn’t this leak object show up in the dominator tree? I mentioned that the dominator tree should show you the largest objects by their amount of retained heap. And well this is a single object that’s responsible for retaining the bitmap. So the reason for that is that the Eclipse Memory Analyzer, when it calculates the dominator
tree, it actually doesn’t treat weak references separately. It basically just treats them like a normal reference. So you’ll see that if I actually right click on this guy again and say path to GC roots, and say with all references, then there’s actually another path to this object. But it’s a weak reference. Generally you don’t need to be too concerned about weak references because they’re not going to prevent your object from being garbage collected. But that’s why the leak object didn’t show up in the dominator tree. So the dominator tree is one really, really useful way of tracking down a memory leak. Another thing I like to use is the histogram view. So I mentioned that in Android, it’s common to leak memory by keeping long lived references to an activity. So you may want to actually go and look at the number instances of your main activity class that you have.</p>

<p>And the histogram view lets you do that. So the histogram view just shows a list of all the classes in its system and right now it’s sorted based on the amount of shallow heap occupied by classes in the system. So at the very top there, we
see we have byte arrays. And the reason for this is that byte arrays are now the backing memory for pixel data. And you know, this is a perfect example of why it’s really useful that we now have the pixel data inside the heap. Because if you’re using this on Gingerbread or earlier, you’re not going to see byte arrays at the top. Because that memory with allocated in native memory. So we could also, if we were concerned about these byte array objects, we might want to right click on it and say list objects with incoming references. And we’ve got our two large byte array objects here. We can right click on one and say, path to GC roots, excluding weak references. So this guy looks to have several paths, which keep it alive. Nothing looks out of the ordinary to me. And when you’re trying to find a memory leak, there’s not really a magic answer for how you find a leak. You really have to understand your system and understand what objects are alive, why they’re alive, during the various parts of your application. But you’ll see if I look at this other byte array object, and again, do path to GC roots excluding weak references, well, I’ve found my leak again. So this was another way that I might have found this if it weren’t so obvious from the dominator tree.</p>

<p>  The histogram view can also help us look for our activity instances. So there’s a lot of classes obviously in the system. Our activity is not here. There’s 2,200 classes. But luckily, Eclipse Memory Analyzer has this handy little filter view at the top. You can just start typing a regular expression. And it’ll return you all the classes that match that. So here we’ve got our main activity. And it tells us that there are actually two instances of this main activity. And that should kind of be a red flag. Normally you should expect to see only a single instance of your main activity alive.Now I mentioned during the screen rotation, we build up a new view hierarchy, there’s going to be a brief time where there’s two instances alive. But for the most part, you should expect to see one here. So I might think, OK, this is a red flag.</p>

<p>  Let’s take a look. So I can right click on this object and list objects with incoming references. So I want to look at what instances do I have and what’s pointing to them? And so I’ve got two instances here. If I right click on one of them and choose path to GC roots, excluding weak references, I’ve again, found my memory leak. And in looking at this, I might realize that, oh, I really didn’t intend to do this. I didn’t mean to keep this reference there. So that’s another way that you could have found the leak. So now that we’ve discovered where our memory leak is, why don’t we actually go ahead and fix it. So in this case, the problem was that we had a non-static inner class. So we could fix this by making it a static inner class. And then it wouldn’t actually keep a reference to the enclosing activity. The other thing we could do is actually just not store it in a static variable. So it’s fine if this leaky
object has a reference to the activity, as long as it doesn’t live longer than the activity. So let’s do that. Let’s just make this a regular instance variable and not a static. So then I can go in here recompile this and push it to the device.
  And hopefully, we should see that our memory leak has been eliminated. Sorry, what we actually want to do is look at our log output in order to see how much memory we’re using. So I’m just going to fire up the process here, take a look at the process ID. And again, just do adb logcat just on that process. So as I page through the photos again, we see lots of GC messages. When I rotate, we’re going to see the memory usage goes up for a minute there. But after a few collections, it does go back down to its previous value. So we’ve successfully eliminated the leak there. And this is great. You always want to eliminate memory leaks.</p>

<p>   So that’s an example of using the Eclipse Memory Analyzer to debug a memory leak. Eclipse Memory Analyzer is a really powerful tool. It’s a little bit complex. It actually took me quite a while to figure out that these were the two best tools for the job. So you really want to watch out for these memory leaks. So I gave an example here of retaining a long lived reference to an activity. If you’ve got our context, a view, a drawable, all of these things you need to
watch out for. Don’t hold long lived references to those. It can also happen with non-static inner classes, which is what I demonstrated there as well. Runnable is actually one that can bite you sometimes. You know, you create a new runnable. You have a deferred event that’s going to run in like five minutes. If user rotates the screen that deferred runnable is going to hold your previous activity instance alive for five minutes. So that’s not good.</p>

<p>  You also want to watch out for caches. Sometimes you have a cache and you want to keep memory alive, so that you can load images faster let’s say. But you may inadvertently hold things alive too long. So that covers basically, the core parts of the Eclipse Memory Analyzer, and gives you a basic understanding of memory leaks. If you’d like to get more information about Memory Analyzer, the download link you can find on the eclipse.org/mat site. Markus Kohler who’s one of the original team members of Eclipse Memory Analyzer, he has a blog called the Java Performance Blog. This is really great. He’s got tons of great articles on there about MAT and different ways you can use it to understand your applications memory usage.</p>

<p>  I’ve also got an article that I wrote on the Android Developer Blog called memory analysis for Android applications. It covers a lot of the same stuff that I did in my demo here. And Romain Guy also has a good article on avoiding memory leaks in Android. So I hope that’s been helpful, I hope you guys have a better understanding now of how you
can figure out your apps memory usage.</p>

<p>  And I’ve talked about two of the biggest changes that we’ve made in Gingerbread and
Honeycomb that affect how your apps use memory. Thanks.</p>

<p>[APPLAUSE]</p>

<p>So I can take questions from the floor if anyone has any. Or you all want to get out and get to a pub and have a beer?</p>

<p>AUDIENCE: Hi, you mentioned that if you use NIO in Honeycomb your objects are going to be not in native memory and now they’re going to be managed memory. How does that affect performance if you’re doing a NIO, is that going to be any slower, like very intense on network?</p>

<p>PATRICK DUBROY: No, I mean it shouldn’t affect. So I should say that there is still a way to allocate native memory for your NIO byte buffers. I’m not that familiar with the NIO APIs, but I believe there’s a way in JNI you can
allocate your own memory. So in that case, you’ll still be using native memory. But either way, it’s
just memory. It’s just allocated in a different place. So there’s nothing that makes
the Dalvik heap memory slower than other memory.</p>

<p>AUDIENCE: So you’re saying how in Honeycomb the bitmaps are stored in the Dalvik heap, but in previous versions to that it was stored on native memory. Does that mean that bitmaps had a different amount of heap size? Or is that still all counted in the 16 or 24 megabytes that previous versions had?</p>

<p>PATRICK DUBROY: Yeah, good question. The accounting limits are still the same. That was accounted for previously. You might have noticed if you ever ran into your heap limit, you would be looking at your heap size and like, I haven’t hit the limit yet, why am I’m getting out of memory? That was actually accounted for, so it was your total heap size plus the amount of externally allocated memory that was your limit. So that hasn’t changed.</p>

<p>AUDIENCE: Hello. I have a question on when does the garbage collector kicks in. Is is when a number of
objects in memory or the size of the heap?</p>

<p>PATRICK DUBROY: Well, it depends on what kind of garbage collection you’re talking about. The concurrent garbage collector–</p>

<p>AUDIENCE: Yeah, the concurrent. Yes.</p>

<p>PATRICK DUBROY: Yeah, so that I believe is the amount of basically, how full your heap is getting.</p>

<p>AUDIENCE: Because I noticed that when you do a lot of [INAUDIBLE] provide operations, so you have like [INAUDIBLE] list of operations, the garbage collector kicks in. But actually don’t collect any objects because you’re just filling in the array of objects that you want to insert into a database. And that’s grow quite quickly. And that tends to slow down a
bit, the application without actually solving any heap size.</p>

<p>PATRICK DUBROY: Yeah, I’m not sure if the GC looks at– so you’re basically saying, I guess, that the collector is kicking in. It’s not actually able to collect anything, so it shouldn’t–</p>

<p>AUDIENCE: But it keeps trying.</p>

<p>PATRICK DUBROY: Yeah, it should be smart enough. Yeah, I don’t believe we actually look at those kind of statistics yet. But I mean it seems reasonable. Yeah.</p>

<p>AUDIENCE: I was wondering if you guys have some plans for making a profiler for applications or more tools for analyzing memory and all that stuff?</p>

<p>PATRICK DUBROY: No plans that I know of. Is there anything in particular that you need? I mean I think the Eclipse
Memory Analyzer is a really powerful tool and I use it in my day-to-day work quite a bit. So I’ve certainly never found
that it it was missing certain features that I needed.</p>

<p>AUDIENCE: Yeah, probably because there are some old versions from Android that show memory leaks or something. But for example, on Eclair, there were some stuff with the– something there.</p>

<p>PATRICK DUBROY: Yeah, I mean we don’t have any immediate plans I don’t think to running specific tools.</p>

<p>AUDIENCE: OK, thank you.</p>

<p>PATRICK DUBROY: Oh, sorry I’ve been– yeah.</p>

<p>AUDIENCE: To my understanding, the native part of a bitmap memory before was actually an instance of the SKIA library, of one of the SKIA library bitmap classes. So is this still there or is it gone now that there is no more native memory allocated?</p>

<p>PATRICK DUBROY: No, SKIA is still part of this stack there. Basically at the point where SKIA calls out to allocate memory, we actually just call back into the VM and allocate the memory there rather than calling malloc. So it’s still basically the same mechanism, but the memory’s just coming from a different place.</p>

<p>AUDIENCE: OK. AUDIENCE: I thought that when I was using my application, I checked the heap size. While using the application the heap size was not significantly going up. But the amount of memory used by the application, which is listed in the applications tab under the running applications is going up significantly. Sometimes even doubling. I know that this is a different heap that is shown there. It’s actually the process heap, right? Can you tell me what the
background of that is that this is shown there because might like– I don’t have a memory leak and users complain about my application leaking memory. Because for the user it looks like it’s leaking memory.</p>

<p>PATRICK DUBROY: Right. Because you’re saying there’s stuff that’s attributed to your process that are showing up in the– basically, in system memory?</p>

<p>AUDIENCE: Yeah. So it’s showing the system memory in the applications tab, which is not really linked to my heap memory. So that is going up, but I can only control the heap memory. If I don’t have a native application I cannot control everything else.</p>

<p>PATRICK DUBROY: I mean there are going to be various things in the system that are going to get larger. For example, like your JIT code caches. As the JIT kicks in and is allocating memory, like it needs to store the compiled
code somewhere. So there’s definitely other parts of this system that allocate memory that’s going to kind of get charged to your application. But I can’t think of why. I can’t think of anything that would be out of the ordinary really that should cause problems.</p>

<p>AUDIENCE: But do you know if this will be changed maybe in the future? That this number is not shown there because for me, it doesn’t make sense to show this number to the end user because he doesn’t understand what it means.</p>

<p>PATRICK DUBROY: I see. Where is he seeing the number?</p>

<p>AUDIENCE: In the running applications tab. If he goes to settings, running applications, he can see the memory usage per
application and that’s actually the system memory.</p>

<p>PATRICK DUBROY: I see. Yeah, I’m not sure what our plans are with that. Sorry. I can take a look and I’m not
actually sure where it’s getting that number from.</p>

<p>AUDIENCE: OK, thanks.</p>

<p>AUDIENCE: My question’s about reasonable expectations of out of memory errors. Is it possible to completely
eliminate them? We’ve been working for a while in getting rid of all the out of memory errors and down to one in about every 17,000 sessions. Should we keep troubleshooting. I mean, I’d like to get it down to zero, but is that reasonable or?</p>

<p>PATRICK DUBROY: So there are certain scenarios where if you’re really close to your memory limit, so if your applications live memory size is really close to that limit, the garbage collector’s fundamentally kind of asynchronous. So if you’re really close to the limit, there can be times where you’re just trying to allocate so fast that the garbage collector
can’t keep up. So you can be actually sort of out running the garbage collector. So certainly it’s possible to
build applications that never see an out of memory error.
  But on the other hand, there are certain types of applications that are going to be running really, really close to the limits. One thing you can use if you have caches or things that you can free up, there are several ways to figure out that you’re getting close to the heap memory limit. I believe there’s a callback you can get notification that we’re getting low on memory. Although, the name escapes me. But you can also look at that, the Activity Manager, get memory class to get a sense of how much memory you have available on the system. And you know, maybe you can keep like smaller caches or leave the initialize objects rather than initializing them all in the constructor or something like that. It really depends on the application whether you expect to be running close to that heap limit or not.</p>

<p>AUDIENCE: You recommended not to call system.gc manually if you can help it. Is there any way to reliably
free bitmap memory pre-Honeycomb?</p>

<p>PATRICK DUBROY: Yes. Pre-Honeycomb?</p>

<p>AUDIENCE: Yes.</p>

<p>PATRICK DUBROY: You can call recycle on the bitmap.</p>

<p>AUDIENCE: Yeah, but it can still take several passes apparently.</p>

<p>PATRICK DUBROY: No. If you call recycle that will immediately free the backing memory. The bitmap itself, that’s like
80 bytes or something.</p>

<p>AUDIENCE: There are also bitmaps like drawables that you can’t manually recycle the bitmaps that the drawable object creates.</p>

<p>PATRICK DUBROY: OK.</p>

<p>AUDIENCE: The backing bitmaps for those.</p>

<p>PATRICK DUBROY: I see. No, I mean there are still some cases I guess where system.gc is the
right approach.</p>

<p>[UNINTELLIGIBLE PHRASE]</p>

<p>PATRICK DUBROY: OK, which objects are you talking about in–</p>

<p>AUDIENCE: My experience is when I have image drawables that are used some where in my layout and I know they’re no longer needed. Some of them are fairly large and it seems like–</p>

<p>PATRICK DUBROY: You can call recycle on those I believe.</p>

<p>AUDIENCE: OK. My experience is that it will cause other problems when I do that.</p>

<p>PATRICK DUBROY: If you’re still using them, then you can’t– I mean, you can only recycle
that when you’re not using it.</p>

<p>AUDIENCE: Sure. OK.</p>

<p>AUDIENCE: For native code that uses a lot of mallocs, what’s the best way to manage that memory?</p>

<p>PATRICK DUBROY: That’s a very good question. When you’ve got native code, I mean mostly what I was covering here was managing memory from the Dalvik side of things. I don’t know that I have any real pointers. I mean that’s one of the reasons why programming in a managed runtime is very nice. Is that you don’t have to deal with manually managing your memory. I don’t have any great advice for that.</p>

<p>AUDIENCE: Does the app that calls into the native libraries, is it aware of, at least on an aggravate level, how much memory is being used or is it completely a separate–</p>

<p>PATRICK DUBROY: I don’t believe there’s any way to account for if you’re calling into the library and it’s calling malloc. I don’t know that there’s any way to account for that memory from your application side.</p>

<p>AUDIENCE: But that garbage collector will run when you start allocating memory, will it not?</p>

<p>PATRICK DUBROY: It’ll run when you start allocating like objects in Dalvik. It doesn’t have any knowledge of calls to malloc.</p>

<p>AUDIENCE: You’ll just get an out of memory or a failed malloc if you–</p>

<p>PATRICK DUBROY: Yeah. Sure. It’s going to be the same mechanisms as any C or C++ program. Malloc is going to return
a null pointer. Yes?</p>

<p>AUDIENCE:
[UNINTELLIGIBLE PHRASE]</p>

<p>PATRICK DUBROY: Pardon me?</p>

<p>AUDIENCE:
[UNINTELLIGIBLE PHRASE]
PATRICK DUBROY: Oh, OK. That’s news to me. Malloc can’t fail on Android.</p>

<p>AUDIENCE:
[UNINTELLIGIBLE PHRASE]</p>

<p> PATRICK DUBROY: I see. OK.</p>

<p>AUDIENCE: Can you repeat that?</p>

<p>PATRICK DUBROY: Romain tells me that malloc can’t fail on Android.</p>

<p>AUDIENCE:
[UNINTELLIGIBLE PHRASE]</p>

<p>PATRICK DUBROY: I see. So I think this is the old Linux lazy– yeah. It’ll successfully allocate the
virtual memory, but Linux can actually hand out more virtual memory than it can actually commit. So you can get problems. Like when your system is totally, totally out of native memory, you’re going to see crashes.</p>

<p>AUDIENCE: So native memory is completely separate from anything Dalvik?</p>

<p>PATRICK DUBROY: Yes. Well, I mean, sorry, I should say, like Dalvik is still allocating its own memory like
for the heap through the native mechanisms. So it’s reserving the same virtual memory pages that other applications are using.</p>

<p>AUDIENCE: But if your system memory is–</p>

<p>PATRICK DUBROY: Yeah, if your system memory is out, you’re in trouble.</p>

<p>AUDIENCE: But Dalvik won’t get a notice say, hey, better start garbage collecting?</p>

<p>PATRICK DUBROY: Well, no.</p>

<p>AUDIENCE: The flag for using larger heap, does that require a permission, like users permission or something like that?</p>

<p>PATRICK DUBROY: I can’t remember whether we added that or not. I don’t think that it does.</p>

<p>AUDIENCE: Like the whole– could it been like a permission thing? But if it’s not then–</p>

<p>PATRICK DUBROY: Yeah, I mean the idea I think is that– yeah, you’re right. I mean it can affect the system as a whole because you’re going to have apps that are using a lot more memory, which is why I gave that big
warning, that this is not something that you should be using unless you know that you really need it.</p>

<p>AUDIENCE: Yeah. But [INAUDIBLE]. OK.</p>

<p>PATRICK DUBROY: I don’t think there’s a permission for it, though.</p>

<p>AUDIENCE: What if the app kind of runs in the background for weeks at a time? So I do everything I can to
simulate a leak, click everywhere I can, but I see the leaks if the app runs two or three days and then
I get [INAUDIBLE].</p>

<p>PATRICK DUBROY: One thing you could try is if you can use the APIs to determine how much
free memory you have. I don’t know if there’s any way you can actually kind of notice in your application that
it started leaking. But you could write out an HPROF file when you notice that you’ve gotten to a certain
point, your heap is getting smaller and smaller. So there is some debug information there that you could use. So if you have like some beta testers, who could actually send you these dumps, then you could do that. So write out the HPROF file
to SD card or something.</p>

<p>AUDIENCE: So maybe I can just write an HPROF file every–</p>

<p>PATRICK DUBROY: I wouldn’t do that. I mean they’re quite large. You don’t want to be doing that on a regular basis. But if you detect that things have gone really, really wrong and you’re about to die, in an alpha version or something for testing that’s one way you could do it. But I definitely wouldn’t recommend putting an app in the market that’s dumping like very large files to the SD card for no reason.</p>

<p>AUDIENCE: OK.</p>

<p>PATRICK DUBROY: OK, Thanks a lot.</p>

<h2>Extra Download</h2>

<p><a href="https://drive.google.com/file/d/0B_t9aqMaOHIJbnNObXBjZWVuTTg/view?usp=sharing">https://drive.google.com/file/d/0B_t9aqMaOHIJbnNObXBjZWVuTTg/view?usp=sharing</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[效率脚本：删除已经合并的git分支]]></title>
    <link href="http://droidyue.com/blog/2014/10/24/auto-delete-merged-branches/"/>
    <updated>2014-10-24T22:45:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/10/24/auto-delete-merged-branches</id>
    <content type="html"><![CDATA[<p>使用Git管理代码工程，着实方便了很多，但是当做完feature分支或者完成hotfix之后，总是忘记删除这些无用的分支，一个一个地删除着实麻烦，重复手工劳动不符合程序员的风格，于是写了一个简单的脚本。一键删除那些不需要的分支，让多余的干扰信息离开视线。</p>

<!--more-->


<h2>删除哪些分支？</h2>

<p>删除的为Merge（合并）操作的源分支。如果工程正在处于分支A(HEAD为A分支),分支B已经合并到了分支A，即A分支包含了B分支的内容，则会删除B分支。</p>

<h2>代码</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'><span class="c1"># encoding: utf-8</span>
</span><span class='line'><span class="n">exceptBranches</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;master&#39;</span><span class="p">,</span> <span class="s1">&#39;pre&#39;</span><span class="p">,</span> <span class="s1">&#39;develop&#39;</span><span class="o">]</span>
</span><span class='line'><span class="k">for</span> <span class="n">branch</span> <span class="k">in</span> <span class="sb">`cd </span><span class="si">#{</span><span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="si">}</span><span class="sb"> &amp;&amp; git branch -l`</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">-</span> <span class="o">[</span><span class="s1">&#39;*&#39;</span><span class="o">]</span>
</span><span class='line'>    <span class="k">next</span> <span class="k">if</span> <span class="n">exceptBranches</span><span class="o">.</span><span class="n">include?</span> <span class="n">branch</span>
</span><span class='line'>    <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;git branch -d </span><span class="si">#{</span><span class="n">branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>使用方法</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ruby removeMergedBranches.rb your_git_project
</span></code></pre></td></tr></table></div></figure>


<h2>执行结果</h2>

<p>执行结果类似如下，注意如果没有进行合并，则会提示警告或者错误，这些可以忽略。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>warning: deleting branch <span class="s1">&#39;custom&#39;</span> that has been merged to
</span><span class='line'>         <span class="s1">&#39;refs/remotes/origin/custom&#39;</span>, but not yet merged to HEAD.
</span><span class='line'>Deleted branch custom <span class="o">(</span>was b63ab7d<span class="o">)</span>.
</span><span class='line'>Deleted branch hotfix <span class="o">(</span>was 340cca0<span class="o">)</span>.
</span><span class='line'>Deleted branch mgit <span class="o">(</span>was 86b4004<span class="o">)</span>.
</span><span class='line'>error: The branch <span class="s1">&#39;develop_rtl&#39;</span> is not fully merged.
</span><span class='line'>If you are sure you want to delete it, run <span class="s1">&#39;git branch -D develop_rtl&#39;</span>.
</span></code></pre></td></tr></table></div></figure>


<h2>链接</h2>

<p><a href="https://github.com/androidyue/weekly-scripts/blob/master/ruby/removeMergedBranches.rb">在Github上的脚本</a></p>

<h3>学习书籍</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B0058FLC40/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B0058FLC40&linkCode=as2&tag=droidyue-23">Git权威指南</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B0058FLC40" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B008041DUY/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B008041DUY&linkCode=as2&tag=droidyue-23">七周七语言:理解多种编程范型</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B008041DUY" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[人生苦短，让你的Git飞起来吧]]></title>
    <link href="http://droidyue.com/blog/2014/10/15/speed-up-your-git/"/>
    <updated>2014-10-15T21:37:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/10/15/speed-up-your-git</id>
    <content type="html"><![CDATA[<p>git是一款超极优秀的版本控制工具，包括Linus大神的linux项目在内的千千万万的项目在使用。你可以使用Eclipse插件管理，亦可以使用终端工具。</p>

<p>git虽然有着svn不能匹及的本地仓库，但是和svn一样，和远程服务器通信也相当常用。常用的pull和push就是比较常见的命令。</p>

<p>然后，你是不是觉得从远程拉取（pull）到本地是不是很慢，从本地推到服务器端（push）又是不是很耗时呢，是吧，正所谓人生苦短，赶紧加速你的git吧。</p>

<!--more-->


<h2>修改ssh配置</h2>

<p>按照下面的内容修改这个文件<code>vim ~/.ssh/config</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">ControlMaster</span> <span class="n">auto</span>
</span><span class='line'><span class="c1">##ControlPath /tmp/%r@%h:%p</span>
</span><span class='line'><span class="no">ControlPath</span> <span class="sr">/tmp/</span><span class="n">git</span><span class="vi">@github</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="mi">22</span>
</span><span class='line'><span class="no">ControlPersist</span> <span class="n">yes</span>
</span></code></pre></td></tr></table></div></figure>


<h2>一些注解</h2>

<ul>
<li><strong>ControlMaster auto</strong>可以使多个ssh会话共享一个已经存在的连接，如果没有，则自动创建一个连接。</li>
<li><strong>ControlPath /tmp/%r@%h:%p</strong>可以指定想要共享的连接。%r代表远程登录用户名，一般都为git，%h表示目标主机，%p表示端口。</li>
<li><strong>ControlPersist yes</strong> 则可以让共享的连接持有处于连接状态。</li>
</ul>


<h2>常用的ControlPath</h2>

<p>下面包含开源中国，github，gitcafe等代码托管。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">ControlPath</span> <span class="sr">/tmp/</span><span class="n">git</span><span class="vi">@git</span><span class="o">.</span><span class="n">oschina</span><span class="o">.</span><span class="n">net</span><span class="p">:</span><span class="mi">22</span>
</span><span class='line'><span class="no">ControlPath</span> <span class="sr">/tmp/</span><span class="n">git</span><span class="vi">@github</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="mi">22</span>
</span><span class='line'><span class="no">ControlPath</span> <span class="sr">/tmp/</span><span class="n">git</span><span class="vi">@gitcafe</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="mi">22</span>
</span></code></pre></td></tr></table></div></figure>


<p>快来试一试吧，是不是提高了5倍！</p>

<p>注：由于网络的情况，结果可能略有不同。已经很快的但没有感觉改善的同学，可以继续读下去。</p>

<h2>还能更快</h2>

<p>还有一个能提高50倍的方法，不过对于一般开发者不是很常用，如需了解可以参考<a href="http://interrobeng.com/2013/08/25/speed-up-git-5x-to-50x/">Speed Up Git (5x to 50x)</a></p>

<h3>其他</h3>

<ul>
<li> <a href="http://www.amazon.cn/gp/product/1430218339/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=1430218339&linkCode=as2&tag=droidyue-23">成为Git大神很简单，读完这本书</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=1430218339" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[译文：理解Java中的弱引用]]></title>
    <link href="http://droidyue.com/blog/2014/10/12/understanding-weakreference-in-java/"/>
    <updated>2014-10-12T09:56:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/10/12/understanding-weakreference-in-java</id>
    <content type="html"><![CDATA[<p>不久之前，我面试了一些求职Java高级开发工程师的应聘者。我常常会面试他们说，“你能给我介绍一些Java中得弱引用吗？”，如果面试者这样说，“嗯，是不是垃圾回收有关的？”，我就会基本满意了，我并不期待回答是一篇诘究本末的论文描述。</p>

<p>然而事与愿违，我很吃惊的发现，在将近20多个有着平均5年开发经验和高学历背景的应聘者中，居然只有两个人知道弱引用的存在，但是在这两个人之中只有一个人真正了解这方面的知识。在面试过程中，我还尝试提示一些东西，来看看有没有人突然说一声“原来是这个啊”，结果很是让我失望。我开始困惑，为什么这块的知识如此不被重视，毕竟弱引用是一个很有用途的特性，况且这个特性已经在7年前 Java 1.2发布时便引入了。</p>

<!--more-->


<p>好吧，这里我不期待你看完本文之后成为一个弱引用方面的专家，但是我认为至少你应该了解什么是弱引用，如何使用它们，并且什么场景使用。既然它们是一些不知名的概念，我简单就着前面的三个问题来说明一下。</p>

<h2>强引用(Strong Reference)</h2>

<p>强引用就是我们经常使用的引用，其写法如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">StringBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuffer</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面创建了一个StringBuffer对象，并将这个对象的（强）引用存到变量buffer中。是的，就是这个小儿科的操作（请原谅我这样的说法）。强引用最重要的就是它能够让引用变得强（Strong），这就决定了它和垃圾回收器的交互。具体来说，如果一个对象通过一串强引用链接可到达(Strongly reachable)，它是不会被回收的。如果你不想让你正在使用的对象被回收，这就正是你所需要的。</p>

<h3>但是强引用如此之强</h3>

<p>在一个程序里，将一个类设置成不可被扩展是有点不太常见的，当然这个完全可以通过类标记成final实现。或者也可以更加复杂一些，就是通过内部包含了未知数量具体实现的工厂方法返回一个接口(Interface)。举个例子，我们想要使用一个叫做Widget的类，但是这个类不能被继承，所以无法增加新的功能。</p>

<p>但是我们如果想追踪Widget对象的额外信息，我们该怎么办？ 假设我们需要记录每个对象的序列号，但是由于Widget类并不包含这个属性，而且也不能扩展导致我们也不能增加这个属性。其实一点问题也没有，HashMap完全可以解决上述的问题。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">serialNumberMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">widget</span><span class="o">,</span> <span class="n">widgetSerialNumber</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>这表面看上去没有问题，但是widget对象的强引用很有可能会引发问题。我们可以确信当一个widget序列号不需要时，我们应该将这个条目从map中移除。如果我们没有移除的话，可能会导致内存泄露，亦或者我们手动移除时删除了我们正在使用的widgets，会导致有效数据的丢失。其实这些问题很类似，这就是没有垃圾回收机制的语言管理内存时常遇到的问题。但是我们不用去担心这个问题，因为我们使用的时具有垃圾回收机制的Java语言。</p>

<p>另一个强引用可能带来的问题就是缓存,尤其是像图片这样的大文件的缓存。假设你有一个程序需要处理用户提供的图片，通常的做法就是做图片数据缓存，因为从磁盘加载图片代价很大，并且同时我们也想避免在内存中同时存在两份一样的图片数据。</p>

<p>缓存被设计的目的就是避免我们去再次加载哪些不需要的文件。你会很快发现在缓存中会一直包含一个到已经指向内存中图片数据的引用。使用强引用会强制图片数据留在内存，这就需要你来决定什么时候图片数据不需要并且手动从缓存中移除，进而可以让垃圾回收器回收。因此你再一次被强制做垃圾回收器该做的工作，并且人为决定是该清理到哪一个对象。</p>

<h2>弱引用(Weak Reference)</h2>

<p>弱引用简单来说就是将对象留在内存的能力不是那么强的引用。使用WeakReference，垃圾回收器会帮你来决定引用的对象何时回收并且将对象从内存移除。创建弱引用如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">Widget</span><span class="o">&gt;</span> <span class="n">weakWidget</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">Widget</span><span class="o">&gt;(</span><span class="n">widget</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>使用weakWidget.get()就可以得到真实的Widget对象，因为弱引用不能阻挡垃圾回收器对其回收，你会发现（当没有任何强引用到widget对象时）使用get时突然返回null。</p>

<p>解决上述的widget序列数记录的问题，最简单的办法就是使用Java内置的WeakHashMap类。WeakHashMap和HashMap几乎一样，唯一的区别就是它的键（不是值!!!）使用WeakReference引用。当WeakHashMap的键标记为垃圾的时候，这个键对应的条目就会自动被移除。这就避免了上面不需要的Widget对象手动删除的问题。使用WeakHashMap可以很便捷地转为HashMap或者Map。</p>

<h3>引用队列(Reference Queue)</h3>

<p>一旦弱引用对象开始返回null，该弱引用指向的对象就被标记成了垃圾。而这个弱引用对象（非其指向的对象）就没有什么用了。通常这时候需要进行一些清理工作。比如WeakHashMap会在这时候移除没用的条目来避免保存无限制增长的没有意义的弱引用。</p>

<p>引用队列可以很容易地实现跟踪不需要的引用。当你在构造WeakReference时传入一个ReferenceQueue对象，当该引用指向的对象被标记为垃圾的时候，这个引用对象会自动地加入到引用队列里面。接下来，你就可以在固定的周期，处理传入的引用队列，比如做一些清理工作来处理这些没有用的引用对象。</p>

<h2>四种引用</h2>

<p>Java中实际上有四种强度不同的引用，从强到弱它们分别是，强引用，软引用，弱引用和虚引用。上面部分介绍了强引用和弱引用，下面介绍剩下的两个，软引用和虚引用。</p>

<h2>软引用（Soft Reference）</h2>

<p>软引用基本上和弱引用差不多，只是相比弱引用，它阻止垃圾回收期回收其指向的对象的能力强一些。如果一个对象是弱引用可到达，那么这个对象会被垃圾回收器接下来的回收周期销毁。但是如果是软引用可以到达，那么这个对象会停留在内存更时间上长一些。当内存不足时垃圾回收器才会回收这些软引用可到达的对象。</p>

<p>由于软引用可到达的对象比弱引用可达到的对象滞留内存时间会长一些，我们可以利用这个特性来做缓存。这样的话，你就可以节省了很多事情，垃圾回收器会关心当前哪种可到达类型以及内存的消耗程度来进行处理。</p>

<h2>虚引用 （Phantom Reference）</h2>

<p>与软引用，弱引用不同，虚引用指向的对象十分脆弱，我们不可以通过get方法来得到其指向的对象。它的唯一作用就是当其指向的对象被回收之后，自己被加入到引用队列，用作记录该引用指向的对象已被销毁。</p>

<p>当弱引用的指向对象变得弱引用可到达，该弱引用就会加入到引用队列。这一操作发生在对象析构或者垃圾回收真正发生之前。理论上，这个即将被回收的对象是可以在一个不符合规范的析构方法里面重新复活。但是这个弱引用会销毁。虚引用只有在其指向的对象从内存中移除掉之后才会加入到引用队列中。其get方法一直返回null就是为了阻止其指向的几乎被销毁的对象重新复活。</p>

<p>虚引用使用场景主要由两个。它允许你知道具体何时其引用的对象从内存中移除。而实际上这是Java中唯一的方式。这一点尤其表现在处理类似图片的大文件的情况。当你确定一个图片数据对象应该被回收，你可以利用虚引用来判断这个对象回收之后在继续加载下一张图片。这样可以尽可能地避免可怕的内存溢出错误。</p>

<p>第二点，虚引用可以避免很多析构时的问题。finalize方法可以通过创建强引用指向快被销毁的对象来让这些对象重新复活。然而，一个重写了finalize方法的对象如果想要被回收掉，需要经历两个单独的垃圾收集周期。在第一个周期中，某个对象被标记为可回收，进而才能进行析构。但是因为在析构过程中仍有微弱的可能这个对象会重新复活。这种情况下，在这个对象真实销毁之前，垃圾回收器需要再次运行。因为析构可能并不是很及时，所以在调用对象的析构之前，需要经历数量不确定的垃圾收集周期。这就意味着在真正清理掉这个对象的时候可能发生很大的延迟。这就是为什么当大部分堆被标记成垃圾时还是会出现烦人的内存溢出错误。</p>

<p>使用虚引用，上述情况将引刃而解，当一个虚引用加入到引用队列时，你绝对没有办法得到一个销毁了的对象。因为这时候，对象已经从内存中销毁了。因为虚引用不能被用作让其指向的对象重生，所以其对象会在垃圾回收的第一个周期就将被清理掉。</p>

<p>显而易见，finalize方法不建议被重写。因为虚引用明显地安全高效，去掉finalize方法可以虚拟机变得明显简单。当然你也可以去重写这个方法来实现更多。这完全看个人选择。</p>

<h2>总结</h2>

<p>我想看到这里，很多人开始发牢骚了，为什么你要讲一个过去十年的老古董API呢，好吧，以我的经验看，很多的Java程序员并不是很了解这个知识，我认为有一些深入的理解是很必要的，同时我希望大家能从本文中收获一些东西。</p>

<h2>原文信息</h2>

<ul>
<li>文章出自  <a href="https://weblogs.java.net/blog/enicholas/archive/2006/05/understanding_w.html">Understanding Weak References</a></li>
<li>作者为<a href="https://www.java.net/blogs/enicholas">Ethan Nicholas</a>，Yahoo! Publishing Tools team Leader，Yahoo! SiteBuilder Web程序的早期作者。</li>
</ul>


<h2>附注信息</h2>

<p>本文涉及到很多概念对于初次接触的人相对比较难以理解，建议结合英文原文进行研究。</p>

<h3>Java高阶推荐</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B00H1FXTNM/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00H1FXTNM&linkCode=as2&tag=droidyue-23">Java虚拟机规范(Java SE 7版)</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00H1FXTNM" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00IOB0K1Q/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00IOB0K1Q&linkCode=as2&tag=droidyue-23">图灵程序设计丛书:Java性能优化权威指南</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00IOB0K1Q" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00D2ID4PK/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00D2ID4PK&linkCode=as2&tag=droidyue-23">深入理解Java虚拟机:JVM高级特性与最佳实践(第2版)</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00D2ID4PK" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[腾讯云分析问题]]></title>
    <link href="http://droidyue.com/blog/2014/10/12/tencent-analytics-issues/"/>
    <updated>2014-10-12T09:47:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/10/12/tencent-analytics-issues</id>
    <content type="html"><![CDATA[<p>今天使用腾讯云分析按照给出的文档开始集成，遇到了一个问题。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>E/AndroidRuntime<span class="o">(</span> 4606<span class="o">)</span>: FATAL EXCEPTION: pool-1-thread-1
</span><span class='line'>E/AndroidRuntime<span class="o">(</span> 4606<span class="o">)</span>: java.lang.NoClassDefFoundError: com.tencent.mid.api.MidService
</span><span class='line'>E/AndroidRuntime<span class="o">(</span> 4606<span class="o">)</span>:    at com.tencent.stat.j.run<span class="o">(</span>Unknown Source<span class="o">)</span>
</span><span class='line'>E/AndroidRuntime<span class="o">(</span> 4606<span class="o">)</span>:    at java.util.concurrent.ThreadPoolExecutor.runWorker<span class="o">(</span>ThreadPoolExecutor.java:1076<span class="o">)</span>
</span><span class='line'>E/AndroidRuntime<span class="o">(</span> 4606<span class="o">)</span>:    at java.util.concurrent.ThreadPoolExecutor<span class="nv">$Worker</span>.run<span class="o">(</span>ThreadPoolExecutor.java:569<span class="o">)</span>
</span><span class='line'>E/AndroidRuntime<span class="o">(</span> 4606<span class="o">)</span>:    at java.lang.Thread.run<span class="o">(</span>Thread.java:864<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<!--more-->


<h2>原因</h2>

<p>其实原因就是腾讯云分析的文档严重过时了，解决方法就是<strong>在Build Path 除了加入mta-sdk-x.x.x.jar,还要加入mid-sdk-x.x.jar</strong>。</p>

<p>但是腾讯的文档只介绍说集成mta-sdk-x.x.x.jar，我想可能那是大概0.x版本SDK的教程吧。</p>

<h2>吐个槽吧</h2>

<h3>霸王条款</h3>

<p>据说想要知道应用宝的下载数据（下载次数）必须集成腾讯云分析。这是在扛KPI，还是一贯的本性呢？</p>

<h3>过时冗余的文档</h3>

<p>前面提到了文档的严重过时失效，而且其文档存在严重的冗余，据我所知有三处文档，SDK下载包中一份，帮助中心一份，应用管理页面一份。如此这样，一旦修改，成本还是比较大的。</p>

<h3>其他</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B00BSXRLR8/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00BSXRLR8&linkCode=as2&tag=droidyue-23">Android讲义哪家强</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00BSXRLR8" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00LVHTI9U/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00LVHTI9U&linkCode=as2&tag=droidyue-23">每个人的第一行代码</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00LVHTI9U" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B0052VL2WC/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B0052VL2WC&linkCode=as2&tag=droidyue-23">谁说菜鸟不会数据分析</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B0052VL2WC" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[众里寻他千百度，蓦然回首，招聘却在Console驻]]></title>
    <link href="http://droidyue.com/blog/2014/10/09/baidu-console-secret/"/>
    <updated>2014-10-09T21:40:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/10/09/baidu-console-secret</id>
    <content type="html"><![CDATA[<p>无意间发现了百度的一个彩蛋，感觉别出心裁，分享一下哈。</p>

<h2>操作</h2>

<ul>
<li> 使用Chrome（傲游等浏览器）打开<a href="http://www.baidu.com/">百度</a></li>
<li> 右键选择<strong>审查元素</strong></li>
<li> 切换到Console（控制台）标签</li>
</ul>


<h2>你就会发现</h2>

<!--more-->


<p>百度的招聘广告彩蛋出现了。快来试一试吧。
<img src="http://droidyueimg.qiniudn.com/baidu_console.png" title="baidu console secret 789 300" ></p>

<h3>其他</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B00COG458G/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00COG458G&linkCode=as2&tag=droidyue-23">设计师要懂心理学</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00COG458G" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B004I91HCY/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B004I91HCY&linkCode=as2&tag=droidyue-23">简约至上:交互式设计四策略</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B004I91HCY" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00ANS78KE/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00ANS78KE&linkCode=as2&tag=droidyue-23">在你身边,为你设计:腾讯的用户体验设计之道</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00ANS78KE" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[修改Linux系统时间的最简单方法]]></title>
    <link href="http://droidyue.com/blog/2014/10/03/modify-system-time-in-linux-or-mac/"/>
    <updated>2014-10-03T21:07:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/10/03/modify-system-time-in-linux-or-mac</id>
    <content type="html"><![CDATA[<p>在Linux桌面发行版提供了设置系统时间的界面程序，这个设置很简单，但是当你学会了下面的方法之后，你就开始厌烦用GUI界面设置了。</p>

<p>最简单的设置方法 就是创建一个符号链接/etc/localtime，其指向目标设置的时区城市代表（/usr/share/zoneinfo/ 目录下）</p>

<!--more-->


<p>比如我们想把机器的时区修改成亚洲的上海（东八区），我们按照下面操作就可以了。</p>

<p>其中s选项代表是符号链接，f选项代表强制删除目标。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo ln -sf /usr/share/zoneinfo/Asia/Shanghai  /etc/localtime
</span></code></pre></td></tr></table></div></figure>


<p>注意，Asia通常是没有Beijing的，可能没有上海国际化吧，所以如果是东八区就要用上海。</p>

<p>经测试，Mac机器上述命令也是生效的。</p>

<h3>其他</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B00BQTWC0U/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00BQTWC0U&linkCode=as2&tag=droidyue-23">Linux命令行大全</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00BQTWC0U" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00LF4UPWS/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00LF4UPWS&linkCode=as2&tag=droidyue-23">Linux就是这个范儿</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00LF4UPWS" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B003TJNO98/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B003TJNO98&linkCode=as2&tag=droidyue-23">鸟哥的Linux私房菜:基础学习篇</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B003TJNO98" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Android处理图像数据全记录]]></title>
    <link href="http://droidyue.com/blog/2014/10/03/handle-image-data-in-android/"/>
    <updated>2014-10-03T17:42:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/10/03/handle-image-data-in-android</id>
    <content type="html"><![CDATA[<p>Android中处理图像是一件很常见的事情，这里记录备忘一些亲身使用过的处理图片数据的方法。</p>

<h2>转为Bitmap</h2>

<!--more-->


<h3>RGB值转Bitmap</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">Bitmap</span> <span class="nf">createColorBitmap</span><span class="o">(</span><span class="n">String</span> <span class="n">rgb</span><span class="o">,</span> <span class="kt">int</span> <span class="n">width</span><span class="o">,</span> <span class="kt">int</span> <span class="n">height</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">Bitmap</span> <span class="n">bmp</span> <span class="o">=</span> <span class="n">Bitmap</span><span class="o">.</span><span class="na">createBitmap</span><span class="o">(</span><span class="n">width</span><span class="o">,</span> <span class="n">height</span><span class="o">,</span> <span class="n">Bitmap</span><span class="o">.</span><span class="na">Config</span><span class="o">.</span><span class="na">ARGB_8888</span><span class="o">);</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">color</span> <span class="o">=</span> <span class="n">Color</span><span class="o">.</span><span class="na">parseColor</span><span class="o">(</span><span class="n">rgb</span><span class="o">);</span>
</span><span class='line'>      <span class="n">bmp</span><span class="o">.</span><span class="na">eraseColor</span><span class="o">(</span><span class="n">color</span><span class="o">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">bmp</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//Usage</span>
</span><span class='line'><span class="n">Bitmap</span> <span class="n">bmp</span> <span class="o">=</span> <span class="n">createColorBitmap</span><span class="o">(</span><span class="s">&quot;#cce8cf&quot;</span><span class="o">,</span> <span class="mi">200</span><span class="o">,</span> <span class="mi">50</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Color值转Bitmap</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">Bitmap</span> <span class="nf">createColorBitmap</span><span class="o">(</span><span class="kt">int</span> <span class="n">color</span><span class="o">,</span> <span class="kt">int</span> <span class="n">width</span><span class="o">,</span> <span class="kt">int</span> <span class="n">height</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">Bitmap</span> <span class="n">bmp</span> <span class="o">=</span> <span class="n">Bitmap</span><span class="o">.</span><span class="na">createBitmap</span><span class="o">(</span><span class="n">width</span><span class="o">,</span> <span class="n">height</span><span class="o">,</span> <span class="n">Bitmap</span><span class="o">.</span><span class="na">Config</span><span class="o">.</span><span class="na">ARGB_8888</span><span class="o">);</span>
</span><span class='line'>  <span class="n">bmp</span><span class="o">.</span><span class="na">eraseColor</span><span class="o">(</span><span class="n">color</span><span class="o">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">bmp</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="c1">//Usage</span>
</span><span class='line'><span class="n">Bitmap</span> <span class="n">bmp</span> <span class="o">=</span> <span class="n">createColorBitmap</span><span class="o">(</span><span class="n">Color</span><span class="o">.</span><span class="na">BLUE</span><span class="o">,</span> <span class="mi">200</span><span class="o">,</span> <span class="mi">50</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>字节数组转Bitmap</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">Bitmap</span> <span class="nf">getBitmapFromByteArray</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">array</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">BitmapFactory</span><span class="o">.</span><span class="na">decodeByteArray</span><span class="o">(</span><span class="n">array</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">array</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>读取文件转Bitmap</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">Bitmap</span> <span class="nf">getBitmapFromFile</span><span class="o">(</span><span class="n">String</span> <span class="n">pathName</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">BitmapFactory</span><span class="o">.</span><span class="na">decodeFile</span><span class="o">(</span><span class="n">pathName</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>读取资源转Bitmap</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">Bitmap</span> <span class="nf">getBitmapFromResource</span><span class="o">(</span><span class="n">Resources</span> <span class="n">res</span><span class="o">,</span> <span class="kt">int</span> <span class="n">resId</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">BitmapFactory</span><span class="o">.</span><span class="na">decodeResource</span><span class="o">(</span><span class="n">res</span><span class="o">,</span> <span class="n">resId</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>输入流转Bitmap</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">Bitmap</span> <span class="nf">getBitmapFromStream</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">inputStream</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">BitmapFactory</span><span class="o">.</span><span class="na">decodeStream</span><span class="o">(</span><span class="n">inputStream</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Drawable转Bitmap</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Bitmap</span> <span class="n">icon</span> <span class="o">=</span> <span class="n">BitmapFactory</span><span class="o">.</span><span class="na">decodeResource</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getResources</span><span class="o">(),</span><span class="n">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">icon_resource</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>转为Drawable</h2>

<h3>资源转Drawable</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Drawable</span> <span class="n">drawable</span> <span class="o">=</span> <span class="n">getResources</span><span class="o">().</span><span class="na">getDrawable</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">ic_launcher</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Bitmap转Drawable</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Drawable</span> <span class="n">d</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BitmapDrawable</span><span class="o">(</span><span class="n">getResources</span><span class="o">(),</span><span class="n">bitmap</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>图片圆角展示</h2>

<p>通过对图片数据bitmap进行处理即可，其中pixels为边角的半径。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="n">Bitmap</span> <span class="nf">getRoundedCornerBitmap</span><span class="o">(</span><span class="n">Bitmap</span> <span class="n">bitmap</span><span class="o">,</span> <span class="kt">int</span> <span class="n">pixels</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Bitmap</span> <span class="n">output</span> <span class="o">=</span> <span class="n">Bitmap</span><span class="o">.</span><span class="na">createBitmap</span><span class="o">(</span><span class="n">bitmap</span><span class="o">.</span><span class="na">getWidth</span><span class="o">(),</span> <span class="n">bitmap</span>
</span><span class='line'>                <span class="o">.</span><span class="na">getHeight</span><span class="o">(),</span> <span class="n">Config</span><span class="o">.</span><span class="na">ARGB_8888</span><span class="o">);</span>
</span><span class='line'>        <span class="n">Canvas</span> <span class="n">canvas</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Canvas</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">color</span> <span class="o">=</span> <span class="mh">0xff424242</span><span class="o">;</span>
</span><span class='line'>        <span class="kd">final</span> <span class="n">Paint</span> <span class="n">paint</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Paint</span><span class="o">();</span>
</span><span class='line'>        <span class="kd">final</span> <span class="n">Rect</span> <span class="n">rect</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Rect</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">bitmap</span><span class="o">.</span><span class="na">getWidth</span><span class="o">(),</span> <span class="n">bitmap</span><span class="o">.</span><span class="na">getHeight</span><span class="o">());</span>
</span><span class='line'>        <span class="kd">final</span> <span class="n">RectF</span> <span class="n">rectF</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RectF</span><span class="o">(</span><span class="n">rect</span><span class="o">);</span>
</span><span class='line'>        <span class="kd">final</span> <span class="kt">float</span> <span class="n">roundPx</span> <span class="o">=</span> <span class="n">pixels</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">paint</span><span class="o">.</span><span class="na">setAntiAlias</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>        <span class="n">canvas</span><span class="o">.</span><span class="na">drawARGB</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</span><span class='line'>        <span class="n">paint</span><span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="n">color</span><span class="o">);</span>
</span><span class='line'>        <span class="n">canvas</span><span class="o">.</span><span class="na">drawRoundRect</span><span class="o">(</span><span class="n">rectF</span><span class="o">,</span> <span class="n">roundPx</span><span class="o">,</span> <span class="n">roundPx</span><span class="o">,</span> <span class="n">paint</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">paint</span><span class="o">.</span><span class="na">setXfermode</span><span class="o">(</span><span class="k">new</span> <span class="n">PorterDuffXfermode</span><span class="o">(</span><span class="n">Mode</span><span class="o">.</span><span class="na">SRC_IN</span><span class="o">));</span>
</span><span class='line'>        <span class="n">canvas</span><span class="o">.</span><span class="na">drawBitmap</span><span class="o">(</span><span class="n">bitmap</span><span class="o">,</span> <span class="n">rect</span><span class="o">,</span> <span class="n">rect</span><span class="o">,</span> <span class="n">paint</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">output</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>其他</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B00LVHTI9U/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00LVHTI9U&linkCode=as2&tag=droidyue-23">第一行代码:Android</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00LVHTI9U" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00J4DXWDG/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00J4DXWDG&linkCode=as2&tag=droidyue-23">Android编程权威指南</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00J4DXWDG" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00GU73RHA/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00GU73RHA&linkCode=as2&tag=droidyue-23">Android应用UI设计模式</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00GU73RHA" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[细话Java："失效"的private修饰符]]></title>
    <link href="http://droidyue.com/blog/2014/10/02/the-private-modifier-in-java/"/>
    <updated>2014-10-02T17:24:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/10/02/the-private-modifier-in-java</id>
    <content type="html"><![CDATA[<p>在Java编程中，使用private关键字修饰了某个成员，只有这个成员所在的类和这个类的方法可以使用，其他的类都无法访问到这个private成员。</p>

<p>上面描述了private修饰符的基本职能，今天来研究一下private功能失效的情况。</p>

<!--more-->


<h2>Java内部类</h2>

<p>在Java中相信很多人都用过内部类，Java允许在一个类里面定义另一个类，类里面的类就是内部类，也叫做嵌套类。一个简单的内部类实现可以如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">class</span> <span class="nc">OuterClass</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">class</span> <span class="nc">InnerClass</span><span class="o">{</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>今天的问题和Java内部类相关，只涉及到部分和本文研究相关的内部类知识，具体关于Java内部类后续的文章会介绍。</p>

<h2>第一次失效?</h2>

<p>一个我们在编程中经常用到的场景，就是在一个内部类里面访问外部类的private成员变量或者方法，这是可以的。如下面的代码实现。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OuterClass</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">language</span> <span class="o">=</span> <span class="s">&quot;en&quot;</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">region</span> <span class="o">=</span> <span class="s">&quot;US&quot;</span><span class="o">;</span>
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">InnerClass</span> <span class="o">{</span>
</span><span class='line'>      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">printOuterClassPrivateFields</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">String</span> <span class="n">fields</span> <span class="o">=</span> <span class="s">&quot;language=&quot;</span> <span class="o">+</span> <span class="n">language</span> <span class="o">+</span> <span class="s">&quot;;region=&quot;</span> <span class="o">+</span> <span class="n">region</span><span class="o">;</span>
</span><span class='line'>          <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">fields</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">OuterClass</span> <span class="n">outer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OuterClass</span><span class="o">();</span>
</span><span class='line'>      <span class="n">OuterClass</span><span class="o">.</span><span class="na">InnerClass</span> <span class="n">inner</span> <span class="o">=</span> <span class="n">outer</span><span class="o">.</span><span class="na">new</span> <span class="n">InnerClass</span><span class="o">();</span>
</span><span class='line'>      <span class="n">inner</span><span class="o">.</span><span class="na">printOuterClassPrivateFields</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这是为什么呢，不是private修饰的成员只能被成员所述的类才能访问么？难道private真的失效了么？</p>

<h3>编译器在捣鬼？</h3>

<p>我们使用javap命令查看一下生成的两个class文件</p>

<p> OuterClass的反编译结果</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="mi">15</span><span class="o">:</span><span class="mi">30</span> <span class="n">$</span> <span class="n">javap</span> <span class="o">-</span><span class="n">c</span>  <span class="n">OuterClass</span>
</span><span class='line'><span class="n">Compiled</span> <span class="n">from</span> <span class="s">&quot;OuterClass.java&quot;</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OuterClass</span> <span class="kd">extends</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span><span class="o">{</span>
</span><span class='line'><span class="kd">public</span> <span class="nf">OuterClass</span><span class="o">();</span>
</span><span class='line'>  <span class="nl">Code:</span>
</span><span class='line'>   <span class="mi">0</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">1</span><span class="o">:</span>  <span class="n">invokespecial</span>    <span class="err">#</span><span class="mi">11</span><span class="o">;</span> <span class="c1">//Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span>
</span><span class='line'>   <span class="mi">4</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">5</span><span class="o">:</span>  <span class="n">ldc</span>  <span class="err">#</span><span class="mi">13</span><span class="o">;</span> <span class="c1">//String en</span>
</span><span class='line'>   <span class="mi">7</span><span class="o">:</span>  <span class="n">putfield</span> <span class="err">#</span><span class="mi">15</span><span class="o">;</span> <span class="c1">//Field language:Ljava/lang/String;</span>
</span><span class='line'>   <span class="mi">10</span><span class="o">:</span> <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">11</span><span class="o">:</span> <span class="n">ldc</span>  <span class="err">#</span><span class="mi">17</span><span class="o">;</span> <span class="c1">//String US</span>
</span><span class='line'>   <span class="mi">13</span><span class="o">:</span> <span class="n">putfield</span> <span class="err">#</span><span class="mi">19</span><span class="o">;</span> <span class="c1">//Field region:Ljava/lang/String;</span>
</span><span class='line'>   <span class="mi">16</span><span class="o">:</span> <span class="k">return</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">[]);</span>
</span><span class='line'>  <span class="nl">Code:</span>
</span><span class='line'>   <span class="mi">0</span><span class="o">:</span>  <span class="k">new</span>  <span class="err">#</span><span class="mi">1</span><span class="o">;</span> <span class="c1">//class OuterClass</span>
</span><span class='line'>   <span class="mi">3</span><span class="o">:</span>  <span class="n">dup</span>
</span><span class='line'>   <span class="mi">4</span><span class="o">:</span>  <span class="n">invokespecial</span>    <span class="err">#</span><span class="mi">27</span><span class="o">;</span> <span class="c1">//Method &quot;&lt;init&gt;&quot;:()V</span>
</span><span class='line'>   <span class="mi">7</span><span class="o">:</span>  <span class="n">astore_1</span>
</span><span class='line'>   <span class="mi">8</span><span class="o">:</span>  <span class="k">new</span>  <span class="err">#</span><span class="mi">28</span><span class="o">;</span> <span class="c1">//class OuterClass$InnerClass</span>
</span><span class='line'>   <span class="mi">11</span><span class="o">:</span> <span class="n">dup</span>
</span><span class='line'>   <span class="mi">12</span><span class="o">:</span> <span class="n">aload_1</span>
</span><span class='line'>   <span class="mi">13</span><span class="o">:</span> <span class="n">dup</span>
</span><span class='line'>   <span class="mi">14</span><span class="o">:</span> <span class="n">invokevirtual</span>    <span class="err">#</span><span class="mi">30</span><span class="o">;</span> <span class="c1">//Method java/lang/Object.getClass:()Ljava/lang/Class;</span>
</span><span class='line'>   <span class="mi">17</span><span class="o">:</span> <span class="n">pop</span>
</span><span class='line'>   <span class="mi">18</span><span class="o">:</span> <span class="n">invokespecial</span>    <span class="err">#</span><span class="mi">34</span><span class="o">;</span> <span class="c1">//Method OuterClass$InnerClass.&quot;&lt;init&gt;&quot;:(LOuterClass;)V</span>
</span><span class='line'>   <span class="mi">21</span><span class="o">:</span> <span class="n">astore_2</span>
</span><span class='line'>   <span class="mi">22</span><span class="o">:</span> <span class="n">aload_2</span>
</span><span class='line'>   <span class="mi">23</span><span class="o">:</span> <span class="n">invokevirtual</span>    <span class="err">#</span><span class="mi">37</span><span class="o">;</span> <span class="c1">//Method OuterClass$InnerClass.printOuterClassPrivateFields:()V</span>
</span><span class='line'>   <span class="mi">26</span><span class="o">:</span> <span class="k">return</span>
</span><span class='line'>
</span><span class='line'><span class="kd">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">access$0</span><span class="o">(</span><span class="n">OuterClass</span><span class="o">);</span>
</span><span class='line'>  <span class="nl">Code:</span>
</span><span class='line'>   <span class="mi">0</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">1</span><span class="o">:</span>  <span class="n">getfield</span> <span class="err">#</span><span class="mi">15</span><span class="o">;</span> <span class="c1">//Field language:Ljava/lang/String;</span>
</span><span class='line'>   <span class="mi">4</span><span class="o">:</span>  <span class="n">areturn</span>
</span><span class='line'>
</span><span class='line'><span class="kd">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">access$1</span><span class="o">(</span><span class="n">OuterClass</span><span class="o">);</span>
</span><span class='line'>  <span class="nl">Code:</span>
</span><span class='line'>   <span class="mi">0</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">1</span><span class="o">:</span>  <span class="n">getfield</span> <span class="err">#</span><span class="mi">19</span><span class="o">;</span> <span class="c1">//Field region:Ljava/lang/String;</span>
</span><span class='line'>   <span class="mi">4</span><span class="o">:</span>  <span class="n">areturn</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>咦？不对，在OuterClass中我们并没有定义这两个方法</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">access$0</span><span class="o">(</span><span class="n">OuterClass</span><span class="o">);</span>
</span><span class='line'>  <span class="nl">Code:</span>
</span><span class='line'>   <span class="mi">0</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">1</span><span class="o">:</span>  <span class="n">getfield</span> <span class="err">#</span><span class="mi">15</span><span class="o">;</span> <span class="c1">//Field language:Ljava/lang/String;</span>
</span><span class='line'>   <span class="mi">4</span><span class="o">:</span>  <span class="n">areturn</span>
</span><span class='line'>
</span><span class='line'><span class="kd">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">access$1</span><span class="o">(</span><span class="n">OuterClass</span><span class="o">);</span>
</span><span class='line'>  <span class="nl">Code:</span>
</span><span class='line'>   <span class="mi">0</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">1</span><span class="o">:</span>  <span class="n">getfield</span> <span class="err">#</span><span class="mi">19</span><span class="o">;</span> <span class="c1">//Field region:Ljava/lang/String;</span>
</span><span class='line'>   <span class="mi">4</span><span class="o">:</span>  <span class="n">areturn</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>从给出来的注释来看，access$0返回outerClass的language属性；access$1返回outerClass的region属性。并且这两个方法都接受OuterClass的实例作为参数。这两个方法为什么生成呢，有什么作用呢？我们看一下内部类的反编译结果就知道了。</p>

<p><strong>OuterClass$InnerClass的反编译结果</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="mi">15</span><span class="o">:</span><span class="mi">37</span> <span class="n">$</span> <span class="n">javap</span> <span class="o">-</span><span class="n">c</span> <span class="n">OuterClass</span><span class="err">\</span><span class="n">$InnerClass</span>
</span><span class='line'><span class="n">Compiled</span> <span class="n">from</span> <span class="s">&quot;OuterClass.java&quot;</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OuterClass</span><span class="n">$InnerClass</span> <span class="kd">extends</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span><span class="o">{</span>
</span><span class='line'><span class="kd">final</span> <span class="n">OuterClass</span> <span class="k">this</span><span class="n">$0</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="n">OuterClass$InnerClass</span><span class="o">(</span><span class="n">OuterClass</span><span class="o">);</span>
</span><span class='line'>  <span class="nl">Code:</span>
</span><span class='line'>   <span class="mi">0</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">1</span><span class="o">:</span>  <span class="n">aload_1</span>
</span><span class='line'>   <span class="mi">2</span><span class="o">:</span>  <span class="n">putfield</span> <span class="err">#</span><span class="mi">10</span><span class="o">;</span> <span class="c1">//Field this$0:LOuterClass;</span>
</span><span class='line'>   <span class="mi">5</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">6</span><span class="o">:</span>  <span class="n">invokespecial</span>    <span class="err">#</span><span class="mi">12</span><span class="o">;</span> <span class="c1">//Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span>
</span><span class='line'>   <span class="mi">9</span><span class="o">:</span>  <span class="k">return</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">printOuterClassPrivateFields</span><span class="o">();</span>
</span><span class='line'>  <span class="nl">Code:</span>
</span><span class='line'>   <span class="mi">0</span><span class="o">:</span>  <span class="k">new</span>  <span class="err">#</span><span class="mi">20</span><span class="o">;</span> <span class="c1">//class java/lang/StringBuilder</span>
</span><span class='line'>   <span class="mi">3</span><span class="o">:</span>  <span class="n">dup</span>
</span><span class='line'>   <span class="mi">4</span><span class="o">:</span>  <span class="n">ldc</span>  <span class="err">#</span><span class="mi">22</span><span class="o">;</span> <span class="c1">//String language=</span>
</span><span class='line'>   <span class="mi">6</span><span class="o">:</span>  <span class="n">invokespecial</span>    <span class="err">#</span><span class="mi">24</span><span class="o">;</span> <span class="c1">//Method java/lang/StringBuilder.&quot;&lt;init&gt;&quot;:(Ljava/lang/String;)V</span>
</span><span class='line'>   <span class="mi">9</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">10</span><span class="o">:</span> <span class="n">getfield</span> <span class="err">#</span><span class="mi">10</span><span class="o">;</span> <span class="c1">//Field this$0:LOuterClass;</span>
</span><span class='line'>   <span class="mi">13</span><span class="o">:</span> <span class="n">invokestatic</span> <span class="err">#</span><span class="mi">27</span><span class="o">;</span> <span class="c1">//Method OuterClass.access$0:(LOuterClass;)Ljava/lang/String;</span>
</span><span class='line'>   <span class="mi">16</span><span class="o">:</span> <span class="n">invokevirtual</span>    <span class="err">#</span><span class="mi">33</span><span class="o">;</span> <span class="c1">//Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span>
</span><span class='line'>   <span class="mi">19</span><span class="o">:</span> <span class="n">ldc</span>  <span class="err">#</span><span class="mi">37</span><span class="o">;</span> <span class="c1">//String ;region=</span>
</span><span class='line'>   <span class="mi">21</span><span class="o">:</span> <span class="n">invokevirtual</span>    <span class="err">#</span><span class="mi">33</span><span class="o">;</span> <span class="c1">//Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span>
</span><span class='line'>   <span class="mi">24</span><span class="o">:</span> <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">25</span><span class="o">:</span> <span class="n">getfield</span> <span class="err">#</span><span class="mi">10</span><span class="o">;</span> <span class="c1">//Field this$0:LOuterClass;</span>
</span><span class='line'>   <span class="mi">28</span><span class="o">:</span> <span class="n">invokestatic</span> <span class="err">#</span><span class="mi">39</span><span class="o">;</span> <span class="c1">//Method OuterClass.access$1:(LOuterClass;)Ljava/lang/String;</span>
</span><span class='line'>   <span class="mi">31</span><span class="o">:</span> <span class="n">invokevirtual</span>    <span class="err">#</span><span class="mi">33</span><span class="o">;</span> <span class="c1">//Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span>
</span><span class='line'>   <span class="mi">34</span><span class="o">:</span> <span class="n">invokevirtual</span>    <span class="err">#</span><span class="mi">42</span><span class="o">;</span> <span class="c1">//Method java/lang/StringBuilder.toString:()Ljava/lang/String;</span>
</span><span class='line'>   <span class="mi">37</span><span class="o">:</span> <span class="n">astore_1</span>
</span><span class='line'>   <span class="mi">38</span><span class="o">:</span> <span class="n">getstatic</span>    <span class="err">#</span><span class="mi">46</span><span class="o">;</span> <span class="c1">//Field java/lang/System.out:Ljava/io/PrintStream;</span>
</span><span class='line'>   <span class="mi">41</span><span class="o">:</span> <span class="n">aload_1</span>
</span><span class='line'>   <span class="mi">42</span><span class="o">:</span> <span class="n">invokevirtual</span>    <span class="err">#</span><span class="mi">52</span><span class="o">;</span> <span class="c1">//Method java/io/PrintStream.println:(Ljava/lang/String;)V</span>
</span><span class='line'>   <span class="mi">45</span><span class="o">:</span> <span class="k">return</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>下面代码调用access$0的代码,其目的是得到OuterClass的language 私有属性。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="mi">13</span><span class="o">:</span>   <span class="n">invokestatic</span> <span class="err">#</span><span class="mi">27</span><span class="o">;</span> <span class="c1">//Method OuterClass.access$0:(LOuterClass;)Ljava/lang/String;</span>
</span></code></pre></td></tr></table></div></figure>


<p>下面代码调用了access$1的代码，其目的是得到OutherClass的region 私有属性。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="mi">28</span><span class="o">:</span>   <span class="n">invokestatic</span> <span class="err">#</span><span class="mi">39</span><span class="o">;</span> <span class="c1">//Method OuterClass.access$1:(LOuterClass;)Ljava/lang/String;</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>注意：在内部类构造的时候，会将外部类的引用传递进来，并且作为内部类的一个属性，所以内部类会持有一个其外部类的引用。</strong><br/>
this$0就是内部类持有的外部类引用，通过构造方法传递引用并赋值。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">final</span> <span class="n">OuterClass</span> <span class="k">this</span><span class="n">$0</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="n">OuterClass$InnerClass</span><span class="o">(</span><span class="n">OuterClass</span><span class="o">);</span>
</span><span class='line'>  <span class="nl">Code:</span>
</span><span class='line'>   <span class="mi">0</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">1</span><span class="o">:</span>  <span class="n">aload_1</span>
</span><span class='line'>   <span class="mi">2</span><span class="o">:</span>  <span class="n">putfield</span> <span class="err">#</span><span class="mi">10</span><span class="o">;</span> <span class="c1">//Field this$0:LOuterClass;</span>
</span><span class='line'>   <span class="mi">5</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">6</span><span class="o">:</span>  <span class="n">invokespecial</span>    <span class="err">#</span><span class="mi">12</span><span class="o">;</span> <span class="c1">//Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span>
</span><span class='line'>   <span class="mi">9</span><span class="o">:</span>  <span class="k">return</span>
</span></code></pre></td></tr></table></div></figure>


<h3>小结</h3>

<p>这部分private看上去失效可，实际上并没有失效，因为当内部类调用外部类的私有属性时，其真正的执行是调用了编译器生成的属性的静态方法（即acess$0,access$1等）来获取这些属性值。这一切都是编译器的特殊处理。</p>

<h2>这次也失效？</h2>

<p>如果说上面的写法很常用，那么这样的写法是不是很少接触，但是却可以运行。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnotherOuterClass</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">InnerClass</span> <span class="n">inner</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnotherOuterClass</span><span class="o">().</span><span class="na">new</span> <span class="n">InnerClass</span><span class="o">();</span>
</span><span class='line'>      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;InnerClass Filed = &quot;</span> <span class="o">+</span> <span class="n">inner</span><span class="o">.</span><span class="na">x</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">class</span> <span class="nc">InnerClass</span> <span class="o">{</span>
</span><span class='line'>      <span class="kd">private</span> <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>和上面一样，使用javap反编译看一下。不过这次我们先看一下InnerClass的结果</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="mi">16</span><span class="o">:</span><span class="mi">03</span> <span class="n">$</span> <span class="n">javap</span> <span class="o">-</span><span class="n">c</span> <span class="n">AnotherOuterClass</span><span class="err">\</span><span class="n">$InnerClass</span>
</span><span class='line'><span class="n">Compiled</span> <span class="n">from</span> <span class="s">&quot;AnotherOuterClass.java&quot;</span>
</span><span class='line'><span class="kd">class</span> <span class="nc">AnotherOuterClass</span><span class="n">$InnerClass</span> <span class="kd">extends</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span><span class="o">{</span>
</span><span class='line'><span class="kd">final</span> <span class="n">AnotherOuterClass</span> <span class="k">this</span><span class="n">$0</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">AnotherOuterClass$InnerClass</span><span class="o">(</span><span class="n">AnotherOuterClass</span><span class="o">);</span>
</span><span class='line'>  <span class="nl">Code:</span>
</span><span class='line'>   <span class="mi">0</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">1</span><span class="o">:</span>  <span class="n">aload_1</span>
</span><span class='line'>   <span class="mi">2</span><span class="o">:</span>  <span class="n">putfield</span> <span class="err">#</span><span class="mi">12</span><span class="o">;</span> <span class="c1">//Field this$0:LAnotherOuterClass;</span>
</span><span class='line'>   <span class="mi">5</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">6</span><span class="o">:</span>  <span class="n">invokespecial</span>    <span class="err">#</span><span class="mi">14</span><span class="o">;</span> <span class="c1">//Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span>
</span><span class='line'>   <span class="mi">9</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">10</span><span class="o">:</span> <span class="n">bipush</span>   <span class="mi">10</span>
</span><span class='line'>   <span class="mi">12</span><span class="o">:</span> <span class="n">putfield</span> <span class="err">#</span><span class="mi">17</span><span class="o">;</span> <span class="c1">//Field x:I</span>
</span><span class='line'>   <span class="mi">15</span><span class="o">:</span> <span class="k">return</span>
</span><span class='line'>
</span><span class='line'><span class="kd">static</span> <span class="kt">int</span> <span class="n">access$0</span><span class="o">(</span><span class="n">AnotherOuterClass$InnerClass</span><span class="o">);</span>
</span><span class='line'>  <span class="nl">Code:</span>
</span><span class='line'>   <span class="mi">0</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">1</span><span class="o">:</span>  <span class="n">getfield</span> <span class="err">#</span><span class="mi">17</span><span class="o">;</span> <span class="c1">//Field x:I</span>
</span><span class='line'>   <span class="mi">4</span><span class="o">:</span>  <span class="n">ireturn</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>又出现了，编译器又自动生成了一个获取私有属性的后门方法access$0一次来获取x的值。</p>

<p>AnotherOuterClass.class的反编译结果</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="mi">16</span><span class="o">:</span><span class="mi">08</span> <span class="n">$</span> <span class="n">javap</span> <span class="o">-</span><span class="n">c</span> <span class="n">AnotherOuterClass</span>
</span><span class='line'><span class="n">Compiled</span> <span class="n">from</span> <span class="s">&quot;AnotherOuterClass.java&quot;</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnotherOuterClass</span> <span class="kd">extends</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span><span class="o">{</span>
</span><span class='line'><span class="kd">public</span> <span class="nf">AnotherOuterClass</span><span class="o">();</span>
</span><span class='line'>  <span class="nl">Code:</span>
</span><span class='line'>   <span class="mi">0</span><span class="o">:</span>  <span class="n">aload_0</span>
</span><span class='line'>   <span class="mi">1</span><span class="o">:</span>  <span class="n">invokespecial</span>    <span class="err">#</span><span class="mi">8</span><span class="o">;</span> <span class="c1">//Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span>
</span><span class='line'>   <span class="mi">4</span><span class="o">:</span>  <span class="k">return</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">[]);</span>
</span><span class='line'>  <span class="nl">Code:</span>
</span><span class='line'>   <span class="mi">0</span><span class="o">:</span>  <span class="k">new</span>  <span class="err">#</span><span class="mi">16</span><span class="o">;</span> <span class="c1">//class AnotherOuterClass$InnerClass</span>
</span><span class='line'>   <span class="mi">3</span><span class="o">:</span>  <span class="n">dup</span>
</span><span class='line'>   <span class="mi">4</span><span class="o">:</span>  <span class="k">new</span>  <span class="err">#</span><span class="mi">1</span><span class="o">;</span> <span class="c1">//class AnotherOuterClass</span>
</span><span class='line'>   <span class="mi">7</span><span class="o">:</span>  <span class="n">dup</span>
</span><span class='line'>   <span class="mi">8</span><span class="o">:</span>  <span class="n">invokespecial</span>    <span class="err">#</span><span class="mi">18</span><span class="o">;</span> <span class="c1">//Method &quot;&lt;init&gt;&quot;:()V</span>
</span><span class='line'>   <span class="mi">11</span><span class="o">:</span> <span class="n">dup</span>
</span><span class='line'>   <span class="mi">12</span><span class="o">:</span> <span class="n">invokevirtual</span>    <span class="err">#</span><span class="mi">19</span><span class="o">;</span> <span class="c1">//Method java/lang/Object.getClass:()Ljava/lang/Class;</span>
</span><span class='line'>   <span class="mi">15</span><span class="o">:</span> <span class="n">pop</span>
</span><span class='line'>   <span class="mi">16</span><span class="o">:</span> <span class="n">invokespecial</span>    <span class="err">#</span><span class="mi">23</span><span class="o">;</span> <span class="c1">//Method AnotherOuterClass$InnerClass.&quot;&lt;init&gt;&quot;:(LAnotherOuterClass;)V</span>
</span><span class='line'>   <span class="mi">19</span><span class="o">:</span> <span class="n">astore_1</span>
</span><span class='line'>   <span class="mi">20</span><span class="o">:</span> <span class="n">getstatic</span>    <span class="err">#</span><span class="mi">26</span><span class="o">;</span> <span class="c1">//Field java/lang/System.out:Ljava/io/PrintStream;</span>
</span><span class='line'>   <span class="mi">23</span><span class="o">:</span> <span class="k">new</span>  <span class="err">#</span><span class="mi">32</span><span class="o">;</span> <span class="c1">//class java/lang/StringBuilder</span>
</span><span class='line'>   <span class="mi">26</span><span class="o">:</span> <span class="n">dup</span>
</span><span class='line'>   <span class="mi">27</span><span class="o">:</span> <span class="n">ldc</span>  <span class="err">#</span><span class="mi">34</span><span class="o">;</span> <span class="c1">//String InnerClass Filed =</span>
</span><span class='line'>   <span class="mi">29</span><span class="o">:</span> <span class="n">invokespecial</span>    <span class="err">#</span><span class="mi">36</span><span class="o">;</span> <span class="c1">//Method java/lang/StringBuilder.&quot;&lt;init&gt;&quot;:(Ljava/lang/String;)V</span>
</span><span class='line'>   <span class="mi">32</span><span class="o">:</span> <span class="n">aload_1</span>
</span><span class='line'>   <span class="mi">33</span><span class="o">:</span> <span class="n">invokestatic</span> <span class="err">#</span><span class="mi">39</span><span class="o">;</span> <span class="c1">//Method AnotherOuterClass$InnerClass.access$0:(LAnotherOuterClass$InnerClass;)I</span>
</span><span class='line'>   <span class="mi">36</span><span class="o">:</span> <span class="n">invokevirtual</span>    <span class="err">#</span><span class="mi">43</span><span class="o">;</span> <span class="c1">//Method java/lang/StringBuilder.append:(I)Ljava/lang/StringBuilder;</span>
</span><span class='line'>   <span class="mi">39</span><span class="o">:</span> <span class="n">invokevirtual</span>    <span class="err">#</span><span class="mi">47</span><span class="o">;</span> <span class="c1">//Method java/lang/StringBuilder.toString:()Ljava/lang/String;</span>
</span><span class='line'>   <span class="mi">42</span><span class="o">:</span> <span class="n">invokevirtual</span>    <span class="err">#</span><span class="mi">51</span><span class="o">;</span> <span class="c1">//Method java/io/PrintStream.println:(Ljava/lang/String;)V</span>
</span><span class='line'>   <span class="mi">45</span><span class="o">:</span> <span class="k">return</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中这句调用就是外部类通过内部类的实例获取私有属性x的操作</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="mi">33</span><span class="o">:</span>   <span class="n">invokestatic</span> <span class="err">#</span><span class="mi">39</span><span class="o">;</span> <span class="c1">//Method AnotherOuterClass$InnerClass.access$0:(LAnotherOuterClass$InnerClass;)I</span>
</span></code></pre></td></tr></table></div></figure>


<h3>再来个总结</h3>

<p>其中<a href="http://docs.oracle.com/javase/specs/jls/se7/html/jls-6.html#jls-6.6.1">java官方文档</a> 有这样一句话</p>

<blockquote><p>if the member or constructor is declared private, then access is permitted if and only if it occurs within the body of the top level class (§7.6) that encloses the declaration of the member or constructor.</p></blockquote>

<p>意思是 如果（内部类的）成员和构造方法设定成了私有修饰符，当且仅当其外部类访问时是允许的。</p>

<h2>如何让内部类私有成员不被外部访问</h2>

<p>相信看完上面两部分，你会觉得，内部类的私有成员想不被外部类访问都很困难吧，谁让编译器“爱管闲事”呢，其实也是可以做到的。那就是使用匿名内部类。</p>

<p>由于mRunnable对象的类型为Runnable，而不是匿名内部类的类型（我们无法正常拿到），而Runanble中没有x这个属性，所以mRunnable.x是不被允许的。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PrivateToOuter</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">Runnable</span> <span class="n">mRunnable</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">(){</span>
</span><span class='line'>      <span class="kd">private</span> <span class="kt">int</span> <span class="n">x</span><span class="o">=</span><span class="mi">10</span><span class="o">;</span>
</span><span class='line'>      <span class="nd">@Override</span>
</span><span class='line'>      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
</span><span class='line'>      <span class="n">PrivateToOuter</span> <span class="n">p</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrivateToOuter</span><span class="o">();</span>
</span><span class='line'>      <span class="c1">//System.out.println(&quot;anonymous class private filed= &quot;+ p.mRunnable.x); //not allowed</span>
</span><span class='line'>      <span class="n">p</span><span class="o">.</span><span class="na">mRunnable</span><span class="o">.</span><span class="na">run</span><span class="o">();</span> <span class="c1">// allowed</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>最后总结</h2>

<ul>
<li>在本文中，private表面上看上去失效了，但实际上是没有的，而是在调用时通过间接的方法来获取私有的属性。</li>
<li>Java的内部类构造时持有对外部类的应用，C++不会，这一点和C++不一样。</li>
</ul>


<h3>深入Java细节的书籍</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B0011F7WU4/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B0011F7WU4&linkCode=as2&tag=droidyue-23">Java编程思想</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B0011F7WU4" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B001PTGR52/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B001PTGR52&linkCode=as2&tag=droidyue-23">Sun 公司核心技术丛书:Effective Java中文版</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B001PTGR52" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00D2ID4PK/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00D2ID4PK&linkCode=as2&tag=droidyue-23">深入理解Java虚拟机:JVM高级特性与最佳实践</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00D2ID4PK" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[WebView处理网页位置请求]]></title>
    <link href="http://droidyue.com/blog/2014/10/01/handle-geolocation-request-in-webview/"/>
    <updated>2014-10-01T17:23:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/10/01/handle-geolocation-request-in-webview</id>
    <content type="html"><![CDATA[<p>随着移动设备的激增，LBS（Location Based Service）已然成为趋势，其最关键的还是获取设备的位置信息。native代码获取位置信息轻轻松松可以搞定，实际上网页获取位置信息也不是那么困难。</p>

<p>在HTML5中，提供了一套定位用户信息的接口，当然这个位置信息是通过客户端，准确说是浏览器获取的。</p>

<!--more-->


<p>注意，位置信息属于个人隐私的范围，只有经过用户同意之后才能获取到信息。</p>

<h2>网页如何实现请求位置信息</h2>

<p>使用getCurrentPosition()方法来请求位置信息。<br/>
下面是一个很简单的示例，来展示用户位置信息的经度和纬度。</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'>    <span class="nt">&lt;body&gt;</span>
</span><span class='line'>  <span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">&quot;demo&quot;</span><span class="nt">&gt;</span>Click the button to get your coordinates:<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>  <span class="nt">&lt;button</span> <span class="na">onclick=</span><span class="s">&quot;getLocation()&quot;</span><span class="nt">&gt;</span>Try It<span class="nt">&lt;/button&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;script&gt;</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;demo&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">function</span> <span class="nx">getLocation</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">&quot;getLocation working&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">geolocation</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="nx">navigator</span><span class="p">.</span><span class="nx">geolocation</span><span class="p">.</span><span class="nx">getCurrentPosition</span><span class="p">(</span><span class="nx">showPosition</span><span class="p">,</span><span class="nx">showError</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>              <span class="nx">x</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;Geolocation is not supported by this browser.&quot;</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">function</span> <span class="nx">showPosition</span><span class="p">(</span><span class="nx">position</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">x</span><span class="p">.</span><span class="nx">innerHTML</span><span class="o">=</span><span class="s2">&quot;Latitude: &quot;</span> <span class="o">+</span> <span class="nx">position</span><span class="p">.</span><span class="nx">coords</span><span class="p">.</span><span class="nx">latitude</span> <span class="o">+</span> <span class="s2">&quot;&lt;br&gt;Longitude: &quot;</span> <span class="o">+</span> <span class="nx">position</span><span class="p">.</span><span class="nx">coords</span><span class="p">.</span><span class="nx">longitude</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      
</span><span class='line'>      <span class="kd">function</span> <span class="nx">showError</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">switch</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">case</span> <span class="nx">error</span><span class="p">.</span><span class="nx">PERMISSION_DENIED</span><span class="o">:</span>
</span><span class='line'>              <span class="nx">x</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;User denied the request for Geolocation.&quot;</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="nx">error</span><span class="p">.</span><span class="nx">POSITION_UNAVAILABLE</span><span class="o">:</span>
</span><span class='line'>              <span class="nx">x</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;Location information is unavailable.&quot;</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="nx">error</span><span class="p">.</span><span class="nx">TIMEOUT</span><span class="o">:</span>
</span><span class='line'>              <span class="nx">x</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;The request to get user location timed out.&quot;</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="nx">error</span><span class="p">.</span><span class="nx">UNKNOWN_ERROR</span><span class="o">:</span>
</span><span class='line'>              <span class="nx">x</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;An unknown error occurred.&quot;</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>    <span class="nt">&lt;/script&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>示例阐述</h3>

<ul>
<li> 检测getLocation方法是否可用</li>
<li> 如果可以调用getCurrentPosition方法，否则提示浏览器不支持</li>
<li> 如果getCurrentPosition获取信息成功，返回一个坐标系的对象，并将这个对象作为参数传递到showPosition方法,如果失败，调用showError方法，并将错误码作为showError方法的参数。</li>
<li> showPosition方法展示经度和纬度信息</li>
<li> showError方法用来处理请求错误</li>
</ul>


<p>上述部分参考自<a href="http://www.w3schools.com/HTML/html5_geolocation.asp">html5_geolocation w3cschool</a>，更多高级操作请访问左侧链接。</p>

<h2>WebView如何返回给网页</h2>

<h3>大致操作步骤</h3>

<ul>
<li>在manifest中申请android.permission.ACCESS_FINE_LOCATION 或 android.permission.ACCESS_COARSE_LOCATION 权限。两者都有更好。</li>
<li>设置webivew开启javascript功能，地理定位功能，设置物理定位数据库路径</li>
<li>在onGeolocationPermissionsShowPrompt处理物理位置请求，常用的是提示用户，让用户决定是否允许。</li>
</ul>


<h3>使用的API</h3>

<ul>
<li>android.permission.ACCESS_FINE_LOCATION 通过GPS，基站，Wifi等获取<strong>精确的</strong>位置信息。</li>
<li>android.permission.ACCESS_COARSE_LOCATION 通过基站，Wifi等获取<strong>错略的</strong>位置信息。</li>
<li>onGeolocationPermissionsShowPrompt 位置信息请求回调，通常在这里弹出选择是否赋予权限的对话框</li>
<li>GeolocationPermissions.Callback.invoke(String origin, boolean allow, boolean remember)决定是否真正提供给网页信息，可根据用户的选择结果选择处理。

<h3>实现代码</h3></li>
</ul>


<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">final</span> <span class="n">WebView</span> <span class="n">webView</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WebView</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span><span class='line'><span class="n">addContentView</span><span class="o">(</span><span class="n">webView</span><span class="o">,</span>  <span class="k">new</span> <span class="n">LayoutParams</span><span class="o">(</span><span class="n">LayoutParams</span><span class="o">.</span><span class="na">MATCH_PARENT</span><span class="o">,</span> <span class="n">LayoutParams</span><span class="o">.</span><span class="na">MATCH_PARENT</span><span class="o">)</span>  <span class="o">);</span>
</span><span class='line'><span class="n">WebSettings</span> <span class="n">settings</span> <span class="o">=</span> <span class="n">webView</span><span class="o">.</span><span class="na">getSettings</span><span class="o">();</span>
</span><span class='line'><span class="n">settings</span><span class="o">.</span><span class="na">setJavaScriptEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'><span class="n">settings</span><span class="o">.</span><span class="na">setGeolocationEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'><span class="n">settings</span><span class="o">.</span><span class="na">setGeolocationDatabasePath</span><span class="o">(</span><span class="n">getFilesDir</span><span class="o">().</span><span class="na">getPath</span><span class="o">());</span>
</span><span class='line'>      
</span><span class='line'><span class="n">webView</span><span class="o">.</span><span class="na">setWebChromeClient</span><span class="o">(</span><span class="k">new</span> <span class="n">WebChromeClient</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onGeolocationPermissionsHidePrompt</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="kd">super</span><span class="o">.</span><span class="na">onGeolocationPermissionsHidePrompt</span><span class="o">();</span>
</span><span class='line'>      <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">LOGTAG</span><span class="o">,</span> <span class="s">&quot;onGeolocationPermissionsHidePrompt&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onGeolocationPermissionsShowPrompt</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">origin</span><span class="o">,</span>
</span><span class='line'>                  <span class="kd">final</span> <span class="n">Callback</span> <span class="n">callback</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">AlertDialog</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AlertDialog</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">MainActivity</span><span class="o">.</span><span class="na">this</span><span class="o">);</span>
</span><span class='line'>      <span class="n">builder</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="s">&quot;Allow to access location information?&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="n">OnClickListener</span> <span class="n">dialogButtonOnClickListener</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OnClickListener</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>          <span class="nd">@Override</span>
</span><span class='line'>          <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="n">DialogInterface</span> <span class="n">dialog</span><span class="o">,</span> <span class="kt">int</span> <span class="n">clickedButton</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="k">if</span> <span class="o">(</span><span class="n">DialogInterface</span><span class="o">.</span><span class="na">BUTTON_POSITIVE</span> <span class="o">==</span> <span class="n">clickedButton</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                  <span class="n">callback</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">origin</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span><span class='line'>              <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">DialogInterface</span><span class="o">.</span><span class="na">BUTTON_NEGATIVE</span> <span class="o">==</span> <span class="n">clickedButton</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                  <span class="n">callback</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">origin</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>              <span class="o">}</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>      <span class="o">};</span>
</span><span class='line'>      <span class="n">builder</span><span class="o">.</span><span class="na">setPositiveButton</span><span class="o">(</span><span class="s">&quot;Allow&quot;</span><span class="o">,</span> <span class="n">dialogButtonOnClickListener</span><span class="o">);</span>
</span><span class='line'>      <span class="n">builder</span><span class="o">.</span><span class="na">setNegativeButton</span><span class="o">(</span><span class="s">&quot;Deny&quot;</span><span class="o">,</span> <span class="n">dialogButtonOnClickListener</span><span class="o">);</span>
</span><span class='line'>      <span class="n">builder</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
</span><span class='line'>      <span class="kd">super</span><span class="o">.</span><span class="na">onGeolocationPermissionsShowPrompt</span><span class="o">(</span><span class="n">origin</span><span class="o">,</span> <span class="n">callback</span><span class="o">);</span>
</span><span class='line'>      <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">LOGTAG</span><span class="o">,</span> <span class="s">&quot;onGeolocationPermissionsShowPrompt&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">});</span>
</span><span class='line'><span class="n">webView</span><span class="o">.</span><span class="na">loadUrl</span><span class="o">(</span><span class="s">&quot;file:///android_asset/geolocation.html&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>疑问解答</h2>

<h3>I/SqliteDatabaseCpp(21863): sqlite returned: error code = 14</h3>

<p>原因是你没有设置setGeolocationDatabasePath，按照上面例子设置即可。</p>

<h3>点击之后没有任何变化</h3>

<ul>
<li>检查代码是否按照上面一样，是否有错误。</li>
<li>在第一次请求的是否，需要的反应时间比较长。</li>
</ul>


<h3>检测定位服务是否可用</h3>

<p>当GPS_PROVIDER和NETWORK_PROVIDER有一者可用，定位服务就可以用，当两者都不能用时，即定位服务不可以用。<br/>
注意PASSIVE_PROVIDER不能作为定位服务可用的标志。因为这个provider只会返回其他Provider提供的位置信息，自己无法定位。</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">testGeolocationOK</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">LocationManager</span> <span class="n">manager</span> <span class="o">=</span> <span class="o">(</span><span class="n">LocationManager</span><span class="o">)</span><span class="n">getSystemService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">LOCATION_SERVICE</span><span class="o">);</span>
</span><span class='line'>      <span class="kt">boolean</span> <span class="n">gpsProviderOK</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="na">isProviderEnabled</span><span class="o">(</span><span class="n">LocationManager</span><span class="o">.</span><span class="na">GPS_PROVIDER</span><span class="o">);</span>
</span><span class='line'>      <span class="kt">boolean</span> <span class="n">networkProviderOK</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="na">isProviderEnabled</span><span class="o">(</span><span class="n">LocationManager</span><span class="o">.</span><span class="na">NETWORK_PROVIDER</span><span class="o">);</span>
</span><span class='line'>      <span class="kt">boolean</span> <span class="n">geolocationOK</span> <span class="o">=</span> <span class="n">gpsProviderOK</span> <span class="o">&amp;&amp;</span> <span class="n">networkProviderOK</span><span class="o">;</span>
</span><span class='line'>      <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">LOGTAG</span><span class="o">,</span> <span class="s">&quot;gpsProviderOK = &quot;</span> <span class="o">+</span> <span class="n">gpsProviderOK</span> <span class="o">+</span> <span class="s">&quot;; networkProviderOK = &quot;</span> <span class="o">+</span> <span class="n">networkProviderOK</span> <span class="o">+</span> <span class="s">&quot;; geoLocationOK=&quot;</span> <span class="o">+</span> <span class="n">geolocationOK</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>跳转到位置设置界面</h3>

<p>我们只需要发送一个简单的隐式intent即可启动位置设置界面</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">Settings</span><span class="o">.</span><span class="na">ACTION_LOCATION_SOURCE_SETTINGS</span><span class="o">);</span>
</span><span class='line'><span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>示例代码</h2>

<p><a href="http://pan.baidu.com/s/1gdrHIin">百度云盘</a></p>

<h3>其他</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B007RSKTXQ/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B007RSKTXQ&linkCode=as2&tag=droidyue-23">程序员装B必备：黑轴机械键盘</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B007RSKTXQ" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00E7XVAZA/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00E7XVAZA&linkCode=as2&tag=droidyue-23">位置信息服务(LBS)关键技术及应用</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00E7XVAZA" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00KHG1006/ref=as_li_qf_sp_asin_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00KHG1006&linkCode=as2&tag=droidyue-23">基于语义Web的LBS服务架构及其服务发现算法研究</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00KHG1006" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[实时预览Markdown利器]]></title>
    <link href="http://droidyue.com/blog/2014/10/01/great-markdown-viewer-as-a-chrome-extension/"/>
    <updated>2014-10-01T09:21:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/10/01/great-markdown-viewer-as-a-chrome-extension</id>
    <content type="html"><![CDATA[<p>使用MBP15寸有点高不成低不就，接显示器分辨率下降（浪费Retina屏），不接显示器屏幕不是很大。</p>

<p>常用的markdown编辑器设置为左侧编辑器（Editor），右边实时查看器（Viewer）。受制于屏幕尺寸，editor和viewer都显示不完整，于是尝试找一个浏览器渲染markdown文件的插件。于是就发现了markdown-reader。</p>

<!--more-->


<h2>功能点</h2>

<ul>
<li>支持读取markdown文件（http,https,file等协议）</li>
<li>文件变化自动加载刷新</li>
<li>代码高亮</li>
<li>显示内容边框</li>
<li>支持table扩展</li>
</ul>


<h2>示例效果</h2>

<p><img src="http://droidyueimg.qiniudn.com/markdown_view_sample.png" title="markdown reader" ></p>

<h2>使用心得</h2>

<p>很不错的一款插件，支持file协议，检测到文件变化很迅速，目测比百度网盘还要快，排版很棒。</p>

<h2>地址</h2>

<ul>
<li><a href="https://chrome.google.com/webstore/detail/markdown-reader/gpoigdifkoadgajcincpilkjmejcaanc">Chrome Store 地址</a></li>
<li><a href="https://github.com/yaniswang/markdownReader">Github开源仓库</a></li>
</ul>


<h3>其他</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B0051EEQWS/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B0051EEQWS&linkCode=as2&tag=droidyue-23">别告诉我你会记笔记</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B0051EEQWS" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B006BPPKZ8/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B006BPPKZ8&linkCode=as2&tag=droidyue-23">超级整理术:工作效率是整理出来的</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B006BPPKZ8" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B004O9F71K/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B004O9F71K&linkCode=as2&tag=droidyue-23">番茄工作法图解:简单易行的时间管理方法</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B004O9F71K" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[利用WebView实现网页的i18n]]></title>
    <link href="http://droidyue.com/blog/2014/09/30/i18n-web-page-using-webview-in-android/"/>
    <updated>2014-09-30T21:44:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/09/30/i18n-web-page-using-webview-in-android</id>
    <content type="html"><![CDATA[<p>软件如果想在全球获得更多的用户，国际化与本地化（internationalization and localization 简称：i18n 和L10n）是非常必要的。本文将介绍一个很geeky的方法来利用webview实现html的i18n。</p>

<!--more-->


<h2>基本概念</h2>

<p>国际化是指在设计软件，将软件与特定语言及地区脱钩的过程。当软件被移植到不同的语言及地区时，软件本身不用做内部工程上的改变或修正。本地化则是指当移植软件时，加上与特定区域设置有关的信息和翻译文件的过程。</p>

<p>国际化和本地化之间的区别虽然微妙，但却很重要。国际化意味着产品有适用于任何地方的“潜力”；本地化则是为了更适合于“特定”地方的使用，而另外增添的特色。用一项产品来说，国际化只需做一次，但本地化则要针对不同的区域各做一次。 这两者之间是互补的，并且两者合起来才能让一个系统适用于各地。</p>

<p>上述摘自<a href="http://zh.wikipedia.org/wiki/%E5%9B%BD%E9%99%85%E5%8C%96%E4%B8%8E%E6%9C%AC%E5%9C%B0%E5%8C%96">维基百科 国际化与本地化</a></p>

<h2>问题</h2>

<p>如何实现网页的国际化和本地化，支持更多的语言呢？最简单的逻辑可能类似如下伪代码实现</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">isChinese</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">lable</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="s2">&quot;中文&quot;</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isEnglish</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">lable</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="s2">&quot;English&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>但是这样是很有问题的，如果增加了语言必然要修改代码代码，违背了对修改关闭的原则。所以上述并不是一种很好的方法</p>

<h2>更Hacky的实现</h2>

<p>实现思路主要是借助强大的Android系统的资源适配机制（基于设备设备的信息Locale等匹配最合适的资源）。貌似这个是Chrome中网页实现i18n的逻辑。实现步骤主要如下</p>

<ul>
<li>Android程序提供必要多个Locale的资源</li>
<li>将网页需要的文字资源组成JSON交换格式</li>
<li>WebView注入一个变量，变量内容为上一步的JSON数据</li>
<li>网页实现读取资源，为元素设置内容</li>
<li>加载网页</li>
</ul>


<h3>提供多个Locale文字资源</h3>

<h4>values/strings.xml</h4>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;resources&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;city_beijing&quot;</span><span class="nt">&gt;</span>Beijing<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;country_china&quot;</span><span class="nt">&gt;</span>China<span class="nt">&lt;/string&gt;</span>
</span><span class='line'><span class="nt">&lt;/resources&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>values-zh-rCN/strings.xml</h4>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;resources&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;city_beijing&quot;</span><span class="nt">&gt;</span>北京<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;country_china&quot;</span><span class="nt">&gt;</span>中国<span class="nt">&lt;/string&gt;</span>
</span><span class='line'><span class="nt">&lt;/resources&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>接下来的代码</h3>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">WebView</span> <span class="n">myWebView</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WebView</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span><span class='line'><span class="n">addContentView</span><span class="o">(</span><span class="n">myWebView</span><span class="o">,</span> <span class="k">new</span> <span class="n">LayoutParams</span><span class="o">(</span><span class="n">LayoutParams</span><span class="o">.</span><span class="na">MATCH_PARENT</span><span class="o">,</span> <span class="n">LayoutParams</span><span class="o">.</span><span class="na">MATCH_PARENT</span><span class="o">));</span>
</span><span class='line'><span class="c1">//将网页需要的文字资源组成JSON交换格式</span>
</span><span class='line'><span class="n">JSONObject</span> <span class="n">jsObj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JSONObject</span><span class="o">();</span>
</span><span class='line'><span class="k">try</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">jsObj</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;country&quot;</span><span class="o">,</span> <span class="n">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">country_china</span><span class="o">));</span>
</span><span class='line'>  <span class="n">jsObj</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;city&quot;</span><span class="o">,</span> <span class="n">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">city_beijing</span><span class="o">));</span>
</span><span class='line'><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">JSONException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="c1">//WebView注入一个变量，变量内容为上一步的JSON数据</span>
</span><span class='line'><span class="n">String</span> <span class="n">injectString</span> <span class="o">=</span> <span class="s">&quot;var textRes = &quot;</span> <span class="o">+</span> <span class="n">jsObj</span><span class="o">;</span>
</span><span class='line'><span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">LOGTAG</span><span class="o">,</span> <span class="s">&quot;injuectString = &quot;</span> <span class="o">+</span> <span class="n">injectString</span><span class="o">);</span>
</span><span class='line'><span class="n">WebSettings</span> <span class="n">settings</span> <span class="o">=</span> <span class="n">myWebView</span><span class="o">.</span><span class="na">getSettings</span><span class="o">();</span>
</span><span class='line'><span class="n">settings</span><span class="o">.</span><span class="na">setJavaScriptEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'><span class="n">myWebView</span><span class="o">.</span><span class="na">loadUrl</span><span class="o">(</span><span class="s">&quot;javascript:&quot;</span> <span class="o">+</span> <span class="n">injectString</span><span class="o">);</span>
</span><span class='line'><span class="n">myWebView</span><span class="o">.</span><span class="na">loadUrl</span><span class="o">(</span><span class="s">&quot;file:///android_asset/location.html&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>网页实现</h3>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'>  <span class="nt">&lt;head&gt;</span>
</span><span class='line'>      <span class="nt">&lt;title&gt;</span>i18n Test<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;body&gt;</span>
</span><span class='line'>      <span class="nt">&lt;label</span> <span class="na">id=</span><span class="s">&quot;country&quot;</span><span class="nt">&gt;&lt;/label&gt;</span>
</span><span class='line'>      <span class="nt">&lt;lable</span> <span class="na">id=</span><span class="s">&quot;city&quot;</span><span class="nt">&gt;&lt;/lable&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/body&gt;</span>
</span><span class='line'>  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;country&#39;</span><span class="p">).</span><span class="nx">innerText</span><span class="o">=</span> <span class="nx">textRes</span><span class="p">.</span><span class="nx">country</span>
</span><span class='line'>      <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;city&#39;</span><span class="p">).</span><span class="nx">innerText</span> <span class="o">=</span> <span class="nx">textRes</span><span class="p">.</span><span class="nx">city</span>
</span><span class='line'>  <span class="nt">&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>结果</h3>

<ul>
<li>当系统语言为中文简体环境下网页显示<strong>中国 北京</strong></li>
<li>当系统语言为非中文简体环境下网页显示<strong>China Beijing</strong></li>
</ul>


<h3>Demo源码下载</h3>

<p><a href="http://pan.baidu.com/s/1sjwNamL">@百度网盘</a></p>

<h3>其他</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B00ASIN7G8/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00ASIN7G8&linkCode=as2&tag=droidyue-23">这样才可以精通Android</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00ASIN7G8" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B002JCU2TG/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B002JCU2TG&linkCode=as2&tag=droidyue-23">瞬间之美:Web界面设计如何让用户心动</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B002JCU2TG" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[每周一脚本：js设置链接为新标签打开]]></title>
    <link href="http://droidyue.com/blog/2014/09/29/open-url-in-new-tab-using-javascript/"/>
    <updated>2014-09-29T21:59:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/09/29/open-url-in-new-tab-using-javascript</id>
    <content type="html"><![CDATA[<p>由于Markdown在编辑Octopress文章的链接时无法指定打开方式，所以很多时候需要使用html写。后来想了一下，为什么不通过javascript把超链接的打开方式默认成新标签实现呢。</p>

<!--more-->


<p>JQuery中提供了一个DOM元素插入事件 DOMNodeInserted ，我们可以通过监听这个事件，对没有target属性值的a标签设置其target为_blank。这样就实现了默认新标签打开了。</p>

<h3>脚本代码</h3>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="cm">/*To use the  DOMNodeInserted event listening, jquery is required*/</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;DOMNodeInserted&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;a[href^=&quot;http&quot;]&#39;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span>
</span><span class='line'>        <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;_blank&#39;</span><span class="p">)</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3>示例</h3>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;//code.jquery.com/jquery-1.11.0.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;https://rawgit.com/androidyue/weekly-scripts/master/javascript/target_blank_link.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;body&gt;</span>
</span><span class='line'>          <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://droidyue.com&quot;</span><span class="nt">&gt;</span>droidyue<span class="nt">&lt;/a&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>上述示例在浏览器加载之后，就会对a标签添加target=&ldquo;_blank&#8221;属性。</p>

<p><a href="https://github.com/androidyue/weekly-scripts/blob/master/javascript/target_blank_link.js">每周一脚本@Github</a></p>

<h3>其他</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B0089TDFNS/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B0089TDFNS&linkCode=as2&tag=droidyue-23">锋利的jQuery</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B0089TDFNS" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00BQ7RMW0/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00BQ7RMW0&linkCode=as2&tag=droidyue-23">编写可维护的JavaScript</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00BQ7RMW0" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00B14IGUK/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00B14IGUK&linkCode=as2&tag=droidyue-23">安全技术大系:Web前端黑客技术揭秘</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00B14IGUK" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Refused to execute script from because its MIME type (text/plain) is not executable, and strict MIME type checking is enabled]]></title>
    <link href="http://droidyue.com/blog/2014/09/27/refused-to-execute-script-from-because-its-mime-type-text-slash-plain-is-not-executable-and-strict-mime-type-checking-is-enabled/"/>
    <updated>2014-09-27T17:08:00+08:00</updated>
    <id>http://droidyue.com/blog/2014/09/27/refused-to-execute-script-from-because-its-mime-type-text-slash-plain-is-not-executable-and-strict-mime-type-checking-is-enabled</id>
    <content type="html"><![CDATA[<p>今天又与这个问题相遇了,Orz,还是研究一下解决方法和出现原因吧。<br/>
刚刚在github上传了一个js文件，想让这个文件被其他网页引用，于是贴出了这个文件的raw版本的地址。但是却就遇到了这样的问题。</p>

<!--more-->


<p>这就是出现错误的代码</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;http://droidyue-tools.qiniudn.com/jquery.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;https://raw.githubusercontent.com/androidyue/weekly-scripts/master/javascript/target_blank_link.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>  <span class="nt">&lt;div&gt;</span>
</span><span class='line'>    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://droidyue.com&quot;</span><span class="nt">&gt;</span>droidyue.com<span class="nt">&lt;/a&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/div&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>解决方法</h2>

<p>将上面的链接中的<font color="red">raw.githubusercontent.com</font>换成<font color="red">rawgit.com</font>即可，此例中的网址最终为 <b><a href="https://rawgit.com/androidyue/weekly-scripts/master/javascript/target_blank_link.js">https://rawgit.com/androidyue/weekly-scripts/master/javascript/target_blank_link.js</a></b></p>

<h2>原因</h2>

<p>因为raw.githubusercontent.com在Response中设置了<strong>X-Content-Type-Options:nosniff</strong>，告诉浏览器强制检查资源的MIME，进行加载。</p>

<p>下面就是未处理的HTTP Response</p>

<figure class='code'><figcaption><span>lineos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>HTTP/1.1 200 OK
</span><span class='line'>Date: Sat, 27 Sep 2014 09:27:12 GMT
</span><span class='line'>Server: Apache
</span><span class='line'>Access-Control-Allow-Origin: https://render.githubusercontent.com
</span><span class='line'>Content-Security-Policy: default-src <span class="s1">&#39;none&#39;</span>
</span><span class='line'>X-XSS-Protection: 1; <span class="nv">mode</span><span class="o">=</span>block
</span><span class='line'>X-Frame-Options: deny
</span><span class='line'>X-Content-Type-Options: nosniff
</span><span class='line'>Strict-Transport-Security: max-age<span class="o">=</span>31536000
</span><span class='line'>ETag: <span class="s2">&quot;4f10b14e4a81a195976ea05787287a019c8bcf6f&quot;</span>
</span><span class='line'>Content-Type: text/plain; <span class="nv">charset</span><span class="o">=</span>utf-8
</span><span class='line'>Cache-Control: max-age<span class="o">=</span>300
</span><span class='line'>Content-Encoding: gzip
</span><span class='line'>Content-Length: 204
</span><span class='line'>Accept-Ranges: bytes
</span><span class='line'>Via: 1.1 varnish
</span><span class='line'>X-Served-By: cache-lax1426-LAX
</span><span class='line'>X-Cache: HIT
</span><span class='line'>X-Cache-Hits: 1
</span><span class='line'>Vary: Authorization,Accept-Encoding
</span><span class='line'>Expires: Sat, 27 Sep 2014 09:32:12 GMT
</span><span class='line'>Source-Age: 44
</span><span class='line'>Keep-Alive: <span class="nv">timeout</span><span class="o">=</span>10, <span class="nv">max</span><span class="o">=</span>50
</span><span class='line'>Connection: Keep-Alive
</span></code></pre></td></tr></table></div></figure>


<h3>X-Content-Type-Options:nosniff 是神马</h3>

<p>  1 如果服务器发送响应头 &ldquo;X-Content-Type-Options: nosniff&#8221;，则 script 和 styleSheet 元素会拒绝包含错误的 MIME 类型的响应。这是一种安全功能，有助于防止基于 MIME类型混淆的攻击。</p>

<p>  2 服务器发送含有 &ldquo;X-Content-Type-Options: nosniff&rdquo; 标头的响应时，此更改会影响浏览器的行为。</p>

<p>  3 如果通过 styleSheet 参考检索到的响应中接收到 &ldquo;nosniff&rdquo; 指令，则 Windows Internet Explorer 不会加载“stylesheet”文件，除非 MIME 类型匹配 &ldquo;text/css&#8221;。</p>

<p>  4 如果通过 script 参考检索到的响应中接收到 &ldquo;nosniff&rdquo; 指令，则 Internet Explorer 不会加载“script”文件，除非 MIME 类型匹配以下值之一：</p>

<ul>
<li>&ldquo;application/ecmascript&rdquo;</li>
<li>&ldquo;application/javascript&rdquo;</li>
<li>&ldquo;application/x-javascript&rdquo;</li>
<li>&ldquo;text/ecmascript&rdquo;</li>
<li>&ldquo;text/javascript&rdquo;</li>
<li>&ldquo;text/jscript&rdquo;</li>
<li>&ldquo;text/x-javascript&rdquo;</li>
<li>&ldquo;text/vbs&rdquo;</li>
<li>&ldquo;text/vbscript&rdquo;</li>
</ul>


<p>该部分参考<a href="http://msdn.microsoft.com/zh-cn/library/ie/gg622941(v=vs.85).aspx">减少 MIME 类型的安全风险</a></p>

<h3>进阶书籍</h3>

<ul>
<li><a href="http://www.amazon.cn/gp/product/B00GOM5IL4/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00GOM5IL4&linkCode=as2&tag=droidyue-23">深入浅出Node.js</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00GOM5IL4" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B0097CON2S/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B0097CON2S&linkCode=as2&tag=droidyue-23">JavaScript语言精粹</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B0097CON2S" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.cn/gp/product/B00BQ7RMW0/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00BQ7RMW0&linkCode=as2&tag=droidyue-23">编写可维护的JavaScript</a><img src="http://ir-cn.amazon-adsystem.com/e/ir?t=droidyue-23&l=as2&o=28&a=B00BQ7RMW0" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>

]]></content>
  </entry>
  
</feed>
